---
title: "Firebaseç·¨"
---

ã“ã“ã¾ã§ã§ã€ã‚ã‚‹ç¨‹åº¦è¦‹ãŸç›®ã®ç¾ã—ã„Todoã‚¢ãƒ—ãƒªãŒå‡ºæ¥ä¸ŠãŒã‚Šã¾ã—ãŸãŒã€è‚å¿ƒã®Todoã‚¿ã‚¹ã‚¯ã®ãƒ‡ãƒ¼ã‚¿ãŒã©ã“ã«ã‚‚æ°¸ç¶šåŒ–ã•ã‚Œã¦ã„ãªã„ã¨ã„ã†è‡´å‘½çš„ãªå•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚

ã¨ã„ã†ã‚ã‘ã§ã€ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã®ç· ã‚æ‹¬ã‚Šã¨ã—ã¦ã€[Firebase](https://firebase.google.com/?hl=ja) ã® [Cloud Firestore](https://firebase.google.com/docs/firestore?hl=ja) ã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æ°¸ç¶šåŒ–ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ãã¾ã™ğŸ’ª

# 1. Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹

ã¾ãšã¯ä»¥ä¸‹ã®æ‰‹é †ã§Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚

1. <https://console.firebase.google.com/> ã§ `ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ ` ã‚’ã‚¯ãƒªãƒƒã‚¯
1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã« `angular-todo` ã¨å…¥åŠ›ã—ã¦ `ç¶šè¡Œ`
1. `ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§Googleã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã‚’æœ‰åŠ¹ã«ã™ã‚‹` ã¯ä»Šå›ã¯OFFã«ã—ã¦ `ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ`
1. 1åˆ†ã»ã©å¾…ã£ã¦ã€ `æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æº–å‚™ãŒã§ãã¾ã—ãŸ` ã¨è¡¨ç¤ºã•ã‚ŒãŸã‚‰ã€ `ç¶šè¡Œ`

ä»¥ä¸‹ã®ã‚ˆã†ãªç”»é¢ã¾ã§æ¥ãŸã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆå®Œäº†ã§ã™ã€‚

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gfsod1ub6aj31lj0u0k7a.jpg)

# 2. Firestoreã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹

ä»¥ä¸‹ã®æ‰‹é †ã§ã€Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã«Firestoreã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚

1. Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒšãƒ¼ã‚¸ï¼ˆä¸Šè¨˜ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®ç”»é¢ï¼‰ã®å·¦ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ `Database` ã‚’ã‚¯ãƒªãƒƒã‚¯
1. `ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä½œæˆ` ã‚’ã‚¯ãƒªãƒƒã‚¯
1. `ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§é–‹å§‹` ã‚’é¸æŠã—ã¦ `æ¬¡ã¸`
1. Cloud Firestoreã®ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ `asia-northeast1` ï¼ˆæ±äº¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰ã‚’é¸æŠã—ã¦ `å®Œäº†`
1. 1åˆ†ã»ã©å¾…ã¤

ä»¥ä¸‹ã®ã‚ˆã†ãªç”»é¢ã«ãªã£ãŸã‚‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æº–å‚™ã¯å®Œäº†ã§ã™ã€‚

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gfsojb9d9mj31tr0u0tdi.jpg)

> **â€»æ³¨æ„**  
> `ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰` ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œã‚‹ã¨ã€ä½œæˆã‹ã‚‰30æ—¥é–“ã¯èª°ã§ã‚‚èª­ã¿æ›¸ããŒå¯èƒ½ãªæ¨©é™è¨­å®šã«ãªã‚Šã¾ã™ã€‚é‡è¦ãªç§˜åŒ¿æƒ…å ±ã‚„å€‹äººæƒ…å ±ãªã©ã‚’ä¿å­˜ã—ã¦ã—ã¾ã‚ãªã„ã‚ˆã†ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

# 3. ã‚¢ãƒ—ãƒªã‹ã‚‰Firestoreã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã®æº–å‚™ã‚’ã™ã‚‹

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ã‚¢ãƒ—ãƒªã‹ã‚‰åˆ©ç”¨ã™ã‚‹ãŸã‚ã®æº–å‚™ãŒå¿…è¦ã§ã™ã€‚ä»¥ä¸‹ã®æ‰‹é †ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚

1. Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒšãƒ¼ã‚¸ã®å·¦ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ `ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ¦‚è¦` ã‚’ã‚¯ãƒªãƒƒã‚¯
1. `</>` ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆWebã‚¢ãƒ—ãƒªï¼‰ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
   ![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gfsomt7homj30hu06m74q.jpg)
1. ã‚¢ãƒ—ãƒªã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã« `angular-todo` ã¨å…¥åŠ›ã—ã€ `ã“ã®ã‚¢ãƒ—ãƒªã®Firebase Hostingã‚‚è¨­å®šã—ã¾ã™` ã«ã¯ **ãƒã‚§ãƒƒã‚¯ã›ãšã«** `ã‚¢ãƒ—ãƒªã‚’ç™»éŒ²` ã‚’ã‚¯ãƒªãƒƒã‚¯
1. è¡¨ç¤ºã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚¹ãƒ‹ãƒšãƒƒãƒˆã®ã†ã¡ä»¥ä¸‹ã®éƒ¨åˆ†ã‚’ã©ã“ã‹ã«ã‚³ãƒ”ãƒ¼ã—ã¦ãŠã„ãŸä¸Šã§ã€ `ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«é€²ã‚€` ã‚’ã‚¯ãƒªãƒƒã‚¯
    ```js
    apiKey: "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
    authDomain: "angular-todo-xxxxx.firebaseapp.com",
    databaseURL: "https://angular-todo-xxxxx.firebaseio.com",
    projectId: "angular-todo-xxxxx",
    storageBucket: "angular-todo-xxxxx.appspot.com",
    messagingSenderId: "xxxxxxxxxxxxx",
    appId: "1:xxxxxxxxxxxxx:web:xxxxxxxxxxxxxxxxxxxxxx",
    measurementId: "G-xxxxxxxxxx"
    ```

ã“ã®ã‚³ãƒ¼ãƒ‰ã‚¹ãƒ‹ãƒšãƒƒãƒˆã¯å¾Œã»ã©Angularã‚¢ãƒ—ãƒªã‹ã‚‰Firestoreã«æ¥ç¶šã™ã‚‹ãŸã‚ã«å¿…è¦ã«ãªã‚Šã¾ã™ã€‚

ã“ã®ã‚³ãƒ¼ãƒ‰ã‚¹ãƒ‹ãƒšãƒƒãƒˆã¯ã€ `å·¦ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®æ­¯è»Šã‚¢ã‚¤ã‚³ãƒ³ > ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¨­å®š > å…¨èˆ¬` ã®ç”»é¢ã§ã„ã¤ã§ã‚‚è¦‹ã‚‰ã‚Œã¾ã™ğŸ‘Œ

# 4. ã‚¢ãƒ—ãƒªã‹ã‚‰Firestoreã‚’åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

Angularã‚¢ãƒ—ãƒªã§Firebaseã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ã€[angularfire](https://github.com/angular/angularfire) ã¨ã„ã†Angularå…¬å¼ã®Firebase SDKã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

[ã“ã¡ã‚‰ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://github.com/angular/angularfire/blob/master/docs/install-and-setup.md) ã‚’å‚è€ƒã«ã€ä»¥ä¸‹ã®æ‰‹é †ã§ã‚¢ãƒ—ãƒªã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã—ã‚‡ã†ã€‚

ã¾ãšå‰æã¨ã—ã¦Firebaseã®SDKæœ¬ä½“ãŒå¿…è¦ã§ã™ã€‚

```bash
npm i -S firebase
# ã¾ãŸã¯
yarn add firebase
```

ç¶šã„ã¦angularfireã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```
ng add @angular/fire
```

é€”ä¸­ `? Please select a project:` ã¨èã‹ã‚Œã‚‹ã®ã§ `angular-todo` ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ãŸã‚‰ã€Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨æ¥ç¶šã™ã‚‹ãŸã‚ã®æƒ…å ±ã‚’ç’°å¢ƒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¿°ã—ã¾ã™ã€‚

`src/environments/environments.ts` ã‚’é–‹ã„ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ã« `environment.firebase` ã«å…ˆã»ã©ã‚³ãƒ”ãƒ¼ã—ã¦ãŠã„ãŸã‚³ãƒ¼ãƒ‰ã‚¹ãƒ‹ãƒšãƒƒãƒˆã‚’ãã®ã¾ã¾ã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚

```diff
export const environment = {
- production: false
+ production: false,
+ firebase: {
+   apiKey: "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
+   authDomain: "angular-todo-xxxxx.firebaseapp.com",
+   databaseURL: "https://angular-todo-xxxxx.firebaseio.com",
+   projectId: "angular-todo-xxxxx",
+   storageBucket: "angular-todo-xxxxx.appspot.com",
+   messagingSenderId: "xxxxxxxxxxxxx",
+   appId: "1:xxxxxxxxxxxxx:web:xxxxxxxxxxxxxxxxxxxxxx",
+   measurementId: "G-xxxxxxxxxx",
+ },
};
```

æœ€å¾Œã«ã€ `src/app/app.module.ts` ã«ä»¥ä¸‹ã®ã‚ˆã†ã« `AngularFireModule` ã¨ `AngularFirestoreModule` ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```diff
+ import { AngularFireModule } from '@angular/fire';
+ import { AngularFirestoreModule } from '@angular/fire/firestore';
+ import { environment } from '../environments/environment';

registerLocaleData(en);

@NgModule({
  declarations: [
    // ç•¥
  ],
  imports: [
    // ç•¥
+   AngularFireModule.initializeApp(environment.firebase),
+   AngularFirestoreModule,
  ],
  // ç•¥
})
export class AppModule { }
```

# 5. å®Ÿéš›ã«ã‚¢ãƒ—ãƒªã‹ã‚‰Firestoreã«ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¦ã¿ã‚‹

ã“ã‚Œã§æº–å‚™ã¯å®Œäº†ã§ã™ï¼

ãã‚Œã§ã¯æ—©é€Ÿã€å®Ÿéš›ã«Firestoreã«ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¦ã¿ã¾ã—ã‚‡ã†ğŸ’ª

`src/app/task-list/task-list.component.ts` ã«ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã‚’è¿½è¨˜ã—ã¾ã™ã€‚

```diff
  import { Component, OnInit } from '@angular/core';
  import { Task } from '../../models/task';
+ import { AngularFirestore } from '@angular/fire/firestore';

  @Component({
    selector: 'app-task-list',
    templateUrl: './task-list.component.html',
    styleUrls: ['./task-list.component.scss']
  })
  export class TaskListComponent implements OnInit {
 
-   constructor() { }
+   constructor(
+     private firestore: AngularFirestore,
+   ) { }

    tasks: Task[] = [
      {title: 'ç‰›ä¹³ã‚’è²·ã†', done: false, deadline: new Date('2021-01-01')},
      {title: 'å¯ç‡ƒã‚´ãƒŸã‚’å‡ºã™', done: true, deadline: new Date('2020-01-02')},
      {title: 'éŠ€è¡Œã«è¡Œã', done: false, deadline: new Date('2020-01-03')},
    ];

    ngOnInit(): void {
    }

    addTask(task: Task): void {
      this.tasks.push(task);
+     this.firestore.collection('tasks').add(task);
    }
  }
```

angularfireãŒæŒã£ã¦ã„ã‚‹ `AngularFirestore` ã¨ã„ã†ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã€ `TaskListComponent` ã«ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆã—ã¦åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

Angularã§ã¯ã€ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®å¼•æ•°ã«å‹æ³¨é‡ˆã‚’æ›¸ãã ã‘ã§ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆãŒã§ãã¾ã™ã€‚

`AngularFirestore` ã‚µãƒ¼ãƒ“ã‚¹ã® `collection()` ãƒ¡ã‚½ãƒƒãƒ‰ã§ `'tasks'` ã¨ã„ã†åå‰ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã€ `add()` ãƒ¡ã‚½ãƒƒãƒ‰ã§ãã“ã« `task` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨ã—ã¦è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚

ã“ã®çŠ¶æ…‹ã§å®Ÿéš›ã«ç”»é¢ã‹ã‚‰é©å½“ãªã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¦ã¿ã¦ã€Firestorã®Web UIã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gfspx52hhwj31s40hqdhj.jpg)

ã“ã‚“ãªãµã†ã«ãƒ‡ãƒ¼ã‚¿ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã¯ãšã§ã™ğŸ‘

# 5. Firestoreã‹ã‚‰èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã™ã‚‹

Firestoreã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§ã€ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã§ã¯ãªãå®Ÿéš›ã®Firestoreä¸Šã®ãƒ‡ãƒ¼ã‚¿ã‚’ç”»é¢ã«è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚

`src/app/task-list/task-list.component.ts` ã«æ‰‹ã‚’åŠ ãˆã¦ã„ãã¾ã™ã€‚

ã¾ãšã¯ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã®åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã§ã¯ãªãç©ºã®é…åˆ—ã«å¤‰æ›´ã—ã¾ã—ã‚‡ã†ã€‚

```diff
- tasks: Task[] = [
-   {title: 'ç‰›ä¹³ã‚’è²·ã†', done: false, deadline: new Date('2021-01-01')},
-   {title: 'å¯ç‡ƒã‚´ãƒŸã‚’å‡ºã™', done: true, deadline: new Date('2020-01-02')},
-   {title: 'éŠ€è¡Œã«è¡Œã', done: false, deadline: new Date('2020-01-03')},
- ];
+ tasks: Task[] = [];
```

ãã—ã¦ã€ `ngOnInit()` ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§Firestoreã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ `this.tasks` ã‚’ä¸Šæ›¸ãã—ã¾ã™ã€‚

```diff
  ngOnInit(): void {
+   this.firestore.collection('tasks').valueChanges().subscribe(tasks => {
+     this.tasks = tasks as Task[];
+   });
  }
```

`ngOninit()` ã¯Angularã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã® [ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒ»ãƒ•ãƒƒã‚¯](https://angular.io/guide/lifecycle-hooks) ãƒ¡ã‚½ãƒƒãƒ‰ã®ä¸€ã¤ã§ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚ŒãŸç›´å¾Œã«å®Ÿè¡Œã•ã‚Œã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚

`this.firestore.collection('tasks')` ã«ç”Ÿãˆã¦ã„ã‚‹ [`valueChanges()`](https://github.com/angular/angularfire/blob/master/docs/firestore/documents.md#valuechanges) ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€Firestoreä¸Šã®æŒ‡å®šã—ãŸã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¾ãŸã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å¤‰æ›´ã‚’æ¤œçŸ¥ã—ã¦ [rxjs](https://rxjs-dev.firebaseapp.com/) ã® [`Observable`](https://rxjs-dev.firebaseapp.com/guide/observable) ã«å¤‰æ›ã—ã¦ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¨ã—ã¦æµã—ã¦ãã‚Œã‚‹åƒãã‚’ã—ã¾ã™ã€‚ã“ã‚Œã‚’ `subscribe()` ã™ã‚‹ã“ã¨ã§ã€å¤‰æ›´ãŒæ¤œçŸ¥ã•ã‚Œã‚‹åº¦ã«ç‰¹å®šã®å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

> Angularã«ãŠã„ã¦ã€éåŒæœŸå‡¦ç†ã¯åŸºæœ¬çš„ã« `Promise` ã§ã¯ãªãrxjsã® `Observable` ã‚’ä½¿ã£ã¦å‡¦ç†ã—ã¾ã™ã€‚ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯ `Observable` ã®è©³ã—ã„ä½¿ã„æ–¹ã«ã¤ã„ã¦ã¯èª¬æ˜ã—ã¾ã›ã‚“ãŒã€æœ¬æ ¼çš„ã«Angularã‚’ä½¿ã£ã¦ã„ããªã‚‰é¿ã‘ã¦ã¯é€šã‚Œãªã„å­˜åœ¨ãªã®ã§ã€ãœã²å­¦ã‚“ã§ã¿ã¦ãã ã•ã„ğŸ’ª

å°‘ã—é›£ã—ã„ã§ã™ãŒã€ã¾ã¨ã‚ã‚‹ã¨ã€ `ngOnInit()` å†…ã§ `valueChanges()` ãƒ¡ã‚½ãƒƒãƒ‰ãŒæµã—ã¦ãã‚Œã‚‹ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ `subscribe()` ã™ã‚‹ã“ã¨ã§ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ä»¥é™ãšã£ã¨Firestoreä¸Šã® `tasks` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®å¤‰æ›´ã‚’æ¤œçŸ¥ã—ç¶šã‘ã¦ã€å¤‰æ›´ãŒã‚ã‚‹åº¦ã« `this.tasks` ã‚’æ›´æ–°ã™ã‚‹å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã€ã¨ã„ã†ã‚ã‘ã§ã™ã­ã€‚

ãªãŠã€Firestorã‹ã‚‰å–å¾—ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã¯ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§å®šç¾©ã—ãŸ `Task` ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¨å®Œå…¨ã«ä¸€è‡´ã¯ã—ã¦ã„ãªã„ãŸã‚ã€ã²ã¨ã¾ãš `as Task[]` ã¨ [å‹ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³](https://www.typescriptlang.org/docs/handbook/basic-types.html#type-assertions) ã‚’ä»˜ã‘ã¦ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚’é€šã—ã¦ã„ã¾ã™ã€‚

ãã‚Œã‹ã‚‰ã€Firestoreã«ã‚¿ã‚¹ã‚¯ãŒè¿½åŠ ã•ã‚Œã‚Œã°è‡ªå‹•ã§å¤‰æ›´ãŒæ¤œçŸ¥ã•ã‚Œã¦ `this.tasks` ãŒä¸¸ã”ã¨æ›´æ–°ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§ã€ `addTask()` ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ã‚ªãƒ³ãƒ¡ãƒ¢ãƒªã® `this.tasks` ã«æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’pushã™ã‚‹å‡¦ç†ã¯ã‚‚ã¯ã‚„ä¸è¦ã§ã™ã­ã€‚å‰Šé™¤ã—ã¦ã—ã¾ã„ã¾ã—ã‚‡ã†âœ‹

```diff
  addTask(task: Task): void {
-   this.tasks.push(task);
    this.firestore.collection('tasks').add(task);
  }
```

ã•ã¦ã€ã²ã¨ã¾ãšã“ã®æ®µéšã§ä¸€æ—¦å‹•ã‹ã—ã¦ã¿ã¦ãã ã•ã„ã€‚å®Ÿéš›ã«å‹•ã‹ã—ã¦ã¿ã‚‹ã¨ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ğŸ˜“

```
ERROR TypeError: task.deadline.getTime is not a function
```

`task.deadline.getTime` ã¨ã„ã†é–¢æ•°ãŒãªã„ã¨è¨€ã‚ã‚Œã¦ã„ã¾ã™ã­ã€‚

ã©ã†ã‚„ã‚‰Firestorã‹ã‚‰å–å¾—ã—ãŸ `task` ã® `deadline` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ä¸­èº«ãŒ `Date` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ãªã„ãŸã‚ã« `getTime()` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒã£ã¦ã„ãªã„ã®ãŒåŸå› ã®ã‚ˆã†ã§ã™ã€‚

å®Ÿéš›ã«ã¯ `datetime` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã¯ [`firebase.firestore.Timestamp`](https://firebase.google.com/docs/reference/js/firebase.firestore.Timestamp) ã¨ã„ã†å‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå…¥ã£ã¦ã„ã¾ã™ã€‚

ã“ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ [`toDate()`](https://firebase.google.com/docs/reference/js/firebase.firestore.Timestamp#todate) ã¨ã„ã†ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒã£ã¦ã„ã¦ã€ `Date` å‹ã«å¤‰æ›ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ãªã®ã§ã€ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã™ã‚‹ã“ã¨ã§ã€ã¨ã‚Šã‚ãˆãšå‹•ã‹ã™ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

```diff
- this.firestore.collection('tasks').valueChanges().subscribe(tasks => {
+ this.firestore.collection('tasks').valueChanges().subscribe((tasks: any) => {
-   this.tasks = tasks as Task[];
+   this.tasks = tasks.map(task => {
+     task.deadline = task.deadline ? task.deadline.toDate() : null;
+     return task;
+   }) as Task[];
  });
```

ã“ã‚Œã§ã€ç‰¹ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã“ã¨ã‚‚ãªãæ­£å¸¸ã«Firestoreä¸Šã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã™ã‚‹ã“ã¨ãŒã§ããŸã‹ã¨æ€ã„ã¾ã™ğŸ‘

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gfu1uar9d4g30ja08swpo.gif)

# 6. ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã‚’è§£æ¶ˆã™ã‚‹

ã•ã¦ã€å®Ÿã¯ä»Šã®å®Ÿè£…ã«ã¯é‡å¤§ãªãƒã‚°ãŒã‚ã‚Šã¾ã™ğŸ˜±

`ngOnInit()` ã§ `valueChanges()` ã‚’ `subscribe()` ã™ã‚‹å‡¦ç†ã‚’æ›¸ãã¾ã—ãŸãŒã€ã“ã‚Œã®æ„å‘³ã¯

> å°‘ã—é›£ã—ã„ã§ã™ãŒã€ã¾ã¨ã‚ã‚‹ã¨ã€ `ngOnInit()` å†…ã§ `valueChanges()` ãƒ¡ã‚½ãƒƒãƒ‰ãŒæµã—ã¦ãã‚Œã‚‹ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ `subscribe()` ã™ã‚‹ã“ã¨ã§ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ä»¥é™ãšã£ã¨Firestoreä¸Šã® `tasks` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®å¤‰æ›´ã‚’æ¤œçŸ¥ã—ç¶šã‘ã¦ã€å¤‰æ›´ãŒã‚ã‚‹åº¦ã« `this.tasks` ã‚’æ›´æ–°ã™ã‚‹å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã€ã¨ã„ã†ã‚ã‘ã§ã™ã­ã€‚

ã¨ã„ã†ã“ã¨ã§ã—ãŸã‚ˆã­ã€‚å®Ÿã¯ä»Šã®ã¾ã¾ã ã¨ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒç ´æ£„ã•ã‚ŒãŸã‚ã¨ã‚‚ãƒ¡ãƒ¢ãƒªä¸Šã«ãƒªã‚¹ãƒŠãƒ¼é–¢æ•°ãŒæ®‹ã‚Šç¶šã‘ã¦ã—ã¾ã„ã€[ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯](https://ja.wikipedia.org/wiki/%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%AA%E3%83%BC%E3%82%AF) ãŒç™ºç”Ÿã—ã¾ã™ã€‚

> ã‚ˆã‚Šè©³ã—ãç†è§£ã—ãŸã„æ–¹ã¯ [Observableã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ« - Angular After Tutorial](https://gitbook.lacolaco.net/angular-after-tutorial/season-2-effective-rxjs/observable-lifecycle#noobservable-1) ãªã©ã‚’ã”å‚ç…§ãã ã•ã„ã€‚ãŸã ã€æ›¸ã‹ã‚Œã¦ã„ã‚‹å†…å®¹ãŒä»Šã®æ™‚ç‚¹ã§èª­ã‚€ã«ã¯å°‘ã—é›£ã—ã„ã¨æ€ã†ã®ã§ã€ã‚‚ã†å°‘ã—æ…£ã‚Œã¦ãã¦ã‹ã‚‰ç†è§£ã‚’æ·±ã‚ã‚‹ã§ã‚‚å…¨ç„¶å¤§ä¸ˆå¤«ã§ã™ğŸ‘

ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ãŒç™ºç”Ÿã—ãªã„ã‚ˆã†ã«ã™ã‚‹ã«ã¯ã€ **ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç ´æ£„ã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã€ `subscribe()` ã«ã‚ˆã‚‹è³¼èª­ã‚’è§£é™¤ã™ã‚‹** ã¨ã„ã†å‡¦ç†ã‚’è¿½è¨˜ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

å…·ä½“çš„ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã¾ã™ã€‚

```diff
- import { Component, OnInit } from '@angular/core';
+ import { Component, OnDestroy, OnInit } from '@angular/core';
  import { Task } from '../../models/task';
  import { AngularFirestore } from '@angular/fire/firestore';
+ import { Subscription } from 'rxjs';

  @Component({
    selector: 'app-task-list',
    templateUrl: './task-list.component.html',
    styleUrls: ['./task-list.component.scss']
  })
- export class TaskListComponent implements OnInit {
+ export class TaskListComponent implements OnInit, OnDestroy {

    constructor(
      private firestore: AngularFirestore,
    ) { }

    tasks: Task[] = [];
 
+   subscription: Subscription;
+
    ngOnInit(): void {
-     this.firestore.collection('tasks').valueChanges().subscribe((tasks: any[]) => {
+     this.subscription = this.firestore.collection('tasks').valueChanges().subscribe((tasks: any[]) => {
        this.tasks = tasks.map(task => {
          task.deadline = task.deadline ? task.deadline.toDate() : null;
          return task;
        }) as Task[];
      });
    }
 
+   ngOnDestroy(): void {
+     this.subscription.unsubscribe();
+   }
+
    addTask(task: Task): void {
      this.firestore.collection('tasks').add(task);
    }
  }
```

* ã‚¯ãƒ©ã‚¹ã®å®£è¨€ã‚’å¤‰æ›´ã—ã€ä»Šã¾ã§ `OnInit` ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã ã‘ã‚’å®Ÿè£…ã—ã¦ã„ãŸã¨ã“ã‚ã‚’ã€åŠ ãˆã¦ `OnDestroy` ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚‚å®Ÿè£…ã™ã‚‹ã‚ˆã†ã«
    * ã“ã‚Œã«ã‚ˆã‚Šã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒç ´æ£„ã•ã‚Œã‚‹ç›´å‰ã«å‘¼ã°ã‚Œã‚‹ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒ»ãƒ¡ã‚½ãƒƒãƒ‰ `ngOnDestroy()` ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹
* `valueChanges().subscribe()` ã®æˆ»ã‚Šå€¤ï¼ˆ `Subscription` å‹ï¼‰ã‚’ã‚¯ãƒ©ã‚¹å¤‰æ•°ã«ä¿å­˜ã—ã¦ãŠã„ã¦ã€ `ngOnDestroy()` å†…ã§ `unsubscribe()` ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€è³¼èª­ã‚’è§£é™¤ã™ã‚‹ã‚ˆã†ã«

ã¨ã„ã†ã“ã¨ã‚’ã—ã¾ã—ãŸã€‚

ã¾ã  `Observable` ã«æ…£ã‚Œã¦ã„ãªã„ã®ã§ã€å¤šåˆ†ã€Œåˆ†ã‹ã£ãŸã‚ˆã†ãªåˆ†ã‹ã‚‰ãªã„ã‚ˆã†ãªã€ã¨ã„ã†æ„Ÿè¦šã ã¨æ€ã„ã¾ã™ğŸ˜…ä»Šã®æ®µéšã§ã¯ã€ã€Œ `subscribe()` ã—ãŸã¾ã¾ `unsubscribe()` ã—ãªã„ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã¨ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã®åŸå› ã«ãªã‚Šã†ã‚‹ã€ã¨ã„ã†äº‹å®Ÿã ã‘ã‚’é ­ã®ç‰‡éš…ã§è¦šãˆã¦ãŠã‘ã°ååˆ†ã§ã™ï¼ğŸ’ª

# 7. Firestoreã‹ã‚‰èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ã«ã‚‚å‹ã‚’æŒãŸã›ã‚‹

ã¡ã‚‡ã£ã¨é›£ã—ã‹ã£ãŸã§ã™ãŒã€ä¸€å¿œã“ã‚Œã§ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã‚‚ãªãå‹•ãã‚‚ã®ãŒä½œã‚Œã¾ã—ãŸğŸ‘

ãŸã ã€ã“ã®è¾ºã‚Šã®ã‚³ãƒ¼ãƒ‰ãŒ

```ts
this.subscription = this.firestore.collection('tasks').valueChanges().subscribe((tasks: any[]) => {
   this.tasks = tasks.map(task => {
     task.deadline = task.deadline ? task.deadline.toDate() : null;
     return task;
   }) as Task[];
 });
```

`any` `as` ã®ã‚ªãƒ³ãƒ‘ãƒ¬ãƒ¼ãƒ‰ã§ã¡ã£ã¨ã‚‚å‹ã®åŠ›ã‚’æ´»ã‹ã›ã¦ã„ã¾ã›ã‚“ã­ğŸ¤”

ã‚„ã¯ã‚ŠTypeScriptã«ãŠã„ã¦ `any` ã‚„ `as` ã¯ã§ãã‚‹ã ã‘ä½¿ã†ã¹ãã§ã¯ãªã„ã®ã§ã€ã‚‚ã†å°‘ã—å‹å®‰å…¨ãªã‚³ãƒ¼ãƒ‰ã«ç›´ã—ã¦ã¿ã¾ã—ã‚‡ã†ğŸ’ª

ã¾ãšã€Firestoreãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨ã—ã¦å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ãã¡ã‚“ã¨å‹ã‚’ä»˜ã‘ã¦æ‰±ãˆã‚‹ã‚ˆã†ã«ã€ `src/models/task.ts` ã«ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```diff
+ import * as firebase from 'firebase';
+ import Timestamp = firebase.firestore.Timestamp;
+
  export interface Task {
    title: string;
    done: boolean;
    deadline?: Date;
  }
+
+ export interface TaskDocument {
+   title: string;
+   done: boolean;
+   deadline?: Timestamp;
+ }
+
+ export function fromDocument(doc: TaskDocument): Task {
+   return {
+     title: doc.title,
+     done: doc.done,
+     deadline: doc.deadline ? doc.deadline.toDate() : null,
+   };
+ }
```

Firestorãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨ã—ã¦ã®ã‚¿ã‚¹ã‚¯ã‚’ `TaskDocument` ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¨ã—ã¦å®šç¾©ã—ã€ã•ã‚‰ã« `TaskDocument` å‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’ `Task` å‹ã«å¤‰æ›ã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’ `fromDocument` é–¢æ•°ã¨ã—ã¦å®šç¾©ã—ã¾ã—ãŸã€‚

ã“ã‚Œã‚‰ã‚’ä½¿ã£ã¦ã€ `ngOnInit()` ã®ä¸­èº«ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã§ãã¾ã™ã€‚

```diff
  import { Component, OnDestroy, OnInit } from '@angular/core';
- import { Task } from '../../models/task';
+ import { fromDocument, Task, TaskDocument } from '../../models/task';
  import { AngularFirestore } from '@angular/fire/firestore';
  import { Subscription } from 'rxjs';

  // ...

    ngOnInit(): void {
-     this.subscription = this.firestore.collection('tasks').valueChanges().subscribe((tasks: any[]) => {
-       this.tasks = tasks.map(task => {
-         task.deadline = task.deadline ? task.deadline.toDate() : null;
-         return task;
-       }) as Task[];
-     });
+     this.subscription = this.firestore.collection('tasks').valueChanges().subscribe((tasks: TaskDocument[]) => {
+       this.tasks = tasks.map(fromDocument);
+     });
    }
```

å‹å®‰å…¨ã‹ã¤ã¨ã¦ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ã§å¯èª­æ€§ã®é«˜ã„ã‚³ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã—ãŸã­ğŸ‘

# 8. ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¯ãƒªãƒƒã‚¯ã§Firestoreä¸Šã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã™ã‚‹ã‚ˆã†ã«

Firestoreã®èª­ã¿æ›¸ããŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸãŒã€ç¾çŠ¶ã§ã¯æ—¢å­˜ã®ã‚¿ã‚¹ã‚¯ã®å®Œäº†çŠ¶æ…‹ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã®ã§ã€ã“ã‚Œã«å¯¾å¿œã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

## Firestoreã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æ™‚ã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã‚‚å–å¾—ã™ã‚‹

ã¾ãšã€æ—¢å­˜ã®Firestoreãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã«ã¯ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã‚’çŸ¥ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãšã¯Firestoreã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã ã¨ãã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã‚‚ä¸€ç·’ã«å–å¾—ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

ã¾ãšã¯ `Task` å‹ã¨ `TaskDocument` å‹ã‚’ä¿®æ­£ã—ã¦ã€ `id` ã‚’æŒã¦ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```diff
  export interface Task {
+   id?: string;
    title: string;
    done: boolean;
    deadline?: Date;
  }
  export interface TaskDocument {
+   id: string;
    title: string;
    done: boolean;
    deadline?: Timestamp;
  }
  
  export function fromDocument(doc: TaskDocument): Task {
    return {
+     id: doc.id,
      title: doc.title,
      done: doc.done,
      deadline: doc.deadline ? doc.deadline.toDate() : null,
    };
  }
```

æ¬¡ã«ã€`valueChanges()` ãƒ¡ã‚½ãƒƒãƒ‰ã«å¼•æ•°ã‚’æ¸¡ã—ã¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã‚‚å–å¾—ã—ã¦ãã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

å¼•æ•°ã¨ã—ã¦ `{idField: 'ä½•ã¨ã„ã†ã‚­ãƒ¼åã¨ã—ã¦å–å¾—ã—ãŸã„ã‹'}` ã‚’æ¸¡ã™ã“ã¨ã§ã€ä»»æ„ã®ã‚­ãƒ¼åã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã‚’å–å¾—ã§ãã¾ã™ã€‚ï¼ˆ[å‚è€ƒ](https://github.com/angular/angularfire/blob/master/docs/firestore/collections.md#valuechangesidfield-string)ï¼‰

```diff
  ngOnInit(): void {
-   this.subscription = this.firestore.collection('tasks').valueChanges().subscribe((tasks: TaskDocument[]) => {
+   this.subscription = this.firestore.collection('tasks').valueChanges({idField: 'id'}).subscribe((tasks: TaskDocument[]) => {
      this.tasks = tasks.map(fromDocument);
    });
  }
```

ã“ã‚Œã§ã€Firestoreã‹ã‚‰èª­ã¿è¾¼ã‚“ã ã‚¿ã‚¹ã‚¯ãŒ `id` ã‚’æŒã£ãŸçŠ¶æ…‹ã«ãªã‚Šã¾ã—ãŸã€‚ã“ã®ã¾ã¾ã®çŠ¶æ…‹ã§ã‚¿ã‚¹ã‚¯ã®è¿½åŠ æ“ä½œã‚’ã—ã¦ã—ã¾ã†ã¨ã€ `id` ã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŒã£ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜ã•ã‚Œã¦ã—ã¾ã†ã®ã§ï¼ˆå®Ÿå®³ã¯ã‚ã‚Šã¾ã›ã‚“ãŒï¼‰ã€ `addTask()` ã®å‡¦ç†ã‚’å°‘ã—ä¿®æ­£ã—ã¦ã€ `id` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯å–ã‚Šé™¤ã„ãŸçŠ¶æ…‹ã§ä¿å­˜ã™ã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

```diff
  addTask(task: Task): void {
-   this.firestore.collection('tasks').add(task);
+   const clone = Object.assign({}, task);
+   delete clone.id;
+ 
+   this.firestore.collection('tasks').add(clone);
  }
  ```

## ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚‰Firestoreä¸Šã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã™ã‚‹

ã€Œãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã“ã¨ã€ã‚’çŸ¥ã£ã¦ã„ã‚‹ã®ã¯ `TaskListItemComponent` ã§ã™ãŒã€Firestoreã‚’æ“ä½œã™ã‚‹å‡¦ç†ã¯ `TaskListComponent` ã«é›†ç´„ã—ã¦ãŠããŸã„ã®ã§ã€ `TaskFormComponent` ã‹ã‚‰ `TaskListComponent` ã¸ã‚¤ãƒ™ãƒ³ãƒˆçµŒç”±ã§ã‚¿ã‚¹ã‚¯ã‚’æ¸¡ã—ãŸã¨ãã¨åŒã˜ã‚ˆã†ã«ã€ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã‚’ `TaskListComponent` ã«æ¸¡ã™ã‚ˆã†ãªå®Ÿè£…ã«ã—ã¦ã¿ã¾ã—ã‚‡ã†âœ‹

`src/app/task-list/task-list.component.ts`

```diff
  addTask(task: Task): void {
    const clone = Object.assign({}, task);
    delete clone.id;

    this.firestore.collection('tasks').add(clone);
  }
+
+ updateTask(task: Task): void {
+   const clone = Object.assign({}, task);
+   delete clone.id;
+
+   this.firestore.collection('tasks').doc(task.id).update(clone);
+ }
```

`src/app/task-list-item/task-list-item.component.ts`

```diff
- import { Component, Input, OnInit } from '@angular/core';
+ import { Component, EventEmitter, Input, OnInit, Output } from '@angular/core';
  import { Task } from '../../models/task';

    // ...

    @Input() task: Task;
+   @Output() updateTask = new EventEmitter<Task>();

    // ...

    onToggleDone(task: Task): void {
      this.updateTask.emit(task);
    }
```

`src/app/task-list-item/task-list-item.component.html`

```diff
  <div class="left">
-   <label nz-checkbox [(ngModel)]="task.done" class="{{ task.done ? 'done' : '' }}">
+   <label nz-checkbox [(ngModel)]="task.done" class="{{ task.done ? 'done' : '' }}" (click)="onToggleDone(task)">
      {{ task.title }}
    </label>
  </div>
```

> `(click)="onToggleDone(task)"` ã¨æ›¸ãã¾ã—ãŸãŒã€å³å¯†ã«ã¯ [`(ngModelChange)="onToggleDone(task)"`](https://ng.ant.design/components/checkbox/en#[nz-checkbox]) ã¨ã™ã¹ãã§ã™ã€‚ã“ã“ã§ã¯èª¬æ˜ã¯å‰²æ„›ã—ã¾ã™ã€‚ãªãœãã†ã™ã¹ããªã®ã‹ãœã²è€ƒãˆã¦ã¿ã¦ãã ã•ã„ğŸ‘

`src/app/task-list/task-list.component.html`

```diff
  <nz-list-item *ngFor="let task of tasks">
-   <app-task-list-item [task]="task"></app-task-list-item>
+   <app-task-list-item [task]="task" (updateTask)="updateTask($event)"></app-task-list-item>
  </nz-list-item>
```

# 9. ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆãŒä½œæˆæ—¥æ™‚é †ã§ä¸¦ã¶ã‚ˆã†ã«ã™ã‚‹

ã„ã‚ˆã„ã‚ˆå¤§è©°ã‚ã§ã™ã€‚

ç¾æ™‚ç‚¹ã§ã‚¿ã‚¹ã‚¯ã®èª­ã¿è¾¼ã¿ãƒ»è¿½åŠ ãƒ»ç·¨é›†ã¨ã‚‚Firestoreã‚’ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã¨ã—ã¦å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸãŒã€å®Ÿéš›ã«æ“ä½œã—ã¦ã¿ã‚‹ã¨é•å’Œæ„Ÿã‚’è¦šãˆãŸã¯ãšã§ã™ã€‚

ãã†ã€ **ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã®ä¸¦ã³é †ãŒãƒãƒ©ãƒãƒ©** ã§ã™ã­ã€‚

Firestoreã‹ã‚‰å–å¾—ã—ãŸãƒªã‚¹ãƒˆã‚’ãã®ã¾ã¾è¡¨ç¤ºã—ã¦ã„ã‚‹ã®ã§ã€FirestoreãŒæ°—ã¾ãã‚Œã«ä¸¦ã¹ãŸé †ç•ªï¼ˆãŠãã‚‰ããƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDæ˜‡é †ï¼‰ã§è¡¨ç¤ºã•ã‚Œã¦ã—ã¾ã£ã¦ã„ã‚‹ã®ã§ã™ã€‚

ãƒªã‚¹ãƒˆã‚’ã‚ªãƒ³ãƒ¡ãƒ¢ãƒªã§ä¿æŒã—ã¦ã„ãŸã¨ãã¨åŒæ§˜ã«ã€ã‚¿ã‚¹ã‚¯ã®ä½œæˆæ—¥æ™‚æ˜‡é †ã§ä¸¦ã¶ã‚ˆã†ã«ä¿®æ­£ã—ã¦ã¿ã¾ã—ã‚‡ã†ğŸ’ª

`src/models/task.ts`

```diff
  export interface Task {
    id?: string;
    title: string;
    done: boolean;
    deadline?: Date;
+   createdAt: Date;
  }
  export interface TaskDocument {
    id: string;
    title: string;
    done: boolean;
    deadline?: Timestamp;
+   createdAt: Timestamp;
  }
  
  export function fromDocument(doc: TaskDocument): Task {
    return {
      id: doc.id,
      title: doc.title,
      done: doc.done,
      deadline: doc.deadline ? doc.deadline.toDate() : null,
+     createdAt: doc.createdAt.toDate(),
    };
  }
```

`src/app/task-list/task-list.component.ts`

```diff
  ngOnInit(): void {
    this.subscription = this.firestore.collection('tasks').valueChanges({idField: 'id'}).subscribe((tasks: TaskDocument[]) => {
-     this.tasks = tasks.map(fromDocument);
+     this.tasks = tasks.map(fromDocument).sort((a: Task, b: Task) => a.createdAt.getTime() - b.createdAt.getTime());
    });
  }
```

`src/app/task-form/task-form.component.ts`

```diff
  submit(): void {
    this.addTask.emit({
      title: this.newTask.title,
      done: false,
      deadline: this.newTask.deadline ? new Date(this.newTask.deadline) : null,
+     createdAt: new Date(),
    });
    this.newTask = {
      title: '',
      deadline: null,
    };
  }
```

å‹ã« `createdAt` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¿½åŠ ã—ã¦ã€ã‚¿ã‚¹ã‚¯ä½œæˆæ™‚ã«ç¾åœ¨æ—¥æ™‚ã‚’å…¥ã‚Œã¦ä¿å­˜ã™ã‚‹ã‚ˆã†ã«ã—ãŸä¸Šã§ã€Firestoreã‹ã‚‰èª­ã¿è¾¼ã‚“ã ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã‚’ [`sort()`](https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Array/sort) ã§ `createdAt` æ˜‡é †ã§ã‚½ãƒ¼ãƒˆã—ã¦ã„ã‚‹ã ã‘ã§ã™ğŸ‘

`createdAt` ãªã—ã®ã‚¿ã‚¹ã‚¯ãŒã™ã§ã«Firestoreä¸Šã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ä¸€åº¦ãã‚Œã‚‰ã‚’Firestoreä¸Šã‹ã‚‰å‰Šé™¤ã—ãŸä¸Šã§å‹•ä½œç¢ºèªã—ã¦ã¿ã¦ãã ã•ã„ã€‚

ç¾çŠ¶ã®å‹•ä½œã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚ç”»é¢ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚‚ã¡ã‚ƒã‚“ã¨çŠ¶æ…‹ãŒä¿æŒã•ã‚Œã¦ã„ã¾ã™ã­ğŸ™Œ

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gfu4driigug30jd0cuwod.gif)

# 10. è¿½åŠ èª²é¡Œ

ã“ã“ã¾ã§ã§ããŸã‚ãªãŸã«ã€æœ€å¾Œã«è¿½åŠ èª²é¡Œã§ã™ï¼

å„ã‚¿ã‚¹ã‚¯ã«å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã—ã€ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ç”»é¢ã‹ã‚‰ã‚‚Firestoreä¸Šã‹ã‚‰ã‚‚ã‚¿ã‚¹ã‚¯ãŒå‰Šé™¤ã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¯ãƒªãƒƒã‚¯ã§ã‚¿ã‚¹ã‚¯ã‚’æ›´æ–°ã—ãŸã¨ãã¨åŒã˜æµã‚Œã§ã§ãã‚‹ã¯ãšã§ã™ğŸ’ª

Firestoreã‹ã‚‰ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã™ã‚‹æ–¹æ³•ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚

```ts
this.firestore.collection('tasks').doc(task.id).delete();
```

å‹•ä½œä¾‹ã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gfu4ohsss6g30je0ehtho.gif)

é ‘å¼µã£ã¦ã¿ã¦ãã ã•ã„ï¼

> ç­†è€…ã®å›ç­”ä¾‹ãŒ [ã“ã¡ã‚‰](https://github.com/ttskch/angular-todo/commit/cc6bec2d475ddb7cb329520cfb41c4634eda4435) ã«ã‚ã‚Šã¾ã™ã€‚ãœã²ã€ã¾ãšã¯è‡ªåŠ›ã§é ‘å¼µã£ã¦ã¿ãŸä¸Šã§ã€ç­”ãˆåˆã‚ã›ã‚’ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

# ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼

ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãŒå½¹ã«ç«‹ã£ãŸã¨æ€ã£ã¦ã„ãŸã ã‘ãŸæ–¹ã¯ã€[ã“ã¡ã‚‰ã®ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸](https://zenn.dev/ttskch/books/84c7a272deb3845e8085) ã‚’SNSç­‰ã§ã‚·ã‚§ã‚¢ã—ã¦ã„ãŸã ã‘ã‚‹ã¨ã¨ã¦ã‚‚å¬‰ã—ã„ã§ã™ï¼ğŸ˜†
