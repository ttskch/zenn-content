---
title: "URIãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒã¤Collection Getã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¨±å®¹ã™ã‚‹"
---

# ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§APIã®ä»•æ§˜ã‚’å¤‰æ›´ã™ã‚‹

ç¾çŠ¶ã€ã‚³ãƒ¡ãƒ³ãƒˆã®ä¸€è¦§å–å¾—APIã¯ã€`GET /api/v1/comments` ã¨ã„ã†ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚ˆã£ã¦ **ç´ã¥ã„ã¦ã„ã‚‹æŠ•ç¨¿ã¨ã¯ç„¡é–¢ä¿‚ã«** ã™ã¹ã¦ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—ã™ã‚‹ä»•æ§˜ã«ãªã£ã¦ã„ã¾ã™ã€‚

ä»Šæ›´ã§ã™ãŒã€ã“ã®ä»•æ§˜ã¯è‡ªç„¶ã§ã¯ãªã„ã®ã§ã€`GET /api/v1/posts/{id}/comments` ã¨ã„ã†ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚ˆã£ã¦ **æŒ‡å®šã—ãŸæŠ•ç¨¿ã®é…ä¸‹ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¸€è¦§ã§å–å¾—ã™ã‚‹** ã‚ˆã†ãªä»•æ§˜ã«å¤‰æ›´ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

ã¾ãšã€ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®šç¾©ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã—ã‚‡ã†ã€‚

```diff:config/packages/api_platform/Comment.yaml
    collectionOperations:
-     get: ~
+     get:
+       path: /posts/{id}/comments
```

æ¬¡ã«ã€Data Providerã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚URIã® `{id}` ç®‡æ‰€ã‚’æŠ•ç¨¿IDã¨è¦‹ãªã—ã¦ã€ãã®æŠ•ç¨¿ã«ç´ã¥ãã‚³ãƒ¡ãƒ³ãƒˆã ã‘ã‚’å–å¾—ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£ã—ã¦ã„ã¾ã™ã€‚

```diff
  <?php

  declare(strict_types=1);

  namespace App\DataProvider\Comment;

  use ApiPlatform\Core\DataProvider\ContextAwareCollectionDataProviderInterface;
  use ApiPlatform\Core\DataProvider\RestrictedDataProviderInterface;
  use App\DataProvider\AbstractCollectionDataProvider;
  use App\Entity\Comment;
  use App\Repository\CommentRepository;
+ use Symfony\Component\HttpKernel\Exception\NotFoundHttpException;

  /**
   * @extends AbstractCollectionDataProvider<Comment>
   */
  final class CollectionDataProvider extends AbstractCollectionDataProvider implements ContextAwareCollectionDataProviderInterface,   RestrictedDataProviderInterface
  {
      public function __construct(private CommentRepository $commentRepository)
      {
      }

      public function supports(string $resourceClass, string $operationName = null, array $context = []): bool
      {
          return Comment::class === $resourceClass;
      }

      /**
       * @return iterable<Comment>
       */
      public function getCollection(string $resourceClass, string $operationName = null, array $context = []): iterable
      {
+         if (!preg_match('#^/api/v1/posts/(\d+)/comments#', strval($context['request_uri']), $m)) {
+             throw new NotFoundHttpException();
+         }
+
+         $postId = intval($m[1]);
+
          $qb = $this->commentRepository->createQueryBuilder('co')
+             ->leftJoin('co.post', 'po')
+             ->andWhere('po.id = :postId')
              ->andWhere('co.isBanned = false')
+             ->setParameter('postId', $postId)
          ;

          return $this->getResult($qb, $resourceClass, $operationName, $context);
      }
  }
```

# URIãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒã¤Collection Getã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ããªã„å•é¡Œ

ã•ã¦ã€ã“ã®çŠ¶æ…‹ã§ `GET /api/v1/posts/1/comments` ã‚’å©ã„ã¦ã¿ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/51827e6cff2f-20220506.png)

å®Ÿã¯ã€API Platformã§ã¯ã€**URIãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒã¤Collection Getã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“**ğŸ˜“

[`ApiPlatform\Core\Bridge\Symfony\Routing\IriConverter` ã®ã“ã®ç®‡æ‰€](https://github.com/api-platform/core/blob/v2.6.8/src/Bridge/Symfony/Routing/IriConverter.php#L137) ã«ãŠã„ã¦ã€IRIã‚’ç”Ÿæˆã™ã‚‹éš›ã«ãƒ«ãƒ¼ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒ `[]` ã¨ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€URIãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒã¤Collection Getã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®šç¾©ã™ã‚‹ã¨ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¿ã‚¤ãƒ ã§ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã—ã¾ã†ã®ã§ã™ã€‚

æœ¬æ¥ã€ä»Šå›ã®ã‚ˆã†ãªã€ŒæŠ•ç¨¿ã«ç´ã¥ãã‚³ãƒ¡ãƒ³ãƒˆã€ã¨ã„ã£ãŸãƒªã‚½ãƒ¼ã‚¹ã®è¦ªå­é–¢ä¿‚ã‚’æ‰±ã†ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§ã¯ã€[Subresources](https://api-platform.com/docs/core/subresources/) ã¨ã„ã†æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®šç¾©ã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

ãŒã€å®Ÿéš›ã«ä½¿ã„è¾¼ã‚“ã§ã¿ã‚‹ã¨åˆ†ã‹ã‚Šã¾ã™ãŒã€Subresourcesã¯2022å¹´5æœˆæ™‚ç‚¹ã§ã¾ã ã¾ã ãƒã‚®ãƒ¼ãªã¨ã“ã‚ã‚‚å¤šãã€ä»•æ§˜çš„ã«ã‚‚ç—’ã„ã¨ã“ã‚ã«æ‰‹ãŒå±Šã‹ãšæ‰±ã„ã¥ã‚‰ã„ã‚‚ã®ã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€æ­£ç›´ãªã¨ã“ã‚ã‚ã¾ã‚Šä½¿ã„ãŸããªã„ã¨ã„ã†ã®ãŒç­†è€…ã®ç¾æ™‚ç‚¹ã®æ„Ÿæƒ³ã§ã™ã€‚

ã¾ãŸã€ãƒªã‚½ãƒ¼ã‚¹ã®è¦ªå­é–¢ä¿‚ã¨ã„ã†ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ä»¥å¤–ã§ã‚‚ã€URIãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒã¤Collection Getã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®šç¾©ã—ãŸããªã‚‹å ´é¢ã¯ååˆ†ã«ã‚ã‚Šå¾—ãã†ã§ã™ã€‚

ãªã®ã§ã€å¤šå°‘å¼·å¼•ãªæ–¹æ³•ã‚’ä½¿ã£ã¦ã§ã‚‚ã€URIãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒã¤Collection Getã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¨±å®¹ã§ãã‚‹ã‚ˆã†ã«ã—ãŸã„ã¨ã„ã†ãƒ‹ãƒ¼ã‚ºã¯å¤§ãã„ã¨è€ƒãˆã¾ã™ã€‚

# `IriConverter` ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¦å¼·å¼•ã«è¨±å®¹ã™ã‚‹

ã“ã®ã‚¨ãƒ©ãƒ¼ã¯ã€å•é¡Œã¨ãªã£ã¦ã„ã‚‹ `IriConverter` ã‚’æ‹¡å¼µã—ã¦ã€ç‰¹å®šã®ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¤ã„ã¦ã¯IRIã®ç”Ÿæˆæ™‚ã«æ‰‹å‹•ã§ãƒ«ãƒ¼ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆã™ã‚‹ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã‚’è¿½è¨˜ã™ã‚‹ã“ã¨ã§å›é¿ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

> `IriConverter` ã®æ‹¡å¼µã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®Stack Overflowã‚„GitHub Issueã«ã‚‚å¤šå°‘ã®å•ç­”ãŒè¦‹ã‚‰ã‚Œã¾ã—ãŸã€‚
>
> * [php - Custom collection operation and IRI conversion problem - Stack Overflow](https://stackoverflow.com/questions/58040770/custom-collection-operation-and-iri-conversion-problem)
> * [Custom IriConverter Â· Issue #250 Â· api-platform/api-platform](https://github.com/api-platform/api-platform/issues/250)

å…·ä½“çš„ã«ã¯ã€`OpenApiFactory` ã‚’æ‹¡å¼µã—ãŸã¨ãã¨åŒæ§˜ã«ã€Symfonyã® [ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚³ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½](https://symfony.com/doc/current/service_container/service_decoration.html) ã‚’ä½¿ã£ã¦ `ApiPlatform\Core\Bridge\Symfony\Routing\IriConverter` ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ç‹¬è‡ªã‚¯ãƒ©ã‚¹ã§ãƒ‡ã‚³ãƒ¬ãƒ¼ãƒˆã—ã¾ã™ã€‚

```php:src/ApiPlatform/IriConverter.php
<?php

declare(strict_types=1);

namespace App\ApiPlatform;

use ApiPlatform\Core\Api\IriConverterInterface;
use ApiPlatform\Core\Api\OperationType;
use ApiPlatform\Core\Api\UrlGeneratorInterface;
use ApiPlatform\Core\Bridge\Symfony\Routing\RouteNameResolverInterface;
use App\Entity\Comment;
use Symfony\Component\HttpFoundation\RequestStack;
use Symfony\Component\Routing\RouterInterface;

/**
 * @see \ApiPlatform\Core\Bridge\Symfony\Routing\IriConverter
 */
class IriConverter implements IriConverterInterface
{
    public function __construct(
        private \ApiPlatform\Core\Bridge\Symfony\Routing\IriConverter $decorated,
        private RouteNameResolverInterface $routeNameResolver,
        private RouterInterface $router,
        private RequestStack $requestStack,
    ) {
    }

    public function getItemFromIri(string $iri, array $context = []): object
    {
        return $this->decorated->getItemFromIri($iri, $context);
    }

    public function getIriFromItem($item, int $referenceType = UrlGeneratorInterface::ABS_PATH): string
    {
        return $this->decorated->getIriFromItem($item, $referenceType);
    }

    public function getIriFromResourceClass(string $resourceClass, int $referenceType = UrlGeneratorInterface::ABS_PATH): string
    {
        // customize this process to enable to declare Collection Get operations with URI parameters
        $iri = $this->getIriWithRouteParametersFromResourceClass($resourceClass, $referenceType);

        return $iri ?? $this->decorated->getIriFromResourceClass($resourceClass, $referenceType);
    }

    public function getItemIriFromResourceClass(string $resourceClass, array $identifiers, int $referenceType = UrlGeneratorInterface::ABS_PATH): string
    {
        return $this->decorated->getItemIriFromResourceClass($resourceClass, $identifiers, $referenceType);
    }

    public function getSubresourceIriFromResourceClass(string $resourceClass, array $identifiers, int $referenceType = UrlGeneratorInterface::ABS_PATH): string
    {
        return $this->decorated->getSubresourceIriFromResourceClass($resourceClass, $identifiers, $referenceType);
    }

    private function getIriWithRouteParametersFromResourceClass(string $resourceClass, int $referenceType = UrlGeneratorInterface::ABS_PATH): string|null
    {
        if (Comment::class === $resourceClass) {
            $requestUri = $this->requestStack->getCurrentRequest()?->getRequestUri() ?? '';
            preg_match('#^/api/v1/posts/(\d+)/comments#', $requestUri, $m);
            $postId = intval($m[1]);

            return $this->router->generate($this->routeNameResolver->getRouteName($resourceClass, OperationType::COLLECTION), [
                'id' => $postId,
            ], $referenceType);
        }

        return null;
    }
}
```

æ‹¡å¼µã—ã¦ã„ã‚‹ã®ã¯ä»Šå›ã‚¨ãƒ©ãƒ¼ç®‡æ‰€ã¨ãªã£ã¦ã„ã‚‹ `getIriFromResourceClass()` ãƒ¡ã‚½ãƒƒãƒ‰ã®ã¿ã§ã€ä»–ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã™ã¹ã¦å…ƒã‚¯ãƒ©ã‚¹ã®åŒãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã‚“ã§ã„ã‚‹ã ã‘ã§ã™ã€‚

`getIriFromResourceClass()` ãƒ¡ã‚½ãƒƒãƒ‰ã§ã®ã¿ã€å…ƒã‚¯ãƒ©ã‚¹ã®åŒãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã¶å‰ã«ã€`getIriWithRouteParametersFromResourceClass()` ã¨ã„ã†privateãƒ¡ã‚½ãƒƒãƒ‰ã§IRIã®ç”Ÿæˆã‚’è©¦ã¿ã‚‹ã‚ˆã†ã«ã—ã¦ãŠã‚Šã€`getIriWithRouteParametersFromResourceClass()` ãƒ¡ã‚½ãƒƒãƒ‰ã§ã¯ã€ç‰¹å®šã®ãƒªã‚½ãƒ¼ã‚¹ã«ãŠã„ã¦ã®ã¿ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆURIã‹ã‚‰ãƒ«ãƒ¼ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«è©²å½“ã™ã‚‹ç®‡æ‰€ã®æ–‡å­—åˆ—ã‚’æŠœãå‡ºã—ã€ã“ã‚Œã‚’ãƒ«ãƒ¼ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦æ‰‹å‹•ã§IRIã‚’ç”Ÿæˆã™ã‚‹ã¨ã„ã†å‡¦ç†ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

`getIriWithRouteParametersFromResourceClass()` ã‹ã‚‰ `null` ãŒè¿”ã•ã‚ŒãŸå ´åˆã¯å…ƒã‚¯ãƒ©ã‚¹ã®åŒãƒ¡ã‚½ãƒƒãƒ‰ãŒå˜ã«å‘¼ã°ã‚Œã‚‹ã®ã§ã€æŒ‡å®šã—ãŸãƒªã‚½ãƒ¼ã‚¹ä»¥å¤–ã®å ´åˆã«ã¯ã‚‚ã¨ã‚‚ã¨ã®æŒ™å‹•ã¨ãªã‚Šã€å®³ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

ä¸Šè¨˜ã®ã‚ˆã†ã«å®Ÿè£…ã—ãŸç‹¬è‡ªã‚µãƒ¼ãƒ“ã‚¹ã‚’ã€ä»¥ä¸‹ã®ã‚ˆã†ã« `config/services.yaml` ã§ `ApiPlatform\Core\Bridge\Symfony\Routing\IriConverter` ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã¨ã—ã¦ç™»éŒ²ã—ã¾ã™ã€‚

```yaml:config/services.yaml
services:

    # ...

    App\ApiPlatform\IriConverter:
        decorates: api_platform.iri_converter
        arguments:
            $routeNameResolver: '@api_platform.route_name_resolver'
```

ã“ã‚Œã§ã€ä¸‹å›³ã®ã¨ãŠã‚Šã€URIãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒã¤Collection Getã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå‹•ä½œã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸğŸ‘

![](https://storage.googleapis.com/zenn-user-upload/44ae276dbb24-20220506.png)

# API Docã«URIãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‡ºåŠ›ã™ã‚‹

å‰ç¯€ã¾ã§ã§ `GET /api/v1/posts/{id}/comments` ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‚ˆã†ã«ã¯ãªã‚Šã¾ã—ãŸãŒã€API Docã‚’ã‚ˆãè¦‹ã¦ã¿ã‚‹ã¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®é …ç›®ã« `page` ã¨ã„ã†ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã ã‘ã—ã‹å‡ºåŠ›ã•ã‚Œã¦ãŠã‚‰ãšã€å¿…é ˆã§ã‚ã‚‹ã¯ãšã®URIãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ `id` ãŒã‚ã‚Šã¾ã›ã‚“ã€‚

![](https://storage.googleapis.com/zenn-user-upload/f1434d5776fd-20220506.png)

ã“ã‚Œã«ã¤ã„ã¦ã‚‚ã€æ‰‹å‹•ã§API Docã«å‡ºåŠ›ã—ã¦ã‚ã’ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã‚Œã¾ã§ã«ä½•åº¦ã‹æ›¸ã„ã¦ããŸã‚ˆã†ã«ã€ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã® `openapi_context` ã§ [`parameter`](https://swagger.io/specification/#parameter-object) ã‚’æ˜ç¤ºçš„ã«å®šç¾©ã™ã‚‹ã“ã¨ã§å¯¾å¿œã—ã¾ã™ã€‚

å…·ä½“çš„ã«ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

```diff:config/packages/api_platform/Comment.yaml
  App\Entity\Comment:
    attributes:
      route_prefix: /v1

    collectionOperations:
      get:
        path: /posts/{id}/comments
+       openapi_context:
+         parameters:
+           - in: path
+             name: id
+             schema:
+               type: integer
+             required: true
+             description: æŠ•ç¨¿ID

      # ...
```

ã“ã‚Œã§ã€ä¸‹å›³ã®ã¨ãŠã‚ŠAPI Docã«URIãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå¿…é ˆã¨ã—ã¦å‡ºåŠ›ã•ã‚Œã¾ã—ãŸğŸ‘Œ

![](https://storage.googleapis.com/zenn-user-upload/e05a36fd166f-20220506.png)
