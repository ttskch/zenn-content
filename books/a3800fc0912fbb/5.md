---
title: "ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã¾ãŸã¯ç„¡åŠ¹åŒ–ã™ã‚‹"
---

# ç‹¬è‡ªã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹

API Platformã§ã¯

* Collectionã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  * get
  * post
* Itemã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  * get
  * put
  * patch
  * delete

ã®6ã¤ã®ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒ [ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å®šç¾©ã•ã‚Œã¦ã„ã¾ã™](https://api-platform.com/docs/core/operations/) ãŒã€ç‹¬è‡ªã«ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

ä¾‹ã¨ã—ã¦ã€æŒ‡å®šã—ãŸã‚³ãƒ¡ãƒ³ãƒˆã‚’BANã™ã‚‹ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ã¾ãšã¯ã€Item Banã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«å¯¾å¿œã™ã‚‹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```php:src/Controller/Comment/ItemBanController.php
<?php

declare(strict_types=1);

namespace App\Controller\Comment;

use App\Entity\Comment;
use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\HttpKernel\Attribute\AsController;

#[AsController]
class ItemBanController extends AbstractController
{
    public function __invoke(Comment $data): Comment
    {
        return $data->setIsBanned(true);
    }
}
```

æ¬¡ã«ã€`#[ApiResource]` ã‚¢ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ãƒˆã§

```diff
  #[ApiResource(
      collectionOperations: [
          'get',
          'post' => [
              'path' => '/posts/{id}/comments',
              'controller' => CollectionPostController::class,
          ],
      ],
+     itemOperations: [
+         'get',
+         'put',
+         'patch',
+         'delete',
+         'ban' => [
+             'method' => 'put',
+             'path' => '/comments/{id}/ban',
+             'controller' => ItemBanController::class,
+             'input' => false,
+         ],
+     ],
  )]
  class Comment
```

ã®ã‚ˆã†ã«ã—ã¦ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«åŠ ãˆã¦ `ban` ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®šç¾©ã—ã¾ã™ã€‚

`input` å±æ€§ã« `false` ã‚’ã‚»ãƒƒãƒˆã—ã¦ã„ã¾ã™ãŒã€ã“ã‚Œã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã§æ¸¡ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã—ã¦ãƒªã‚½ãƒ¼ã‚¹ã‚’ä¸Šæ›¸ãã™ã‚‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å‹•ä½œã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚

`ban` ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯PUTãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã¯ã„ã‚‹ã‚‚ã®ã®ã€é€šå¸¸ã®Item Putã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨é•ã£ã¦ãƒªã‚½ãƒ¼ã‚¹ã‚’ä»»æ„ã®å†…å®¹ã«æ›´æ–°ã™ã‚‹ãŸã‚ã®ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ãªãã€**ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®å†…å®¹ã«ã‹ã‹ã‚ã‚‰ãšå¸¸ã« `isBanned` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã« `true` ã‚’ã‚»ãƒƒãƒˆã™ã‚‹ã ã‘** ã®ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãªã®ã§ã€ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚’ç„¡åŠ¹åŒ–ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®ã‚ˆã†ã«ã€`input` å±æ€§ã‚’ `false` ã«ã™ã‚‹ã“ã¨ã§ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚’ã€ã¾ãŸ `output` å±æ€§ã‚’ `false` ã«ã™ã‚‹ã“ã¨ã§ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚’ã€ãã‚Œãã‚Œç„¡åŠ¹åŒ–ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚è©³ç´°ã¯

[API Platform: Using Data Transfer Objects (DTOs) `#disabling-the-input-or-the-output`](https://api-platform.com/docs/core/dto/#disabling-the-input-or-the-output)

ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

ã“ã‚Œã§ã€æŒ‡å®šã—ãŸã‚³ãƒ¡ãƒ³ãƒˆã® `isBanned` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ `true` ã«ã™ã‚‹ãŸã‚ã® `PUT /api/comments/{id}/ban` ã¨ã„ã†ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒã§ãã¾ã—ãŸã€‚å®Ÿéš›ã«å©ã„ã¦ã¿ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã« `isBanned` ã‚’ `true` ã«ã‚»ãƒƒãƒˆã§ãã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/b5cdccc6005b-20220506.png)

## Data Providerã‚’ä½œæˆã—ã¦ã¿ã‚‹

ç‹¬è‡ªã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’BANã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸãŒã€ç¾çŠ¶ã§ã¯ `GET /api/comments` ã§ã‚³ãƒ¡ãƒ³ãƒˆã®ä¸€è¦§ã‚’å–å¾—ã—ãŸéš›ã«ã€BANã•ã‚Œã¦ã„ã‚‹ã¯ãšã®ã‚³ãƒ¡ãƒ³ãƒˆã‚‚æ™®é€šã«å–å¾—ã§ãã¦ã—ã¾ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/dd58cbd20738-20220506.png)

ã“ã‚Œã¯æ„å›³ã¨ç•°ãªã‚‹ã®ã§ã€Data Providerã‚’è‡ªä½œã—ã¦ã€**BANã•ã‚Œã¦ã„ãªã„ã‚³ãƒ¡ãƒ³ãƒˆã ã‘ãŒå–å¾—ã•ã‚Œã‚‹ã‚ˆã†ã«** ä¿®æ­£ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

> å‚è€ƒã®ãŸã‚ã€å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒªãƒ³ã‚¯ã‚’å†æ²ã—ã¦ãŠãã¾ã™ã€‚
>
> [API Platform: Data Providers](https://api-platform.com/docs/core/data-providers/)

ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã™ã‚‹ã ã‘ã§ã€æ„å›³ã—ãŸã¨ãŠã‚Šã®å‹•ä½œã«ãªã‚‹ã¯ãšã§ã™ã€‚

```php:src/DataProvider/Comment/CollectionDataProvider.php
<?php

declare(strict_types=1);

namespace App\DataProvider\Comment;

use ApiPlatform\Core\DataProvider\ContextAwareCollectionDataProviderInterface;
use ApiPlatform\Core\DataProvider\RestrictedDataProviderInterface;
use App\Entity\Comment;
use App\Repository\CommentRepository;

final class CollectionDataProvider implements ContextAwareCollectionDataProviderInterface, RestrictedDataProviderInterface
{
    public function __construct(private CommentRepository $commentRepository)
    {
    }

    public function supports(string $resourceClass, string $operationName = null, array $context = []): bool
    {
        return Comment::class === $resourceClass;
    }

    /**
     * @return iterable<Comment>
     */
    public function getCollection(string $resourceClass, string $operationName = null, array $context = []): iterable
    {
        /** @var iterable<Comment> $comments */
        $comments = $this->commentRepository->findBy(['isBanned' => false]);

        return $comments;
    }
}
```

ã“ã®çŠ¶æ…‹ã§ `GET /api/comments` ã‚’å©ãã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã€BANã•ã‚Œã¦ã„ãªã„ã‚³ãƒ¡ãƒ³ãƒˆã ã‘ãŒå–å¾—ã•ã‚Œã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ğŸ‘

![](https://storage.googleapis.com/zenn-user-upload/233f427a4d28-20220506.png)

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹

å‰ç¯€ã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ä»–ã«ç‹¬è‡ªã®ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¾ã—ãŸãŒã€é€†ã«ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ã“ã¨ã‚‚ã‚‚ã¡ã‚ã‚“ã§ãã¾ã™ã€‚

å…ˆã«å°‘ã—è§¦ã‚ŒãŸã¨ãŠã‚Šã€`#[ApiResource]` ã‚¢ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ãƒˆã® `collectionOperations` ãŠã‚ˆã³ `itemOperations` ã‚’æ˜ç¤ºçš„ã«å®£è¨€ã—ãŸå ´åˆã€ãã®ä¸­ã«å€‹åˆ¥ã«æ˜è¨˜ã•ã‚Œãªã‹ã£ãŸã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¾ã™ã€‚

ä¾‹ã¨ã—ã¦ã€ã‚³ãƒ¡ãƒ³ãƒˆã®ç·¨é›†ãƒ»å‰Šé™¤ã¯ä¸€åˆ‡ã§ããªã„ã‚ˆã†ã«ã€Item Putã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€Item Patchã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€Item Deleteã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ã“ã®å ´åˆã€å˜ã«ä»¥ä¸‹ã®ã‚ˆã†ã« `'put'` `'patch'` `'delete'` ã‚’ `itemOperations` é…åˆ—ã‹ã‚‰å‰Šé™¤ã—ã¦ã—ã¾ãˆã°OKã§ã™ã€‚

```diff
  #[ApiResource(
      collectionOperations: [
          'get',
          'post' => [
              'path' => '/posts/{id}/comments',
              'controller' => CollectionPostController::class,
          ],
      ],
      itemOperations: [
          'get',
-         'put',
-         'patch',
-         'delete',
          'ban' => [
              'method' => 'put',
              'path' => '/comments/{id}/ban',
              'controller' => ItemBanController::class,
              'input' => false,
          ],
      ],
  )]
  class Comment
```

ã“ã‚Œã§ã€ä¸‹å›³ã®ã¨ãŠã‚Š3ã¤ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/f797e36f17c7-20220506.png)

## Item Getã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹

ã•ã‚‰ã«ã€ä¾‹ã¨ã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆã®Item Getã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚ç„¡åŠ¹åŒ–ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

ãŒã€Item Getã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹å ´åˆã®ã¿ã€ç‰¹åˆ¥ãªæ³¨æ„ãŒå¿…è¦ã§ã™ã€‚

å…ˆã»ã©ã¨åŒã˜è¦é ˜ã§

```diff
  #[ApiResource(
      collectionOperations: [
          'get',
          'post' => [
              'path' => '/posts/{id}/comments',
              'controller' => CollectionPostController::class,
          ],
      ],
      itemOperations: [
-         'get',
          'ban' => [
              'method' => 'put',
              'path' => '/comments/{id}/ban',
              'controller' => ItemBanController::class,
              'input' => false,
          ],
      ],
  )]
  class Comment
```

ã®ã‚ˆã†ã«å®šç¾©ã—ã¦Item Getã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¾ã§ç„¡åŠ¹ã«ã—ã¦ã—ã¾ã†ã¨ã€**å®Ÿã¯ã€API Platformã¯æ­£å¸¸ã«å‹•ä½œã§ããªããªã£ã¦ã—ã¾ã„ã¾ã™ã€‚**

å®Ÿéš›ã€ä¸Šè¨˜ã®çŠ¶æ…‹ã§ `GET /api/comments/1` ãªã©ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦ã¿ã‚‹ã¨ã€ID 1ã®ã‚³ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ã¦ã„ã¦ã‚‚404ã«ãªã‚Šã€æ„å›³ã©ãŠã‚Šç„¡åŠ¹åŒ–ã§ãã¦ã„ã‚‹ã‚ˆã†ã«æ€ã‚ã‚Œã¾ã™ã€‚

ã—ã‹ã—ã€ã“ã®çŠ¶æ…‹ã ã¨API Platformã¯ **`Comment` ãƒªã‚½ãƒ¼ã‚¹ã®IRIã‚’ç”Ÿæˆã§ããªããªã£ã¦ã—ã¾ã„ã€ä¾‹ãˆã°ä¸€è¦‹ç„¡é–¢ä¿‚ã«è¦‹ãˆã‚‹ `POST /api/posts/1/comments` ãªã©ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ãŸéš›ã«

```
"No item route associated with the type \"App\\Entity\\Comment\"."
```

ã¨ã„ã£ãŸã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã—ã¾ã„ã¾ã™ã€‚

ã“ã‚Œã«ã¤ã„ã¦ã¯ã€[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã“ã®éƒ¨åˆ†](https://api-platform.com/docs/core/operations/#:~:text=if%20you%20do%20not%20want%20to%20allow%20access%20to%20the%20resource%20item%20(i.e.%20you%20don't%20want%20a%20get%20item%20operation)%2C%20instead%20of%20omitting%20it%20altogether%2C%20you%20should%20instead%20declare%20a%20get%20item%20operation%20which%20returns%20http%20404%20(not%20found)%2C%20so%20that%20the%20resource%20item%20can%20still%20be%20identified%20by%20an%20iri.%20for%20example%3A) ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã¨ãŠã‚Šã€ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã™ã‚‹ã®ãŒæ­£ã—ã„æ‰‹é †ã¨ãªã‚Šã¾ã™ã€‚

```diff
  #[ApiResource(
      collectionOperations: [
          'get',
          'post' => [
              'path' => '/posts/{id}/comments',
              'controller' => CollectionPostController::class,
          ],
      ],
      itemOperations: [
-         'get',
+         'get' => [
+             'controller' => NotFoundAction::class,
+             'read' => false,
+             'output' => false,
+         ],
          'ban' => [
              'method' => 'put',
              'path' => '/comments/{id}/ban',
              'controller' => ItemBanController::class,
              'input' => false,
          ],
      ],
  )]
  class Comment
```

404ã‚’è¿”ã™ `NotFoundAction` ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã‚’æŒ‡å®šã—ã€[`read` å±æ€§](https://api-platform.com/docs/core/events/#:~:text=Description-,read,Enables%20or%20disables%20ReadListener,-deserialize) ã¨ [`output` å±æ€§](https://api-platform.com/docs/core/dto/#disabling-the-input-or-the-output) ã‚’ `false` ã«ã™ã‚‹ã“ã¨ã§ä¸€åˆ‡ã®å†…éƒ¨å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œãªã„ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

ã“ã†ã™ã‚‹ã“ã¨ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯Item Getã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ãªã„ã‚ˆã†ã«è¦‹ã›ã¤ã¤ã€å†…éƒ¨çš„ã«ã¯å­˜åœ¨ã—ã¦ã„ã¦IRIã‚’æ­£å¸¸ã«ç”Ÿæˆã§ãã‚‹çŠ¶æ…‹ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

> ãªãŠã€[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã“ã®éƒ¨åˆ†](https://api-platform.com/docs/core/operations/#:~:text=Description-,GET,list%20of%20elements,-POST) ã‚’è¦‹ã‚‹ã¨ã€Collection Getã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚ã€Œå¿…é ˆã€ã¨ãªã£ã¦ã„ã¾ã™ãŒã€å®Ÿè³ªçš„ã«ã¯ã€Collection Getã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ç‰©ç†çš„ã«ç„¡åŠ¹åŒ–ã—ã¦ã—ã¾ã£ã¦ã‚‚ç‰¹ã«æœ‰å®³ãªå‰¯ä½œç”¨ã¯ãªã•ãã†ã«æ€ã‚ã‚Œã¾ã™ã€‚

## Item Getã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’API Docã‹ã‚‰ã‚‚å‰Šé™¤ã™ã‚‹

å‰é …ã®æ–¹æ³•ã§ç„¡äº‹ã«ã‚³ãƒ¡ãƒ³ãƒˆã®Item Getã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹åŒ–ã§ããŸã®ã§ã™ãŒã€å®Ÿã¯ã€ã“ã®çŠ¶æ…‹ã ã¨API Docã«ã¯ã‚³ãƒ¡ãƒ³ãƒˆã®Item Getã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ™®é€šã«è¨˜è¼‰ã•ã‚ŒãŸã¾ã¾ã«ãªã£ã¦ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/f797e36f17c7-20220506.png)

API Docã®å‡ºåŠ›ã¨APIè‡ªä½“ã®æŒ™å‹•ã¯ã¾ã£ãŸãåˆ¥ç‰©ãªã®ã§ã€ã“ã®ã¾ã¾ã§ã‚‚ã‚¢ãƒ—ãƒªã®å‹•ä½œã«å•é¡ŒãŒã‚ã‚‹ã‚ã‘ã§ã¯ãªã„ã®ã§ã™ãŒã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®é–‹ç™ºè€…ãŒAPI Docã‚’å‚è€ƒã«ã—ã¦ã„ãŸã‚Šã€[openapi-generator](https://github.com/OpenAPITools/openapi-generator) ã‚„ [openapi2aspida](https://github.com/aspida/openapi2aspida) ãªã©ã‚’ä½¿ã£ã¦API Docã‹ã‚‰è‡ªå‹•ã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦ã„ãŸã‚Šã™ã‚‹å ´åˆã«ã¯ã€API Docã®å†…å®¹ãŒå®Ÿè£…ã«å³ã—ãŸã‚‚ã®ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã¯ã¨ã¦ã‚‚é‡è¦ã§ã™ã€‚

API Platformã§ã¯ã€ç‰©ç†çš„ã«ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ãªã„ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’API Docã‹ã‚‰å‰Šé™¤ã™ã‚‹ã‚ˆã†ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯æ®‹å¿µãªãŒã‚‰å…¬å¼ã«ã¯ç”¨æ„ã•ã‚Œã¦ãŠã‚‰ãšã€`ApiPlatform\Core\OpenApi\Factory\OpenApiFactory` ã¨ã„ã†ã‚µãƒ¼ãƒ“ã‚¹ã‚’ç‹¬è‡ªã«æ‹¡å¼µã™ã‚‹ã—ã‹ã‚ã‚Šã¾ã›ã‚“ã€‚

`OpenApiFactory` ã‚’æ‹¡å¼µã™ã‚‹æ–¹æ³•ã¯

[API Platform: OpenAPI Specification Support (formerly Swagger) `#overriding-the-openapi-specification`](https://api-platform.com/docs/core/openapi/#overriding-the-openapi-specification)

ã«æ‰‹å¼•ããŒè¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

> ã¾ãŸã€[Stack Overflowã«ã‚‚åŒæ§˜ã®æ‰‹æ®µã‚’ç¤ºã™å•ç­”ãŒã‚ã‚Šã¾ã—ãŸã€‚](https://stackoverflow.com/questions/54111661/how-to-hide-a-route-from-api-platform-documentation)

å…·ä½“çš„ã«ã¯ã€Symfonyã® [ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚³ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½](https://symfony.com/doc/current/service_container/service_decoration.html) ã‚’ä½¿ã£ã¦ `ApiPlatform\Core\OpenApi\Factory\OpenApiFactory` ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ç‹¬è‡ªã‚¯ãƒ©ã‚¹ã§ãƒ‡ã‚³ãƒ¬ãƒ¼ãƒˆã—ã¾ã™ã€‚

å…ƒã®å‡¦ç†ã«åŠ ãˆã¦ã€ã€Œ`openapi_context` ã® `description` ã« `'#hidden'` ã¨ã„ã†æ–‡å­—åˆ—ã‚’å«ã‚€ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¤ã„ã¦ã¯API Docã‹ã‚‰å‰Šé™¤ã™ã‚‹ã€ã¨ã„ã†å‡¦ç†ã‚’ä»˜ã‘è¶³ã—ã¦ã„ã¾ã™ã€‚

```php:src/ApiPlatform/OpenApiFactory.php
<?php

declare(strict_types=1);

namespace App\ApiPlatform;

use ApiPlatform\Core\OpenApi\Factory\OpenApiFactoryInterface;
use ApiPlatform\Core\OpenApi\Model\PathItem;
use ApiPlatform\Core\OpenApi\OpenApi;

class OpenApiFactory implements OpenApiFactoryInterface
{
    public function __construct(private OpenApiFactoryInterface $decorated)
    {
    }

    public function __invoke(array $context = []): OpenApi
    {
        $openApi = $this->decorated->__invoke($context);

        /**
         * @var string   $path
         * @var PathItem $pathItem
         */
        foreach ($openApi->getPaths()->getPaths() as $path => $pathItem) {
            // hide operations which include "#hidden" in description from API Doc
            if ($pathItem->getGet() && preg_match('/#hidden/', $pathItem->getGet()->getDescription())) {
                $openApi->getPaths()->addPath($path, $pathItem->withGet(null));
            }
        }

        return $openApi;
    }
}
```

`openapi_context` ã¯ã€ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ãƒªã‚½ãƒ¼ã‚¹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã”ã¨ã« [OpenAPI](https://swagger.io/specification/) ã®å®šç¾©ã‚’æ‰‹å‹•ã§è¨­å®šã™ã‚‹ãŸã‚ã®å±æ€§ã§ã™ã€‚

ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã‚ã‚ã›ã¦å‚ç…§ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

[API Platform: OpenAPI Specification Support (formerly Swagger) `#using-the-openapi-and-swagger-contexts`](https://api-platform.com/docs/core/openapi/#using-the-openapi-and-swagger-contexts)

ã•ã¦ã€ä¸Šè¨˜ã®ã‚ˆã†ã«å®Ÿè£…ã—ãŸç‹¬è‡ªã‚µãƒ¼ãƒ“ã‚¹ã‚’ã€ä»¥ä¸‹ã®ã‚ˆã†ã« `config/services.yaml` ã§ `ApiPlatform\Core\OpenApi\Factory\OpenApiFactory` ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã¨ã—ã¦ç™»éŒ²ã—ã¾ã™ã€‚

```yaml:config/services.yaml
services:

    # ...

    App\ApiPlatform\OpenApiFactory:
        decorates: api_platform.openapi.factory
        autoconfigure: false
```

æœ€å¾Œã«ã€`Comment` ã‚¯ãƒ©ã‚¹ã® `#[ApiResource]` ã‚¢ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ãƒˆã«ä»¥ä¸‹ã®ã‚ˆã†ã« `openapi_context.description` ã« `'#hidden'` ã¨ã„ã†æ–‡å­—åˆ—ã‚’ã‚»ãƒƒãƒˆã™ã‚Œã°å®Œäº†ã§ã™ã€‚

```diff
  #[ApiResource(
      collectionOperations: [
          'get',
          'post' => [
              'path' => '/posts/{id}/comments',
              'controller' => CollectionPostController::class,
          ],
      ],
      itemOperations: [
          'get' => [
              'controller' => NotFoundAction::class,
              'read' => false,
              'output' => false,
+             'openapi_context' => [
+                 'description' => '#hidden',
+             ],
          ],
          'ban' => [
              'method' => 'put',
              'path' => '/comments/{id}/ban',
              'controller' => ItemBanController::class,
              'input' => false,
          ],
      ],
  )]
  class Comment
```

ã“ã‚Œã§ã€ä¸‹å›³ã®ã¨ãŠã‚Šã€ã‚³ãƒ¡ãƒ³ãƒˆã®Item Getã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒAPI Docã‹ã‚‰å‰Šé™¤ã•ã‚Œã¾ã—ãŸğŸ‘

![](https://storage.googleapis.com/zenn-user-upload/ad2ada661efa-20220506.png)
