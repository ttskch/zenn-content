---
title: "idãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãªã„Itemã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹"
---

# idãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãªã„Itemã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå‹•ä½œã—ãªã„å•é¡Œ

å”çªã§ã™ãŒã€ã“ã“ã§æ–°ãŸã«æ©Ÿèƒ½ã‚’2ã¤è¿½åŠ ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

ç¾çŠ¶ã€æŠ•ç¨¿ã®Item Get/Item Putã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ã®è¨­å®šãªã®ã§ã€`GET /api/v1/posts/{id}` `PUT /api/v1/posts/{id}` ã¨ã„ã†å®šç¾©ã«ãªã£ã¦ã„ã¾ã™ã€‚

ã“ã‚Œã‚’ã€`GET /api/v1/posts/latest` `PUT /api/v1/posts/latest` ã¨ã„ã†ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã€ã€Œæœ€ã‚‚ç›´è¿‘ã«ä½œæˆã•ã‚ŒãŸæŠ•ç¨¿1ä»¶ã€ã‚’å–å¾—ãƒ»æ›´æ–°ã§ãã‚‹ã¨ã„ã†ä»•æ§˜ã«å¤‰æ›´ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

> ã‚„ã‚„å¾®å¦™ãªä¾‹ã§ã™ãŒã€æœ¬æ¥ã¯ã€idãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãªã„Itemã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦ã¯ã€ã€Œãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰€æœ‰ã—ã¦ã„ã‚‹å”¯ä¸€ã®ãƒªã‚½ãƒ¼ã‚¹ï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãªã©ï¼‰ã‚’å–å¾—ãƒ»æ›´æ–°ã™ã‚‹ã€ã¨ã„ã£ãŸã‚‚ã®ãŒæƒ³å®šã•ã‚Œã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

ã¾ãšã¯ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®šç¾©ã‚’ä¿®æ­£ã—ã¾ã™ã€‚

```diff:config/packages/api_platform/Post.yaml
  App\Entity\Post:
    attributes:
      route_prefix: /v1
+
+   itemOperations:
+     latest:
+       method: get
+       path: /posts/latest
+     putLatest:
+       method: put
+       path: /posts/latest
+     patch: ~
+     delete: ~
```

Item Getã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® `get` ã§ã¯ãªã `latest` ã¨ã„ã†ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åã«å¤‰æ›´ã€Item Putã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚åŒæ§˜ã« `putLatest` ã¨ã„ã†ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åã«å¤‰æ›´ã—ã€`patch` `delete` ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¤ã„ã¦ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å®šç¾©ã®ã¾ã¾æ®‹ã—ã¦ã„ã¾ã™ã€‚

æ¬¡ã«ã€å¯¾å¿œã™ã‚‹Data Providerã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚

> å‚è€ƒã®ãŸã‚ã€å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒªãƒ³ã‚¯ã‚’å†æ²ã—ã¦ãŠãã¾ã™ã€‚
>
> [API Platform: Data Providers `#custom-item-data-provider`](https://api-platform.com/docs/core/data-providers/#custom-item-data-provider)

```php:src/DataProvider/Post/ItemDataProvider.php
<?php

declare(strict_types=1);

namespace App\DataProvider\Post;

use ApiPlatform\Core\DataProvider\ItemDataProviderInterface;
use ApiPlatform\Core\DataProvider\RestrictedDataProviderInterface;
use App\Entity\Post;
use App\Repository\PostRepository;

final class ItemDataProvider implements ItemDataProviderInterface, RestrictedDataProviderInterface
{
    public function __construct(private PostRepository $postRepository)
    {
    }

    public function supports(string $resourceClass, string $operationName = null, array $context = []): bool
    {
        return Post::class === $resourceClass;
    }

    public function getItem(string $resourceClass, $id, string $operationName = null, array $context = []): ?Post
    {
        if ('latest' === $operationName || 'putLatest' === $operationName) {
            /** @var Post|null $post */
            $post = $this->postRepository->findOneBy([], ['id' => 'DESC']);

            return $post;
        }

        /** @var Post|null $post */
        $post = $this->postRepository->find(strval($id));

        return $post;
    }
}
```

ã“ã®ã‚ˆã†ãªå†…å®¹ã§å•é¡Œãªã•ãã†ã§ã—ã‚‡ã†ã€‚

ã€Œç›´è¿‘ã®1ä»¶ã€ã‚’è¡¨ã™æ¡ä»¶ã¨ã—ã¦ã€ŒidãŒæœ€å¤§ã®ã‚‚ã®ã€ã¨ã„ã†å®Ÿè£…ã‚’ã—ã¦ã„ã¾ã™ãŒã€æœ¬æ¥ã§ã‚ã‚Œã° [gedmo/doctrine-extensions](https://github.com/doctrine-extensions/DoctrineExtensions) ç­‰ã‚’å°å…¥ã—ã¦ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’Timestampableã«ã—ã€`createdAt` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’åŸºæº–ã«ã™ã‚‹ã»ã†ãŒã‚‚ã¡ã‚ã‚“æœ›ã¾ã—ã„ã§ã™ã€‚ä»Šå›ã¯ç°¡å˜ã®ãŸã‚ã“ã®ã‚ˆã†ãªå®Ÿè£…ã¨ã—ã¦ã„ã¾ã™ã€‚

> ã¾ãŸã€ã“ã‚Œã¯Collection Data Providerã§ã¯ãªãItem Data Providerãªã®ã§ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãªã©ã® `CollectionExtension` ã®é©ç”¨ã«ã¤ã„ã¦ã¯è€ƒãˆã‚‹å¿…è¦ãŒãªã„ç‚¹ã«ã‚‚ç•™æ„ã—ã¦ãã ã•ã„ã€‚

ã•ã¦ã€ã“ã‚Œã§å®Ÿè£…ã¨ã—ã¦ã¯å®Œæˆã—ãŸã‚ˆã†ã«æ€ã‚ã‚Œã¾ã™ãŒã€å®Ÿã¯ã“ã®çŠ¶æ…‹ã§å®Ÿéš›ã« `GET /api/v1/posts/latest` ã‚’å©ã„ã¦ã¿ã‚‹ã¨ã€ä¸‹å›³ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ã¨ãªã‚Šã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/3d4b51c14d7f-20220506.png)

ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã«ã‚ˆã‚‹ã¨ã€[`ReadListener` ã®ã“ã®ç®‡æ‰€](https://github.com/api-platform/core/blob/v2.6.8/src/EventListener/ReadListener.php#L112) ã§ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã„ã¾ã™ã€‚

ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚€é™ã‚Šã€**Itemã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã„ã¦ã¯ã€ãƒªã‚½ãƒ¼ã‚¹ã‚’ç‰¹å®šã§ãã‚‹identifierã¨å‘¼ã°ã‚Œã‚‹å€¤ã‚’URIãƒ‘ã‚¹ã¾ãŸã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã§å¿…ãšå—ã‘å–ã‚‰ãªã‘ã‚Œã°ãªã‚‰ãªã„ä»•æ§˜** ã«ãªã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

ã—ã‹ã—ã€ãã†ã¯è¨€ã£ã¦ã‚‚ã€ä»Šå›ã®ä¾‹ã®ã‚ˆã†ã«idãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å¿…è¦ã¨ã—ãªã„Itemã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ãŸã„ã‚±ãƒ¼ã‚¹ã¯å¤šåˆ†ã«è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚

ãã“ã§ã€å›é¿ç­–ã‚’è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚

# å›é¿ç­–1ï¼ˆãŠã™ã™ã‚ï¼‰

ç‡ç›´ã«è€ƒãˆã‚‹ã¨ã€ã‚¨ãƒ©ãƒ¼ç®‡æ‰€ãŒ `ReadListener` å†…ãªã®ã§ã€[`read: false`](https://api-platform.com/docs/core/events/#:~:text=Description-,read,Enables%20or%20disables%20ReadListener,-deserialize) ã‚’è¨­å®šã—ã¦ `ReadListener` è‡ªä½“ãŒå‘¼ã°ã‚Œãªã„ã‚ˆã†ã«ã™ã‚Œã°ã‚ˆã•ãã†ã§ã™ã€‚

ãŸã ã—ã€`ReadListener` ãŒå‘¼ã°ã‚Œãªã„ã¨Data Providerã‚‚å‘¼ã°ã‚Œãªã„ã®ã§ã€ã“ã®å ´åˆã¯ãƒªã‚½ãƒ¼ã‚¹ã®å–å¾—ã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã§è¡Œã†å¿…è¦ãŒã‚ã‚‹ã§ã—ã‚‡ã†ã€‚

ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```diff:config/packages/api_platform/Post.yaml
  App\Entity\Post:
    attributes:
      route_prefix: /v1

    itemOperations:
      latest:
        method: get
        path: /posts/latest
+       controller: App\Controller\Post\ItemLatestController
+       read: false
      putLatest:
        method: put
        path: /posts/latest
+       controller: App\Controller\Post\ItemPutLatestController
+       read: false
      patch: ~
      delete: ~
```

```php:src/Controller/Post/ItemLatestController.php
<?php

declare(strict_types=1);

namespace App\Controller\Post;

use App\Entity\Post;
use App\Repository\PostRepository;
use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\HttpKernel\Attribute\AsController;

#[AsController]
class ItemLatestController extends AbstractController
{
    public function __construct(private PostRepository $postRepository)
    {
    }

    public function __invoke(): ?Post
    {
        /** @var Post|null $post */
        $post = $this->postRepository->findOneBy([], ['id' => 'DESC']);

        return $post;
    }
}
```

```php:src/Controller/Post/ItemPutLatestController.php
<?php

declare(strict_types=1);

namespace App\Controller\Post;

use App\Entity\Post;
use App\Repository\PostRepository;
use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\HttpKernel\Attribute\AsController;

#[AsController]
class ItemPutLatestController extends AbstractController
{
    public function __construct(private PostRepository $postRepository)
    {
    }

    public function __invoke(Post $data): ?Post
    {
        /** @var Post|null $post */
        $post = $this->postRepository->findOneBy([], ['id' => 'DESC']);

        return $post ? $post->setTitle($data->getTitle())->setBody($data->getBody()) : null;
    }
}
```

ã“ã®çŠ¶æ…‹ã§æ”¹ã‚ã¦ `GET /api/v1/posts/latest` `PUT /api/v1/posts/latest` ã‚’å©ã„ã¦ã¿ã‚‹ã¨ã€æœŸå¾…ã©ãŠã‚Šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªããªã‚Šã¾ã—ãŸï¼ğŸ™Œ

![](https://storage.googleapis.com/zenn-user-upload/6d2b4e6007ef-20220506.png)

![](https://storage.googleapis.com/zenn-user-upload/51ec949b204a-20220506.png)

ã¡ãªã¿ã«ã€idãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚‚ãªã **ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚‚å¿…è¦ã¨ã—ãªã„** Item Putã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã„ã†ã®ã‚‚è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚ï¼ˆä¾‹ãˆã°ã€ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚ã‚’æ›´æ–°ã™ã‚‹APIãªã©ï¼‰

ã“ã®ã‚ˆã†ãªã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¤ã„ã¦ã¯ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’BANã™ã‚‹ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã—ãŸéš›ã«èª¬æ˜ã—ãŸã¨ãŠã‚Šã€[`input: false`](https://api-platform.com/docs/core/dto/#disabling-the-input-or-the-output) ã‚’è¿½è¨˜ã—ã¦ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚’ç„¡åŠ¹åŒ–ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§è¦æ³¨æ„ã§ã™ã€‚

# å›é¿ç­–2ï¼ˆã‚„ã‚„å¼·å¼•ãªåˆ¥è§£ï¼‰

è›‡è¶³ã§ã¯ã‚ã‚Šã¾ã™ãŒã€ç­†è€…ãŒè©¦è¡ŒéŒ¯èª¤ã®ä¸­ã§è¦‹ã¤ã‘ãŸã‚‚ã†1ã¤ã®ã‚„ã‚„å¼·å¼•ãªåˆ¥è§£ã‚’ã”ç´¹ä»‹ã—ã¦ãŠããŸã„ã¨æ€ã„ã¾ã™ã€‚

å‰ç¯€ã§ç´¹ä»‹ã—ãŸå›é¿ç­–ã¯ã€

* `read: false` ã«ã‚ˆã£ã¦ `ReadListener` ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹
* ãã®ä¸Šã§ã€ãƒªã‚½ãƒ¼ã‚¹ã®å–å¾—ã‚’è¡Œã†ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã‚’ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã”ã¨ã«ä½œæˆã™ã‚‹

ã¨ã„ã†ã‚‚ã®ã§ã—ãŸã€‚

ã—ã‹ã—ã€**ãã‚‚ãã‚‚idãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå­˜åœ¨ã•ãˆã—ã¦ã„ã‚Œã°ï¼ˆãã‚ŒãŒä¾‹ãˆç„¡æ„å‘³ãªå€¤ã ã£ãŸã¨ã—ã¦ã‚‚ï¼‰ä¸Šè¨˜ã®å¯¾å¿œã¯ã„ãšã‚Œã‚‚å¿…è¦ãªããªã‚Šã¾ã™ã€‚**

ãã“ã§ã€[`PRE_READ`](https://api-platform.com/docs/core/events/#:~:text=Priority-,PRE_READ,5,-POST_READ) ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã« `id=0` ã¨ã„ã†ç„¡å®³ãªidãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä»˜åŠ ã™ã‚‹ã“ã¨ã§ã€`ReadListener` ãŒã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãšã«å‡¦ç†ãŒç¶šè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ã€ã¨ã„ã†ã‚„ã‚„å¼·å¼•ãªå¯¾å‡¦ã‚‚è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚

å…·ä½“çš„ã«ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªEventSubscriberã‚’å®Ÿè£…ã™ã‚Œã°ã‚ˆã„ã§ã—ã‚‡ã†ã€‚

```php:src/ApiPlatform/EventSubscriber.php
<?php

declare(strict_types=1);

namespace App\ApiPlatform;

use ApiPlatform\Core\DataProvider\OperationDataProviderTrait;
use ApiPlatform\Core\EventListener\EventPriorities;
use ApiPlatform\Core\EventListener\ReadListener;
use Symfony\Component\EventDispatcher\EventSubscriberInterface;
use Symfony\Component\HttpKernel\Event\RequestEvent;
use Symfony\Component\HttpKernel\KernelEvents;

class EventSubscriber implements EventSubscriberInterface
{
    public static function getSubscribedEvents(): array
    {
        return [
            KernelEvents::REQUEST => ['onPreRead', EventPriorities::PRE_READ],
        ];
    }

    /**
     * @see ReadListener::onKernelRequest()
     * @see OperationDataProviderTrait::extractIdentifiers()
     */
    public function onPreRead(RequestEvent $event): void
    {
        $request = $event->getRequest();
        $parameters = $request->attributes;

        // @see https://github.com/api-platform/api-platform/issues/702#issuecomment-474889155
        if (!$parameters->get('id')) {
            $parameters->set('id', 0);
        }
    }
}
```

ã“ã®å ´åˆã€æœ€åˆã«å®Ÿè£…ã—ãŸ `App\DataProvider\Post\ItemDataProvider` ãŒå¼•ãç¶šãå­˜åœ¨ã—ã¦ã„ã‚Œã°ã€ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®šç¾©ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¦ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤ã—ã¦ã—ã¾ã£ã¦ã‚‚ã€æœŸå¾…ã©ãŠã‚Šã«å‹•ä½œã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```diff:config/packages/api_platform/Post.yaml
  App\Entity\Post:
    attributes:
      route_prefix: /v1

    itemOperations:
      latest:
        method: get
        path: /posts/latest
-       controller: App\Controller\Post\ItemLatestController
-       read: false
      putLatest:
        method: put
        path: /posts/latest
-       controller: App\Controller\Post\ItemPutLatestController
-       read: false
      patch: ~
      delete: ~
```

ãŒã€ã‚„ã¯ã‚Šå¯¾å¿œã¨ã—ã¦ã¯å¼·å¼•ãªã®ã§ãŠã™ã™ã‚ã¯ã—ã¾ã›ã‚“ã€‚
