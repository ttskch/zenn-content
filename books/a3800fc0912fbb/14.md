---
title: "ãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½ã®ä½¿ã„æ–¹ã¨PostgreSQLç‰¹æœ‰ã®å•é¡Œ"
---

# API Platformã®ãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½

API Platformã«ã¯ãƒ•ã‚£ãƒ«ã‚¿ã¨ã„ã†æ©Ÿèƒ½ãŒçµ„ã¿è¾¼ã¿ã§ç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚

[API Platform: Filters](https://api-platform.com/docs/core/filters/)

Collectionã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã„ã¦ã€çµæœã‚»ãƒƒãƒˆã«å¯¾ã—ã¦æ§˜ã€…ãªåŠ¹æœã‚’å¾Œä»˜ã‘ã§ãã‚‹æ©Ÿèƒ½ã§ã™ã€‚

å…ˆã«ã€ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã—ãŸéš›ã«ã€`CollectionExtension` ã¨ã—ã¦ `PaginationExtension` ã®ä»–ã« `FilterExtension` ãªã©ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã€ã¨è¨€åŠã—ã¾ã—ãŸãŒã€ãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½ã¯ `FilterExtension` çµŒç”±ã§Collectionã«é©ç”¨ã•ã‚Œã‚‹ã¨ã„ã†ã‚ã‘ã§ã™ã­ã€‚

ãƒ•ã‚£ãƒ«ã‚¿ã¯è‡ªä½œã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ãŒã€ä¸Šè¨˜å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã¨ãŠã‚Šã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æ§˜ã€…ãªå®Ÿè£…ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚

# Serch Filterã‚’ä½¿ã£ã¦ã¿ã‚‹

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ•ã‚£ãƒ«ã‚¿ã®ä¸­ã§ã‚‚ç‰¹ã«ã‚ˆãä½¿ã†ã‚‚ã®ã®1ã¤ãŒ [Serch Filter](https://api-platform.com/docs/core/filters/#search-filter) ã§ã™ã€‚

ã“ã‚Œã¯ã€Collectionã‚’ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ã—ã¦çµã‚Šè¾¼ã‚€ãŸã‚ã®ãƒ•ã‚£ãƒ«ã‚¿ã§ã™ã€‚

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ‰‹å¼•ãã‚’å‚è€ƒã«ã€å®Ÿéš›ã«Serch Filterã‚’ä½¿ã£ã¦æŠ•ç¨¿ã‚’æ¤œç´¢ã™ã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

æ‰‹é †ã¯ã¨ã¦ã‚‚ç°¡å˜ã§ã€ã¾ãšã€`config/services.yaml` ã«ãƒ•ã‚£ãƒ«ã‚¿ã®å®šç¾©ã‚’æ›¸ãã¾ã™ã€‚

```yaml
services:

    # ...

    post.search_filter:
        parent: api_platform.doctrine.orm.search_filter
        arguments:
            - title: partial
              body: partial
        tags: [api_platform.filter]
        autowire: false
        autoconfigure: false
```

ä»Šå›ã¯ã€

* `post.search_filter` ã¨ã„ã†ã‚µãƒ¼ãƒ“ã‚¹å
* `title` ãŠã‚ˆã³ `body` ã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ã€ã„ãšã‚Œã‚‚ `partial`ï¼ˆéƒ¨åˆ†ä¸€è‡´ï¼‰ã§æ¤œç´¢ã™ã‚‹

ã¨ã„ã†å†…å®¹ã§å®šç¾©ã—ã¾ã—ãŸã€‚

æ¬¡ã«ã€ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®šç¾©ã«ã“ã®ãƒ•ã‚£ãƒ«ã‚¿ã®é©ç”¨ã‚’è¿½è¨˜ã—ã¾ã™ã€‚

```diff
  App\Entity\Post:
    attributes:
      route_prefix: /v1
+
+   collectionOperations:
+     get:
+       filters:
+         - post.search_filter
+     post: ~

    itemOperations:
      latest:
        method: get
        path: /posts/latest
        controller: App\Controller\Post\ItemLatestController
        read: false
        openapi_context:
          description: 'Retrieves the latest Post resource. #withoutIdentifier'
      putLatest:
        method: put
        path: /posts/latest
        controller: App\Controller\Post\ItemPutLatestController
        read: false
        openapi_context:
          description: 'Replaces the latest Post resource. #withoutIdentifier'
      patch: ~
      delete: ~
```

ã“ã‚Œã ã‘ã§å®Œäº†ã§ã™ã€‚å®Ÿéš›ã«å‹•ä½œã•ã›ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ã¾ãšã€äº‹å‰ã«æ—¢å­˜ã®APIã‚’ä½¿ã£ã¦æŠ•ç¨¿ä¸€è¦§ã‚’ä»¥ä¸‹ã®çŠ¶æ…‹ã«ã—ã¦ãŠãã¾ã™ã€‚

| id  | title     | body  |
| --- | --------- | ----- |
| 1   | ã‚¿ã‚¤ãƒˆãƒ«1 | æœ¬æ–‡1 |
| 2   | ã‚¿ã‚¤ãƒˆãƒ«2 | æœ¬æ–‡2 |
| 3   | ã‚¿ã‚¤ãƒˆãƒ«3 | æœ¬æ–‡3 |

ãã®ä¸Šã§ã€`GET /api/v1/posts?title=ã‚¿ã‚¤ãƒˆãƒ«&body=æœ¬æ–‡` ã‚’å©ã„ã¦ã¿ã‚‹ã¨ã€

![](https://storage.googleapis.com/zenn-user-upload/e2bcd3590159-20220506.png)

ã“ã®ã‚ˆã†ã«3ä»¶ã™ã¹ã¦ãŒãƒ’ãƒƒãƒˆã—ã¾ã™ã€‚

ã§ã¯ä»Šåº¦ã¯ `GET /api/v1/posts?title=ã‚¿ã‚¤ãƒˆãƒ«&body=æœ¬æ–‡1` ã‚’å©ã„ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

![](https://storage.googleapis.com/zenn-user-upload/56989ede652c-20220506.png)

ã“ã¡ã‚‰ã¯1ä»¶ã ã‘ãŒãƒ’ãƒƒãƒˆã—ã¾ã—ãŸã€‚æœŸå¾…ã©ãŠã‚Šã®å‹•ä½œã§ã™ã­ğŸ‘

Search Filterä»¥å¤–ã®çµ„ã¿è¾¼ã¿ã®ãƒ•ã‚£ãƒ«ã‚¿ã‚’ä½¿ã†å ´åˆã‚„ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚£ãƒ«ã‚¿ã‚’è‡ªä½œã™ã‚‹å ´åˆã‚‚ã€åŸºæœ¬çš„ã«åŒã˜è¦é ˜ã§å¯¾å¿œå¯èƒ½ã§ã™ã€‚

# PostgreSQLã«ãŠã„ã¦JSONå‹ã‚«ãƒ©ãƒ ã‚’Search Filterã§æ¤œç´¢ã§ããªã„å•é¡Œ

ãƒ•ã‚£ãƒ«ã‚¿ã«é–¢é€£ã—ã¦ä¸€ç‚¹ç‰¹ç­†ã™ã¹ãå•é¡Œã¨ãã®å¯¾å‡¦ã‚’è§£èª¬ã—ã¦ãŠãã¾ã™ã€‚

æœ¬æ›¸ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯SQLiteãƒ™ãƒ¼ã‚¹ã§å®Ÿè£…ã—ã¦ã„ã‚‹ã®ã§å®Ÿä¾‹ã‚’ç¤ºã™ã“ã¨ãŒã§ãã¾ã›ã‚“ãŒã€**DBã«PostgreSQLã‚’æ¡ç”¨ã—ã¦ã„ã‚‹å ´åˆã«ã€JSONå‹ã®ã‚«ãƒ©ãƒ ã‚’Search Filterã§æ¤œç´¢ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€DBãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã‚¨ãƒ©ãƒ¼ã¨ãªã‚Šæ­£å¸¸ã«å‹•ä½œã—ã¾ã›ã‚“ã€‚**

ã“ã‚Œã¯ã€[Search Filterã®å®Ÿè£…](https://github.com/api-platform/core/blob/v2.6.8/src/Bridge/Doctrine/Orm/Filter/SearchFilter.php#L189-L221) ãŒã€æŒ‡å®šã•ã‚ŒãŸã‚«ãƒ©ãƒ ã‚’LIKEå¥ã§æ¤œç´¢ã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ãŠã‚Šã€PostgreSQLã§ã¯JSONå‹ã‚«ãƒ©ãƒ ã«å¯¾ã—ã¦LIKEå¥ã§æ¤œç´¢ã™ã‚‹ã“ã¨ãŒã§ããªã„ãŸã‚ã«èµ·ã“ã‚‹å•é¡Œã§ã™ã€‚

DBã®ä»•æ§˜ã ã‹ã‚‰ã—ã‚‡ã†ãŒãªã„ã¨è¨€ã£ã¦ã—ã¾ãˆã°ãã‚Œã¾ã§ã§ã™ãŒã€ãƒãƒƒã‚·ãƒ¥ãƒãƒƒãƒ—ã§ãªã„å˜ãªã‚‹ã‚¹ã‚«ãƒ©ãƒ¼å€¤ã®é…åˆ—ã§ã‚ã‚‹ã‚ˆã†ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’JSON DBAL Typeã§ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹ã®ã¯Doctrine ORMã«ãŠã„ã¦å¸¸å¥—æ‰‹æ®µã§ã™ã€‚ï¼ˆä¾‹ãˆã° `make` ã‚³ãƒãƒ³ãƒ‰ã§Securityã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã® `User` ã‚¯ãƒ©ã‚¹ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ã¨ã€`$roles` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®DBAL Typeã¯JSONã«ãªã£ã¦ã„ã¾ã™ï¼‰

ãã“ã§ã€ã“ã‚Œã‚‚ã‚„ã‚„å¼·å¼•ãªæ–¹æ³•ã§ã¯ã‚ã‚Šã¾ã™ãŒå›é¿ç­–ã‚’ç¤ºã—ã¦ãŠãã¾ã™ã€‚

ã¾ãšã€PostgreSQLç”¨ã® `json_to_text` ã¨ã„ã† [DQLãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©é–¢æ•°](https://www.doctrine-project.org/projects/doctrine-orm/en/2.11/cookbook/dql-user-defined-functions.html) ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè£…ãƒ»æœ‰åŠ¹åŒ–ã—ã¾ã™ã€‚

> ä»¥ä¸‹ã®Stack Overflowãªã©ãŒå‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚
>
> [php - Symfony find user by role (JSON array Doctrine property) - Stack Overflow `#answer-70244617`](https://stackoverflow.com/questions/67725384/symfony-find-user-by-role-json-array-doctrine-property#answer-70244617)

```php:src/Doctrine/Extension/Postgresql/JsonToText.php
<?php

declare(strict_types=1);

namespace App\Doctrine\Extension\Postgresql;

use Doctrine\ORM\Query\AST\Functions\FunctionNode;
use Doctrine\ORM\Query\AST\Node;
use Doctrine\ORM\Query\Lexer;
use Doctrine\ORM\Query\Parser;
use Doctrine\ORM\Query\SqlWalker;

class JsonToText extends FunctionNode
{
    private Node $value;

    public function parse(Parser $parser)
    {
        $parser->match(Lexer::T_IDENTIFIER);
        $parser->match(Lexer::T_OPEN_PARENTHESIS);
        $this->value = $parser->StringPrimary();
        $parser->match(Lexer::T_CLOSE_PARENTHESIS);
    }

    public function getSql(SqlWalker $sqlWalker)
    {
        return sprintf('CAST(%s AS TEXT)', $this->value->dispatch($sqlWalker));
    }
}
```

```yaml:config/packages/doctrine.yaml
doctrine:
    orm:
        dql:
            string_functions:
                json_to_text: App\Doctrine\Extension\Postgresql\JsonToText
```

ãã—ã¦ã€ã“ã® `json_to_text` é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦JSONå‹ã‚«ãƒ©ãƒ ã‚’LIKEå¥ã§æ¤œç´¢ã™ã‚‹ãŸã‚ã®ç‹¬è‡ªãƒ•ã‚£ãƒ«ã‚¿ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¾ã™ã€‚

```php:src/Filter/JsonSearchFilter.php
<?php

declare(strict_types=1);

namespace App\Filter;

use ApiPlatform\Core\Bridge\Doctrine\Orm\Filter\SearchFilter;
use ApiPlatform\Core\Bridge\Doctrine\Orm\Util\QueryNameGeneratorInterface;
use ApiPlatform\Core\Exception\InvalidArgumentException;
use Doctrine\ORM\QueryBuilder;

class JsonSearchFilter extends SearchFilter
{
    /**
     * @see SearchFilter::addWhereByStrategy()
     *
     * Almost copy-and-pasted from original method, but modified only
     *  - disable strategies except "partial"
     *  - cast value with json_to_text
     */
    protected function addWhereByStrategy(string $strategy, QueryBuilder $queryBuilder, QueryNameGeneratorInterface $queryNameGenerator, string $alias, string $field, mixed $values, bool $caseSensitive): void
    {
        if (!\is_array($values)) {
            $values = [$values];
        }

        $wrapCase = $this->createWrapCase($caseSensitive);
        $valueParameter = ':'.$queryNameGenerator->generateParameterName($field);
        $aliasedField = sprintf('%s.%s', $alias, $field);

        if (!$strategy || self::STRATEGY_EXACT === $strategy) {
            if (1 === \count($values)) {
                $queryBuilder
                    ->andWhere($queryBuilder->expr()->eq($wrapCase($aliasedField), $wrapCase($valueParameter)))
                    ->setParameter($valueParameter, $values[0]);

                return;
            }

            $queryBuilder
                ->andWhere($queryBuilder->expr()->in($wrapCase($aliasedField), $valueParameter))
                ->setParameter($valueParameter, $caseSensitive ? $values : array_map('strtolower', $values));

            return;
        }

        $ors = [];
        $parameters = [];
        foreach ($values as $key => $value) {
            $keyValueParameter = sprintf('%s_%s', $valueParameter, $key);
            $parameters[$caseSensitive ? $value : strtolower($value)] = $keyValueParameter;

            // here is only modified
            switch ($strategy) {
                case self::STRATEGY_PARTIAL:
                    $ors[] = $queryBuilder->expr()->like(
                        sprintf('json_to_text(%s)', $wrapCase($aliasedField)),
                        $wrapCase((string) $queryBuilder->expr()->concat("'%'", $keyValueParameter, "'%'"))
                    );
                    break;
                default:
                    throw new InvalidArgumentException(sprintf('strategy %s does not exist.', $strategy));
            }
        }

        $queryBuilder->andWhere($queryBuilder->expr()->orX(...$ors));
        array_walk($parameters, [$queryBuilder, 'setParameter']);
    }
}
```

çµ„ã¿è¾¼ã¿ã® `SearchFilter` ã‚’ç¶™æ‰¿ã—ã¦ã€LIKEå¥ã®çµ„ã¿ç«‹ã¦ã‚’è¡Œã£ã¦ã„ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã®ã¿ä¸Šæ›¸ãã—ã¦ã„ã¾ã™ã€‚

å†…å®¹ã¯ã»ã¨ã‚“ã©å…ƒãƒ¡ã‚½ãƒƒãƒ‰ã®ã‚³ãƒ”ãƒšã§ã€LIKEå¥ã®çµ„ã¿ç«‹ã¦ã«é–¢ã™ã‚‹ç®‡æ‰€ã®ã¿ã€

* `partial` ä»¥å¤–ã®æˆ¦ç•¥ã‚’éå¯¾å¿œã«
* å¯¾è±¡ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ `json_to_text` ã§ã‚­ãƒ£ã‚¹ãƒˆã™ã‚‹ã‚ˆã†ã«

ã¨ã„ã†2ç‚¹ã®å¤‰æ›´ã‚’åŠ ãˆã¦ã„ã¾ã™ã€‚

ã‚ã¨ã¯ã€é€šå¸¸ã®ãƒ•ã‚£ãƒ«ã‚¿ã‚’ä½¿ç”¨ã™ã‚‹ã®ã¨åŒæ§˜ã®æ‰‹é †ã§ã€JSONå‹ã‚«ãƒ©ãƒ ã«å¯¾ã—ã¦ã¯ã“ã® `JsonSearchFilter` ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«ã™ã‚Œã°ã‚ˆã„ã ã‘ã§ã™ã€‚

ä¾‹ãˆã° `Post` ã‚¯ãƒ©ã‚¹ã« `tags` ã¨ã„ã†JSONå‹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚‹ã¨ã—ãŸã‚‰ã€ä»¥ä¸‹ã®ã‚ˆã†ãªè¨­å®šã«ãªã‚‹ã§ã—ã‚‡ã†ã€‚

```yaml:config/services.yaml
post.json_search_filter:
    class: App\Filter\JsonSearchFilter
    arguments:
        $properties:
            tags: partial
```
