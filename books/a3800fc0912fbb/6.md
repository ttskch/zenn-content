---
title: "ç‹¬è‡ªState Providerã§ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹"
---

# ç¾çŠ¶ã®å®Ÿè£…ã§ã¯ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ãŒãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã•ã‚Œãªã„

å‰ç« ã§ã€`GET /api/comments` ã§ã‚³ãƒ¡ãƒ³ãƒˆã®ä¸€è¦§ã‚’å–å¾—ã—ãŸéš›ã«ã€BANã•ã‚Œã¦ã„ãªã„ã‚³ãƒ¡ãƒ³ãƒˆã®ã¿ãŒå–å¾—ã•ã‚Œã‚‹ã‚ˆã†ã«State Providerã‚’è‡ªä½œã—ã¾ã—ãŸã€‚

ã—ã‹ã—ã€å®Ÿã¯ç¾çŠ¶ã®State Providerã®å®Ÿè£…ã«ã¯ã€**å–å¾—ã•ã‚ŒãŸä¸€è¦§ãŒãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã•ã‚Œãªããªã£ã¦ã—ã¾ã£ã¦ã„ã‚‹** ã¨ã„ã†ä¸å‚™ãŒã‚ã‚Šã¾ã™ã€‚

ç¾çŠ¶ã®State Providerã®ã‚³ãƒ¼ãƒ‰ã‚’æ”¹ã‚ã¦ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```php
<?php

declare(strict_types=1);

namespace App\State\Provider\Comment;

use ApiPlatform\Metadata\Operation;
use ApiPlatform\State\ProviderInterface;
use App\Entity\Comment;
use App\Repository\CommentRepository;

/**
 * @implements ProviderInterface<Comment>
 */
class GetCollectionProvider implements ProviderInterface
{
    public function __construct(private CommentRepository $commentRepository)
    {
    }

    public function provide(Operation $operation, array $uriVariables = [], array $context = []): object|array|null
    {
        $comments = $this->commentRepository->findBy(['isBanned' => false]);

        return $comments;
    }
}
```

`provide()` ãƒ¡ã‚½ãƒƒãƒ‰ã«ãŠã„ã¦ã€ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ `findBy()` ã§å–å¾—ã—ãŸçµæœã‚»ãƒƒãƒˆã®é…åˆ—ã‚’ãã®ã¾ã¾è¿”ã—ã¦ã„ã¾ã™ãŒã€å®Ÿã¯ã“ã‚Œã ã¨ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãŒè¡Œã‚ã‚Œã¾ã›ã‚“ã€‚

å®Ÿé¨“ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ã¾ãšã€`POST /api/posts/1/comments` ã‚’å©ã„ã¦ï¼ˆBANã•ã‚Œã¦ã„ãªã„ï¼‰ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã—ã€`GET /api/comments` ã§2ã¤ä»¥ä¸Šã®ã‚³ãƒ¡ãƒ³ãƒˆãŒè¿”ã£ã¦ãã‚‹çŠ¶æ…‹ã«ã—ã¦ãã ã•ã„ã€‚

![](https://storage.googleapis.com/zenn-user-upload/4e9a985b1b7f-20220506.png)

ãã®ä¸Šã§ã€`config/packages/api_platform.yaml` ã§ [`api_platform.defaults.pagination_items_per_page`](https://api-platform.com/docs/core/pagination/#changing-the-number-of-items-per-page-globally) ã« `1` ã‚’è¨­å®šã—ã¾ã™ã€‚ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã“ã®è¨­å®šã¯çœç•¥ã•ã‚Œã¦ãŠã‚Šã€åˆæœŸå€¤ã®30ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ï¼‰

```diff:config/packages/api_platform.yaml
  api_platform:
      mapping:
          paths: ['%kernel.project_dir%/src/Entity']
      patch_formats:
          json: ['application/merge-patch+json']
      swagger:
          versions: [3]
+     defaults:
+         pagination_items_per_page: 1
```

ã“ã®çŠ¶æ…‹ã§ã€`POST /api/posts/1/comments` ã‚’å©ã‘ã°ã€å…¨2ä»¶ï¼ˆä»¥ä¸Šï¼‰ã®ã‚³ãƒ¡ãƒ³ãƒˆãŒ1ä»¶ãšã¤ã®ãƒšãƒ¼ã‚¸ã«åˆ†å‰²ã•ã‚Œã¦å–å¾—ã•ã‚Œã‚‹ã“ã¨ãŒæœŸå¾…ã•ã‚Œã¾ã™ãŒã€å®Ÿéš›ã«ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Š2ä»¶å…¨ä»¶ãŒå–å¾—ã§ãã¦ã—ã¾ã„ã¾ã™ğŸ˜“

![](https://storage.googleapis.com/zenn-user-upload/4e9a985b1b7f-20220506.png)

# API Platformã«ãŠã‘ã‚‹ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³

å®Ÿã¯ã€API Platformã«ãŠã„ã¦ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã¯ã€State Providerã® `provide()` ãƒ¡ã‚½ãƒƒãƒ‰ã§ [`ApiPlatform\State\Pagination\PaginatorInterface` ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™å¿…è¦ãŒã‚ã‚Šã¾ã™](https://api-platform.com/docs/core/pagination/#pagination-for-custom-state-providers)ã€‚

ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚„ãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½ï¼ˆæœ¬æ›¸ã§ã‚‚å¾Œè¿°ã—ã¾ã™ï¼‰ã‚’Collectionã«é©ç”¨ã™ã‚‹ãŸã‚ã«ã¯ã€ãã‚Œã‚‰ã®æ©Ÿèƒ½ã”ã¨ã«ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ `CollectionExtension` ã‚’ã€Collectionã‚’è¡¨ã™QueryBuilderã«å¯¾ã—ã¦ã€Œé©ç”¨ã™ã‚‹ã€ã¨ã„ã†ãƒ—ãƒ­ã‚»ã‚¹ãŒå¿…è¦ã§ã™ã€‚

`CollectionExtension` ã¨ã¯ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ³ãƒ†ãƒŠã«ãŠã„ã¦ `api_platform.doctrine.orm.query_extension.collection` ã¨ã„ã†ã‚¿ã‚°ãŒä»˜åŠ ã•ã‚Œã¦ã„ã‚‹ã€[`ApiPlatform\Doctrine\Orm\Extension\QueryCollectionExtensionInterface`](https://github.com/api-platform/core/blob/v3.1.18/src/Doctrine/Orm/Extension/QueryCollectionExtensionInterface.php) ã¾ãŸã¯ [`ApiPlatform\Doctrine\Orm\Extension\QueryResultCollectionExtensionInterface`](https://github.com/api-platform/core/blob/v3.1.18/src/Doctrine/Orm/Extension/QueryResultCollectionExtensionInterface.php) ã®å®Ÿè£…ã‚¯ãƒ©ã‚¹ã®ã“ã¨ã§ã™ã€‚

è‡ªä½œã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ãŒã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ `ApiPlatform\Doctrine\Orm\Extension` ã¨ã„ã†åå‰ç©ºé–“ã®é…ä¸‹ã« `PaginationExtension` ã‚„ `FilterExtension` ãªã©ã„ãã¤ã‹ã®å®Ÿè£…ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚

è‡ªä½œã®Collection State Providerã§ã¯ã€ã„ããªã‚Šçµæœã‚»ãƒƒãƒˆã‚’å–å¾—ã—ã¦è¿”ã™ã®ã§ã¯ãªãã€**çµæœã‚»ãƒƒãƒˆã‚’å–å¾—ã™ã‚‹ãŸã‚ã®QueryBuilderã‚’ä½œæˆã—ã€QueryBuilderã«ã“ã‚Œã‚‰ã® `CollectionExtension` ã‚’é©ç”¨ã—ãŸå¾Œã§çµæœã‚»ãƒƒãƒˆã‚’å–å¾—ã—ã¦è¿”ã™** ã¨ã„ã†å¯¾å¿œãŒå¿…è¦ã¨ã„ã†ã‚ã‘ã§ã™ã€‚

# ã‚³ãƒ¡ãƒ³ãƒˆCollection State Providerã‚’ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã«å¯¾å¿œã•ã›ã‚‹

å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰ã«æ²¿ã£ã¦å¯¾å¿œæ–¹æ³•ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

ã¾ãšã€æ—¢å­˜ã® `App\State\Provider\Comment\GetCollectionProvider` ã« `CollectionExtension` ç¾¤ã‚’ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

State Providerã‚¯ãƒ©ã‚¹ã®ã‚µãƒ¼ãƒ“ã‚¹å®šç¾©å†…ã§ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆã‚’è¨­å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€ä»Šå¾ŒãŸãã•ã‚“ã®Collection State Providerã‚’ä½œã£ã¦ã„ãå¯èƒ½æ€§ã‚’è€ƒãˆã¦ã€[å¤‰æ•°åãƒ™ãƒ¼ã‚¹ã®ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆ](https://symfony.com/doc/current/service_container.html#binding-arguments-by-name-or-type) ã‚’ä½¿ã£ã¦ä¸€å›ã®è¨­å®šã ã‘ã§ã™ã¹ã¦ã®Collection State Providerã«å…±é€šã—ã¦é©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¾ã™ã€‚

```diff:config/services.yaml
  services:

      # ...

      _defaults:
          autowire: true      # Automatically injects dependencies in your services.
          autoconfigure: true # Automatically registers your services as commands, event subscribers, etc.
+         bind:
+             $collectionExtensions: !tagged api_platform.doctrine.orm.query_extension.collection

      # ...
```

ã“ã‚Œã§ã€`$collectionExtensions` ã¨ã„ã†å¼•æ•°ã«å¯¾ã—ã¦ã¯å¸¸ã« `api_platform.doctrine.orm.query_extension.collection` ã§ã‚¿ã‚°ä»˜ã‘ã•ã‚Œã¦ã„ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ç¾¤ãŒã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆã•ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

ãã®ä¸Šã§ã€`App\State\Provider\Comment\GetCollectionProvider` ã‚’ä»¥ä¸‹ã®ã‚ˆã†ãªå®Ÿè£…ã«ä¿®æ­£ã—ã¾ã™ã€‚

```php
<?php

declare(strict_types=1);

namespace App\State\Provider\Comment;

use ApiPlatform\Doctrine\Orm\Extension\QueryResultCollectionExtensionInterface;
use ApiPlatform\Doctrine\Orm\Util\QueryNameGenerator;
use ApiPlatform\Metadata\Operation;
use ApiPlatform\State\ProviderInterface;
use App\Entity\Comment;
use App\Repository\CommentRepository;
use Doctrine\ORM\QueryBuilder;

/**
 * @implements ProviderInterface<Comment>
 */
class GetCollectionProvider implements ProviderInterface
{
    public function __construct(
        private iterable $collectionExtensions,
        private CommentRepository $commentRepository,
    )    {
    }

    public function provide(Operation $operation, array $uriVariables = [], array $context = []): object|array|null
    {
        $qb = $this->commentRepository->createQueryBuilder('co')
            ->andWhere('co.isBanned = false')
        ;

        return $this->getResult($qb, Comment::class, $operation, $context);
    }

    /**
     * @return iterable<Comment>
     */
    private function getResult(QueryBuilder $qb, string $resourceClass, Operation $operation, array $context): iterable
    {
        $resultExtension = null;

        foreach ($this->collectionExtensions as $extension) {
            $extension->applyToCollection($qb, new QueryNameGenerator(), $resourceClass, $operation, $context);

            if ($extension instanceof QueryResultCollectionExtensionInterface && $extension->supportsResult($resourceClass, $operation, $context)) {
                $resultExtension ??= $extension;
            }
        }

        $result = $resultExtension ? $resultExtension->getResult($qb, $resourceClass, $operation, $context) : $qb->getQuery()->getResult();

        return $result;
    }
}
```

QueryBuilderã« `CollectionExtension` ã‚’é©ç”¨ã—ã¦ã„ãå‡¦ç†ã¯ `getResult()` ã¨ã„ã†privateãƒ¡ã‚½ãƒƒãƒ‰ã«åˆ†ã‘ã¦ã‚ã‚Šã¾ã™ã€‚

ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆã•ã‚ŒãŸ `$collectionExtensions` ã‚’é †ã«é©ç”¨ã—ã¦ã„ããªãŒã‚‰ã€ãã®ä¸­ã« [`QueryResultCollectionExtensionInterface`](https://github.com/api-platform/core/blob/v3.1.18/src/Doctrine/Orm/Extension/QueryResultCollectionExtensionInterface.php) ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ `CollectionExtension` ãŒã‚ã‚Œã°ã€æœ€å¾Œã«ãã® `getResult()` çµæœã‚’è¿”ã—ã€ãªã‘ã‚Œã°ã™ã¹ã¦é©ç”¨ã—ãŠãˆãŸQueryBuilderã‹ã‚‰çµæœã‚»ãƒƒãƒˆã®é…åˆ—ã‚’å–å¾—ã—ã¦è¿”ã™ã€ã¨ã„ã†å‡¦ç†ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

å…ˆã«å°‘ã—è§¦ã‚ŒãŸã‚ˆã†ã«ã€`CollectionExtension` ã«ã¯ã€`QueryCollectionExtensionInterface` ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã‚‚ã®ã¨ `QueryResultCollectionExtensionInterface` ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã‚‚ã®ã®2ç¨®é¡ãŒã‚ã‚Šã¾ã™ã€‚

ä¾‹ãˆã° `FilterExtension` ã¯ [`QueryCollectionExtensionInterface`](https://github.com/api-platform/core/blob/v3.1.18/src/Doctrine/Orm/Extension/QueryCollectionExtensionInterface.php) ã®å®Ÿè£…ã§ã‚ã‚Šã€**æœ€çµ‚çš„ãªçµæœã‚»ãƒƒãƒˆã‚’ç”Ÿæˆã™ã‚‹æ©Ÿèƒ½ï¼ˆ`getResult()` ãƒ¡ã‚½ãƒƒãƒ‰ï¼‰ã‚’æŒã¡ã¾ã›ã‚“** ãŒã€`PaginationExtension` ã¯ [`QueryResultCollectionExtensionInterface`](https://github.com/api-platform/core/blob/v3.1.18/src/Doctrine/Orm/Extension/QueryResultCollectionExtensionInterface.php) ã®å®Ÿè£…ã§ã‚ã‚Šã€**æœ€çµ‚çš„ãªçµæœã‚»ãƒƒãƒˆã‚’ç”Ÿæˆã™ã‚‹æ©Ÿèƒ½ï¼ˆ`getResult()` ãƒ¡ã‚½ãƒƒãƒ‰ï¼‰ã‚’æŒã¡ã¾ã™ã€‚**

ã“ã‚Œã§å¯¾å¿œã¯å®Œäº†ãªã®ã§ã€æ”¹ã‚ã¦ `GET /api/comments` ã®çµæœã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

![](https://storage.googleapis.com/zenn-user-upload/b78d3e5cdd5e-20220506.png)

ç„¡äº‹ã«ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãŒé©ç”¨ã•ã‚Œã¦ã„ã¾ã™ã­ï¼ğŸ‘

# `CollectionExtension` ã‚’é©ç”¨ã™ã‚‹å‡¦ç†ã‚’Traitã«åˆ†é›¢ã™ã‚‹

æœ€å¾Œã«å°‘ã—ã ã‘ãƒªãƒ•ã‚¡ã‚¯ã‚¿ã—ã¦ãŠãã¾ã™ã€‚

å…ˆã»ã© `CollectionExtension` ã‚’QueryBuilderã«é©ç”¨ã™ã‚‹å‡¦ç†ã‚’ `getResult()` privateãƒ¡ã‚½ãƒƒãƒ‰ã«æ›¸ãã¾ã—ãŸãŒã€ä»Šå¾ŒãŸãã•ã‚“ã®Collection State Providerã‚’ä½œã£ã¦ã„ãã¨ã€ã™ã¹ã¦ã®ã‚¯ãƒ©ã‚¹ã«ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚

ã“ã‚Œã¯ç„¡é§„ãªã®ã§ã€Traitã‚’ä½œã£ã¦ãã¡ã‚‰ã«ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç§»å‹•ã•ã›ã¦ãŠãã“ã¨ã«ã—ã¾ã—ã‚‡ã†ã€‚

ã¾ãšã€ä»¥ä¸‹ã®ã‚ˆã†ãªTraitã‚’ä½œã‚Šã€`getResult()` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç§»æ¤ã—ã¾ã™ã€‚

```php:src/Traits/CollectionStateProviderTrait.php
<?php

declare(strict_types=1);

namespace App\Traits;

use ApiPlatform\Doctrine\Orm\Extension\QueryCollectionExtensionInterface;
use ApiPlatform\Doctrine\Orm\Extension\QueryResultCollectionExtensionInterface;
use ApiPlatform\Doctrine\Orm\Util\QueryNameGenerator;
use ApiPlatform\Metadata\Operation;
use Doctrine\ORM\QueryBuilder;
use Symfony\Contracts\Service\Attribute\Required;

/**
 * @template T
 */
trait CollectionStateProviderTrait
{
    /**
     * @var iterable<QueryCollectionExtensionInterface|QueryResultCollectionExtensionInterface>
     */
    protected iterable $extensions;

    /**
     * @param iterable<QueryCollectionExtensionInterface|QueryResultCollectionExtensionInterface> $collectionExtensions
     */
    #[Required]
    public function setExtension(iterable $collectionExtensions): void
    {
        $this->extensions = $collectionExtensions;
    }

    /**
     * @return iterable<T>
     */
    protected function getResult(QueryBuilder $qb, string $resourceClass, Operation $operation, array $context): iterable
    {
        $resultExtension = null;

        foreach ($this->extensions as $extension) {
            $extension->applyToCollection($qb, new QueryNameGenerator(), $resourceClass, $operation, $context);

            if ($extension instanceof QueryResultCollectionExtensionInterface && $extension->supportsResult($resourceClass, $operation, $context)) {
                $resultExtension ??= $extension;
            }
        }

        /** @var iterable<T> $result */
        $result = $resultExtension ? $resultExtension->getResult($qb, $resourceClass, $operation, $context) : $qb->getQuery()->getResult();

        return $result;
    }
}
```

Traitã«å¸¸ã« `$collectionExtensions` ã‚’ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆã™ã‚‹ãŸã‚ã«ã€setterãƒ¡ã‚½ãƒƒãƒ‰ã« [`#[Required]` ã‚¢ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ãƒˆ](https://symfony.com/doc/current/service_container/autowiring.html#autowiring-other-methods-e-g-setters-and-public-typed-properties) ã‚’ä»˜åŠ ã—ã¦ã‚³ãƒ³ãƒ†ãƒŠæ§‹ç¯‰æ™‚ã«å¸¸ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã‚ã‚Šã¾ã™ã€‚

ã“ã‚Œã§ã€`App\State\Provider\Comment\GetCollectionProvider` ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«éå¸¸ã«ã‚¹ãƒƒã‚­ãƒªã—ãŸå®Ÿè£…ã«ã§ãã¾ã™ã€‚

```php
<?php

declare(strict_types=1);

namespace App\State\Provider\Comment;

use ApiPlatform\Metadata\Operation;
use ApiPlatform\State\ProviderInterface;
use App\Entity\Comment;
use App\Repository\CommentRepository;
use App\Traits\CollectionStateProviderTrait;

/**
 * @implements ProviderInterface<Comment>
 */
class GetCollectionProvider implements ProviderInterface
{
    /**
     * @phpstan-use CollectionStateProviderTrait<Comment>
     */
    use CollectionStateProviderTrait;

    public function __construct(private CommentRepository $commentRepository)
    {
    }

    public function provide(Operation $operation, array $uriVariables = [], array $context = []): object|array|null
    {
        $qb = $this->commentRepository->createQueryBuilder('co')
            ->andWhere('co.isBanned = false')
        ;

        return $this->getResult($qb, Comment::class, $operation, $context);
    }
}
```

æœ€å¾Œã«ã€å®Ÿé¨“ã®ãŸã‚ã«å¤‰æ›´ã—ãŸãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®šã‚’å…ƒã«æˆ»ã—ã¦ãŠãã¾ã—ã‚‡ã†ğŸ¤š

```diff:config/packages/api_platform.yaml
  api_platform:
      mapping:
          paths: ['%kernel.project_dir%/src/Entity']
      patch_formats:
          json: ['application/merge-patch+json']
      swagger:
          versions: [3]
-     defaults:
-         pagination_items_per_page: 1
```
