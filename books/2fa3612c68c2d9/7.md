---
title: "TwigExtensionã¨UrlGeneratorï¼ˆãªã©ï¼‰ã‚’è‡ªä½œã—ã¦é¢å€’ãªå‡¦ç†ã‚’åŠ¹ç‡åŒ–"
---

# ã“ã®ç« ã«å¯¾å¿œã™ã‚‹ã‚³ãƒŸãƒƒãƒˆ

* [ğŸ“ TwigExtensionã¨UrlGeneratorï¼ˆãªã©ï¼‰ã‚’è‡ªä½œã—ã¦é¢å€’ãªå‡¦ç†ã‚’åŠ¹ç‡åŒ–](https://github.com/ttskch/symfony-example-app/commit/37345f7145a5efd6e8ca1ba11257bd9ea8d77b7a)

> ãƒ‡ãƒ¢ã‚¢ãƒ—ãƒªã¯æ—¥æœ¬èªã¨è‹±èªã«å¯¾å¿œã™ã‚‹ãŸã‚ãƒ­ã‚±ãƒ¼ãƒ«ã«å¿œã˜ã¦æ—¥æ™‚ã®æ–‡å­—åˆ—è¡¨ç¾ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’å¤‰ãˆã¦ã„ã‚‹ã®ã§ã€ã‚³ãƒŸãƒƒãƒˆã®å†…å®¹ã¯æœ¬æ–‡ã®è§£èª¬ã¨è‹¥å¹²ç•°ãªã‚Šã¾ã™ã€‚

# TwigExtensionã¨UrlGeneratorï¼ˆãªã©ï¼‰ã‚’è‡ªä½œã—ã¦é¢å€’ãªå‡¦ç†ã‚’åŠ¹ç‡åŒ–

ã“ã“ã§ã•ã‚‰ã«ã€ç”»é¢ã®æç”»ã‚„ç”»é¢é·ç§»ã®åˆ¶å¾¡ã®ãŸã‚ã®ä¾¿åˆ©ãªå‡¦ç†ã‚’éƒ¨å“åŒ–ã—ã¦ãŠãã¾ã™ğŸ’ª

## TwigExtensionã‚’è‡ªä½œ

ã¾ãšã€Twigå†…ã§ã‚ˆãä½¿ã†å‡¦ç†ã‚’é–¢æ•°ã‚„ãƒ•ã‚£ãƒ«ã‚¿ã¨ã—ã¦å®šç¾©ã™ã‚‹ãŸã‚ã® [TwigExtension](https://symfony.com/doc/current/templating/twig_extension.html) ã‚’è‡ªä½œã—ã¾ã™ã€‚

`config/services.yaml` ã§ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚¿ã‚°ä»˜ã‘ã‚’ã—ã¦ãŠã„ãŸä¸Šã§ã€

```yaml
App\Twig\AppExtension:
    tags: ['twig.extension']
```

ä»¥ä¸‹ã®ã‚ˆã†ã« `Twig\Extension\AbstractExtension` ã‚¯ãƒ©ã‚¹ã‚’ç¶™æ‰¿ã—ã¦å®Ÿè£…ã™ã‚Œã°OKã§ã™ã€‚

```php
class AppExtension extends AbstractExtension
{
    private RoleManager $rm;
    private TranslatorInterface $translator;

    public function __construct(RoleManager $rm, TranslatorInterface $translator)
    {
        $this->rm = $rm;
        $this->translator = $translator;
    }

    public function getFunctions()
    {
        return [
            new TwigFunction('roles', [$this, 'roles'], ['is_safe' => ['html']]),
        ];
    }

    public function getFilters()
    {
        return [
            new TwigFilter('datetime', [$this, 'datetime']),
        ];
    }

    public function roles(UserInterface $user): string
    {
        $badges = [];

        foreach ($this->rm->getReachableRoles($user) as $role) {
            $badges[] = sprintf('<span class="badge badge-secondary">%s</span>', $this->translator->trans($role));
        }

        return implode(' ', $badges);
    }

    public function datetime(?\DateTimeInterface $datetime): string
    {
        $days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];

        return $datetime === null ? '' : sprintf($datetime->format('Y/m/d(%\s) H:i:s'), $days[(int) $datetime->format('w')]);
    }
}
```

ã“ã‚Œã§ã€Twigãƒ•ã‚¡ã‚¤ãƒ«å†…ã§ `roles()` ã‚„ `|datetime` ã¨ã„ã†æ©Ÿèƒ½ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ã“ã‚Œã‚’ä½¿ã£ã¦ã€ãƒ“ãƒ¥ãƒ¼ã®ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã™ã€‚ä¾‹ãˆã°ã€ `user/_detail.html.twig` ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```diff
  <div class="table-responsive">
    <table class="table table-sm table-hover">
      <tbody>
      <tr>
        <th>{% trans %}Id{% endtrans %}</th>
        <td>{{ user.id }}</td>
      </tr>
      <tr>
        <th>{% trans %}Email{% endtrans %}</th>
        <td>{{ user.email }}</td>
      </tr>
      <tr>
        <th>{% trans %}Roles{% endtrans %}</th>
-       <td>
-         {% for role in user.roles %}
-           {% if role != 'ROLE_USER' %}
-             <span class="badge badge-secondary">{{ role|trans }}</span>
-           {% endif %}
-         {% endfor %}
-       </td>
+       <td>{{ roles(user) }}</td>
      </tr>
      <tr>
        <th>{% trans %}Display name{% endtrans %}</th>
        <td>{{ user.displayName }}</td>
      </tr>
      <tr>
        <th>{% trans %}Last logged in at{% endtrans %}</th>
-       <td>{{ user.lastLoggedInAt|date('Y/m/d H:i:s') }}</td>
+       <td>{{ user.lastLoggedInAt|datetime }}</td>
      </tr>
      <tr>
        <th>{% trans %}Created at{% endtrans %}</th>
-       <td>{{ user.createdAt|date('Y/m/d H:i:s') }}</td>
+       <td>{{ user.createdAt|datetime }}</td>
      </tr>
      <tr>
        <th>{% trans %}Updated at{% endtrans %}</th>
-       <td>{{ user.updatedAt|date('Y/m/d H:i:s') }}</td>
+       <td>{{ user.updatedAt|datetime }}</td>
      </tr>
      </tbody>
    </table>
  </div>
  ```

ã‚¹ãƒƒã‚­ãƒªæ›¸ã‘ã¦å¬‰ã—ã„ã§ã™ã­ï¼

ã“ã‚“ãªæ„Ÿã˜ã§ã€ã“ã®å¾Œã‚‚Twigã§ä½¿ã„å›ã›ã‚‹ã¨æ¥½ã«ãªã‚Šãã†ãªå‡¦ç†ã‚„è¡¨ç¾ãŒå‡ºã¦ããŸã‚‰éšæ™‚ `AppExtension` ã«è¿½åŠ ã—ã¦ã„ãã“ã¨ã«ã—ã¾ã™ğŸ‘

## UrlGeneratorï¼ˆãªã©ï¼‰ã‚’è‡ªä½œ

ã‚‚ã†1ã¤ä½œã£ã¦ãŠãã®ãŒã“ã‚Œã§ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®UrlGeneratorã‚’ãƒ©ãƒƒãƒ—ã—ã¦ä¾¿åˆ©ãªæ©Ÿèƒ½ã‚’ç”Ÿã‚„ã—ã€ãã‚Œã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã‚„Twigã‹ã‚‰ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¨ã„ã†ã‚‚ã®ã§ã™ã€‚

ä½•ã‚’è¨€ã£ã¦ã„ã‚‹ã‹åˆ†ã‹ã‚‰ãªã„ã¨æ€ã†ã®ã§ã€ã‚‚ã†å°‘ã—è©³ã—ãèª¬æ˜ã—ã¾ã™ğŸ’ª

### ä¾‹1

ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ“ä½œã‚’æƒ³åƒã—ã¦ã¿ã¦ãã ã•ã„ã€‚

1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ç”»é¢ã‚’æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚é™é †ã§ã‚½ãƒ¼ãƒˆã—ã¦ã€2ãƒšãƒ¼ã‚¸ç›®ã‚’è¡¨ç¤ºã—ã¦ã„ã‚‹
2. ã“ã®çŠ¶æ…‹ã‹ã‚‰ã€ã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® `ç·¨é›†` ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†ç”»é¢ã§ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡ã—ã¦ã€ç·¨é›†å®Œäº†å¾Œã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹
4. **ã‚½ãƒ¼ãƒˆã‚‚ãƒšãƒ¼ã‚¸é€ã‚Šã‚‚ãƒªã‚»ãƒƒãƒˆã•ã‚ŒãŸçŠ¶æ…‹ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹**

4ã®ã‚¹ãƒ†ãƒƒãƒ—ã«ãŠã„ã¦ã€**ã§ãã‚Œã°å…ƒã©ãŠã‚Šæœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚é™é †ã®2ãƒšãƒ¼ã‚¸ç›®ãŒè¡¨ç¤ºã•ã‚Œã¦ã»ã—ããªã„ã§ã™ã‹ï¼Ÿ**

å°‘ãªãã¨ã‚‚åƒ•ã®æ„Ÿè¦šã§ã¯ãã†ãªã£ã¦ã»ã—ã„ã§ã™ã€‚

ãªã®ã§ã“ã†ã„ã†å ´åˆã€ä¸€è¦§ç”»é¢ã‹ã‚‰ç·¨é›†ç”»é¢ã¸è¡Œãã¨ãã« `?returnTo={ã‚‚ã¨ã‚‚ã¨é–²è¦§ã—ã¦ã„ãŸä¸€è¦§ç”»é¢ã®URLï¼ˆãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä»˜ãï¼‰}` ã‚’URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã¶ã‚‰ä¸‹ã’ãŸçŠ¶æ…‹ã§ç§»å‹•ã—ã¦ã€ç·¨é›†ç”»é¢ã‹ã‚‰ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã¨ãã¯

* `returnTo` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ãã®å€¤ã¸
* ãªã‘ã‚Œã° `/user/` ã¸

ã¨ã„ã†æ„Ÿã˜ã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

### ä¾‹2

ä¾‹1ã¨ã»ã¨ã‚“ã©åŒã˜ã§ã™ãŒã‚‚ã†1ãƒ‘ã‚¿ãƒ¼ãƒ³ã€‚

1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ç”»é¢ã‚’æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚é™é †ã§ã‚½ãƒ¼ãƒˆã—ã¦ã€2ãƒšãƒ¼ã‚¸ç›®ã‚’è¡¨ç¤ºã—ã¦ã„ã‚‹
2. ã“ã®çŠ¶æ…‹ã‹ã‚‰ã€ã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® `ç·¨é›†` ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†ç”»é¢ã§ `ã‚­ãƒ£ãƒ³ã‚»ãƒ«` ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ç”»é¢ã«æˆ»ã‚‹
4. **ã‚½ãƒ¼ãƒˆã‚‚ãƒšãƒ¼ã‚¸é€ã‚Šã‚‚ãƒªã‚»ãƒƒãƒˆã•ã‚ŒãŸçŠ¶æ…‹ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹**

ã“ã®å ´åˆã‚‚ã€4ã®ã‚¹ãƒ†ãƒƒãƒ—ã«ãŠã„ã¦ **å…ƒã©ãŠã‚Šæœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚é™é †ã®2ãƒšãƒ¼ã‚¸ç›®ãŒè¡¨ç¤ºã•ã‚Œã¦ã»ã—ã„** ã§ã™ã‚ˆã­ã€‚

ãªã®ã§ã“ã†ã„ã†å ´åˆã€ç·¨é›†ç”»é¢ã® `ã‚­ãƒ£ãƒ³ã‚»ãƒ«` ã®ãƒªãƒ³ã‚¯å…ˆã¯

* `returnTo` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ãã®å€¤
* ãªã‘ã‚Œã° `/user/`

ã¨ãªã‚‹ã‚ˆã†ã«å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

### å®Ÿéš›ã®å¯¾å¿œæ–¹æ³•

ä¸Šè¨˜ã®ã‚ˆã†ãªå‡¦ç†ã‚’ãã‚Œãã‚Œã®ç®‡æ‰€ã§æ›¸ãã®ã¯DRYã˜ã‚ƒãªã„ã®ã§ã€ä»¥ä¸‹ã®3ã¤ã‚’ä½œã‚‹ã“ã¨ã§ã“ã‚Œã‚‰ã®å‡¦ç†ã‚’åŠ¹ç‡çš„ã«å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã« `$this->redirectToRoute()` ã®ä»£ã‚ã‚Šã«ä½¿ãˆã‚‹ `$this->redirectToRouteOrReturn()` ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆ `returnTo` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ãã¡ã‚‰ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ï¼‰ã‚’ç”Ÿã‚„ã™ãŸã‚ã®Trait
* ç¾åœ¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆURLã‚’ `returnTo` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦ä»˜åŠ ã™ã‚‹æ©Ÿèƒ½ã‚’æŒã£ãŸè‡ªä½œUrlGenerator
* ãã®è‡ªä½œUrlGeneratorã‚’ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰ä½¿ã†ãŸã‚ã®Twigæ‹¡å¼µ

ãã‚Œãã‚Œã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

#### ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ç”¨ã®Trait

```php
// src/Routing/ReturnToAwareControllerTrait.php

namespace App\Routing;

use Symfony\Component\DependencyInjection\ContainerInterface;
use Symfony\Component\HttpFoundation\RedirectResponse;

/**
 * @property ContainerInterface $container
 */
trait ReturnToAwareControllerTrait
{
    protected function redirectOrReturn(string $url, int $status = 302): RedirectResponse
    {
        if ($returnTo = $this->container->get('request_stack')->getCurrentRequest()->query->get('returnTo')) {
            return new RedirectResponse($returnTo, $status);
        }

        return new RedirectResponse($url, $status);
    }

    protected function redirectToRouteOrReturn(string $route, array $parameters = [], int $status = 302): RedirectResponse
    {
        return $this->redirectOrReturn($this->container->get('router')->generate($route, $parameters), $status);
    }
}
```

ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚

ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã¯ `AbstractController` ã‚’ç¶™æ‰¿ã—ã¦ã„ã‚‹ã“ã¨ã‚’å‰æã«ã—ã¦ã„ã‚‹ã®ã§ã€ `$this->container` ã‹ã‚‰ç¾åœ¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚„ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®UrlGeneratorã‚’å–å¾—ã—ã¦ä½¿ã£ã¦ã„ã¾ã™ã€‚

ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã§ã¯ã€ã“ã®Traitã‚’ `use` ã—ãŸä¸Šã§ `$this->redirectToRouteOrReturn('user_index');` ãªã©ã¨æ›¸ã„ã¦ãŠã‘ã°ã€

* `returnTo` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ãã“ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
* ãªã‘ã‚Œã° `/user/` ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

ã¨ã„ã†æŒ¯ã‚‹èˆã„ã‚’ã—ã¦ãã‚Œã¾ã™ã€‚

ã¨ã„ã†ã‚ã‘ã§ã€ä»Šå¾Œã¯ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã§ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç†ã¯ã™ã¹ã¦ [ã“ã®ã‚ˆã†ã«](https://github.com/ttskch/symfony-example-app/commit/37345f7145a5efd6e8ca1ba11257bd9ea8d77b7a#diff-5873f79fbdd8f6affa13dd6dcecf2fc45ee48c7da1d168005561a3134c13060c) `$this->redirectToRoute()` ã®ä»£ã‚ã‚Šã« `$this->redirectToRouteOrReturn()` ã‚’ä½¿ã†ã“ã¨ã«ã—ã¾ã™ğŸ‘

#### è‡ªä½œUrlGenerator

```php
// src/Routing/ReturnToAwareUrlGenerator.php

namespace App\Routing;

use Symfony\Component\HttpFoundation\RequestStack;
use Symfony\Component\Routing\Generator\UrlGeneratorInterface;

class ReturnToAwareUrlGenerator
{
    private RequestStack $requestStack;
    private UrlGeneratorInterface $generator;

    public function __construct(RequestStack $requestStack, UrlGeneratorInterface $generator)
    {
        $this->requestStack = $requestStack;
        $this->generator = $generator;
    }

    public function generate(string $name, array $parameters = [], int $referenceType = UrlGeneratorInterface::ABSOLUTE_PATH): string
    {
        if ($returnTo = $this->requestStack->getCurrentRequest()->query->get('returnTo')) {
            return $returnTo;
        }

        return $this->generator->generate($name, $parameters, $referenceType);
    }

    public function generateWithReturnTo(string $name, array $parameters = [], int $referenceType = UrlGeneratorInterface::ABSOLUTE_PATH): string
    {
        $request = $this->requestStack->getCurrentRequest();

        $parameters = array_merge_recursive($parameters, ['returnTo' => $request->query->get('returnTo') ?? $request->getUri()]);

        return $this->generator->generate($name, $parameters, $referenceType);
    }
}
```

ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚

`UrlGeneratorInterface` ã‚’å®Ÿè£…ã—ã¦ã‚¢ãƒ—ãƒªå…¨ä½“ã§ã‚µãƒ¼ãƒ“ã‚¹ã‚’å·®ã—æ›¿ãˆã¦ã‚‚ã„ã„ã®ã§ã™ãŒã€ä¾å­˜ãŒå¤šãã¦å®Ÿè£…ãŒé¢å€’ãªã®ã§ã‚„ã‚Šã¾ã›ã‚“ğŸ˜…

å®Ÿè³ªã“ã®ã‚ã¨ä½œã‚‹Twigæ‹¡å¼µã‹ã‚‰ã—ã‹åˆ©ç”¨ã—ãªã„ã‚µãƒ¼ãƒ“ã‚¹ãªã®ã§ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®UrlGeneratorã‚’ãƒ©ãƒƒãƒ—ã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦ä½œã‚‹ã ã‘ã§ååˆ†ã§ã™ã€‚

`generate()` ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€ `returnTo` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ãã®URLã‚’è¿”ã—ã€ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆUrlGeneratorã¨åŒã˜çµæœã‚’è¿”ã—ã¾ã™ã€‚

`generateWithReturnTo()` ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®UrlGeneratorã¨åŒã˜çµæœã‚’ä½œæˆã—ãŸä¸Šã§ã€ã•ã‚‰ã« `returnTo` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä»˜åŠ ã—ãŸURLã‚’è¿”ã¾ã™ã€‚
ãŸã ã—ã€ç¾åœ¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆURLã«ã™ã§ã« `returnTo` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€æœ€çµ‚çš„ãª `returnTo` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å†…å®¹ã¯ç¾åœ¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆURLã§ã¯ãªãã‚‚ã¨ã‚‚ã¨ã® `returnTo` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å†…å®¹ã‚’è¸è¥²ã—ã¾ã™ã€‚

> ã“ã®ã‚ãŸã‚Šã®æ¡ä»¶ã€æ–‡ç« ã§èª­ã‚€ã¨ã‹ãªã‚Šã‚„ã‚„ã“ã—ãæ„Ÿã˜ã‚‹ã¨æ€ã„ã¾ã™ãŒã€å®Ÿéš›ã«ç”»é¢ã‚’å‹•ã‹ã—ã¦ã¿ã‚Œã°ã“ã®æ¡ä»¶ã§ã‚ˆã•ãã†ã¨ã„ã†ã“ã¨ãŒç›´æ„Ÿçš„ã«åˆ†ã‹ã£ã¦ã„ãŸã ã‘ã‚‹ã¨æ€ã†ã®ã§ã€ã‚ã¾ã‚Šæ·±ãè€ƒãˆãšã«ã‚ã¨ã§å®Ÿéš›ã«ç”»é¢ã‚’å‹•ã‹ã—ã¦ã¿ã¦ãã ã•ã„ğŸ˜…

#### Twigæ‹¡å¼µ

```php
// src/Twig/RoutingExtension.php

namespace App\Twig;

use App\Routing\ReturnToAwareUrlGenerator;
use Symfony\Component\Routing\Generator\UrlGeneratorInterface;
use Twig\Extension\AbstractExtension;
use Twig\TwigFunction;

class RoutingExtension extends AbstractExtension
{
    private ReturnToAwareUrlGenerator $returnToAwareUrlGenerator;

    public function __construct(ReturnToAwareUrlGenerator $returnToAwareUrlGenerator)
    {
        $this->returnToAwareUrlGenerator = $returnToAwareUrlGenerator;
    }

    public function getFunctions()
    {
        return [
            new TwigFunction('pathOrReturnTo', [$this, 'pathOrReturnTo']),
            new TwigFunction('pathWithReturnTo', [$this, 'pathWithReturnTo']),
        ];
    }

    /**
     * @see \Symfony\Bridge\Twig\Extension\RoutingExtension::getPath()
     */
    public function pathOrReturnTo(string $name, array $parameters = [], bool $relative = false)
    {
        return $this->returnToAwareUrlGenerator->generate($name, $parameters, $relative ? UrlGeneratorInterface::RELATIVE_PATH : UrlGeneratorInterface::ABSOLUTE_PATH);
    }

    public function pathWithReturnTo(string $name, array $parameters = [], bool $relative = false)
    {
        return $this->returnToAwareUrlGenerator->generateWithReturnTo($name, $parameters, $relative ? UrlGeneratorInterface::RELATIVE_PATH : UrlGeneratorInterface::ABSOLUTE_PATH);
    }
}
```

ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚

ã•ã£ãä½œã£ãŸ `ReturnToAwareUrlGenerator` ã‚’ä½¿ã£ã¦ã€ `pathOrReturnTo()` ã¨ `pathWithReturnTo()` ã¨ã„ã†2ã¤ã®Twigé–¢æ•°ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

ã‚ãˆã¦æ—¢å­˜ã® `AppExtension` ã¨ã¯åˆ†ã‘ã¦ `RoutingExtension` ã¨ã„ã†åˆ¥ã‚¯ãƒ©ã‚¹ã§å®šç¾©ã—ã¾ã—ãŸã€‚ãªã®ã§ã€ `config/services.yaml` ã«

```yaml
App\Twig\RoutingExtension:
    tags: ['twig.extension']
```

ã‚’è¿½è¨˜ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™âœ‹

ã‚ã¨ã¯ã€

* [ä¸€è¦§ç”»é¢ã‹ã‚‰è¿½åŠ ãƒ»ç·¨é›†ç”»é¢ã¸ã®ãƒªãƒ³ã‚¯ã¯æ¨™æº–ã® `path()` ã®ä»£ã‚ã‚Šã« `pathWithReturnTo()` ã§ãƒªãƒ³ã‚¯å…ˆã‚’ç”Ÿæˆ](https://github.com/ttskch/symfony-example-app/commit/37345f7145a5efd6e8ca1ba11257bd9ea8d77b7a#diff-1531818f336c6925801382ec45b23f1f49d691040b3792efc02c132b3a5b5b6a)
* [è¿½åŠ ãƒ»ç·¨é›†ç”»é¢ã® `ã‚­ãƒ£ãƒ³ã‚»ãƒ«` ãƒªãƒ³ã‚¯ã¯æ¨™æº–ã® `path()` ã®ä»£ã‚ã‚Šã« `pathOrReturnTo()` ã§ãƒªãƒ³ã‚¯å…ˆã‚’ç”Ÿæˆ](https://github.com/ttskch/symfony-example-app/commit/37345f7145a5efd6e8ca1ba11257bd9ea8d77b7a#diff-f29062df2b488e2efab1c8205484e079905f216733b8a0402baff4b6c952cb17)

ã™ã‚‹ã‚ˆã†ã«ãƒ“ãƒ¥ãƒ¼ã‚’ä¿®æ­£ã™ã‚Œã°å®Œäº†ã§ã™ğŸ™Œ

æ‰‹å…ƒã§ã‚³ãƒ¼ãƒ‰ã‚’å†ç¾ã—ã¦å‹•ã‹ã—ã¦ã„ã‚‹æ–¹ã‚„ã€å®Œæˆå“ã®ãƒ‡ãƒ¢ç’°å¢ƒã‚’è¦‹ã¦ã„ã‚‹æ–¹ã¯ãœã²å®Ÿéš›ã«ä¸€è¦§ç”»é¢ã¨è¿½åŠ ãƒ»ç·¨é›†ç”»é¢ã®é–“ã®ç”»é¢é·ç§»ã‚’ã„ã‚ã„ã‚è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

ç›´æ„Ÿçš„ã«æ°—æŒã¡ã‚ˆã„å‹•ä½œã«ãªã£ã¦ã„ã‚‹ã“ã¨ãŒå®Ÿæ„Ÿã„ãŸã ã‘ã‚‹ã¨æ€ã„ã¾ã™ğŸ’ª
