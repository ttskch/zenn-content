---
title: "Security Voterã‚’ä½¿ã£ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†ãƒ»å‰Šé™¤ã®æ¨©é™ã‚’æ•´ç†"
---

# ã“ã®ç« ã«å¯¾å¿œã™ã‚‹ã‚³ãƒŸãƒƒãƒˆ

* [ğŸ“ Security Voterã‚’ä½¿ã£ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†ãƒ»å‰Šé™¤ã®æ¨©é™ã‚’æ•´ç†](https://github.com/ttskch/symfony-example-app/compare/9a51fb4...016301d)

# Security Voterã‚’ä½¿ã£ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†ãƒ»å‰Šé™¤ã®æ¨©é™ã‚’æ•´ç†

ã˜ã£ãã‚Šè§£èª¬ã—ã¦ããŸãƒ¦ãƒ¼ã‚¶ãƒ¼å‘¨ã‚Šã®å®Ÿè£…ã‚‚ã“ã‚Œã§ã‚„ã£ã¨æœ€å¾Œã§ã™ã€‚

ç¾çŠ¶ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ç”»é¢ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯ã€

```php
/**
 * @IsGranted("ROLE_ALLOWED_TO_EDIT_USER")
 */
```

ã‚„

```twig
{% if is_granted('ROLE_ALLOWED_TO_EDIT_USER') %}
  <a href="{{ pathWithReturnTo('user_edit', {id: user.id}) }}" class="ml-sm-3">ç·¨é›†</a>
{% endif %}
```

ã®ã‚ˆã†ã«ã€ `ROLE_ALLOWED_TO_EDIT_USER` æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã ã‘ã«åˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚

ãŒã€é€†ã«è¨€ãˆã° `ROLE_ALLOWED_TO_EDIT_USER` æ¨©é™ã•ãˆæŒã£ã¦ã„ã‚Œã°èª°ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ã‘ã§ã€ä¾‹ãˆã° `ROLE_ALLOWED_TO_EDIT_USER`ã—ã‹æŒã£ã¦ã„ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ `ROLE_ALLOWED_TO_ADMIN` ã‚’æŒã£ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç·¨é›†ã—ã¦ã—ã¾ã†ã“ã¨ã‚‚ã§ãã‚‹çŠ¶æ…‹ã§ã™ã€‚

ã“ã‚Œã£ã¦ã¡ã‚‡ã£ã¨å¤‰ã§ã™ã‚ˆã­ã€‚

ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç·¨é›†ã§ãã‚‹æ¨©é™ã€ã¨ã€Œç®¡ç†è€…æ¨©é™ã€ã¯ãã‚Œãã‚Œåˆ¥ã€…ã®å½¹å‰²ã§ã¯ã‚ã‚Šã¾ã™ãŒã€ãã“ã«ã¯æ˜ç¢ºãªä¸Šä¸‹é–¢ä¿‚ãŒã‚ã‚Šã€**ç®¡ç†è€…ã®è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ã¯ç®¡ç†è€…ã§ãªã„ã¨ã§ããªã„ã‚ˆã†ã«ã—ãŸã„** ã¨ã„ã†è¦ä»¶ãŒè¦‹ãˆã¦ãã¾ã™ã€‚

ã¾ãŸã€å¤šãã®å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†è‡ªèº«ã‚’å‰Šé™¤ã§ãã¦ã—ã¾ã†ã“ã¨ã‚‚å•é¡Œã«ãªã‚Šã¾ã™ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†ç”»é¢ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã®ã¯ `ROLE_ALLOWED_TO_EDIT_USER` ã‚’æŒã£ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã ã‘ã§ã™ã‹ã‚‰ã€ã‚‚ã—ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå”¯ä¸€ã® `ROLE_ALLOWED_TO_EDIT_USER` ä¿æœ‰è€…ã ã£ãŸå ´åˆã€è‡ªåˆ†ã‚’å‰Šé™¤ã§ãã¦ã—ã¾ã†ã¨ä»–ã«èª°ã‚‚ `ROLE_ALLOWED_TO_EDIT_USER` ã‚’æŒã£ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ãªã„çŠ¶æ³ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

ã“ã‚Œã§ã¯å›°ã‚‹ã®ã§ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†è‡ªèº«ã‚’å‰Šé™¤ã§ããªã„ã‚ˆã†ã«ã—ãŸã„** ã¨ã„ã†è¦ä»¶ã‚‚å¿…è¦ãã†ã§ã™ã€‚

ã¨ã„ã†ã‚ã‘ã§ã€[Security Voter](https://symfony.com/doc/current/security/voters.html) ã‚’ä½¿ã£ã¦ã“ã‚Œã‚‰ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

ãªãŠã€Security Voterã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®éå»è¨˜äº‹ã§è©³ã—ãèª¬æ˜ã—ã¦ã„ã¾ã™ã®ã§ã€ãœã²ã‚ã‚ã›ã¦ã”å‚ç…§ãã ã•ã„âœ‹

> [[Symfony] Security Voterã‚’ä½¿ã£ã¦ã€Œãƒªã‚½ãƒ¼ã‚¹ã®æ‰€æœ‰è€…ã§ãªã„ã¨ç·¨é›†ä¸å¯ã€ã‚’å®Ÿè£…ã—ã¦ã¿ã‚ˆã†](https://zenn.dev/ttskch/articles/5ef96bf6e9d835)

## Voterã‚’å®Ÿè£…

```php
// src/Security/Voter/UserVoter.php

namespace App\Security\Voter;

use App\Entity\User;
use App\Security\RoleManager;
use Symfony\Component\Security\Core\Authentication\Token\TokenInterface;
use Symfony\Component\Security\Core\Authorization\Voter\Voter;

class UserVoter extends Voter
{
    const EDIT = 'EDIT';
    const DELETE = 'DELETE';

    private RoleManager $rm;

    public function __construct(RoleManager $rm)
    {
        $this->rm = $rm;
    }

    protected function supports($attribute, $subject)
    {
        if (!in_array($attribute, [
            self::EDIT,
            self::DELETE,
        ])) {
            return false;
        }

        if (!$subject instanceof User) {
            return false;
        }

        return true;
    }

    protected function voteOnAttribute($attribute, $subject, TokenInterface $token)
    {
        $user = $token->getUser();

        if (!$user instanceof User) {
            return false;
        }

        switch ($attribute) {
            case self::EDIT:
                return $this->canEdit($subject, $user);
            case self::DELETE:
                return $this->canDelete($subject, $user);
        }

        throw new \LogicException();
    }

    private function canEdit(User $them, User $me)
    {
        if (!$this->rm->isGranted($me, 'ROLE_ALLOWED_TO_EDIT_USER')) {
            return false;
        }

        // ç®¡ç†è€…ã«å¯¾ã™ã‚‹ç·¨é›†ã¯ç®¡ç†è€…ã—ã‹ã§ããªã„
        if ($this->rm->isGranted($them, 'ROLE_ALLOWED_TO_ADMIN')) {
            if (!$this->rm->isGranted($me, 'ROLE_ALLOWED_TO_ADMIN')) {
                return false;
            }
        }

        return true;
    }

    private function canDelete(User $them, User $me): bool
    {
        // ç·¨é›†å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã¯å‰æã¨ã—ã¦ã€ç›¸æ‰‹ãŒè‡ªåˆ†è‡ªèº«ã§ãªã„å ´åˆã«ã—ã‹å‰Šé™¤ã¯ã§ããªã„
        return $this->canEdit($them, $me) && $them !== $me;
    }
}
```

ã“ã‚Œã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«å¯¾ã™ã‚‹ç·¨é›†å¯å¦ã®åˆ¤å®šãŒVoterçµŒç”±ã§ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸğŸ‘

## ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã® `@IsGranted` ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®å†…å®¹ã‚’ä¿®æ­£

ä»¥ä¸‹ã®ã‚ˆã†ã« `edit` `change_password` `delete` ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¿®æ­£ã—ã¾ã™ã€‚

```diff
  /**
   * @Route("/{id}/edit", name="edit", methods={"GET", "POST"})
-  * @IsGranted("ROLE_ALLOWED_TO_EDIT_USER")
+  * @IsGranted("EDIT", subject="user", statusCode=403)
   */
  public function edit(Request $request, User $user)
```

```diff
  /**
   * @Route("/{id}/change_password", name="change_password", methods={"GET", "POST"})
-  * @IsGranted("ROLE_ALLOWED_TO_EDIT_USER")
+  * @IsGranted("EDIT", subject="user", statusCode=403)
   */
  public function changePassword(Request $request, User $user)
```

```diff
  /**
   * @Route("/delete/{id}", name="delete", methods={"GET", "DELETE"})
-  * @IsGranted("ROLE_ALLOWED_TO_EDIT_USER")
+  * @IsGranted("EDIT", subject="user", statusCode=403)
   */
  public function delete(Request $request, User $user)
```

## ãƒ“ãƒ¥ãƒ¼ã® `{% if is_granted() %}` ã®å†…å®¹ã‚’ä¿®æ­£

ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†ç”»é¢ã¸ã®ãƒªãƒ³ã‚¯ã‚’å›²ã£ã¦ã„ã‚‹ `if` æ–‡ã‚’ä¿®æ­£ã—ã¾ã™ã€‚

```diff
  # user/index.html.twig
  
- {% if is_granted('ROLE_ALLOWED_TO_EDIT_USER') %}
+ {% if is_granted('EDIT', user) %}
    <a href="{{ pathWithReturnTo('user_edit', {id: user.id}) }}" class="ml-sm-3">ç·¨é›†</a>
  {% endif %}
```

```diff
  # user/show.html.twig
  
- {% if is_granted('ROLE_ALLOWED_TO_EDIT_USER') %}
+ {% if is_granted('EDIT', user) %}
    <li class="nav-item">
      <a href="{{ path('user_edit', {id: user.id}) }}" class="nav-link">ç·¨é›†</a>
    </li>
  {% endif %}
```

ã¾ãŸã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ç”»é¢ã¸ã®ãƒªãƒ³ã‚¯ã‚’æ–°ãŸã« `if` æ–‡ã§å›²ã„ã¾ã™ã€‚

```diff
+ {% if is_granted('DELETE', user) %}
    <div class="float-left">
      <a href="{{ path('user_delete', {id: user.id}) }}" class="btn btn-outline-danger">å‰Šé™¤...</a>
    </div>
+ {% endif %}
```

ã“ã‚Œã§ã€å¯¾å¿œå®Œäº†ã§ã™ï¼ğŸ™Œ
