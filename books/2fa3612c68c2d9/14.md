---
title: "CRUDã‚’å®Ÿè£…"
---

# ã“ã®ç« ã«å¯¾å¿œã™ã‚‹ã‚³ãƒŸãƒƒãƒˆ

* [ğŸ“ CRUDã‚’å®Ÿè£…](https://github.com/ttskch/symfony-example-app/commit/6fd12654a6158d04d4082c107418f406dee59ec6)

> ãƒ‡ãƒ¢ã‚¢ãƒ—ãƒªã¯æ—¥æœ¬èªã¨è‹±èªã«å¯¾å¿œã™ã‚‹ãŸã‚ã™ã¹ã¦ã®æ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«ã‚’ç¿»è¨³ã—ã¦ã„ã‚‹ã®ã§ã€ã‚³ãƒŸãƒƒãƒˆã®å†…å®¹ã¯æœ¬æ–‡ã®è§£èª¬ã¨è‹¥å¹²ç•°ãªã‚Šã¾ã™ã€‚

# CRUDã‚’å®Ÿè£…

`Customer` ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨ã€ãã®å­ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã§ã‚ã‚‹ `Person` ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ä½œã£ãŸã®ã§ã€æ¬¡ã¯ `Customer` ã®CRUDã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

## `make:crud` ã‚’ä½¿ã†ã‹ã€æ—¢å­˜ã®CRUDã‚’ã‚³ãƒ”ãƒšã™ã‚‹

`make:crud` ã‚’ä½¿ãˆã°CRUDã®ãŸã‚ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ»ãƒ•ã‚©ãƒ¼ãƒ ãƒ»ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¸€æ°—ã«è‡ªå‹•ç”Ÿæˆã—ã¦ãã‚Œã¾ã™ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®CRUDã‚’ä½œã‚‹ç« ã§ã‚‚è¿°ã¹ãŸã¨ãŠã‚Šã€åƒ•ã®å ´åˆã¯è‡ªå‹•ç”Ÿæˆã—ãŸã‚ã¨ã«æ‰‹ã§ä¿®æ­£ã™ã‚‹éƒ¨åˆ†ãŒå¤šã„ã®ã§åŸºæœ¬çš„ã«ã¯åˆ¥ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®CRUDã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒšã—ã¦ã‹ã‚‰æ–‡å­—åˆ—ã®ä¸€æ‹¬ç½®æ›ãªã©ã§å†…å®¹ã‚’å¤‰æ›´ã—ã¦ãƒ™ãƒ¼ã‚¹ã‚’ä½œã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã€‚

ã“ã®è¾ºã¯å¥½ã¿ã¨ã„ã†ã‹è‡ªåˆ†ãŒæ¥½ãªæ–¹æ³•ã§ã‚„ã‚Œã°ã„ã„ã‹ãªã¨æ€ã„ã¾ã™ã€‚

## FormType

ã¾ãšã¯ `Person` `Customer` ãã‚Œãã‚Œã®FormTypeã‚’ä½œæˆã—ã¾ã™ã€‚

```php
// src/Form/Customer/PersonType.php

class PersonType extends AbstractType
{
    public function buildForm(FormBuilderInterface $builder, array $options)
    {
        $builder
            ->add('fullName', TextType::class, [
                'label' => 'æ°å',
                'attr' => [
                    'required' => true,
                ],
                'label_attr' => [
                    'class' => 'required',
                ],
                'constraints' => [
                    new Assert\NotBlank(),
                ],
            ])
            ->add('email', EmailType::class, [
                'required' => false,
                'label' => 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹',
            ])
            ->add('tel', TelType::class, [
                'required' => false,
                'label' => 'é›»è©±ç•ªå·',
            ])
            ->add('address', TextareaType::class, [
                'required' => false,
                'label' => 'ä½æ‰€',
                'attr' => [
                    'rows' => 3,
                ],
            ])
        ;
    }

    public function configureOptions(OptionsResolver $resolver)
    {
        $resolver->setDefaults([
            'data_class' => Person::class,
        ]);
    }
}
```

`fullName` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å¯¾ã—ã¦ä½•ã‚„ã‚‰ã”ã¡ã‚ƒã”ã¡ã‚ƒã‚„ã£ã¦ã„ã¾ã™ãŒã€ã“ã‚Œã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®éå»è¨˜äº‹ã§è§£èª¬ã—ã¦ã„ã‚‹ã®ã§ã”å‚ç…§ãã ã•ã„ğŸ™

> [[Symfony] ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã„ã¦å­ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå´ã®NotBlankåˆ¶ç´„ãŒç„¡è¦–ã•ã‚Œã‚‹ã‚±ãƒ¼ã‚¹ã«ã¤ã„ã¦](https://zenn.dev/ttskch/articles/c596276f0d50d3)

```php
// src/Form/CustomerType.php

class CustomerType extends AbstractType
{
    private TranslatorInterface $translator;

    public function __construct(TranslatorInterface $translator)
    {
        $this->translator = $translator;
    }

    public function buildForm(FormBuilderInterface $builder, array $options)
    {
        $builder
            ->add('state', ChoiceType::class, [
                'label' => 'çŠ¶æ…‹',
                'choices' => array_combine(CustomerConstant::getValidStates(), CustomerConstant::getValidStates()),
                'multiple' => false,
                'placeholder' => '',
                'attr' => [
                    'data-placeholder' => 'é¸æŠã—ã¦ãã ã•ã„',
                    'data-allow-clear' => true,
                    'class' => 'w-100',
                ],
            ])
            ->add('name', TextType::class, [
                'label' => 'é¡§å®¢å',
            ])
            ->add('people', CollectionType::class, [
                'required' => false,
                'entry_type' => PersonType::class,
                'label' => 'å…ˆæ–¹æ‹…å½“è€…',
                'prototype' => true,
                'allow_add' => true,
                'allow_delete' => true,
            ])
        ;
    }

    public function configureOptions(OptionsResolver $resolver)
    {
        $resolver->setDefaults([
            'data_class' => Customer::class,
        ]);
    }
}
```

CollectionTypeã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚„ã‚„è¤‡é›‘ã§ã™ãŒã€ã“ã‚Œã«ã¤ã„ã¦ã‚‚ä»¥ä¸‹ã®éå»è¨˜äº‹ã‚’ã”å‚ç…§ãã ã•ã„ğŸ™

> [[Symfony/Form] CollectionTypeã®åŸºæœ¬çš„ãªä½¿ã„æ–¹](https://zenn.dev/ttskch/articles/3e846a1aa5eb40)

`CustomerType` ã® `state` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã® `choices` ãŒ `CustomerConstant::getValidStates()` ã‚’å¼•ã„ã¦ã„ã‚‹ã®ã§ã€é¸æŠè‚¢ãŒå¢—æ¸›ã—ã¦ã‚‚ `CustomerConstant` ã‚¯ãƒ©ã‚¹ã‚’ä¿®æ­£ã™ã‚‹ã ã‘ã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚FormTypeã‚‚å¯¾å¿œå®Œäº†ã§ãã¦å¬‰ã—ã„ã§ã™ã­ğŸ‘Œ

ã“ã®ã¾ã¾ã§ã‚‚ç‰¹ã«å•é¡Œã¯ãªã„ã®ã§ã™ãŒã€åƒ•ã¯ã„ã¤ã‚‚ã“ã†ã„ã†å®šæ•°é¸æŠç³»ã®ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ãã‚Œãã‚Œå€‹åˆ¥ã®FormTypeã¨ã—ã¦å®šç¾©ã—ã¦ã€åˆ¥ã®ãƒ•ã‚©ãƒ¼ãƒ ã§ã„ã¤ã§ã‚‚ä½¿ã„å›ã›ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

```php
// src/Form/Customer/StateChoiceType.php

class StateChoiceType extends ChoiceType
{
    public function configureOptions(OptionsResolver $resolver)
    {
        parent::configureOptions($resolver);

        $resolver->setDefaults([
            'choices' => array_combine(CustomerConstant::getValidStates(), CustomerConstant::getValidStates()),
            'multiple' => false,
            'placeholder' => '',
            'attr' => [
                'data-placeholder' => 'é¸æŠã—ã¦ãã ã•ã„',
                'data-allow-clear' => true,
                'class' => 'w-100',
            ],
        ]);
    }
}
```

```diff
  // src/Form/CustomerType.php
  
  public function buildForm(FormBuilderInterface $builder, array $options)
  {
      $builder
-         ->add('state', ChoiceType::class, [
+         ->add('state', StateChoiceType::class, [
              'label' => 'çŠ¶æ…‹',
-             'choices' => array_combine(CustomerConstant::getValidStates(), CustomerConstant::getValidStates()),
-             'multiple' => false,
-             'placeholder' => '',
-             'attr' => [
-                 'data-placeholder' => 'é¸æŠã—ã¦ãã ã•ã„',
-                 'data-allow-clear' => true,
-                 'class' => 'w-100',
-             ],
          ])
          ->add('name', TextType::class, [
              'label' => 'é¡§å®¢å',
          ])
          ->add('people', CollectionType::class, [
              'required' => false,
              'entry_type' => PersonType::class,
              'label' => 'å…ˆæ–¹æ‹…å½“è€…',
              'prototype' => true,
              'allow_add' => true,
              'allow_delete' => true,
          ])
      ;
  }
```

## ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©

æ¬¡ã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã‚’æ›¸ãã¾ã™ã€‚

å†…å®¹çš„ã«ã¯ `make:crud` ã‚³ãƒãƒ³ãƒ‰ã§è‡ªå‹•ç”Ÿæˆã—ãŸã‚³ãƒ¼ãƒ‰ã‚’å¤šå°‘æ•´å½¢ã—ã¦ã€è‡ªä½œã® `ReturnToAwareControllerTrait` ã‚’é©ç”¨ã—ãŸã‚Šãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’å°å…¥ã—ãŸã‚Šã™ã‚‹ãã‚‰ã„ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®CRUDã‚’ä½œã£ãŸã¨ãã¨ã»ã¼åŒã˜ãªã®ã§ã€è©³ç´°ãªèª¬æ˜ã¯å‰²æ„›ã—ã¾ã™ğŸ™

æœ€çµ‚çš„ãªã‚³ãƒ¼ãƒ‰ã¯ [ã“ã‚“ãªæ„Ÿã˜](https://github.com/ttskch/symfony-example-app/blob/6fd12654a6158d04d4082c107418f406dee59ec6/src/Controller/CustomerController.php) ã«ãªã‚Šã¾ã™ã€‚

## ãƒ“ãƒ¥ãƒ¼

æœ€å¾Œã¯ãƒ“ãƒ¥ãƒ¼ã®å®Ÿè£…ã§ã™ã€‚

ã“ã‚Œã‚‚ã»ã¨ã‚“ã©ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®CRUDã‚’ä½œã£ãŸã¨ãã¨åŒã˜ã§ã™ãŒã€ä¸€ç‚¹ã€ä»Šå›ã¯ãƒ•ã‚©ãƒ¼ãƒ ã« `allow_add` `allow_delete` ãªCollectionTypeã‚’ä½¿ã£ãŸã®ã§ã€ãƒ•ãƒ­ãƒ³ãƒˆå´ã§å¤šå°‘ã®DOMæ“ä½œãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

ã“ã®è¾ºã‚Šã®å‡¦ç†ã¯æ¯å›æ›¸ãã®ã¯é¢å€’ãã•ã™ãã‚‹ã®ã§ã€ã„ã¤ã§ã‚‚ä½¿ã„å›ã›ã‚‹ã‚ˆã†ã«éƒ¨å“åŒ–ã—ã¦ãŠãã¾ã™ã€‚

```twig
{% macro template(form) %}
  {% set wrap = form.children|length > 1 %}
  <div class="{% if wrap %}card mb-3{% endif %} collection-item">
    <div class="{% if wrap %}card-body mb-n3{% endif%} d-flex">
      <div class="flex-grow-1">
        {{ form_widget(form, {attr: {class: 'mb-2'}}) }}
      </div>
      <div class="ml-2">
        <button type="button" class="btn btn-sm btn-outline-secondary collection-item-remover">
          <i class="far fa-trash-alt"></i>
        </button>
      </div>
    </div>
  </div>
{% endmacro %}

<div class="form-collection">
  {% for childForm in form.children %}
    {{ _self.template(childForm) }}
  {% endfor %}

  <div class="placeholder"></div>
  <button type="button" class="btn btn-block btn-outline-secondary m-0 collection-item-adder"><i class="fa fa-plus"></i> è¿½åŠ </button>
  <div class="prototype" data-prototype="{{ _self.template(form.vars.prototype)|e }}" data-last-index="{{ form|length - 1 }}" data-required-num="{{ requiredNum ?? 0 }}"></div>
</div>
```

ã“ã‚“ãªæ„Ÿã˜ã®Twigéƒ¨å“ã¨ã€

```js
import applySelect2 from '../lib/applySelect2';

ensureRemoverDisabled();

$(document).on('click', '.collection-item-adder', function () {
  const $prototype = $(this).closest('.form-collection').find('.prototype');
  const $placeholder = $(this).closest('.form-collection').find('.placeholder');

  let lastIndex = parseInt($prototype.data('last-index'));
  const html = $prototype.data('prototype').replace(/__name__/g, ++lastIndex);
  const $element = $(html);
  $placeholder.append($element);
  $prototype.data('lastIndex', lastIndex);

  applySelect2($element.find('select'));
  ensureRemoverDisabled();
});

$(document).on('click', '.collection-item-remover', function () {
  $(this).closest('.collection-item').remove();

  ensureRemoverDisabled();
});

function ensureRemoverDisabled() {
  $('.prototype').each(function () {
    const requiredNum = $(this).data('required-num');
    const $removers = $(this).closest('.form-collection').find('.collection-item-remover');

    if ($removers.length <= requiredNum) {
      $removers.prop('disabled', true);
    } else {
      $removers.prop('disabled', false);
    }
  });
}
```

Twigã®ãƒãƒ¼ã‚¯ã‚¢ãƒƒãƒ—ã«å¯¾å¿œã™ã‚‹ã“ã‚“ãªæ„Ÿã˜ã®JavaScriptã®å‡¦ç†ã‚’ç”¨æ„ã—ã¦ãŠãã¾ã™ã€‚

> ãƒãƒ¼ã‚¯ã‚¢ãƒƒãƒ—ã¨JavaScriptã®å‡¦ç†ã®èª¬æ˜ã¯ã“ã“ã§ã¯å‰²æ„›ã—ã¾ã™ãŒã€ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯å¤ãè‰¯ãjQueryã‚’ä½¿ã£ãŸã‚´ãƒªã‚´ãƒªã®DOMæ“ä½œã ã‘ãªã®ã§ãã‚“ãªã«é›£ã—ãã¯ã‚ã‚Šã¾ã›ã‚“ğŸ‘Œ

JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã¯å¿˜ã‚Œãšã«Webpack Encoreã‚¨ãƒ³ãƒˆãƒªãƒ¼ã¨ã—ã¦è¿½åŠ ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

```diff
  Encore
+   .addEntry('widgets_form-collection', [
+     './assets/js/widgets/form-collection.js',
+   ])
```

ã“ã®ä¸Šã§ã€ `new.html.twig` ã¨ `edit.html.twig` ã§ã®ã¿

```twig
{% block javascripts %}
  {{ parent() }}
  {{ encore_entry_script_tags('widgets_form-collection') }}
{% endblock %}
```

ã¨ã—ã¦ã‚¢ã‚»ãƒƒãƒˆã®èª­ã¿è¾¼ã¿ã‚’è¡Œã†ã‚ˆã†ã«ã—ã¾ã™ã€‚

ãƒ•ã‚©ãƒ¼ãƒ éƒ¨åˆ†ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®è¨˜è¿°ã¯ã“ã‚“ãªæ„Ÿã˜ã«ãªã‚Šã¾ã™ã€‚

```twig
{{ form_start(form) }}
{{ form_errors(form) }}
{{ form_row(form.state) }}
{{ form_row(form.name) }}
<div class="form-group row">
  {{ form_label(form.people) }}
  <div class="col-sm-9">
    {% include 'widgets/form-collection.html.twig' with {
      form: form.people,
    } %}
  </div>
</div>
<div class="float-right">
  <button type="submit" class="btn btn-primary float-right ml-2">ä¿å­˜</button>
  <a href="{{ cancelPath }}" class="btn btn-outline-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
</div>
{{ form_widget(form._token) }}
{{ form_end(form, {render_rest: false}) }}
```

## å‹•ä½œç¢ºèª

ã“ã‚Œã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã„ã„æ„Ÿã˜ãªé¡§å®¢ã®CRUDãŒå®Œæˆã—ã¾ã—ãŸğŸ™Œ

![](https://tva1.sinaimg.cn/large/0081Kckwgy1glwxxszwr3j327u0h83yu.jpg)

![](https://tva1.sinaimg.cn/large/0081Kckwgy1glwxzdak04j327s0r8js9.jpg)

![](https://tva1.sinaimg.cn/large/0081Kckwgy1glwxzxu6u8j31b20u0abc.jpg)
