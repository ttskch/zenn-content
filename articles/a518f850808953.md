---
title: "[Symfony] Userã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«plainPasswordãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¨­ã‘ã¦æ‰±ã„ã‚„ã™ãã™ã‚‹"
emoji: "ğŸ»"
type: "tech"
topics: ["php", "symfony"]
published: true
published_at: 2020-04-24
---

:::message
ã“ã®è¨˜äº‹ã¯ã€2020-04-24ã«åˆ¥ã®ãƒ–ãƒ­ã‚°åª’ä½“ã«æŠ•ç¨¿ã—ãŸè¨˜äº‹ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ã™ã€‚
:::

ä»¥å‰ã€ä»¥ä¸‹ã®è¨˜äº‹ã§Symfonyã‚¢ãƒ—ãƒªã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã‚’è¿½åŠ ã‚‹åŸºæœ¬çš„ãªæ‰‹é †ã‚’èª¬æ˜ã—ã¾ã—ãŸã€‚

> [[Symfony] FOSUserBundleã‚’ä½¿ã‚ãªãã¦ã‚‚15åˆ†ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³ã¯å®Ÿè£…ã§ãã‚‹ | blog.ttskch](https://blog.ttskch.com/symfony-no-longer-needs-fosuserbundle/)

ä»Šå›ã¯ã“ã‚Œã®å°‘ã—ã ã‘ç™ºå±•ç·¨ã§ã™ã€‚

`bin/console make:user` ã‚³ãƒãƒ³ãƒ‰ã§ä½œã£ãŸUserã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¯ `password` ã¨ã„ã†ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ¸ˆã¿ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä¿æŒã™ã‚‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã—ã‹æŒãŸãªã„ãŸã‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã§ãã‚‹ã‚ˆã†ãªæ“ä½œãŒã‚¢ãƒ—ãƒªå†…ã®è¤‡æ•°ç®‡æ‰€ã«ã‚ã‚‹å ´åˆã€ **å…¥åŠ›ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦ `password` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã‚»ãƒƒãƒˆã€ã¨ã„ã†ã®ã‚’ã™ã¹ã¦ã®ç®‡æ‰€ã§ã‚„ã‚‰ãªã‘ã‚Œã°ãªã‚‰ãšã€é¢å€’ã§ã™ã€‚** ğŸ˜“

ã¾ãŸã€ä»¥ä¸‹ã®è¨˜äº‹ã§è§£èª¬ã—ã¦ã„ã¾ã™ãŒã€

> [Symfonyã§ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®ç”»é¢ã‚’æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã™ã‚‹æ–¹æ³•ã€ç°¡å˜ã§ã™ã€‘ | blog.ttskch](https://blog.ttskch.com/symfony-simulate-login-on-functional-test/)

ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã‚’ä½¿ã£ã¦ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®ç”»é¢ã‚’æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã—ãŸã„å ´åˆã«ã€Userã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒ `password` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã—ã‹æŒãŸãªã„ã¨ã€[è¨˜äº‹å†…ã§è§£èª¬ã—ã¦ã„ã‚‹ã¨ãŠã‚Š](https://blog.ttskch.com/symfony-simulate-login-on-functional-test/#2)ã€

1. `bin/console security:encode-password {ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰}` ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹
2. ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥ã‚’ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã«æ›¸ã

ã¨ã„ã†ã¡ã‚‡ã£ã¨é¢å€’ãªã“ã¨ã‚’ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ğŸ™„

ã¨ã„ã†ã‚ã‘ã§ã€å‰ç½®ããŒé•·ããªã‚Šã¾ã—ãŸãŒã€ã“ã®ã‚ˆã†ãªå•é¡Œã‚’è§£æ±ºã™ã‚‹å®šçŸ³ã‚’èª¬æ˜ã—ã¾ã™âœ‹

# Userã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã« `plainPassword` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¿½åŠ 

ã¾ãšã€Userã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã« `plainPassword` ã¨ã„ã£ãŸãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¿½åŠ ã—ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¹³æ–‡ã‚’æŒã¦ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ï¼ˆã‚‚ã¡ã‚ã‚“DBã«ã¯ä¿å­˜ã—ã¾ã›ã‚“ï¼‰

```php
// â€» @ORM\Column(...) ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã—ã¦ã„ãªã„ã“ã¨ã«æ³¨æ„
private $plainPassword;

// ...

public function getPlainPassword(): ?string
{
    return $this->plainPassword ? (string) $this->plainPassword : null;
}

public function setPlainPassword(?string $plainPassword): self
{
    $this->plainPassword = $plainPassword;

    return $this;
}

// ...

public function eraseCredentials()
{
    $this->plainPassword = null;
}
```

ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®è¿½åŠ ã«åŠ ãˆã¦ã€[`eraseCredentials()` ãƒ¡ã‚½ãƒƒãƒ‰](https://github.com/symfony/security/blob/b8aceecf827b9fba021557a5c39028bbe3190959/Core/User/UserInterface.php#L83) ã‚’ã€ `plainPassword` ã‚’ç ´æ£„ã™ã‚‹ã‚ˆã†ã«é©åˆ‡ã«å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

# Entity Listenerã‚’ä½¿ã£ã¦ `plainPassword` ã‚’ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ãŸã‚‚ã®ã‚’ `password` ã«è‡ªå‹•ã§åæ˜ ã•ã›ã‚‹

æ¬¡ã«ã€Doctrineã® [Entity Listener](https://symfony.com/doc/current/bundles/DoctrineBundle/entity-listeners.html) ã¨ã„ã†æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ `preFlush` Lifecycle Eventsã‚’ãƒ•ãƒƒã‚¯ã—ã€å¹³æ–‡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ãŸã‚‚ã®ãŒè‡ªå‹•ã§ `password` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã‚»ãƒƒãƒˆã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

Entity Listenerã®è©³ã—ã„ä½¿ã„æ–¹ã«ã¤ã„ã¦ã¯ [ã“ã¡ã‚‰ã®è¨˜äº‹](https://blog.ttskch.com/symfony-doctrine-entity-listener/) ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ãªå†…å®¹ã§å®Ÿè£…ã—ã¾ã™ã€‚

```php
<?php

namespace App\EntityListener;

use App\Entity\User;
use Doctrine\ORM\Event\LifecycleEventArgs;
use Doctrine\ORM\Event\PreFlushEventArgs;
use Doctrine\ORM\Event\PreUpdateEventArgs;
use Symfony\Component\Security\Core\Encoder\UserPasswordEncoderInterface;

class UserListener
{
    /**
     * @var UserPasswordEncoderInterface
     */
    private $encoder;

    public function __construct(UserPasswordEncoderInterface $encoder)
    {
        $this->encoder = $encoder;
    }

    public function preFlush(User $user, PreFlushEventArgs $event)
    {
        if ($plainPassword = $user->getPlainPassword()) {
            $user->setPassword($this->encoder->encodePassword($user, $plainPassword));
            $user->eraseCredentials();
        }
    }
}
```

```php
/**
 * @ORM\Entity(repositoryClass="App\Repository\UserRepository")
 * @ORM\EntityListeners({"App\EntityListener\UserListener"})
 */
class User implements UserInterface
{
    // ...
}
```

```yaml
# services.yaml

services:
    # ...
    App\EntityListener\:
        resource: '../src/EntityListener'
        tags: ['doctrine.orm.entity_listener']
```

`UserListner::preFlush()` ã®å†…å®¹ã¯ã”ãã‚·ãƒ³ãƒ—ãƒ«ã§ã™ã­ã€‚

`plainPassword` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«å€¤ãŒå…¥ã£ã¦ã„ãŸã‚‰ã€ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦ `password` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã‚»ãƒƒãƒˆã€ã¨ã—ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚

ç”¨ãŒæ¸ˆã‚“ã ã‚‰ `$user->eraseCredentials();` ã‚’å‘¼ã³å‡ºã—ã¦å¹³æ–‡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®æƒ…å ±ã‚’ã¡ã‚ƒã‚“ã¨ç ´æ£„ã—ã¦ã„ã‚‹ã“ã¨ã«ã‚‚æ³¨ç›®ã—ã¦ãã ã•ã„ã€‚

ã“ã‚Œã§ã€ã‚¢ãƒ—ãƒªå´ã§ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰å‡¦ç†ã®ã“ã¨ã¯ç‰¹ã«æ°—ã«ã—ãªãã¦ã‚‚ã€ `plainPassword` ã«å¹³æ–‡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã¦flushã™ã‚Œã°ã€å¸¸ã«è‡ªå‹•ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥ãŒ `password` ã«ä¿å­˜ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ğŸ‘

# è½ã¨ã—ç©´ï¼š `prePersist` ã¨ `preUpdate` ã ã¨ `plainPassword` ã—ã‹å¤‰æ›´ã•ã‚Œã¦ã„ãªã„ã¨ãã«å‹•ã‹ãªã„

ã¡ãªã¿ã«ã€ä»Šå›ãƒ•ãƒƒã‚¯ã™ã‚‹Lifecycle Eventsã¨ã—ã¦ `preFlush` ã‚’é¸æŠã—ã¾ã—ãŸãŒã€ã‚ˆã‚Šç›´æ„Ÿçš„ãª `prePersist` ã¨ `preUpdate` ã‚’ä»£ã‚ã‚Šã«ä½¿ã£ã¦ã—ã¾ã†ã¨ã€è‹¥å¹²æ„å›³ã—ãªã„æŒ™å‹•ã«ãªã£ã¦ã—ã¾ã†ã®ã§è¦æ³¨æ„ã§ã™ã€‚

æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆæ™‚ã¯ `prePersist` ã§ã¡ã‚ƒã‚“ã¨ãƒ•ãƒƒã‚¯ã§ãã‚‹ã®ã§ã™ãŒã€æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°æ™‚ã« `preUpdate` ã ã¨ãƒ•ãƒƒã‚¯ã§ããªã„ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹ã®ã§ã™ã€‚

å…·ä½“çš„ã«ã¯ã€ **ã©ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚‚å¤‰æ›´ã›ãš `plainPassword` ã«ã ã‘å€¤ã‚’ã‚»ãƒƒãƒˆã—ãŸã¨ã** ã§ã™ã€‚

`plainPassword` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯Doctrineã®ç®¡ç†å¤–ã®ãŸã‚ã€ `plainPassword` ã ã‘ã‚’å¤‰æ›´ã—ãŸã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¯ã€Doctrineã‹ã‚‰è¦‹ã‚‹ã¨ã€Œä½•ã‚‚å¤‰æ›´ã•ã‚Œã¦ã„ãªã„ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã€ã«è¦‹ãˆã‚‹ã®ã§ã™ã€‚

Doctrineã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€ `preUpdate` ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã•ã‚Œã‚‹ã®ã¯ [ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã°ã‚ŒãŸã¨ã](https://github.com/doctrine/orm/blob/8c259ea5cb632dbb57001b2262048ae7fa52b102/lib/Doctrine/ORM/UnitOfWork.php#L384-L388) ã§ã™ãŒã€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒä½•ã‚‚å¤‰æ›´ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€ãã®ã¡ã‚‡ã£ã¨å‰ã® [ã“ã®ifæ–‡](https://github.com/doctrine/orm/blob/8c259ea5cb632dbb57001b2262048ae7fa52b102/lib/Doctrine/ORM/UnitOfWork.php#L340-L354) ã§å¼¾ã‹ã‚Œã¦ã€ä½•ã‚‚ã›ãšã«çµ‚äº†ã—ã¦ã—ã¾ã„ã¾ã™ã€‚

`preFlush` ã®ç™ºç«ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¯ [ã“ã®ifæ–‡ã‚ˆã‚Šã‚‚ã¡ã‚‡ã£ã¨æ‰‹å‰](https://github.com/doctrine/orm/blob/8c259ea5cb632dbb57001b2262048ae7fa52b102/lib/Doctrine/ORM/UnitOfWork.php#L336-L338) ã«ã‚ã‚‹ã®ã§ã€ `preFlush` ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§Entity Listenerã‹ã‚‰ `password` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å¤‰æ›´ã—ã¦ã‚ã’ã‚Œã°ã€ãã®ç›´å¾Œã®ifæ–‡ã§ç„¡äº‹ã«ã€Œå¤‰æ›´ã‚ã‚Šã€ã¨ã„ã†åˆ¤å®šã«ãªã‚Šã€å¤‰æ›´ãŒDBã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚

## ã¡ãªã¿ã«ï¼šFOSUserBundleã‚‚ `prePersist` ã¨ `preUpdate` ã‚’è¦‹ã¦ã„ã‚‹ã®ã§åŒã˜å•é¡ŒãŒå†ç¾ã™ã‚‹

Symfonyã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã®ãƒ‡ãƒ•ã‚¡ã‚¯ãƒˆã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ã§ã‚ã‚‹ï¼ˆæœ€è¿‘ã¯ãã†ã§ã‚‚ãªã„ã‹ã‚‚â€¦ï¼‰[FOSUserBundle](https://github.com/FriendsOfSymfony/FOSUserBundle) ã‚‚ã€ä»Šå›ç´¹ä»‹ã—ãŸã®ã¨åŒæ§˜ã®ä»•çµ„ã¿ã§ `plainPassword` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ç”¨æ„ã—ã¦ãã‚Œã¦ã„ã‚‹ã®ã§ã™ãŒã€[ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹ã¨](https://github.com/FriendsOfSymfony/FOSUserBundle/blob/cf7fe27b2f4e1f298ee6eadf537267f8c9f9b85c/Doctrine/UserListener.php#L51-L72) `prePersist` ã¨ `preUpdate` ã‚’ãƒ•ãƒƒã‚¯ã—ã¦ã„ã¦ã€ä¸Šè¿°ã—ãŸã®ã¨åŒã˜å•é¡ŒãŒå†ç¾ã—ã¾ã™ã€‚

é ­ã®ç‰‡éš…ã«å…¥ã‚Œã¦ãŠãã¨ã€ã„ã–ã¨ã„ã†ã¨ãåŠ©ã‹ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

# `NotBlank` åˆ¶ç´„ã‚’ã‚»ãƒƒãƒˆã—ãŸã„å ´åˆã¯ã€æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆæ™‚ã®ã¿ã‚’å¯¾è±¡ã«ã—ãªã„ã¨ã„ã‘ãªã„

ã¨ã“ã‚ã§ã€ä»Šå›æ–°è¨­ã—ãŸ `plainPassword` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§ã™ãŒã€å°‘ã—å„ä»‹ãªã“ã¨ã«

* æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆæ™‚ã¯ã€ç©ºãŒã‚»ãƒƒãƒˆã•ã‚Œã‚‹ã“ã¨ã¯æ‹’å¦ã—ãŸã„
* æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°æ™‚ã¯ã€ç©ºãŒã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ãŸã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¤‰æ›´ã—ãªã„ã€ã¨ã—ãŸã„

ã¨ã„ã†è¦ä»¶ãŒè‡ªå‹•çš„ã«ç™ºç”Ÿã—ã¦ã—ã¾ã„ã¾ã™ã€‚

ãªã®ã§ã€[Validation Groups](https://symfony.com/doc/current/validation/groups.html) ã‚’ä½¿ã£ã¦ã€Œæ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆæ™‚ã«ã®ã¿ `NotBlank` åˆ¶ç´„ã‚’é©ç”¨ã€ã¨ã„ã†è¨­å®šã‚’ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

å…·ä½“çš„ã«ã¯ã€ã¾ãšä»¥ä¸‹ã®ã‚ˆã†ã«Userã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã® `plainPassword` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«Validation Groupsä»˜ãã§ `NotBlank` åˆ¶ç´„ã‚’ã‚»ãƒƒãƒˆã—ã¾ã™ã€‚

```php
/**
 * @Assert\NotBlank(groups={"registration"})
 */
private $plainPassword;
```

ãã—ã¦ã€FormTypeãŒä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ãªä¸€èˆ¬çš„ãªå†…å®¹ã ã¨ã™ã‚‹ã¨ã€

```php
class UserType extends AbstractType
{
    public function buildForm(FormBuilderInterface $builder, array $options)
    {
        $builder
            ->add('email', EmailType::class, [
                'label' => 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹',
            ])
            ->add('plainPassword', PasswordType::class, [
                'label' => 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰',
            ])
        ;
    }

    public function configureOptions(OptionsResolver $resolver)
    {
        $resolver->setDefaults([
            'data_class' => User::class,
        ]);
    }
}
```

ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã‹ã‚‰æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œã‚‹ã¨ãã«ã€ä»¥ä¸‹ã®ã‚ˆã†ã« `validation_groups` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã‚°ãƒ«ãƒ¼ãƒ—ã‚’æŒ‡å®šã—ã¦ã‚ã’ã‚Œã°ã€ãã®ãƒ•ã‚©ãƒ¼ãƒ ã§ã¯ `plainPassword` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«å¯¾ã™ã‚‹ `NotBlank` åˆ¶ç´„ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚

```php
$form = $this->createForm(UserType::class, $user = $this->getUser(), [
    'validation_groups' => ['registration'],
]);

$form->handleRequest($request);
```

æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°ãƒ•ã‚©ãƒ¼ãƒ ã§ã¯ `validation_groups` ã‚’æŒ‡å®šã—ãªã„ã‚ˆã†ã«ã™ã‚Œã°ã€ `NotBlank` åˆ¶ç´„ã®å¯¾è±¡ã¨ãªã‚‰ãšã€ `plainPassword` ã«nullãŒå…¥ã£ã¦ã„ãŸã‚‰ç„¡è¦–ã•ã‚Œã¦ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¤‰æ›´ã•ã‚Œã¾ã›ã‚“ğŸ‘

## åˆ¥è§£

ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã‹ã‚‰ `validation_groups` ã‚’æ¸¡ã™ã®ãŒé¢å€’ã€é–¢å¿ƒã‚’åˆ†é›¢ã—ãŸã„ã¨ã„ã†å ´åˆã¯ã€æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆç”¨ã¨æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°ç”¨ã§FormTypeã‚’åˆ†ã‘ã¦ã—ã¾ã£ã¦ã‚‚ã‚ˆã„ã§ã—ã‚‡ã†ã€‚

**æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆç”¨**

```php
class UserRegisterType extends AbstractType
{
    public function buildForm(FormBuilderInterface $builder, array $options)
    {
        $builder
            ->add('email', EmailType::class, [
                'label' => 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹',
            ])
            ->add('plainPassword', PasswordType::class, [
                'label' => 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰',
            ])
        ;
    }

    public function configureOptions(OptionsResolver $resolver)
    {
        $resolver->setDefaults([
            'data_class' => User::class,
            'validation_groups' => ['registration'],
        ]);
    }
}
```

**æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°ç”¨**

```php
class UserEditType extends UserRegisterType
{
    public function configureOptions(OptionsResolver $resolver)
    {
        parent::configureOptions($resolver);

        $resolver->setDefaults([
            'validation_groups' => [],
        ]);
    }
}
```

ã“ã†ã—ã¦ãŠã‘ã°ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©å´ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«FormTypeã‚’ä½¿ã„åˆ†ã‘ã‚‹ã ã‘ã§æ¸ˆã¿ã¾ã™ã€‚

```php
// æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆç”¨
$form = $this->createForm(UserRegisterType::class, $user = $this->getUser());

// æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°ç”¨
$form = $this->createForm(UserEditType::class, $user = $this->getUser());
```

# ã¾ã¨ã‚

* Userã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã« `plainPassword` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¿½åŠ ã—ã¦ã€ `password` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯Etity listenerã§ãƒ•ãƒƒã‚¯ã—ã¦è‡ªå‹•ã§æ›´æ–°ã•ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹ã¨ã€è‰²ã€…ã¨æ¥½ã«ãªã‚‹
* `password` ã®æ›´æ–°ã‚’prePersistã§ã‚„ã‚ã†ã¨ã™ã‚‹ã¨ã€ `plainPassword` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã—ã‹å¤‰æ›´ã›ãšã«persistã—ãŸã¨ãã«ç„¡è¦–ã•ã‚Œã¦ã—ã¾ã†ã®ã§ã€preFlushã‚’ä½¿ã†ã¨ã‚ˆã„
* `plainPassword` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«å¯¾ã™ã‚‹ `NotBlank` åˆ¶ç´„ã¯æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆæ™‚ã«ã®ã¿æœ‰åŠ¹ã«ã—ãŸã„ã®ã§ã€Validation Groupsã‚’é©åˆ‡ã«è¨­å®šã—ã¦ã‚ã’ã‚‹ã¨ã‚ˆã„
