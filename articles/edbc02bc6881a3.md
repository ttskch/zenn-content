---
title: "[Symfony] FOSUserBundleã‚’ä½¿ã‚ãªãã¦ã‚‚15åˆ†ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³ã¯å®Ÿè£…ã§ãã‚‹"
emoji: "ğŸ»"
type: "tech"
topics: ["php", "symfony"]
published: true
published_at: 2020-03-25
---

:::message
ã“ã®è¨˜äº‹ã¯ã€2020-03-25ã«åˆ¥ã®ãƒ–ãƒ­ã‚°åª’ä½“ã«æŠ•ç¨¿ã—ãŸè¨˜äº‹ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ã™ã€‚
:::

Symfonyã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã®ãƒãƒ³ãƒ‰ãƒ«ã¨ã„ãˆã° [FOSUserBundle](https://github.com/FriendsOfSymfony/FOSUserBundle) ãŒå®šç•ªã ã¨æ€ã„ã¾ã™ã€‚

ç¢ºã‹ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã«å¿…è¦ãªæœ€ä½é™ã®æ©Ÿèƒ½ã‚’æ‰‹æ—©ãå®Ÿè£…ã§ãã‚‹ã¨ã„ã†ç‚¹ã§ã¯ä¾¿åˆ©ãªãƒãƒ³ãƒ‰ãƒ«ãªã®ã§ã™ãŒã€å¾Œã€…ç´°ã‹ã„æ‹¡å¼µãŒã—ã¥ã‚‰ã„ã¨ã„ã†å£°ã‚‚èãã¾ã™ã€‚

> ã‚ã¨ã€å€‹äººçš„ã«Symfony2æ™‚ä»£ã«ã—ã‹ä½¿ã£ãŸã“ã¨ãŒãªã‹ã£ãŸã®ã§ã€Symfony4ã«ã¡ã‚ƒã‚“ã¨å¯¾å¿œã—ã¦ã‚‹ã®ã‹ï¼Ÿã¨ã„ã†ä¸å®‰ã‚‚ã‚ã£ãŸã®ã§ã™ãŒã€[ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆ](https://github.com/FriendsOfSymfony/FOSUserBundle/releases) ã‚’è¦‹ã‚‹ã¨ `Added Symfony 4 compatibility.` ã¨ã‹æ›¸ã‹ã‚Œã¦ã„ã‚‹ã®ã§ç‰¹ã«å¿ƒé…ã¯è¦ã‚‰ãªã„ã£ã½ã„ã§ã™ã€‚

FOSUserBundleã‚’ä½¿ã‚ãšã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã¨ãªã‚‹ã¨ã€è‰²ã‚“ãªå‡¦ç†ã‚’ã‚¼ãƒ­ã‹ã‚‰æ›¸ã‹ãªã„ã¨ã„ã‘ãªãã¦é¢å€’ãã†ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ãŒã€å®Ÿã¯ [MakerBundle](https://symfony.com/doc/current/bundles/SymfonyMakerBundle/index.html) ã‚’ä½¿ãˆã°æ„å¤–ã¨æ‰‹è»½ã«å®Ÿè£…ã§ãã¾ã™ã€‚

ã¨ã„ã†ã‚ã‘ã§ã€ä»Šå›ã¯FOSUserbundleã‚’ä½¿ã‚ãšã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚’å®Ÿè£…ã™ã‚‹æ‰‹é †ã‚’ç°¡å˜ã«è§£èª¬ã—ãŸã„ã¨æ€ã„ã¾ã™âœ‹

# 1. MakerBundleã‚’ä½¿ã£ã¦ä¸€æ’ƒã§ `User` ã‚¯ãƒ©ã‚¹ã‚’ä½œã‚‹

<https://symfony.com/doc/current/security.html>

ã“ã¡ã‚‰ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ç„¼ãç›´ã—ã§ã™ãŒã€MakerBundleã‚’ä½¿ãˆã°ã€SecurityBundleã® `UserInterface` ã‚’å®Ÿè£…ã—ãŸã€Doctrineã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨ã—ã¦ã® `User` ã‚¯ãƒ©ã‚¹ã‚’ã‚³ãƒãƒ³ãƒ‰ä¸€ç™ºã§ä½œã‚Œã¾ã™ã€‚

```bash
$ bin/console make:user

 The name of the security user class (e.g. User) [User]:
 >

 Do you want to store user data in the database (via Doctrine)? (yes/no) [yes]:
 >

 Enter a property name that will be the unique "display" name for the user (e.g. email, username, uuid) [email]:
 >

 Will this app need to hash/check user passwords? Choose No if passwords are not needed or will be checked/hashed by some other system (e.g. a single sign-on server).

 Does this app need to hash/check user passwords? (yes/no) [yes]:
 >

 created: src/Entity/User.php
 created: src/Repository/UserRepository.php
 updated: src/Entity/User.php
 updated: config/packages/security.yaml


  Success!


 Next Steps:
   - Review your new App\Entity\User class.
   - Use make:entity to add more fields to your User entity and then run make:migration.
   - Create a way to authenticate! See https://symfony.com/doc/current/security.html
```

`make:user` ã‚³ãƒãƒ³ãƒ‰ã‚’å©ã„ã¦ã€Enterã‚’é€£æ‰“ã—ãŸã ã‘ã§ã™ğŸ˜‡

ã“ã‚Œã§ã€

* `src/Entity/User.php`
    * SecurityBundleã® `UserInterface` å®Ÿè£…æ¸ˆã¿
    * `email` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥å­
* `src/Repository/UserRepository.php`

ã®2ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œã‚‰ã‚Œã€ä»¥ä¸‹ã®ã‚ˆã†ã« `config/packages/security.yaml` ã«ã‚‚å¿…è¦ãªè¨­å®šãŒè¿½è¨˜ã•ã‚Œã¾ã™ã€‚

```diff
security:
+   encoders:
+       App\Entity\User:
+           algorithm: auto
+
    providers:
-       in_memory: { memory: null }
+       # used to reload user from session & other features (e.g. switch_user)
+       app_user_provider:
+           entity:
+               class: App\Entity\User
+               property: email
```

ã‚ã¨ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚Œã°ã€ `User` ã‚¯ãƒ©ã‚¹ã®ä½œæˆã¯å®Œäº†ã§ã™ï¼

```bash
$ bin/console doctrine:migrations:diff
$ bin/console doctrine:migrations:migrate
```

# 2. MakerBundleã‚’ä½¿ã£ã¦ä¸€æ’ƒã§ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã‚’ä½œã‚‹

<https://symfony.com/doc/current/security/form_login_setup.html>

ã¾ãŸã—ã¦ã‚‚å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ç„¼ãç›´ã—ã§ã™ãŒã€MakerBundleã‚’ä½¿ãˆã°ã€ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¨ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ï¼ˆAuthenticatorï¼‰ã‚‚ã‚³ãƒãƒ³ãƒ‰ä¸€ç™ºã§ä½œã‚Œã¾ã™ã€‚

```bash
$ bin/console make:auth

 What style of authentication do you want? [Empty authenticator]:
  [0] Empty authenticator
  [1] Login form authenticator
 > 1

 The class name of the authenticator to create (e.g. AppCustomAuthenticator):
 > LoginFormAuthenticator

 Choose a name for the controller class (e.g. SecurityController) [SecurityController]:
 >

 Do you want to generate a '/logout' URL? (yes/no) [yes]:
 >

 created: src/Security/LoginFormAuthenticator.php
 updated: config/packages/security.yaml
 created: src/Controller/SecurityController.php
 created: templates/security/login.html.twig


  Success!


 Next:
 - Customize your new authenticator.
 - Finish the redirect "TODO" in the App\Security\LoginFormAuthenticator::onAuthenticationSuccess() method.
 - Review & adapt the login template: templates/security/login.html.twig.
```

ã“ã‚Œã§ã€

* `src/Controller/SecurityController.php` ï¼ˆ `/login` ã¨ `/logout` ã®2ã¤ã®ãƒ«ãƒ¼ãƒˆãŒå®Ÿè£…æ¸ˆã¿ï¼‰
* `src/Security/LoginFormAuthenticator.php` ï¼ˆ[AbstractGuardAuthenticator](https://symfony.com/doc/current/security/guard_authentication.html) ã‚’é©åˆ‡ã«å®Ÿè£…æ¸ˆã¿ï¼‰
* `templates/security/login.html.twig` ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®ãƒ“ãƒ¥ãƒ¼ï¼‰

ã®3ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œã‚‰ã‚Œã€ä»¥ä¸‹ã®ã‚ˆã†ã« `config/packages/security.yaml` ã«ã‚‚å¿…è¦ãªè¨­å®šãŒè¿½è¨˜ã•ã‚Œã¾ã™ã€‚

```diff
security:
    :
    :
    firewalls:
        dev:
            pattern: ^/(_(profiler|wdt)|css|images|js)/
            security: false
        main:
            anonymous: lazy
+           guard:
+               authenticators:
+                   - App\Security\LoginFormAuthenticator
+           logout:
+               path: app_logout
+               # where to redirect after logout
+               # target: app_any_route
```

## ç”Ÿæˆã•ã‚ŒãŸé››å½¢ã‚’ä¿®æ­£

ã‚³ãƒãƒ³ãƒ‰ä¸€ç™ºã§ç”Ÿæˆã•ã‚ŒãŸé››å½¢ã¯ä¸€ç®‡æ‰€ã ã‘ä¿®æ­£ãŒå¿…è¦ãªå†…å®¹ã«ãªã£ã¦ã„ã¾ã™ã€‚

`LoginFormAuthenticator` ã® `onAuthenticationSuccess` ãƒ¡ã‚½ãƒƒãƒ‰ã®ä»¥ä¸‹ã®éƒ¨åˆ†ã§ã™ã€‚

ãƒ­ã‚°ã‚¤ãƒ³ã«æˆåŠŸã—ãŸã‚ã¨ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ‘ã‚¹ãŒãªã„å ´åˆã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã©ã®URLã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã›ã‚‹ã‹ã‚’è¨­å®šã—ã¾ã™ã€‚

ä»¥ä¸‹ã®ä¾‹ã§ã¯ã€ `default_index` ã¨ã„ã†ãƒ«ãƒ¼ãƒˆåã®URLã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã›ã¦ã„ã¾ã™ã€‚

```diff
public function onAuthenticationSuccess(Request $request, TokenInterface $token, $providerKey)
{
    if ($targetPath = $this->getTargetPath($request->getSession(), $providerKey)) {
        return new RedirectResponse($targetPath);
    }

-   // For example : return new RedirectResponse($this->urlGenerator->generate('some_route'));
-   throw new \Exception('TODO: provide a valid redirect inside '.__FILE__);
+   return new RedirectResponse($this->urlGenerator->generate('default_index'));
}
```

# 3. ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ã‚’è¨­å®šã™ã‚‹

ã“ã“ã¾ã§ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³ã®æ©Ÿèƒ½ã¯å®Ÿè£…ã§ãã¦ã„ã‚‹ã®ã§ã€ `config/packages/security.yaml` ã§ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã§ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ã‚’è¨­å®šã™ã‚Œã°ã€ã€Œãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ä»¥å¤–ã¯ `ROLE_USER` ã‚’æŒã£ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ãªã„ã¨è¦‹ã‚‰ã‚Œãªã„ã€ã¨ã„ã†çŠ¶æ…‹ãŒä½œã‚Œã¾ã™ã€‚

```yaml
security:
    :
    :
    access_control:
        - { path: ^/(login|logout)$, roles: IS_AUTHENTICATED_ANONYMOUSLY }
        - { path: ^/, roles: ROLE_USER }
```

# ã¾ã¨ã‚

* ç¾ä»£ã«ãŠã„ã¦ã¯ã€MakerBundleã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³ã«å¿…è¦ãªå®Ÿè£…ãŒã»ã¼ã‚³ãƒãƒ³ãƒ‰ä¸€ç™ºã§å®Ÿè£…ã§ãã‚‹ï¼
