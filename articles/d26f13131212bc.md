---
title: "[Symfony] ã‚·ãƒ³ãƒ—ãƒ«ã§ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã‚„ã™ã„æœ€å¼·ã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ³ãƒ‰ãƒ«"
emoji: "ğŸ»"
type: "tech"
topics: ["php", "symfony", "doctrine"]
published: true
published_at: 2020-07-30
---

:::message
ã“ã®è¨˜äº‹ã¯ã€2020-07-30ã«åˆ¥ã®ãƒ–ãƒ­ã‚°åª’ä½“ã«æŠ•ç¨¿ã—ãŸè¨˜äº‹ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ã™ã€‚
:::

:::message
2023-12-24ã« [æœ€æ–°ç‰ˆã®å†…å®¹ã§åŒæ§˜ã®è¨˜äº‹ã‚’æ›¸ãã¾ã—ãŸ](https://zenn.dev/ttskch/articles/c9467909b1154b) ã®ã§ã€ãœã²ãã¡ã‚‰ã‚’ã”è¦§ãã ã•ã„ã€‚
:::

# TtskchPaginatorBundle

ã‚·ãƒ³ãƒ—ãƒ«ã§ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã‚„ã™ã„æœ€å¼·ã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ³ãƒ‰ãƒ«ã‚’ä½œã‚Šã¾ã—ãŸã€‚

[ttskch/TtskchPaginatorBundle: The most thin and simple paginator bundle for Symfony](https://github.com/ttskch/TtskchPaginatorBundle)

![](https://camo.githubusercontent.com/f92e57e7943f48db6e3f021092b5c34d32f4f338/68747470733a2f2f747661312e73696e61696d672e636e2f6c617267652f30303753385a496c677931676835746936327838796a333177353075306773742e6a7067)

ã“ã‚“ãªæ„Ÿã˜ã®ç¾ã—ã„ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãŒç°¡å˜ã«å®Ÿè£…ã§ãã¾ã™ã€‚

# ç‰¹å¾´

* è¶…è»½é‡
* Symfonyä»¥å¤–ã«ä¸€åˆ‡ä¾å­˜ãªã—
* ãƒšãƒ¼ã‚¸ãƒ£ãƒ¼éƒ¨åˆ†ã®HTMLãªã©ã¯twigã§ç°¡å˜ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½
* è¦‹å‡ºã—éƒ¨åˆ†ã‚’ç°¡å˜ã«ã‚½ãƒ¼ãƒˆã®ãŸã‚ã®ãƒªãƒ³ã‚¯ã«ã§ãã‚‹
* æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã¨ã®é€£å‹•ã‚‚ç°¡å˜
* ãƒšãƒ¼ã‚¸ãƒ£ãƒ¼éƒ¨åˆ†ã®HTMLã®Bootstrap4ãƒ†ãƒ¼ãƒã‚’ãƒ—ãƒªã‚»ãƒƒãƒˆ

# å‹•ä½œè¦ä»¶

* PHP >=7.1.3
* Symfony ^4.0|^5.0

# ãƒ‡ãƒ¢

<https://ttskchpaginatorbundle.herokuapp.com/>

ã“ã¡ã‚‰ã§å®Ÿéš›ã«å‹•ã„ã¦ã„ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã‚’è§¦ã‚Œã¾ã™ã€‚

# ä½¿ã„æ–¹

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

æ™®é€šã«composerã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã€ `bundles.php` ã«è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

```bash
$ composer require ttskch/paginator-bundle
```

```php
// config/bundles.php

return [
    // ...
    Ttskch\PaginatorBundle\TtskchPaginatorBundle::class => ['all' => true],
];
```

## Doctrine ORMã¨ã‚ã‚ã›ã¦ä½¿ã†

TtskchPaginatorBundleè‡ªä½“ã¯Doctrine ORMã«ãƒ­ãƒƒã‚¯ã‚¤ãƒ³ã¯ã—ã¦ã„ã¾ã›ã‚“ãŒã€Doctrine ORMã¨ã‚ã‚ã›ã¦ä½¿ã†ãŸã‚ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æä¾›ã—ã¦ã„ã‚‹ã®ã§ã€ãã‚Œã‚’ä½¿ãˆã°ã¨ã¦ã‚‚å°‘ãªã„å¤‰æ›´ã§ç°¡å˜ã«ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’å°å…¥ã§ãã¾ã™ã€‚

**Before**

```php
// FooController.php

public function index(FooRepository $fooRepository)
{
    return $this->render('index.html.twig', [
        'foos' => $fooRepository->findAll(),
    ]);
}
```

```twig
{# index.html.twig #}

<table>
  <thead>
  <tr>
    <th>Id</th>
    <th>Name</th>
    <th>Email</th>
  </tr>
  </thead>
  <tbody>
  {% for foo in foos %}
    <tr>
      <td>{{ foo.id }}</td>
      <td>{{ foo.name }}</td>
      <td>{{ foo.email }}</td>
    </tr>
  {% endfor %}
  </tbody>
</table>
```

**After**

```diff
  // FooController.php
 
+ use Ttskch\PaginatorBundle\Context;
+ use Ttskch\PaginatorBundle\Doctrine\Counter;
+ use Ttskch\PaginatorBundle\Doctrine\Slicer;
+ 
- public function index(FooRepository $fooRepository)
+ public function index(FooRepository $fooRepository, Context $context)
  {
+     $qb = $fooRepository->createQueryBuilder('f');
+     $context->initialize('id', new Slicer($qb), new Counter($qb));
+ 
      return $this->render('index.html.twig', [
-       'foos' => $fooRepository->findAll(),
+       'foos' => $context->slice,
      ]);
  }
```

```diff
  {# index.html.twig #}
  
  <table>
    <thead>
    <tr>
-     <th>Id</th>
-     <th>Name</th>
-     <th>Email</th>
+     <th>{{ ttskch_paginator_sortable('id') }}</th>
+     <th>{{ ttskch_paginator_sortable('name') }}</th>
+     <th>{{ ttskch_paginator_sortable('email') }}</th>
    </tr>
    </thead>
    <tbody>
    {% for foo in foos %}
      <tr>
        <td>{{ foo.id }}</td>
        <td>{{ foo.name }}</td>
        <td>{{ foo.email }}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
+ 
+ {{ ttskch_paginator_pager() }}
```

ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚

```php
$context->initialize('id', new Slicer($qb), new Counter($qb));
```

ã§ã€ `$context` ãŒå†…éƒ¨çš„ã« `handleRequest()` ã‚’å®Ÿè¡Œã—ã¦ã€URLã®ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã‚‚ã¨ã«ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ãã‚Œã¾ã™ã€‚

`new Slicer($qb)` ã¨ `new Counter($qb)` ã¯ãã‚Œãã‚Œã€

* ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã® `Foo` ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹ãŸã‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
* `Foo` ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ç·æ•°ã‚’ç®—å‡ºã™ã‚‹ãŸã‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯

ã§ã™ã€‚ã“ã‚Œã‚‰ãŒTtskchPaginatorBundleãŒç”¨æ„ã—ã¦ãã‚Œã¦ã„ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã§ã™ã€‚

ãƒ“ãƒ¥ãƒ¼å´ã§ã¯ã€

* `ttskch_paginator_sortable()` é–¢æ•°ã§ã‚½ãƒ¼ãƒˆã®ãŸã‚ã®ãƒªãƒ³ã‚¯ã‚’å‡ºåŠ›
* `ttskch_paginator_pager()` é–¢æ•°ã§ãƒšãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’å‡ºåŠ›

ã—ã¦ã„ã¾ã™ã€‚

## ãƒ“ãƒ¥ãƒ¼ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å¤‰æ›´ã™ã‚‹

ãƒ“ãƒ¥ãƒ¼ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯è¨­å®šã§è‡ªç”±ã«å¤‰æ›´ã§ãã¾ã™ã€‚

```yaml
# config/packages/ttskch_paginator.yaml

ttskch_paginator:
  template:
    pager: 'your/own/pager.html.twig'
    sortable: 'your/own/sortable.html.twig'
```

ãƒ—ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹Bootstrap4ã‚¹ã‚¿ã‚¤ãƒ«ã®ãƒšãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’ä½¿ã„ãŸã„ã ã‘ãªã‚‰ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã™ã‚Œã°OKã§ã™ã€‚

```yaml
# config/packages/ttskch_paginator.yaml

ttskch_paginator:
  template:
    pager: '@TtskchPaginator/pager/bootstrap4.html.twig'
```

## æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚ã‚ã›ã¦ä½¿ã†

æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚ã‚ã›ã¦ä½¿ã†å ´åˆã¯ã€ãƒªãƒã‚¸ãƒˆãƒªã‚¯ãƒ©ã‚¹ã«QueryBuilderã®çµ„ã¿ç«‹ã¦ã‚‹ã‚’æ›¸ãã¾ã™ã€‚

ã“ã®ã¨ãã€é€ä¿¡ã•ã‚ŒãŸæ¤œç´¢æ¡ä»¶ã‚„ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã®æƒ…å ±ã‚’ã„ã¡ã„ã¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰å–ã‚Šå‡ºã—ãŸã‚Šã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚TtskchPaginatorBundleãŒ `Criteria` ã¨ã„ã†ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¡ä»¶ã‚’è¡¨ã™ã‚¯ãƒ©ã‚¹ã‚’æŒã£ã¦ã„ã¦ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã§ `$context->initialize()` ã—ãŸã¨ãã«é©åˆ‡ã« `Criteria` ã«å€¤ãŒã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® `Criteria` ã¯ãƒšãƒ¼ã‚¸ç•ªå·ã‚„1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Šã®è¡¨ç¤ºä»¶æ•°ãªã©ã€ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ã—ã‹æŒãŸãªã„ãŸã‚ã€ã“ã‚Œã‚’ç¶™æ‰¿ã—ã¦ç‹¬è‡ªã® `FooCriteria` ã‚’ä½œã‚‹ã¨ã“ã‚ã‹ã‚‰å§‹ã‚ã¾ã™ã€‚

ã¨ã‚Šã‚ãˆãšæ–‡å­—åˆ—ã§æ¤œç´¢ã™ã‚‹ãŸã‚ã® `query` ã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚

```php
// FooCriteria.php

use Ttskch\PaginatorBundle\Entity\Criteria;

class FooCriteria extends Criteria
{
    public $query;
}
```

ç¶šã„ã¦ã€ã“ã® `FooCriteria` ã«å¯¾å¿œã™ã‚‹FormTypeã‚’ä½œã‚Šã¾ã™ã€‚TtskchPaginatorBundleãŒæä¾›ã—ã¦ã„ã‚‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® `CriteriaType` ã‚’ç¶™æ‰¿ã™ã‚‹ã“ã¨ã§ã€ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ã«é–¢ã™ã‚‹å‡¦ç†ã‚’æ°—ã«ã™ã‚‹å¿…è¦ãŒãªããªã‚Šã¾ã™ã€‚

```php
// FooSearchType.php

use Symfony\Component\Form\Extension\Core\Type\SearchType;
use Symfony\Component\Form\FormBuilderInterface;
use Symfony\Component\OptionsResolver\OptionsResolver;
use Ttskch\PaginatorBundle\Form\CriteriaType;

class FooSearchType extends CriteriaType
{
    public function buildForm(FormBuilderInterface $builder, array $options)
    {
        parent::buildForm($builder, $options); // <- å¿˜ã‚Œãšã«

        $builder
            ->add('query', SearchType::class)
        ;
    }

    public function configureOptions(OptionsResolver $resolver)
    {
        $resolver->setDefaults([
            'data_class' => FooCriteria::class,
            // symfony/security-csrfãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ç’°å¢ƒã§ã¯ä»¥ä¸‹ãŒå¿…è¦
            // 'csrf_protection' => false,
        ]);
    }
}
```

æ¬¡ã«ã€ãƒªãƒã‚¸ãƒˆãƒªã‚¯ãƒ©ã‚¹ã« `FooCriteria` ã‚’ã‚‚ã¨ã«QueryBuilderã‚’çµ„ã¿ç«‹ã¦ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½œã‚Šã¾ã™ã€‚

```php
// FooRepository.php

private function createQueryBuilderFromCriteria(FooCriteria $criteria)
{
    return $this->createQueryBuilder('f')
        ->orWhere('f.name like :query')
        ->orWhere('f.email like :query')
        ->setParameter('query', '%'.str_replace('%', '\%', $criteria->query).'%')
    ;
}
```

`$criteria->query` ã‚’LIKEå¥ã«é£Ÿã‚ã›ã¦æ¤œç´¢ã—ã¦ã„ã‚‹ã ã‘ã§ã™ã­ã€‚

ã“ã®QueryBuilderã‚’çµ„ã¿ç«‹ã¦ã‚‹å‡¦ç†ã ã‘ã¯ã‚¢ãƒ—ãƒªå›ºæœ‰ãªã®ã§è‡ªåˆ†ã§æ›¸ãå¿…è¦ãŒã©ã†ã—ã¦ã‚‚ã‚ã‚Šã¾ã™ãŒã€ã“ã‚Œã‚’ã‚‚ã¨ã« `Slicer` `Counter` ã‚’ä½œã‚‹å‡¦ç†ã«ã¯TtskchPaginatorBundleãŒæä¾›ã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’æ´»ç”¨ã§ãã¾ã™ã€‚

```php
// FooRepository.php

use Ttskch\PaginatorBundle\Doctrine\Counter;
use Ttskch\PaginatorBundle\Doctrine\Slicer;

// ...

public function sliceByCriteria(FooCriteria $criteria)
{
    $qb = $this->createQueryBuilderFromCriteria($criteria);
    $slicer = new Slicer($qb);

    return $slicer($criteria);
}

public function countByCriteria(FooCriteria $criteria)
{
    $qb = $this->createQueryBuilderFromCriteria($criteria);
    $counter = new Counter($qb);

    return $counter($criteria);
}

private function createQueryBuilderFromCriteria(FooCriteria $criteria)
{
    return $this->createQueryBuilder('f')
        ->orWhere('f.name like :query')
        ->orWhere('f.email like :query')
        ->setParameter('query', '%'.str_replace('%', '\%', $criteria->query).'%')
    ;
}
```

ã“ã‚“ãªæ„Ÿã˜ã§ã€æ¤œç´¢æ¡ä»¶é©ç”¨æ¸ˆã¿ã®QueryBuilderã‚’æ¸¡ã—ã¦ `Slicer` `Counter` ã‚’ä½œã‚Šã€ãã‚Œã‚‰ã®å‡¦ç†ã‚’ `FooCriteria` ã‚’æ¸¡ã—ã¦å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ã™ã‚Œã°OKã§ã™ã€‚ï¼ˆ `Slicer` `Counter` ã¯invokableã§ã™ï¼‰

æœ€å¾Œã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã®å®Ÿè£…ã§ã™ã€‚

`$context->initialize()` ã®ç¬¬2ã€ç¬¬3å¼•æ•°ã§å…ˆã»ã©ä½œã£ãŸãƒªãƒã‚¸ãƒˆãƒªã‚¯ãƒ©ã‚¹ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ¸¡ã—ã¾ã™ã€‚

ã¾ãŸã€Criteria/FormTypeã‚’ç‹¬è‡ªã«æ‹¡å¼µã—ãŸå ´åˆã¯ã€ç¬¬4ã€ç¬¬5å¼•æ•°ã§ãã®ã‚¯ãƒ©ã‚¹åã‚’æ¸¡ã—ã¾ã™ã€‚

ãã†ã™ã‚‹ã“ã¨ã§ã€ `$context->form` ã§ `handleRequest()` æ¸ˆã¿ã®Formã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå–å¾—ã§ãã¾ã™ã€‚

```php
// FooController.php

public function index(FooRepository $fooRepository, Context $context)
{
    $context->initialize(
        'id',
        [$fooRepository, 'sliceByCriteria'],
        [$fooRepository, 'countByCriteria'],
        FooCriteria::class,
        FooSearchType::class
    );

    return $this->render('index.html.twig', [
        'foos' => $context->slice,
        'form' => $context->form->createView(),
    ]);
}
```

ã‚ã¨ã¯ãƒ“ãƒ¥ãƒ¼ã«ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¨­ç½®ã™ã‚Œã°å®Œäº†ã§ã™ã€‚

```diff
  {# index.html.twig #}
  
+ {{ form(form, {action: path('foo_index'), method: 'get'}) }}
+ 
  <table>
      <thead>
      <tr>
          <th>{{ ttskch_paginator_sortable('id') }}</th>
          <th>{{ ttskch_paginator_sortable('name') }}</th>
          <th>{{ ttskch_paginator_sortable('email') }}</th>
      </tr>
      </thead>
      <tbody>
      {% for foo in foos %}
          <tr>
              <td>{{ foo.id }}</td>
              <td>{{ foo.name }}</td>
              <td>{{ foo.email }}</td>
          </tr>
      {% endfor %}
      </tbody>
  </table>
  
  {{ ttskch_paginator_pager() }}
```

# ã¾ã¨ã‚

* ãƒãƒ³ãƒ‰ãƒ«å›ºæœ‰ã®ã‚³ãƒ¼ãƒ‰ãŒå°‘ãªãæ¸ˆã‚“ã§ã€ã„ã–ã¨ãªã£ãŸã‚‰ã„ã¤ã§ã‚‚æ¨ã¦ã¦åˆ¥ã®å®Ÿè£…ã«ç§»è¡Œã§ãã‚‹
* ã ã‘ã©ã‚„ã‚ŠãŸã„ã“ã¨ã¯å…¨éƒ¨ã§ãã‚‹

ã¨ã„ã†ã®ã‚’æ„è­˜ã—ã¦ä½œã‚Šã¾ã—ãŸã€‚

ã„ã¤ã§ã‚‚æ¨ã¦ã‚‰ã‚Œã‚‹ã¨ã„ã†ã®ãŒç‰¹ã«å¤§äº‹ã ã¨æ€ã£ã¦ã„ã¦ã€å®Ÿéš›ã«ã€Œãƒãƒ³ãƒ‰ãƒ«ã‚’ä½¿ã‚ãšã«è‡ªåˆ†ã§å®Ÿè£…ã—ãŸã¨ã—ã¦ã‚‚ã©ã†ã›æ›¸ã‹ãªã„ã¨ã„ã‘ãªã„ã‚ˆã†ãªã‚‚ã®ã€ã ã‘ã—ã‹æä¾›ã—ã¦ã„ã¾ã›ã‚“ã€‚

ã‚‚ã—æ™®æ®µã‹ã‚‰ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’è‡ªåŠ›ã§æ›¸ã„ã¦ã„ã‚‹ã¨ã„ã†æ–¹ãŒã„ãŸã‚‰ã€è©¦ã—ã«ä½¿ã£ã¦ã¿ã¦ã„ãŸã ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™ğŸ’ª

[ttskch/TtskchPaginatorBundle: The most thin and simple paginator bundle for Symfony](https://github.com/ttskch/TtskchPaginatorBundle)
