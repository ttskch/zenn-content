---
title: "[Doctrine] QueryBuilderã§INå¥ã«é…åˆ—ã‚’æ¸¡ã™ï¼é…åˆ—ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒç›®çš„ã®å€¤ã‚’å«ã‚“ã§ã„ã‚‹ã‹ã©ã†ã‹ã§çµã‚Šè¾¼ã‚€"
emoji: "ğŸ»"
type: "tech"
topics: ["php", "symfony", "doctrine"]
published: true
published_at: 2020-06-20
---

:::message
ã“ã®è¨˜äº‹ã¯ã€2020-06-20ã«åˆ¥ã®ãƒ–ãƒ­ã‚°åª’ä½“ã«æŠ•ç¨¿ã—ãŸè¨˜äº‹ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ã™ã€‚
:::

å‚™å¿˜éŒ²ã§ã™ã€‚

# QueryBuilderã§INå¥ã«é…åˆ—ã‚’æ¸¡ã™

## ä¸€è¦‹æ™®é€šã£ã½ã„ã‘ã©ãƒã‚®ãƒ¼ãªã‚„ã‚Šæ–¹ï¼ˆãŠå‹§ã‚ã—ãªã„ï¼‰

```php
use Doctrine\DBAL\Connection;
use Doctrine\DBAL\Types\Types;

$ids = [1,2,3,4,5];

$qb = $fooRepository->createQueryBuilder('f');
$qb
    ->andWhere('f.id IN (:ids)')
    ->setParameter('ids', $ids, Types::ARRAY)
    // ã¾ãŸã¯
    ->setParameter('ids', $ids, Connection::PARAM_INT_ARRAY)
    ->getQuery()
    ->getResult()
;
```

> å‚è€ƒï¼š
>
> * [php - Doctrine DBAL setParameter() with array value - Stack Overflow](https://stackoverflow.com/questions/31243022/doctrine-dbal-setparameter-with-array-value)
> * <https://github.com/doctrine/orm/blob/2a98a98cd36e5eb54ad5ff8ca26fc3a30d5a82ff/lib/Doctrine/ORM/QueryBuilder.php#L526>

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒé…åˆ—ã˜ã‚ƒãªã„ã¨ãã¨åŒã˜æ›¸ãæ–¹ãªã®ã§ã“ã‚ŒãŒæ¨™æº–çš„ãªã‚„ã‚Šæ–¹ã®ã‚ˆã†ãªæ°—ã‚‚ã™ã‚‹ã®ã§ã™ãŒã€[Doctrineã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://www.doctrine-project.org/projects/doctrine-orm/en/2.7/reference/query-builder.html) ã§è¨€åŠã•ã‚Œã¦ãŠã‚‰ãšã€æ¨™æº–ã®ã‚„ã‚Šæ–¹ãŒä¸æ˜ã§ã™ğŸ˜“

å®Ÿéš›ã«ä½¿ã£ã¦ã¿ã‚‹ã¨ãªã‚“ã‹æ­£å¸¸ã«å‹•ã‹ãªã„æ„Ÿã˜ãŒã—ã¦ã„ã‚‹ã®ã§ã€å€‹äººçš„ã«ã¯ãŠå‹§ã‚ã—ã¾ã›ã‚“ğŸ™„


https://twitter.com/ttskch/status/1276032724403273729

## ãƒã‚®ãƒ¼ã˜ã‚ƒãªã„ã‚„ã‚Šæ–¹ï¼ˆãŠå‹§ã‚ï¼‰

```php
$ids = [1,2,3,4,5];

$qb = $fooRepository->createQueryBuilder('f');
$qb
    ->andWhere($qb->expr()->in('f.id', $ids))
    ->getQuery()
    ->getResult()
;
```

ã¾ãŸã¯

```php
$ids = [1,2,3,4,5];

$expr = $this->getEntityManager()->getExpressionBuilder();

$fooRepository->createQueryBuilder('f')
    ->andWhere($expr->in('f.id', $ids))
    ->getQuery()
    ->getResult()
;
```

> å‚è€ƒï¼š[Doctrineã§INå¥ã«é…åˆ—æ¸¡ã™æ–¹æ³•ã€‚ - Qiita](https://qiita.com/sotarok/items/ddb30c47951e80782e61)

ã“ã®æ–¹æ³•ã¯ã€å€‹äººçš„ãªæ„Ÿè¦šã¨ã—ã¦ç‰¹ã«ä½•ã‚‚å¿ƒé…ã—ãªãã¦ã‚‚å¸¸ã«æ­£å¸¸ã«å‹•ã„ã¦ãã‚Œã¦ã„ã¾ã™ã€‚

ãªãŠã€1ã¤æ³¨æ„ç‚¹ãŒã‚ã£ã¦ã€ **`$ids` ãŒç©ºã®é…åˆ—ã ã¨SQLãƒ¬ãƒ™ãƒ«ã®ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚**

> å‚è€ƒï¼š[$query->expr()->in and notIn function does not support empty array Â· Issue #8033 Â· doctrine/orm](https://github.com/doctrine/orm/issues/8033)

ãªã®ã§ã€æ¸¡ã™é…åˆ—ãŒç©ºã«ãªã‚Šå¾—ã‚‹å ´åˆã¯ã€ã¡ã‚‡ã£ã¨å¼·å¼•ã§ã™ãŒä»¥ä¸‹ã®ã‚ˆã†ã«å¯¾å‡¦ã—ã¦ãŠãã¨ã‚ˆã„ã§ã™ã€‚

```php
->andWhere($ids ? $expr->in('f.id', $ids) : '1=0')
```

é…åˆ—ãŒç©ºã®å ´åˆã«ã¯ '1=0' ã¨ã„ã†å¿…ãš `false` ã«ãªã‚‹å¼ã‚’ `andWhere()` ã«æ¸¡ã—ã¦ã„ã‚‹ã€ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚ï¼ˆã‚‚ã£ã¨ã„ã„æ–¹æ³•ã”å­˜çŸ¥ã®æ–¹ã¯ [DM](https://twitter.com/ttskch) ãã ã•ã„ğŸ™ï¼‰

# ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ä¸­èº«ãŒé…åˆ—ã®ã¨ãã«ã€ãã®é…åˆ—ãŒç›®çš„ã®å€¤ã‚’å«ã‚“ã§ã„ã‚‹ã‹ã©ã†ã‹ã§çµã‚Šè¾¼ã‚€

ä¸€ç¬ã€INå¥ã‚’ä½¿ã£ã¦å³å·¦è¾ºã‚’å…¥ã‚Œæ›¿ãˆã‚Œã°ã„ã„ã®ã‹ãªï¼Ÿã¨ã‹æ€ã£ã¦ã—ã¾ã„ãã†ã§ã™ãŒã€ã“ã®å ´åˆã¯æ™®é€šã« `like` ã‚’ä½¿ãˆã°ã„ã„ã ã‘ã§ã™âœ‹

```php
$postRepository->createQueryBuilder('p')
    ->andWhere('p.tags like :targetTag')
    ->setParameter('targetTag', sprintf('%%%s%%', $targetTag))
    ->getQuery()
    ->getResult()
;
```

> å‚è€ƒï¼š[php - Is there a way to query if array field contains a certain value in Doctrine2? - Stack Overflow](https://stackoverflow.com/questions/13126220/is-there-a-way-to-query-if-array-field-contains-a-certain-value-in-doctrine2)
