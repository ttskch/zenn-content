---
title: "[Symfony][Doctrine] Single Table Inheritanceã‚’ä½¿ã£ã¦ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«åŸºåº•ã‚¯ãƒ©ã‚¹ã‚’æŒãŸã›ã‚‹"
emoji: "ğŸ»"
type: "tech"
topics: ["php", "symfony", "doctrine"]
published: true
published_at: 2020-07-21
---

:::message
ã“ã®è¨˜äº‹ã¯ã€2020-07-21ã«åˆ¥ã®ãƒ–ãƒ­ã‚°åª’ä½“ã«æŠ•ç¨¿ã—ãŸè¨˜äº‹ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ã™ã€‚
:::

# ã¯ã˜ã‚ã«

[[Symfony][Doctrine] MappedSuperclassã‚’ä½¿ã£ã¦ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«åŸºåº•ã‚¯ãƒ©ã‚¹ã‚’æŒãŸã›ã‚‹](https://zenn.dev/ttskch/articles/675931a29dfdfa)

ã“ã¡ã‚‰ã®è¨˜äº‹ã§ `MappedSuperclass` ã‚’ä½¿ã†æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã—ãŸãŒã€ä»Šå›ã¯ [`Single Table Inheritance`](https://www.doctrine-project.org/projects/doctrine-orm/en/2.7/reference/inheritance-mapping.html#single-table-inheritance) ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã™ã€‚

ä»¥ä¸‹ã®è¦ä»¶ï¼ˆâ†‘ã®è¨˜äº‹ã¨åŒã˜ï¼‰ã‚’ä¾‹ã«ä½¿ã„æ–¹ã‚’èª¬æ˜ã—ã¦ã¿ã¾ã™ã€‚

* `åŠ´åƒè€…` ã¨ã„ã†ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã‚’ç¶™æ‰¿ã—ãŸ `ä¼šç¤¾å“¡` ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨ `ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹` ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ä½œã‚ŠãŸã„

# ã‚„ã‚Šæ–¹

ã¾ãšã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã§ `åŠ´åƒè€…` æŠ½è±¡ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚

```php
/**
 * @ORM\Entity(repositoryClass=WorkerRepository::class)
 * @ORM\InheritanceType("SINGLE_TABLE")
 * @ORM\DiscriminatorColumn(name="type", type="string")
 * @ORM\DiscriminatorMap({"employee" = Employee::class, "freelancer" = Freelancer::class})
 */
abstract class Worker
{
    /**
     * @ORM\Id()
     * @ORM\GeneratedValue()
     * @ORM\Column(type="integer")
     */
    protected $id;

    /**
     * @ORM\Column(type="string", length=255)
     */
    protected $name;
}
```

* `@ORM\InheritanceType("SINGLE_TABLE")` ã«ã‚ˆã£ã¦Single Table Inheritanceã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’å®£è¨€ã—ã¦ã„ã¾ã™
* `@ORM\DiscriminatorColumn(name="type", type="string")` ã«ã‚ˆã£ã¦discriminatorï¼ˆè­˜åˆ¥å­ï¼‰ã¨ã™ã‚‹ã‚«ãƒ©ãƒ ã‚’è¨­å®šã—ã¦ã„ã¾ã™
    * ã‚«ãƒ©ãƒ åã¯ `type` ã€typeã¯ `"string"` ã¨è¨­å®šã—ã¦ã„ã¾ã™
    * ã‚‚ã¡ã‚ã‚“ã“ã‚Œã‚‰ã¯è‡ªç”±ã«æ±ºã‚ã‚‰ã‚Œã¾ã™
* `@ORM\DiscriminatorMap({"employee" = Employee::class, "freelancer" = Freelancer::class})` ã«ã‚ˆã£ã¦ã€discriminatorã‚«ãƒ©ãƒ ã®å€¤ã¨å­ã‚¯ãƒ©ã‚¹ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’è¨­å®šã—ã¦ã„ã¾ã™
    * çœç•¥ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã€ãã®å ´åˆã¯ `Worker` ã‚’ç¶™æ‰¿ã—ã¦ã„ã‚‹ã‚¯ãƒ©ã‚¹ãŒã™ã¹ã¦è¨­å®šã•ã‚Œã€å€¤ã¯å­ã‚¯ãƒ©ã‚¹ã®ã‚¯ãƒ©ã‚¹åã‚’å°æ–‡å­—ã«ã—ãŸã‚‚ã®ã«ãªã‚‹ã‚ˆã†ã§ã™ï¼ˆæœªç¢ºèªğŸ™ï¼‰

ã‚ã¨ã¯æ™®é€šã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨åŒã˜ã‚ˆã†ã« `ä¼šç¤¾å“¡` `ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹` ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ä½œã£ã¦ã€ `åŠ´åƒè€…` æŠ½è±¡ã‚¯ãƒ©ã‚¹ã‚’ç¶™æ‰¿ã—ã¦ã‚ã’ã‚Œã°OKã§ã™ã€‚

```php
/**
 * @ORM\Entity(repositoryClass=EmployeeRepository::class)
 */
class Employee extends Worker
{
    /**
     * @ORM\Column(type="integer")
     */
    private $salary;
}
```

```php
/**
 * @ORM\Entity(repositoryClass=FreelancerRepository::class)
 */
class Freelancer extends Worker
{
    /**
     * @ORM\Column(type="integer")
     */
    private $sales;
}
```

ã“ã‚Œã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«1ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã§ `ä¼šç¤¾å“¡` ã¨ `ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹` ã®2ã¤ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’è¡¨ç¾ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

| id | type | name | salary | sales |
| --- | --- | --- | --- | --- |
| 1 | employee | å±±ç”°å¤ªéƒ | 300000 | NULL |
| 2 | freelancer | éˆ´æœ¨ä¸€éƒ | NULL | 500000 |

# ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã‚‚ã„ã„æ„Ÿã˜

## OneToMany

`MappedSuperclass` ã‚’ä½¿ã£ãŸç¶™æ‰¿ã¯ã€ä»–ã®ã‚¯ãƒ©ã‚¹ã‹ã‚‰åŸºåº•ã‚¯ãƒ©ã‚¹ã‚’ç›´æ¥å‚ç…§ã•ã‚Œã‚‹ã“ã¨ã‚’æƒ³å®šã—ã¦ãŠã‚‰ãšã€[ä»–ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‹ã‚‰åŸºåº•ã‚¯ãƒ©ã‚¹ã«å¯¾ã—ã¦ManyToOneã§ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã‚’å¼µã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã§ã—ãŸ](https://zenn.dev/ttskch/articles/675931a29dfdfa#%E4%BB%96%E3%81%AE%E3%82%A8%E3%83%B3%E3%83%86%E3%82%A3%E3%83%86%E3%82%A3%E3%81%8B%E3%82%89%E5%9F%BA%E5%BA%95%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%AB%E5%AF%BE%E3%81%97%E3%81%A6manytoone%E3%81%A7%E3%83%AA%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%B7%E3%83%83%E3%83%97%E3%82%92%E5%BC%B5%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AF%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84) ãŒã€ `Single Table Inheritance` ã§ã¯ãã‚Œã‚‚å•é¡Œãªãå¯¾å¿œå¯èƒ½ã§ã™ã€‚

éå»è¨˜äº‹ã®ä¾‹ã‚’å€Ÿã‚Šã¦ã€ã€Œ `åŠ´åƒè€…` ãŒ `ä»•äº‹` ã‚’æ‰€æœ‰ã™ã‚‹ã€ã¨ã„ã†ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã‚’è¨­å®šã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```diff
  /**
   * @ORM\Entity(repositoryClass=WorkerRepository::class)
   * @ORM\InheritanceType("SINGLE_TABLE")
   * @ORM\DiscriminatorColumn(name="type", type="string")
   * @ORM\DiscriminatorMap({"employee" = Employee::class, "freelancer" = Freelancer::class})
   */
  abstract class Worker
  {
      /**
       * @ORM\Id()
       * @ORM\GeneratedValue()
       * @ORM\Column(type="integer")
       */
      protected $id;

      /**
       * @ORM\Column(type="string", length=255)
       */
      protected $name;
+
+     /**
+      * @ORM\OneToMany(targetEntity=Job::class, mappedBy="worker")
+      */
+     protected $jobs;
  }
```

```php
/**
 * @ORM\Entity(repositoryClass=JobRepository::class)
 */
class Job
{
    /**
     * @ORM\Id()
     * @ORM\GeneratedValue()
     * @ORM\Column(type="integer")
     */
    private $id;

    /**
     * @ORM\ManyToOne(targetEntity=Worker::class, inversedBy="jobs")
     */
    private $worker;
}
```

ã“ã‚Œã§ç‰¹ã«å•é¡Œãªãå‹•ä½œã—ã¾ã™ğŸ‘

## ManyToOne

`åŠ´åƒè€…` ã‹ã‚‰ã®ManyToOneã‚‚ã„ã„æ„Ÿã˜ã«ã§ãã¾ã™ã€‚

ä¾‹ãˆã°ã€Œ `æ¡ˆä»¶` ãŒ `åŠ´åƒè€…` ã‚’æ‰€æœ‰ã™ã‚‹ã€ã¨ã„ã†ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã‚’è¨­å®šã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```diff
  /**
   * @ORM\Entity(repositoryClass=WorkerRepository::class)
   * @ORM\InheritanceType("SINGLE_TABLE")
   * @ORM\DiscriminatorColumn(name="type", type="string")
   * @ORM\DiscriminatorMap({"employee" = Employee::class, "freelancer" = Freelancer::class})
   */
  abstract class Worker
  {
      /**
       * @ORM\Id()
       * @ORM\GeneratedValue()
       * @ORM\Column(type="integer")
       */
      protected $id;

      /**
       * @ORM\Column(type="string", length=255)
       */
      protected $name;
+
+     /**
+      * @ORM\ManyToOne(targetEntity=Matter::class, inversedBy="workers")
+      */
+     protected $matter;
  }
```

```php
class Matter
{
    /**
     * @ORM\Id()
     * @ORM\GeneratedValue()
     * @ORM\Column(type="integer")
     */
    private $id;

    /**
     * @ORM\OneToMany(targetEntity=Worker::class, mappedBy="matter")
     */
    private $workers;
}
```

ã“ã‚Œã§ã€ `Matter::$workers` ã«ã¯ã€ãã® `æ¡ˆä»¶` ã«æ‰€å±ã—ã¦ã„ã‚‹ `åŠ´åƒè€…` ãŒå…¨å“¡å…¥ã£ã¦ãã¾ã™ğŸ‘

## ç¨®é¡ã”ã¨ã«ManyToOne

ã•ã‚‰ã«ã€ `æ¡ˆä»¶` ã‹ã‚‰ `ä¼šç¤¾å“¡` ã¨ `ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹` ã‚’åˆ¥ã€…ã«å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã®ã‚‚è¶…ç°¡å˜ã«å®Ÿè£…ã§ãã¾ã™ã€‚

```diff
  class Matter
  {
      /**
       * @ORM\Id()
       * @ORM\GeneratedValue()
       * @ORM\Column(type="integer")
       */
      private $id;
  
      /**
       * @ORM\OneToMany(targetEntity=Worker::class, mappedBy="matter")
       */
      private $workers;
+ 
+     /**
+      * @ORM\OneToMany(targetEntity=Employee::class, mappedBy="matter")
+      */
+     private $employees;
+ 
+     /**
+      * @ORM\OneToMany(targetEntity=Freelancer::class, mappedBy="matter")
+      */
+     private $freelancers;
  }
```

```diff
  /**
   * @ORM\Entity(repositoryClass=EmployeeRepository::class)
   */
  class Employee extends Worker
  {
+     /**
+      * @ORM\ManyToOne(targetEntity=Matter::class, inversedBy="employees")
+      */
+     protected $matter;
+ 
      /**
       * @ORM\Column(type="integer")
       */
      private $salary;
  }
```

```diff
  /**
   * @ORM\Entity(repositoryClass=FreelancerRepository::class)
   */
  class Freelancer extends Worker
  {
+     /**
+      * @ORM\ManyToOne(targetEntity=Matter::class, inversedBy="freelancers")
+      */
+     protected $matter;
+ 
      /**
       * @ORM\Column(type="integer")
       */
      private $sales;
  }
```

ã“ã®ã‚ˆã†ã«ã€ `targetEntity` ã‚’å­ã‚¯ãƒ©ã‚¹ã«ã—ã¦ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã‚’æ›¸ãã ã‘ã§ã™ã€‚ç°¡å˜ï¼

## Repository

ã‚‚ã¡ã‚ã‚“ã€Repositoryã‚¯ãƒ©ã‚¹ã‚‚ãã‚Œãã‚Œã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«å¯¾å¿œã™ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã ã‘ã‚’è¿”ã—ã¦ãã‚Œã¾ã™ã€‚

| Repositoryã‚¯ãƒ©ã‚¹| è¿”ã™ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ |
| --- | --- |
| `WorkerRepository` | `Employee` ãŠã‚ˆã³ `Freelancer` |
| `EmployeeRepository` | `Employee` ã®ã¿ |
| `FreelancerRepository` | `Freelancer` ã®ã¿ |

ä¾¿åˆ©ã§ã™ã­ã€œï¼

## âš ï¸æ³¨æ„ç‚¹

ç¨®é¡ã”ã¨ã«ManyToOneã®ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã‚’å¼µã‚‹ã«ã¯ã€ä¸Šè¨˜ã®ã¨ãŠã‚Š `$matter` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å­ã‚¯ãƒ©ã‚¹ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®ã¨ãã€ **`$matter` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å¯è¦–æ€§ãŒ `private` ã ã¨ã€é †å‚ç…§ã¯ã§ãã¦ã‚‚é€†å‚ç…§ãŒã•ã‚Œã¾ã›ã‚“ã€‚**

ã¤ã¾ã‚Šã€ `Matter::$employees` ã‚„ `Matter::$freelancers` ã«ã¯ã¡ã‚ƒã‚“ã¨ `Employee` `Freelancer` ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãŒå…¥ã£ã¦ãã‚Œã‚‹ã®ã§ã™ãŒã€ `Employee::$matter` ã‚„ `Freelancer::$matter` ã¯ `null` ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

> Doctrineã®ã‚³ãƒ¼ãƒ‰ã¾ã§ã¯è¿½ã£ã¦ãªã„ã®ã§ç†å±ˆã¯çŸ¥ã‚Šã¾ã›ã‚“â€¦è©³ã—ã„æ–¹ã„ã‚‰ã£ã—ã‚ƒã£ãŸã‚‰ãœã² [æ•™ãˆã¦](https://twitter.com/ttskch) ãã ã•ã„ğŸ™

# ã¾ã¨ã‚

* Doctrineã® [Single Table Inheritance](https://www.doctrine-project.org/projects/doctrine-orm/en/2.7/reference/inheritance-mapping.html#single-table-inheritance) ã‚’ä½¿ãˆã°ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«åŸºåº•ã‚¯ãƒ©ã‚¹ã‚’æŒãŸã›ã‚‹ã“ã¨ãŒã§ãã‚‹
* `MappedSuperclass` ã‚’ä½¿ã†ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨é•ã£ã¦ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã‚‚ã„ã„æ„Ÿã˜
