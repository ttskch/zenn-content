---
title: "Symfony5+PostgreSQL+Firebase Authãªã‚¢ãƒ—ãƒªã‚’GitHub Actionsã§Herokuã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¾ã§"
emoji: "ğŸ»"
type: "tech"
topics: ["php", "symfony", "postgresql", "firebase", "firebaseauthentication", "githubactions", "heroku"]
published: true
published_at: 2022-02-08
---

:::message
ã“ã®è¨˜äº‹ã¯ã€2022-02-08ã«åˆ¥ã®ãƒ–ãƒ­ã‚°åª’ä½“ã«æŠ•ç¨¿ã—ãŸè¨˜äº‹ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ã™ã€‚
:::

æ„å¤–ã¨èº“ã„ãŸã®ã§ãƒ–ãƒ­ã‚°ã«æ®‹ã—ã¦ãŠãã¾ã™ã€‚

# 1. `Procfile` ã‚’ä½œæˆ

> [PHP å‘ã‘ã® Web ã‚µãƒ¼ãƒãƒ¼ãŠã‚ˆã³ãƒ©ãƒ³ã‚¿ã‚¤ãƒ è¨­å®šã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º | Heroku Dev Center `#nginx`](https://devcenter.heroku.com/ja/articles/custom-php-settings#nginx)

ã‚ãŸã‚Šã‚’å‚è€ƒã« `heroku/nginx/default.conf` ã‚’ä»¥ä¸‹ã®å†…å®¹ã§ä½œæˆã—ã¦ã€

```
location / {
    # try to serve file directly, fallback to rewrite
    try_files $uri @rewriteapp;
}

location @rewriteapp {
    # rewrite all to index.php
    rewrite ^(.*)$ /index.php/$1 last;
}
```

ä»¥ä¸‹ã®å†…å®¹ã§ `Procfile` ã‚’ä½œæˆã—ã¾ã™ã€‚

```
web: vendor/bin/heroku-php-nginx -C heroku/nginx/default.conf public/
```

# 2. `app.json` ã‚’ä½œæˆ

Herokuå´ã®ç’°å¢ƒè¨­å®šã¯Web UIãªã©ã§è¡Œã†ã¨ã—ã¦ã‚‚ã€ã‚¤ãƒ³ãƒ•ãƒ©ã®æƒ…å ±ã‚’ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã«æ®‹ã™æ„å‘³ã§ `app.json` ã‚’ä½œã£ã¦ãŠãã¾ã™ã€‚

```json
{
  "buildpacks": [
    {
      "url": "heroku/nodejs"
    },
    {
      "url": "heroku/php"
    }
  ],
  "addons": [
    {
      "plan": "heroku-postgresql:hobby-dev",
      "options": {
        "version": "13"
      }
    }
  ],
  "env": {
    "APP_ENV": "dev",
    "APP_SECRET": {
      "generator": "secret"
    },
    "DATABASE_URL": "",
    "FIREBASE_CREDENTIALS": {
      "description": "Firebaseã®ç§˜å¯†éµ"
    }
  }
}
```

# 3. `composer.json` ã« `compile` ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒãƒ³ãƒ‰ã‚’è¿½åŠ 

* ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã« `bin/console doctrine:migrations:migrate` ã‚’å®Ÿè¡Œã™ã‚‹
* ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã« `--no-dev` ãªã—ã§ `composer install` ã™ã‚‹
* `--no-dev` ã§ `composer install` ã•ã‚ŒãŸã¨ãã¯ `@auto-scripts` ã‚’å®Ÿè¡Œã—ãªã„ï¼ˆ`require-dev` ã®ã‚¯ãƒ©ã‚¹ãŸã¡ãŒ `ClassNotFoundError` ã«ãªã£ã¦ã—ã¾ã£ã¦ `@auto-scripts` ã®å®Ÿè¡ŒãŒå¤±æ•—ã—ã¦ã—ã¾ã†ã®ã§ï¼‰

ã¨ã„ã†3ã¤ã®ã“ã¨ã‚’é”æˆã™ã¹ãã€`composer.json` ã‚’ä¿®æ­£ã—ã¾ã™ã€‚

è©³ã—ãã¯

> [[PHP] Herokuã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã§require-devã®ä¾å­˜ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ | blog.ttskch](https://blog.ttskch.com/php-heroku-install-require-dev/)

éå»ã«ã“ã¡ã‚‰ã®è¨˜äº‹ã§è§£èª¬ã—ã¦ã„ã¾ã™ã®ã§ã€å…ˆã«ç›®ã‚’é€šã—ã¦ã¿ã¦ã„ãŸã ã‘ã‚‹ã¨ã‚ˆã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“âœ‹

```json
{
    "scripts": {
        "auto-scripts": {
            "cache:clear": "symfony-cmd",
            "assets:install %PUBLIC_DIR%": "symfony-cmd"
        },
        "auto-commands": [
            "npm install"
        ],
        "post-install-cmd": [
            "if [ $COMPOSER_DEV_MODE -ne 0 ]; then composer auto-scripts; fi",
            "@auto-commands"
        ],
        "post-update-cmd": [
            "if [ $COMPOSER_DEV_MODE -ne 0 ]; then composer auto-scripts; fi",
            "@auto-commands"
        ],
        "db-migrate": "bin/console doctrine:migrations:migrate --no-interaction --no-debug --allow-no-migration",
        "compile": [
            "composer install --prefer-dist --optimize-autoloader --no-interaction",
            "@db-migrate"
        ]
    }
}
```

ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚

ã¡ãªã¿ã«ã€æœ€åˆã¯

```json
        "db-migrate": "bin/console doctrine:migrations:migrate --no-interaction --no-debug --allow-no-migration",
```

ã§ã¯ãªã

```json
        "db-migrate": [
            "bin/console doctrine:database:create --if-not-exists",
            "bin/console doctrine:migrations:migrate --no-interaction --no-debug --allow-no-migration"
        ],
```

ã¨æ›¸ã„ã¦ã„ãŸã‚“ã§ã™ãŒã€[Heroku Postgres](https://jp.heroku.com/postgres) ã ã¨ `bin/console doctrine:database:create --if-not-exists` ã‚’å©ã„ãŸæ™‚ç‚¹ã§ `User does not have CONNECT privilege` ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã—ãŸã€‚

> å‚è€ƒï¼š[Why am I seeing "User does not have CONNECT privilege" error with Heroku Postgres on Review Apps? - Heroku Help](https://help.heroku.com/63D7ALXT/why-am-i-seeing-user-does-not-have-connect-privilege-error-with-heroku-postgres-on-review-apps)

webpack-encore ã‚’å°å…¥ã—ã¦ã„ã‚‹å ´åˆã¯ã€`npm install` å¾Œã« `npm run build` ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã† `package.json` ã‚‚ä¿®æ­£ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

```diff
  {
    "scripts": {
      "dev-server": "encore dev-server",
      "dev": "encore dev",
      "watch": "encore dev --watch",
      "build": "encore production --progress",
+     "postinstall": "npm run build"
    }
  }
```

# 4. Firebaseã®ç§˜å¯†éµã‚’ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›ã™ã‚‹ã‚ˆã†ã«

[kreait/firebase-bundle](https://github.com/kreait/firebase-bundle) ã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã€Firebaseã®ç§˜å¯†éµã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã‚€ã“ã¨ã—ã‹ã§ãã¾ã›ã‚“ã€‚

> [kreait/firebase-php](https://github.com/kreait/firebase-php) ã«ã¯ [ç§˜å¯†éµã®JSONæ–‡å­—åˆ—ã‚’æ¸¡ã›ã‚‹APIãŒã‚ã‚‹](https://github.com/kreait/firebase-php/blob/29b07849b81bb83986441e4830a6bd947a59907b/src/Firebase/ServiceAccount.php#L81) ã®ã§ã™ãŒã€`kreait/firebase-bundle` ã§ã¯ãã“ã¯éš è”½ã•ã‚Œã¦ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã—ã‹ã§ããªããªã£ã¦ã„ã¾ã™ã€‚

Herokuã§ã¯ [ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãŒæ°¸ç¶šçš„ã§ã¯ãªã„](https://devcenter.heroku.com/articles/dynos#ephemeral-filesystem) ã®ã§ã€ç’°å¢ƒå¤‰æ•°ã«ç§˜å¯†éµã‚’ã‚»ãƒƒãƒˆã—ã¦ãŠã„ã¦ã€ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ãã®å†…å®¹ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ãã“ã§ã€`composer.json` ã® `auto-commands` ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒãƒ³ãƒ‰ã«ä»¥ä¸‹ã®ã‚ˆã†ãª2è¡Œã‚’è¿½è¨˜ã—ã¦ã¿ã¾ã—ãŸãŒã€**ã“ã‚Œã ã¨ä¸Šæ‰‹ãè¡Œãã¾ã›ã‚“ã§ã—ãŸã€‚**

```diff
  {
      "scripts": {
          "auto-commands": [
              "npm install",
+             "if [ ! -f firebase-credentials-dev.json ]; then echo $FIREBASE_CREDENTIALS > firebase-credentials-dev.json; fi",
+             "if [ ! -f firebase-credentials-prod.json ]; then echo $FIREBASE_CREDENTIALS > firebase-credentials-prod.json; fi"
          ]
      }
  }
```

åŸå› ã¯ã‚ˆãåˆ†ã‹ã£ã¦ã„ã¾ã›ã‚“ãŒã€Herokuç’°å¢ƒä¸Š && Composerã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒãƒ³ãƒ‰çµŒç”±ã®å ´åˆã®ã¿ã€`echo $FIREBASE_CREDENTIALS` ãŒ `\n` ã‚’æ”¹è¡Œæ–‡å­—ã¨ã—ã¦å‡ºåŠ›ã—ã¦ã—ã¾ã„ã€æ­£ã—ã„ç§˜å¯†éµã®å†…å®¹ã§ã¯ãªã `\n` ã¨ã„ã†æ–‡å­—åˆ—ãŒæ”¹è¡Œæ–‡å­—ã«ç½®æ›ã•ã‚ŒãŸå†…å®¹ãŒãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¾ã‚Œã¦ã€Symfonyã®ã‚³ãƒ³ãƒ†ãƒŠã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãŒå¤±æ•—ã—ã¦ã—ã¾ã„ã¾ã—ãŸã€‚

> `echo -E` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§è¡Œã‘ã‚‹ã‹ã¨æ€ã£ãŸã‘ã©Herokuç’°å¢ƒã® `echo` ã‚³ãƒãƒ³ãƒ‰ã«ã¯ `-E` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚

ãªã®ã§ã€`echo` ã‚³ãƒãƒ³ãƒ‰ã®ä»£ã‚ã‚Šã« `php -r` ã‚’ä½¿ã£ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«å¯¾å‡¦ã—ãŸã¨ã“ã‚æœŸå¾…ã©ãŠã‚Šã«å‹•ä½œã—ã¾ã—ãŸã€‚

```diff
  {
      "scripts": {
          "auto-commands": [
              "npm install",
-             "if [ ! -f firebase-credentials-dev.json ]; then echo $FIREBASE_CREDENTIALS > firebase-credentials-dev.json; fi",
-             "if [ ! -f firebase-credentials-prod.json ]; then echo $FIREBASE_CREDENTIALS > firebase-credentials-prod.json; fi"
+             "if [ ! -f firebase-credentials-dev.json ]; then php -r \"echo getenv('FIREBASE_CREDENTIALS');\" > firebase-credentials-dev.json; fi",
+             "if [ ! -f firebase-credentials-prod.json ]; then php -r \"echo getenv('FIREBASE_CREDENTIALS');\" > firebase-credentials-prod.json; fi"
          ]
      }
  }
```

# 5. GitHub Actionsã‹ã‚‰Herokuã«ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹ã‚ˆã†ã«

ã“ã“ã¾ã§ã§ã€ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã¯Herokuã«ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½ãªçŠ¶æ…‹ã«ãªã‚Šã¾ã—ãŸã€‚

æœ€å¾Œã«ã€GitHub Actionsã§ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ãŸã¨ãã®ã¿Herokuã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã‚ˆã†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æ›¸ãã¾ã™ã€‚

```yaml
name: CI

on: push

jobs:
  test:
    # ç•¥

  deploy:
    if: ${{ github.ref == 'refs/heads/main' }} # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushã§ã®ã¿å®Ÿè¡Œ
    needs: test # testã‚’ãƒ‘ã‚¹ã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: akhileshns/heroku-deploy@v3.12.12
        with:
          heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          heroku_app_name: YOUR_HEROKU_APP_NAME
          heroku_email: ${{ secrets.HEROKU_EMAIL }}
```

> å‚è€ƒï¼š
> 
> * [Contexts - GitHub Docs `#determining-when-to-use-contexts`](https://docs.github.com/en/actions/learn-github-actions/contexts#determining-when-to-use-contexts)
> * [Workflow syntax for GitHub Actions - GitHub Docs `#jobsjob_idneeds`](https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idneeds)
> * [Deploy to Heroku Â· Actions Â· GitHub Marketplace](https://github.com/marketplace/actions/deploy-to-heroku)

[Deploy to Heroku](https://github.com/marketplace/actions/deploy-to-heroku) ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ãˆã°GitHub Actionsã‹ã‚‰ç°¡å˜ã«Herokuã«ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¾ã™ã€‚

Herokuã®APIã‚­ãƒ¼ã¨Herokuã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå¿…è¦ãªã®ã§ã€

<https://dashboard.heroku.com/account/applications>

ã® `Create Authorization` ã§APIã‚­ãƒ¼ã‚’ä½œæˆã—ã¦ã€

![](https://tva1.sinaimg.cn/large/008i3skNgy1gz65wrvpd8j31xc0di0tw.jpg)

`https://github.com/{owner}/{repo}/settings/secrets/actions`

ã® `New repository secret` ã§ `HEROKU_API_KEY` ã¨ã—ã¦ç™»éŒ²ã—ã¾ã™ã€‚åŒæ§˜ã« `HEROKU_EMAIL` ã¨ã—ã¦ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚‚ç™»éŒ²ã—ã¾ã™ã€‚

![](https://tva1.sinaimg.cn/large/008i3skNgy1gz65zea4xwj31130u0wi0.jpg)

ã“ã‚Œã§ã€mainãƒ–ãƒ©ãƒ³ãƒãŒæ›´æ–°ã•ã‚Œã¦ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã—ãŸã‚‰è‡ªå‹•ã§Herokuã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸğŸ‘
