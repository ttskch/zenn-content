---
title: "[Symfony] ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ç³»ã®é …ç›®ã‚’æŒãŸã›ã‚‹å®Ÿè£…ä¾‹"
emoji: "ğŸ»"
type: "tech"
topics: ["php", "symfony"]
published: true
published_at: 2020-12-19
---

:::message
ã“ã®è¨˜äº‹ã¯ã€2020-12-19ã«åˆ¥ã®ãƒ–ãƒ­ã‚°åª’ä½“ã«æŠ•ç¨¿ã—ãŸè¨˜äº‹ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ã™ã€‚
:::

# ã¯ã˜ã‚ã«

[Symfony Advent Calendar 2020](https://qiita.com/advent-calendar/2020/symfony) ã®19æ—¥ç›®ã®è¨˜äº‹ã§ã™ï¼ğŸ„ğŸŒ™

æ˜¨æ—¥ã‚‚åƒ•ã®è¨˜äº‹ã§ã€[[Symfony] æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã§CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’é€ã‚‹æ–¹æ³•](https://zenn.dev/ttskch/articles/cdedca841727c2) ã§ã—ãŸâœ¨

> ã¡ãªã¿ã«ã€åƒ•ã¯ã‚ˆã [Twitterã«ã‚‚Symfonyãƒã‚¿ã‚’å‘Ÿã„ã¦ã„ã‚‹](https://twitter.com/search?q=from%3Attskch%20(symfony%20OR%20doctrine)&src=typed_query&f=live) ã®ã§ã€ã‚ˆã‚ã—ã‘ã‚Œã°ãœã² [ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã‚„ã£ã¦ãã ã•ã„ğŸ•ŠğŸ¤²](https://twitter.com/ttskch)

# ã‚„ã‚ŠãŸã„ã“ã¨

* ã„ãã¤ã‹ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ç³»ã®é …ç›®ãŒã‚ã‚‹
* å„é …ç›®ãã‚Œãã‚Œã«1ã€œè¤‡æ•°ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ·»ä»˜ã§ãã‚‹

ã“ã‚“ãªè¦ä»¶ã®å®Ÿè£…ã‚’è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚

# ã‚„ã‚Šæ–¹1ï¼šæ™®é€šã« `File` ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ä½œã‚‹

ã”ãæ™®é€šã«ä½œã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã«ãªã‚‹ã‹ãªã¨æ€ã„ã¾ã™ã€‚

```php
/**
 * @ORM\Entity(repositoryClass=FooRepository::class)
 */
class Foo
{
    /**
     * @var Collection|File[]
     *
     * @ORM\OneToMany(targetEntity=File::class, mappedBy="foo", cascade={"persist", "remove"})
     */
    public Collection $files;
}
```

```php
/**
 * @ORM\Entity(repositoryClass=BarRepository::class)
 */
class Bar
{
    /**
     * @var Collection|File[]
     *
     * @ORM\OneToMany(targetEntity=File::class, mappedBy="bar", cascade={"persist", "remove"})
     */
    public Collection $files;
}
```

```php
/**
 * @ORM\Entity(repositoryClass=FileRepository::class)
 */
class File
{
    /**
     * @ORM\Column(type="string", length=255)
     */
    public ?string $url = null;

    /**
     * @ORM\ManyToOne(targetEntity=Foo::class, inversedBy="files")
     */
    public ?Foo $foo = null;

    /**
     * @ORM\ManyToOne(targetEntity=Bar::class, inversedBy="files")
     */
    public ?Bar $bar = null;
}
```

> `File` ã‚¯ãƒ©ã‚¹ã‚„ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†ã®å®Ÿè£…ã®è©³ç´°ã«ã¤ã„ã¦ã¯ã“ã®è¨˜äº‹ã§ã¯è§£èª¬ã—ã¾ã›ã‚“ğŸ™

ä»–ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«ã‚‚ `$files` é …ç›®ãŒç™»å ´ã—ãŸã‚‰ã€ãã®éƒ½åº¦ `File` ã‚¯ãƒ©ã‚¹ã«ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¦ã„ãæ„Ÿã˜ã§ã™ã­ã€‚

```diff
  /**
   * @ORM\Entity(repositoryClass=FileRepository::class)
   */
  class File
  {
      /**
       * @ORM\Column(type="string", length=255)
       */
      public ?string $url = null;
  
      /**
       * @ORM\ManyToOne(targetEntity=Foo::class, inversedBy="files")
       */
      public ?Foo $foo = null;
  
      /**
       * @ORM\ManyToOne(targetEntity=Bar::class, inversedBy="files")
       */
      public ?Bar $bar = null;
+ 
+     /**
+      * @ORM\ManyToOne(targetEntity=Baz::class, inversedBy="files")
+      */
+     public ?Baz $baz = null;
  }
```

ã“ã‚Œã§ç‰¹ã«å•é¡Œãªãå¯¾å¿œã§ãã¾ã™ãŒã€ã“ã®å®Ÿè£…ã ã¨ **1ã¤ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«è¤‡æ•°ã®æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«é …ç›®ãŒå¿…è¦ã«ãªã‚‹ã¨ã€ã¡ã‚‡ã£ã¨ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒæ•£ã‚‰ã‹ã£ã¦ãã¾ã™ã€‚**

## 1ã¤ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«è¤‡æ•°ã®æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«é …ç›®ãŒã‚ã‚‹ã¨

```php
/**
 * @ORM\Entity(repositoryClass=BazRepository::class)
 */
class Baz
{
    /**
     * @var Collection|File[]
     *
     * @ORM\OneToMany(targetEntity=File::class, mappedBy="bazAsXxxOwner", cascade={"persist", "remove"})
     */
    public Collection $xxxFiles;

    /**
     * @var Collection|File[]
     *
     * @ORM\OneToMany(targetEntity=File::class, mappedBy="bazAsYyyOwner", cascade={"persist", "remove"})
     */
    public Collection $yyyFiles;
}
```

```php
/**
 * @ORM\Entity(repositoryClass=FileRepository::class)
 */
class File
{
    /**
     * @ORM\Column(type="string", length=255)
     */
    public ?string $url = null;

    /**
     * @ORM\ManyToOne(targetEntity=Baz::class, inversedBy="xxxFiles")
     */
    public ?Baz $bazAsXxxOwner = null;

    /**
     * @ORM\ManyToOne(targetEntity=Baz::class, inversedBy="yyyFiles")
     */
    public ?Baz $bazAsYyyOwner = null;
}
```

ã“ã‚“ãªæ„Ÿã˜ã§ã€ `File` ã‹ã‚‰è¦‹ã‚‹ã¨è¦ªã§ã‚ã‚‹ `Baz` ã‚’2ã¤åˆ¥ã€…ã«èªè­˜ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å¤‰æ•°åã‚‚ã€ã©ã†ã—ã¦ã‚‚ã¡ã‚‡ã£ã¨é¢å€’è‡­ã„æ„Ÿã˜ã®åå‰ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

# ã‚„ã‚Šæ–¹2ï¼šSingle Table Inheritanceã‚’ä½¿ã£ã¦å°‘ã—æ•´ç†ã™ã‚‹

Doctrineã® [Single Table Inheritance](https://www.doctrine-project.org/projects/doctrine-orm/en/2.7/reference/inheritance-mapping.html#single-table-inheritance) ã‚’ä½¿ã†ã¨ã€ä¸Šè¨˜ã®ã¡ã‚‡ã£ã¨æ°—æŒã¡æ‚ªã„å®Ÿè£…ã‚’å°‘ã—ãã‚Œã„ã«æ•´ç†ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

> Single Table Inheritanceã®è©³ç´°ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®éå»è¨˜äº‹ã‚’ã”å‚ç…§ãã ã•ã„ã€‚
>
> [[Symfony][Doctrine] Single Table Inheritanceã‚’ä½¿ã£ã¦ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«åŸºåº•ã‚¯ãƒ©ã‚¹ã‚’æŒãŸã›ã‚‹](https://zenn.dev/ttskch/articles/890af3fe4e0a92)

```php
// src/Entity/File.php

namespace App\Entity;

use App\Entity\Baz\XxxFile as BazXxxFile;
use App\Entity\Baz\YyyFile as BazYyyFile;

/**
 * @ORM\Entity(repositoryClass=FileRepository::class)
 * @ORM\InheritanceType("SINGLE_TABLE")
 * @ORM\DiscriminatorColumn(name="type", type="string")
 * @ORM\DiscriminatorMap({
 *     "baz_xxx_file" = BazXxxFile::class,
 *     "baz_yyy_file" = BazYyyFile::class,
 * })
 */
abstract class File
{
    /**
     * @ORM\Column(type="string", length=255)
     */
    public ?string $url = null;
}
```

```php
// src/Entity/Baz/XxxFile.php

namespace App\Entity\Baz;

use src/Entity/File as BaseFile;

/**
 * @ORM\Entity(repositoryClass=FileRepository::class)
 */
class XxxFile extends BaseFile
{
    /**
     * @ORM\ManyToOne(targetEntity=Baz::class, inversedBy="xxxfiles")
     */
    public ?Baz $baz = null;
}
```

```php
// src/Entity/Baz/YyyFile.php

namespace App\Entity\Bar;

use src/Entity/File as BaseFile;

/**
 * @ORM\Entity(repositoryClass=FileRepository::class)
 */
class YyyFile extends BaseFile
{
    /**
     * @ORM\ManyToOne(targetEntity=Baz::class, inversedBy="yyyfiles")
     */
    public ?Baz $baz = null;
}
```

```php
use App\Entity\Baz\XxxFile as BazXxxFile;

/**
 * @ORM\Entity(repositoryClass=BazRepository::class)
 */
class Baz
{
    /**
     * @var Collection|BazXxxFile[]
     *
     * @ORM\OneToMany(targetEntity=BazXxxFile::class, mappedBy="baz", cascade={"persist", "remove"})
     */
    public Collection $xxxFiles;

    /**
     * @var Collection|BazYyyFile[]
     *
     * @ORM\OneToMany(targetEntity=BazYyyFile::class, mappedBy="baz", cascade={"persist", "remove"})
     */
    public Collection $yyyFiles;
}
```

ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚

å„æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«é …ç›®ï¼ˆ `$xxxFiles` `$yyyFiles` ï¼‰ãã‚Œãã‚Œã«åˆ¥ã€…ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼ˆ `BazXxxFile` `BazYyyFile` ï¼‰ãŒå¯¾å¿œã™ã‚‹ã®ã§ã€å¤‰æ•°åã‚‚ãã‚Œã„ã«ãªã‚Šã¾ã™ã—ã€ä»–ã«ã‚‚

* èª¤ã£ã¦è¤‡æ•°ã®è¦ªã«ç´ã¥ãã‚ˆã†ãª `File` ã‚’ä½œã£ã¦ã—ã¾ã†ã“ã¨ãŒãªã„
* ã©ã®é …ç›®ã® `File` ãªã®ã‹ã‚’ `instanceof` ã§æ­£ç¢ºã«çŸ¥ã‚‹ã“ã¨ãŒã§ãã‚‹

ãªã©ã®ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚

æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«é …ç›®ãŒå¢—ãˆãŸã¨ãã¯ã€å¯¾å¿œã™ã‚‹ `File` æ´¾ç”Ÿã‚¯ãƒ©ã‚¹ã‚’ä½œã£ã¦ã€ `File` åŸºåº•ã‚¯ãƒ©ã‚¹ã«Single Table Inheritanceã®å®šç¾©ã‚’æ›¸ãè¶³ã›ã°OKã§ã™ã€‚

```php
use App\Entity\Baz\XxxFile as BazXxxFile;

/**
 * @ORM\Entity(repositoryClass=FooRepository::class)
 */
class Foo
{
    /**
     * @var Collection|FooFile[]
     *
     * @ORM\OneToMany(targetEntity=FooFile::class, mappedBy="foo", cascade={"persist", "remove"})
     */
    public Collection $files;
}
```

```diff
  // src/Entity/File.php
  
  namespace App\Entity;
  
  use App\Entity\Baz\XxxFile as BazXxxFile;
  use App\Entity\Baz\YyyFile as BazYyyFile;
+ use App\Entity\Foo\File as FooFile;
  
  /**
   * @ORM\Entity(repositoryClass=FileRepository::class)
   * @ORM\InheritanceType("SINGLE_TABLE")
   * @ORM\DiscriminatorColumn(name="type", type="string")
   * @ORM\DiscriminatorMap({
+  *     "foo_file" = FooFile::class,
   *     "baz_xxx_file" = BazXxxFile::class,
   *     "baz_yyy_file" = BazYyyFile::class,
   * })
   */
  abstract class File
  {
      /**
       * @ORM\Column(type="string", length=255)
       */
      public ?string $url = null;
  }
```

# ãŠã‚ã‚Šã«

Symfonyã§ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ç³»ã®é …ç›®ã‚’æŒãŸã›ã‚‹å®Ÿè£…ä¾‹ã‚’2ãƒ‘ã‚¿ãƒ¼ãƒ³ç´¹ä»‹ã—ã¦ã¿ã¾ã—ãŸã€‚

æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã®ä»–ã«ã‚‚ã€ä¾‹ãˆã° **è‰²ã€…ãªã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«å¯¾ã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã‘ã‚‹æ©Ÿèƒ½** ã¨ã‹ã§ã‚‚åŒæ§˜ã®å®Ÿè£…ãŒä½¿ãˆã‚‹ã‹ãªã¨æ€ã„ã¾ã™ã€‚

[Symfony Advent Calendar 2020](https://qiita.com/advent-calendar/2020/symfony)ã€æ˜æ—¥ã¯ [@kaino5454](https://twitter.com/kaino5454) ã•ã‚“ã§ã™ï¼ãŠæ¥½ã—ã¿ã«ï¼
