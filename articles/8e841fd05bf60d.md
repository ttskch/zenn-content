---
title: "DigitalOceanã®Ubuntu 18.04ã«PHP 7.3ã®LAMPç’°å¢ƒã¨SSLåŒ–ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦Deployerã§ãƒ‡ãƒ—ãƒ­ã‚¤"
emoji: "ğŸ˜"
type: "tech"
topics: ["php", "apache", "digitalocean", "deployer"]
published: true
published_at: 2020-05-05
---

:::message
ã“ã®è¨˜äº‹ã¯ã€2020-05-05ã«åˆ¥ã®ãƒ–ãƒ­ã‚°åª’ä½“ã«æŠ•ç¨¿ã—ãŸè¨˜äº‹ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ã™ã€‚
:::

DigitalOceanã®Ubuntu 18.04ã‚¤ãƒ¡ãƒ¼ã‚¸ã«PHP7.3ã®LAMPç’°å¢ƒã¨SSLåŒ–ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦ã€Deployerã§ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã¾ã§ã®ã™ã¹ã¦ã®æ‰‹é †ã‚’ä¸å¯§ã«åˆ—æŒ™ã—ã¾ã™ã€‚

> ã•ãã‚‰ã®VPSç‰ˆã¯ [ã“ã¡ã‚‰](https://zenn.dev/ttskch/articles/d43d001c9b1b2d)

# 1. Dropletã‚’ä½œæˆ

ä»Šå›ã¯ç´ ã®Ubuntuã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ™ãƒ¼ã‚¹ã«æ§‹ç¯‰ã™ã‚‹æ‰‹é †ã‚’è§£èª¬ã—ã¾ã™ã€‚

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gehavhnrkcj31l00h20vl.jpg)

> Marketplaceã‹ã‚‰LAMPã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’é¸æŠã™ã‚Œã°ã€ä»¥é™ã®æ‰‹é †ã®ã†ã¡ã„ãã¤ã‹ã‚’çœç•¥ã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚
>
> ![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gehawin76sj30wk0fsdh5.jpg)

# 2. Dropletã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

**ãƒ­ãƒ¼ã‚«ãƒ«å´**

```bash
$ ssh root@xxx.xxx.xxx.xxx
```

**ã‚µãƒ¼ãƒãƒ¼å´**

```bash
# ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’å¤‰æ›´
% timedatectl set-timezone Asia/Tokyo

% apt update

# PHP7.3ã‚’å…¥ã‚Œã‚‹ãŸã‚ã®ç”¨æ„ï¼ˆæ¨™æº–ã®ã¾ã¾ã ã¨7.2ãŒå…¥ã£ã¦ã—ã¾ã†ï¼‰
% apt install software-properties-common -y
% apt-add-repository ppa:ondrej/php
% apt update

# LAMPç’°å¢ƒã‚’ä½œã‚‹ï¼ˆapache2ã¯Ubuntu 18.04ã«åˆã‚ã‹ã‚‰å…¥ã£ã¦ã„ã‚‹ã®ã§è¿½åŠ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸è¦ï¼‰
% apt install php7.3 mysql-server php7.3-mysql -y
% a2dismod php7.2
% a2enmod php7.3
% service apache2 restart

# å¿…è¦ã«å¿œã˜ã¦PHPã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆä¸‹è¨˜ã¯ä¾‹ï¼‰
% apt install php7.3-ctype php7.3-fileinfo php7.3-iconv php7.3-mbstring php7.3-simplexml php7.3-xml -y

# Deployerã«ã‚ˆã‚‹ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¿…è¦ãªã‚‚ã®ã‚’ä¸€å¼ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# @see acl: https://github.com/deployphp/deployer/issues/1118#issuecomment-296160569
% apt install git curl zip unzip php-zip acl -y

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ“ãƒ«ãƒ‰ç”¨ã«æœ€æ–°ã®npmã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆæ¨™æº–ã ã¨3.5.2ãŒå…¥ã‚‹ã®ã§ã•ã™ãŒã«å¤ã„ï¼‰
# @see https://qiita.com/seibe/items/36cef7df85fe2cefa3ea
% apt install nodejs npm -y
% npm -v
3.5.2
% npm i -g n
% n stable
% exec $SHELL -l
% npm -v
6.14.4

# Apacheã®mod_rewriteã‚’æœ‰åŠ¹åŒ–
% a2enmod rewrite
% service apache2 restart

# ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã‚’æœ‰åŠ¹åŒ–
% ufw allow 80
% ufw allow 443
% ufw allow 22
% ufw enable
% ufw status
Status: active

To                         Action      From
--                         ------      ----
80                         ALLOW       Anywhere
443                        ALLOW       Anywhere
22                         ALLOW       Anywhere
80 (v6)                    ALLOW       Anywhere (v6)
443 (v6)                   ALLOW       Anywhere (v6)
22 (v6)                    ALLOW       Anywhere (v6)

# MySQLã‚’è¨­å®š
% service mysql start
% mysql -uroot

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆ
mysql> create database database_name;

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ
mysql> create user user@localhost identified by "password_here";
mysql> grant all privileges on database_name.* to user@localhost;

mysql> exit;
```

# 3. Ubuntuã«ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ 

ãƒ‡ãƒ—ãƒ­ã‚¤ã«rootãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ä½¿ã„ãŸããªã„ã®ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ã—ã¾ã™ã€‚

**ã‚µãƒ¼ãƒãƒ¼å´**

```bash
% useradd user -m # ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚‚åŒæ™‚ã«ä½œæˆ
% passwd user # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®š

# ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚‚SSHãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã‚ˆã†ã«
% su user
> mkdir ~/.ssh
> vi ~/.ssh/authorized_keys # ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚·ãƒ³ã‚„CIã‚µãƒ¼ãƒãƒ¼ã®å…¬é–‹éµã‚’è¿½è¨˜ã™ã‚‹
> exit 

# ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ«ãƒ¼ãƒˆã«æ›¸ãè¾¼ã¿ã§ãã‚‹ã‚ˆã†ã«
% chown -R user:user /var/www/html
```

# 4. ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰GitHubã®ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã‚’pullã§ãã‚‹ã‚ˆã†ã«

GitHubãƒªãƒã‚¸ãƒˆãƒªãŒprivateãªå ´åˆã¯ã€ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ã‚µãƒ¼ãƒãƒ¼ãŒpullã§ãã‚‹ã‚ˆã†ã«SSHã‚­ãƒ¼ã‚’GitHubã«ç™»éŒ²ã—ã¦ãŠãã¾ã™ã€‚

**ã‚µãƒ¼ãƒãƒ¼å´**

```bash
% su user
> ssh-keygen -t rsa -N "" -C "" -f ~/.ssh/id_rsa
> cat ~/.ssh/id_rsa.pub # ã“ã®å…¬é–‹éµã‚’ã‚³ãƒ”ãƒ¼
> exit
```

ã‚³ãƒ”ãƒ¼ã—ãŸå…¬é–‹éµã‚’ `https://github.com/{user}/{repo}/settings/keys/new` ã§é©å½“ãªåå‰ã‚’ä»˜ã‘ã¦ç™»éŒ²ã—ã¾ã™ã€‚

# 5. ä¸€æ—¦ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œ

ã‚ã‚‹ç¨‹åº¦è¤‡é›‘ãªæ§‹æˆã®ã‚¢ãƒ—ãƒªãªã‚‰ã€ã‚µãƒ¼ãƒãƒ¼å´ã§è‰²ã€…å¿…è¦ãªè¨­å®šã‚’ã—ã¦ã„ãªã„çŠ¶æ…‹ã®åˆå›ã®ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—ã™ã‚‹ã¨æ€ã„ã¾ã™ãŒã€ã‚µãƒ¼ãƒãƒ¼å´ã«ãƒ•ã‚¡ã‚¤ãƒ«ä¸€å¼ã‚’ç”Ÿæˆã•ã›ã‚‹ãŸã‚ã«ä¸€æ—¦ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

**ãƒ­ãƒ¼ã‚«ãƒ«å´**

Deployerã®ä½¿ã„æ–¹ã«ã¤ã„ã¦ã¯ [ã“ã¡ã‚‰ã®éå»è¨˜äº‹](https://zenn.dev/ttskch/articles/2598d4acbf342c#_4-%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E3%82%B3%E3%83%BC%E3%83%89%E3%83%99%E3%83%BC%E3%82%B9%E3%81%ABdeployer%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E8%BF%BD%E5%8A%A0) ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

```bash
$ dep deploy
# å¤±æ•—ã™ã‚‹ã®ã‚’å¾…ã¤
```

**ã‚µãƒ¼ãƒãƒ¼å´**

```bash
# ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®ã†ã¡Webã‚µãƒ¼ãƒãƒ¼ãŒæ›¸ãè¾¼ã¿ã‚’è¡Œã†ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒã‚ã‚Œã°ã€ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’è¨­å®šã™ã‚‹
% chmod -R a+rw /var/www/html/{project_name}/shared/path/to/{writable_dirs}
# â€» ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®Webã‚µãƒ¼ãƒãƒ¼å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ã¯ www-data ãªã®ã§ã€ã‚‚ã†å°‘ã—å³ã—ãè¨­å®šã—ãŸã„å ´åˆã¯ chmod -R a+w ã§ã¯ãªãã€chmod -R www-data:user ã¨ã‹ã«ã™ã‚‹ã¨ã‚ˆã„ã‹ã¨æ€ã„ã¾ã™  

# ä¾‹ãˆã° .env.dist ã‚’ .env ã«ãƒªãƒãƒ¼ãƒ ã—ã¦å†…å®¹ã‚’é©åˆ‡ã«å¤‰æ›´ã™ã‚‹ãªã©ã‚’è¡Œã†
% cat /var/www/html/{project_name}/release/.env.dist > /var/www/html/{project_name}/shared/.env
% vi /var/www/html/{project_name}/shared/.env # é©åˆ‡ã«å¤‰æ›´
```

**ãƒ­ãƒ¼ã‚«ãƒ«å´**

ã‚µãƒ¼ãƒãƒ¼å´ã®æº–å‚™ãŒæ•´ã£ãŸã‚‰ã€å†åº¦ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿæ–½ã—ã¾ã™ã€‚ã‚µãƒ¼ãƒãƒ¼å´ã®èª¿æ•´ãŒæ­£ã—ãæ¸ˆã‚“ã§ã„ã‚Œã°ã€ä»Šåº¦ã¯æˆåŠŸã—ã¾ã™ğŸ‘

```bash
$ dep deploy
```

# 6. Apacheã®Virtual Hostã‚’ä½œæˆ

Apacheã®vhostã®è¨­å®šå†…å®¹ã‚‚ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã§ç®¡ç†ã—ã¦ãŠãã®ãŒãŠã™ã™ã‚ã§ã™ã€‚åƒ•ã¯ã„ã¤ã‚‚

* `/docs/apache/http.conf`
* `/docs/apache/https.conf`

ã¿ãŸã„ãªæ„Ÿã˜ã§ `SSLåŒ–ã—ã¦ãªã„ã¨ãç”¨` `SSLåŒ–ã—ãŸã‚ã¨ç”¨` ã®2ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã«å…¥ã‚Œã¦ã‚ã‚Šã¾ã™ã€‚

ä»¥é™ã®èª¬æ˜ã¯ã“ã‚Œã‚’å‰æã«é€²ã‚ã¾ã™ğŸ™

## `http.conf` ã®å†…å®¹

åƒ•ãŒã„ã¤ã‚‚ä½¿ã£ã¦ã„ã‚‹ã®ã¯ã ã„ãŸã„ã“ã‚“ãªå†…å®¹ã§ã™ã€‚

```
<Directory />
    AllowOverride None
    Deny from all
</Directory>

<Directory "/var/www/html/{project_name}/current/public">
    AllowOverride All
    Options -Indexes +FollowSymLinks
    Order allow,deny
    Allow from all
    Require all granted
</Directory>

<FilesMatch \.php$>
    SetHandler application/x-httpd-php
</FilesMatch>

<VirtualHost *:80>
    ServerName {domain}
    # ServerAlias xxx.xxx.xxx.xxx
    DocumentRoot "/var/www/html/{project_name}/current/public"
    ErrorLog ${APACHE_LOG_DIR}/{project_name}.error.log
    CustomLog ${APACHE_LOG_DIR}/{project_name}.access.log common
</VirtualHost>
```

## `https.conf` ã®å†…å®¹

åƒ•ãŒã„ã¤ã‚‚ä½¿ã£ã¦ã„ã‚‹ã®ã¯ã ã„ãŸã„ã“ã‚“ãªå†…å®¹ã§ã™ã€‚

```
<Directory />
    AllowOverride None
    Deny from all
</Directory>

<Directory "/var/www/html/{project_name}/current/public">
    AllowOverride All
    Options -Indexes +FollowSymLinks
    Order allow,deny
    Allow from all
    Require all granted
</Directory>

<FilesMatch \.php$>
    SetHandler application/x-httpd-php
</FilesMatch>

<IfModule mod_ssl.c>
    <VirtualHost *:443>
        SSLEngine on
        SSLCertificateFile /etc/letsencrypt/live/{project_name}/fullchain.pem
        SSLCertificateKeyFile /etc/letsencrypt/live/{project_name}/privkey.pem
        BrowserMatch "MSIE [2-6]" nokeepalive ssl-unclean-shutdown downgrade-1.0 force-response-1.0
        BrowserMatch "MSIE [17-9]" ssl-unclean-shutdown
        <FilesMatch \.php$>
            SSLOptions +StdEnvVars
        </FilesMatch>

        ServerName {project_name}
        DocumentRoot "/var/www/html/{project_name}/current/public"
        ErrorLog ${APACHE_LOG_DIR}/{project_name}.error.log
        CustomLog ${APACHE_LOG_DIR}/{project_name}.access.log common
    </VirtualHost>
</IfModule>

<VirtualHost *:80>
    ServerName {project_name}
    RedirectMatch (.*) https://{project_name}$1
</VirtualHost>
```

## å®Ÿéš›ã«è¨­å®š

**ã‚µãƒ¼ãƒãƒ¼å´**

```bash
# ä½¿ã‚ãªã„ã®ã§å‰Šé™¤
% a2dissite 000-default.conf

# vhostã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã‚³ãƒ”ãƒ¼
% cp /var/www/html/{project_name}/current/docs/apache/http.conf /etc/apache2/sites-available/{project_name}.conf
% a2ensite {project_name}.conf
% service apache2 reload
```

ã“ã‚Œã§ã²ã¨ã¾ãš `http` ã§ã‚µã‚¤ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹çŠ¶æ…‹ã¾ã§æ¥ã¾ã—ãŸğŸ‘

# 7. SSLåŒ–

**ã‚µãƒ¼ãƒãƒ¼å´**

```bash
# certbotï¼ˆLet's Encryptã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã€è¨¼æ˜æ›¸ã‚’å–å¾—
% apt install certbot -y
% certbot certonly --agree-tos --webroot -w /var/www/html/{project_name}/current/public -d {ãƒ‰ãƒ¡ã‚¤ãƒ³}
# å¯¾è©±å¼ã§è¨­å®šã‚’åŸ‹ã‚ã¦ã„ã£ã¦ãã ã•ã„

# Apacheã§SSLã‚’æœ‰åŠ¹åŒ–ã—ã¦ã€confãƒ•ã‚¡ã‚¤ãƒ«ã‚’SSLç”¨ã®ã‚‚ã®ã«å…¥ã‚Œæ›¿ãˆ
% a2enmod ssl
% cp /var/www/html/{project_name}/current/docs/apache/https.conf /etc/apache2/sites-available/{project_name}.conf
% service apache2 restart
```

ã“ã‚Œã§ã€ `https` ã§ã‚µã‚¤ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹çŠ¶æ…‹ã«ãªã‚Šã¾ã™ğŸ‘
