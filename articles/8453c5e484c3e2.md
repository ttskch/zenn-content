---
title: "[2021å¹´ç‰ˆ] ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒSymfony5ãªSPAã‚’Firebase Authenticationã§ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹æ–¹æ³•"
emoji: "ğŸ»"
type: "tech"
topics: ["php", "symfony", "firebase", "firebaseauthentication", "angular", "apolloangular"]
published: true
published_at: 2021-09-01
---

:::message
ã“ã®è¨˜äº‹ã¯ã€2021-09-01ã«åˆ¥ã®ãƒ–ãƒ­ã‚°åª’ä½“ã«æŠ•ç¨¿ã—ãŸè¨˜äº‹ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ã™ã€‚
:::

# ã¯ã˜ã‚ã«

ã“ã®è¨˜äº‹ã¯ã€ä»¥å‰åƒ•ãŒæ›¸ã„ãŸ [ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒSymfonyãªSPAã‚’Firebase Authenticationã§ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ | QUARTETCOM TECH BLOG](https://tech.quartetcom.co.jp/2018/12/19/symfony4-firebase-authentication/) ã¨ã„ã†è¨˜äº‹ã®2021å¹´ç‰ˆã§ã™ã€‚

Symfonyã§ã¯ [Security Component](https://symfony.com/doc/current/security.html) ã‚’ä½¿ã£ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€

* ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—æ™‚ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹èªè¨¼ï¼ˆæœ¬äººç¢ºèªï¼‰ã®å‡¦ç†
* ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´æ™‚ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹èªè¨¼ï¼ˆæœ¬äººç¢ºèªï¼‰ã®å‡¦ç†
* ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã®å‡¦ç†
* SNSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚ˆã‚‹ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—/ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½

ãªã©ã‚’ã™ã¹ã¦è‡ªå‰ã§å®Ÿè£…ã—ã‚ˆã†ã¨æ€ã†ã¨çµæ§‹å¤§å¤‰ãªã®ã§ã€[Firebase Authentication](https://firebase.google.com/docs/auth) ã‚’ä½¿ã£ã¦æ¥½ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€ã¨ã„ã†å†…å®¹ã§ã™ã€‚

[Symfony 5.1ã§èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ãŒå¤§ããå¤‰æ›´ã«ãªã£ãŸ](https://symfony.com/blog/new-in-symfony-5-1-updated-security-system) ã“ã¨ã§è¨˜äº‹å†…ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã®æ›¸ãæ–¹ãªã©ãŒé™³è…åŒ–ã—ã¦ã—ã¾ã£ãŸã®ã§ã€2021å¹´ç‰ˆã¨ã—ã¦æ”¹ã‚ã¦ã¾ã¨ã‚ã¦ãŠãã“ã¨ã«ã—ã¾ã—ãŸã€‚

ã¨ã„ã†ã“ã¨ã§ã€ä»Šå›ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«Symfony5ï¼ˆ5.1+ï¼‰ã‚’ä½¿ã£ã¦ã„ã‚‹SPAãŒã‚ã‚‹ã¨ä»®å®šã—ã¦ã€ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æ©Ÿæ§‹ã«Firebase Authenticationã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦è§£èª¬ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

# Firebase Authenticationã¨ã¯

[å…¬å¼ã‚µã‚¤ãƒˆ](https://firebase.google.com/docs/auth) ã«ã‚ˆã‚‹ã¨ã€

> Firebase Authentication ã«ã¯ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ ã‚µãƒ¼ãƒ“ã‚¹ã€ä½¿ã„ã‚„ã™ã„ SDKã€ã‚¢ãƒ—ãƒªã§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã«ä½¿ç”¨ã§ãã‚‹ UI ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚Firebase Authentication ã§ã¯ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€é›»è©±ç•ªå·ã€ä¸€èˆ¬çš„ãªãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ ID ãƒ—ãƒ­ãƒã‚¤ãƒ€ï¼ˆGoogleã€Facebookã€Twitterï¼‰ãªã©ã‚’ä½¿ç”¨ã—ãŸèªè¨¼ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

ã¨ã®ã“ã¨ã§ã™ã€‚

è‰²ã€…ãªæ–¹æ³•ã§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã‚’FirebaseãŒä¸€æ‰‹ã«æ‹…ã£ã¦ãã‚Œã¦ã€ã“ã¡ã‚‰ã¯SDKã‚’ä½¿ã£ã¦ãã®æ©Ÿèƒ½ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã ã‘ã§ã‚ˆã„ã®ã§ã¨ã¦ã‚‚æ¥½ãŒã§ããã†ã§ã™ã€‚

# å¤§ã¾ã‹ãªæµã‚Œ

Symfonyã‚¢ãƒ—ãƒªã§Firebase Authenticationã‚’ä½¿ã†ãŸã‚ã®å¤§ã¾ã‹ãªæµã‚Œã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

> å‰æã¨ã—ã¦ã€Firebaseã® [Webã‚³ãƒ³ã‚½ãƒ¼ãƒ«](https://console.firebase.google.com/) ä¸Šã§å„ç¨®è¨­å®šï¼ˆèªè¨¼æ–¹æ³•ã®ã‚ªãƒ³/ã‚ªãƒ•ã€OAuthã®ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã®ç™»éŒ²ãªã©ï¼‰ã‚’æ¸ˆã¾ã›ã¦ãŠã„ã¦ãã ã•ã„ğŸ™

1. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰Firebaseã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦IDãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆä¸­èº«ã¯JWTï¼‰ã‚’ã‚‚ã‚‰ã†
1. èªè¨¼ãŒå¿…è¦ãªãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹éš›ã«ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã® `Authorization` ãƒ˜ãƒƒãƒ€ãƒ¼ã§IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’é€ã‚‹
1. Symfonyå´ã§Firebase SDKã‚’ä½¿ã£ã¦IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ï¼†æ¤œè¨¼ã—ã€Firebaseã‹ã‚‰è©²å½“ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®UUIDã‚’å–å¾—ã™ã‚‹
1. Symfonyå´ã§ãã®UUIDã«å¯¾å¿œã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã«ã™ã‚‹

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®å®Ÿè£…

ä¸Šè¨˜ã®å‰åŠ `1` `2` ã«ã‚ãŸã‚‹ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®å®Ÿè£…æ–¹æ³•ã«ã¤ã„ã¦ã¯ã“ã®è¨˜äº‹ã§ã¯å‰²æ„›ã—ã¾ã™ğŸ™

ãŒã€ä»¥ä¸‹ã«æŒ™ã’ãŸã‚ãŸã‚Šã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ã™ã‚Œã°ã€ãã‚“ãªã«é›£ã—ã„ã“ã¨ã¯ãªã„ã¨æ€ã„ã¾ã™ğŸ‘Œ

* [ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã§ Firebase Authentication ã‚’ä½¿ã£ã¦ã¿ã‚‹](https://firebase.google.com/docs/auth/web/start)
* [Firebase ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç®¡ç†ã™ã‚‹](https://firebase.google.com/docs/auth/web/manage-users)
* [ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼ã™ã‚‹](https://firebase.google.com/docs/auth/admin/verify-id-tokens)

## Angularã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆ

ã‚‚ã—ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«Angularã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã¯ã€Angularå…¬å¼ã® [angular/angularfire](https://github.com/angular/angularfire) ã‚’ä½¿ã†ã¨ä¾¿åˆ©ã§ã™ã€‚

## Angularã‚’ä½¿ã£ã¦ã„ã¦ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒGraphQLã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«Apollo Angularã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆ

ã ã„ã¶ãƒ‹ãƒƒãƒãªè©±ã§ã™ãŒç¬‘ã€åƒ•ãŒæœ€è¿‘Symfony5 + API Platform + Angular + Apollo Angularã§SPAã‚’ä½œã£ã¦ã„ã¦ã€Apollo Angularã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã«Firebase Authenticationã®IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä»˜åŠ ã™ã‚‹ã‚„ã‚Šæ–¹ãŒãƒ‘ãƒƒã¨åˆ†ã‹ã‚‰ãªã‹ã£ãŸã®ã§ã€ä¸€å¿œãƒ¡ãƒ¢ã¨ã—ã¦æ®‹ã—ã¦ãŠãã¾ã™ã€‚

:::details è¡¨ç¤ºã™ã‚‹

åŸºæœ¬çš„ã«ã¯ä»¥ä¸‹ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã‚ˆã†ã«ã—ã¦Apollo Angularã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¾ã™ã€‚

> [Authentication | Apollo Angular](https://apollo-angular.com/docs/recipes/authentication/)

Firebase Authenticationã¨ã®ä½µç”¨ã‚’å®Ÿè·µã—ã¦ã„ã‚‹ãƒ–ãƒ­ã‚°è¨˜äº‹ãªã©ã¯è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ããªã‹ã£ãŸã®ã§ã™ãŒã€YouTubeã«å®Ÿè·µå‹•ç”»ãŒã‚ã£ãŸã®ã§å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚

> [Hasura Authentication with JWT Firebase and Angular 9 [tutorial, 2020] - YouTube](https://www.youtube.com/watch?v=CpDmQb_gMgY&t=566s)
>
> ã“ã®å‹•ç”»ã®9:26ã‚ãŸã‚Šã‹ã‚‰è©²å½“ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚

çµè«–ã¨ã—ã¦ã¯ã€`GraphQLModule` ã‚’ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã§å®Ÿè£…ã™ã‚Œã°å¯¾å¿œã§ãã¾ã™âœ‹ï¼ˆã“ã“ã§ã¯ç´°ã‹ã„èª¬æ˜ã¯å‰²æ„›ã—ã¾ã™ğŸ™ï¼‰

```ts
export function createApollo(
  httpLink: HttpLink,
  afa: AngularFireAuth,
): ApolloClientOptions<any> {
  const auth = setContext(async () => {
    const token = await afa.idToken.pipe(take(1)).toPromise()
    return {
      headers: {
        Authorization: `Bearer ${token}`,
      },
    }
  })
  return {
    link: ApolloLink.from([
      auth,
      httpLink.create({uri: environment.graphqlUri}),
    ]),
    cache: new InMemoryCache(),
  }
}

@NgModule({
  providers: [
    {
      provide: APOLLO_OPTIONS,
      useFactory: createApollo,
      deps: [HttpLink, AngularFireAuth],
    },
  ],
})
export class GraphQLModule {}
```

:::

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å®Ÿè£…

ã•ã¦ã€ã“ã“ã‹ã‚‰ãŒæœ¬ç¨¿ã®æœ¬é¡Œã§ã™ã€‚

ä¸Šè¨˜ã€Œå¤§ã¾ã‹ãªæµã‚Œã€ã®å¾ŒåŠéƒ¨åˆ†ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚‚ã‚‰ã„ã€ãã‚Œã‚’å…ƒã«Firebase SDKã‚’ä½¿ã£ã¦Firebaseã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã™ã‚‹ï¼‰ã‚’ã€Symfony 5.1+ ã®æ–°ã—ã„èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ä½¿ã£ã¦å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

æ–°ã—ã„èªè¨¼ã‚·ã‚¹ãƒ†ãƒ è‡ªä½“ã®ä½¿ã„æ–¹ã¯ä»¥ä¸‹ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¾ã¨ã¾ã£ã¦ã„ã¾ã™ã€‚

> [Using the new Authenticator-based Security (Symfony Docs)](https://symfony.com/doc/current/security/authenticator_manager.html)

ä»¥ä¸‹ã€Firebase Authenticationã¨ã®é€£æºã®ä»•æ–¹ã‚‚å«ã‚ã¦ã€é †ã‚’è¿½ã£ã¦å…·ä½“çš„ãªå®Ÿè£…æ–¹æ³•ã‚’è§£èª¬ã—ã¦ã„ãã¾ã™âœ‹

## 1. PHPç”¨ã®Firebase SDKã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ã¾ãšã€Symfonyå´ã§IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ï¼†æ¤œè¨¼ã™ã‚‹ãŸã‚ã«ã€PHPç”¨ã®Firebase SDKã§ã‚ã‚‹ [kreait/firebase-php](https://github.com/kreait/firebase-php) ã‚’å°å…¥ã—ã¾ã™ã€‚

```bash
$ composer require kreait/firebase-php
```

[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://firebase-php.readthedocs.io/en/stable/authentication.html) ã«å¾“ã„ã€SDKã®åˆæœŸåŒ–ã«ã¯ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½¿ã†ã“ã¨ã«ã—ã¾ã™ã€‚

Firebaseã® [Webã‚³ãƒ³ã‚½ãƒ¼ãƒ«](https://console.firebase.google.com/) ä¸Šã§ç›®çš„ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹ã„ã¦ `ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¨­å®š > ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ` ã¨é€²ã¿ã€`æ–°ã—ã„ç§˜å¯†éµã®ç”Ÿæˆ` ã§ç§˜å¯†éµã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

ã“ã‚Œã‚’ `firebase_credentials.json` ãªã©ã®åˆ†ã‹ã‚Šã‚„ã™ã„ãƒ•ã‚¡ã‚¤ãƒ«åã«ãƒªãƒãƒ¼ãƒ ã—ãŸä¸Šã§ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆãªã©ã«é…ç½®ã—ã¦ **`.gitignore` ã«è¿½è¨˜ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚**

ä»¥ä¸‹ã®ã‚ˆã†ã« `config/services.yaml` ã«è¿½è¨˜ã™ã‚‹ã“ã¨ã§ã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹ã«è‡ªå‹•ã§DIã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¨ä¾¿åˆ©ã§ã™ã€‚

```yaml
services:
    _defaults:
        bind:
            $firebaseCredentialsPath: '%kernel.project_dir%/firebase_credentials.json'
```

ã“ã‚Œã§ã€ `$firebaseCredentialsPath` ã¨ã„ã†å¤‰æ•°åã®å¼•æ•°ã«è‡ªå‹•ã§ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’è¡¨ã™æ–‡å­—åˆ—ãŒã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ï¼ˆ[å‚è€ƒ](https://symfony.com/doc/current/service_container.html#binding-arguments-by-name-or-type)ï¼‰

## 2. Userã‚¯ãƒ©ã‚¹ã«Firebaseä¸Šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼UIDã‚’æŒãŸã›ã‚‹

Firebase SDKã‚’ä½¿ã£ã¦Firebaseã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼UIDã‚’å–å¾—ã—ãŸã‚ã¨ã€ãã‚Œã‚’Symfonyä¸Šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨å¯¾å¿œã¥ã‘ã‚‹ãŸã‚ã«ã€Userã‚¯ãƒ©ã‚¹ã«Firebaseã®ãƒ¦ãƒ¼ã‚¶ãƒ¼UIDã‚’æŒãŸã›ã¦ãŠãã¾ã™ã€‚

```php
class User implements UserInterface
{
    // ...

+   /**
+    * @ORM\Column(type="string", length=255, unique=true)
+    */
+   private string $firebaseUid;

    // ...
}
```

> DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚å¿˜ã‚Œãšã«ã€‚


## 3. Authenticatorã‚¯ãƒ©ã‚¹ã‚’å®Ÿè£…ã™ã‚‹

IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ï¼†æ¤œè¨¼ã—ãŸä¸Šã§Symfonyå´ã®å¯¾å¿œã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã«ã™ã‚‹ãŸã‚ã®Authenticatorã‚¯ãƒ©ã‚¹ã‚’ä»¥ä¸‹ã®ã‚ˆã†ãªå†…å®¹ã§å®Ÿè£…ã—ã¾ã™ã€‚

```php
// src/Security/FirebaseIdTokenAuthenticator.php

namespace App\Security;

use App\Repository\UserRepository;
use Firebase\Auth\Token\Exception\InvalidToken;
use Kreait\Firebase\Contract\Auth;
use Kreait\Firebase\Exception\InvalidArgumentException;
use Kreait\Firebase\Factory;
use Lcobucci\JWT\UnencryptedToken;
use Symfony\Component\HttpFoundation\JsonResponse;
use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\Security\Core\Authentication\Token\TokenInterface;
use Symfony\Component\Security\Core\Exception\AuthenticationException;
use Symfony\Component\Security\Core\Exception\CustomUserMessageAuthenticationException;
use Symfony\Component\Security\Http\Authenticator\AbstractAuthenticator;
use Symfony\Component\Security\Http\Authenticator\Passport\Badge\UserBadge;
use Symfony\Component\Security\Http\Authenticator\Passport\PassportInterface;
use Symfony\Component\Security\Http\Authenticator\Passport\SelfValidatingPassport;

class FirebaseIdTokenAuthenticator extends AbstractAuthenticator
{
    private Auth $auth;
    private UserRepository $userRepository;

    public function __construct(string $firebaseCredentialsPath, UserRepository $userRepository)
    {
        try {
            $factory = (new Factory)->withServiceAccount($firebaseCredentialsPath);
        } catch (InvalidArgumentException $e) {
            throw new \LogicException('"/firebase_credentials.json" is not placed');
        }

        $this->auth = $factory->createAuth();
        $this->userRepository = $userRepository;
    }

    public function supports(Request $request): ?bool
    {
        return $request->headers->has('Authorization');
    }

    public function authenticate(Request $request): PassportInterface
    {
        $idToken = preg_replace('/^Bearer +/', '', $request->headers->get('Authorization'));

        if ($idToken === null) {
            // 401 Unauthorized with custom message
            throw new CustomUserMessageAuthenticationException('No firebase id-token provided');
        }

        try {
            /** @var UnencryptedToken $verifiedIdToken */
            $verifiedIdToken = $this->auth->verifyIdToken($idToken);
        } catch (InvalidToken $e) {
            throw new CustomUserMessageAuthenticationException(sprintf('The firebase id-token is invalid: %s', $e->getMessage()));
        } catch (\InvalidArgumentException $e) {
            throw new CustomUserMessageAuthenticationException(sprintf('The firebase id-token could not be parsed: %s', $e->getMessage()));
        }

        $firebaseUid = $verifiedIdToken->claims()->get('sub');

        // if the correct firebase user is not registered to Symfony app, register it.
        $firebaseUid = $this->userRepository->findOrCreate($firebaseUid)->firebaseUid;

        return new SelfValidatingPassport(new UserBadge($firebaseUid));
    }

    public function onAuthenticationSuccess(Request $request, TokenInterface $token, string $firewallName): ?Response
    {
        // on success, let the request continue
        return null;
    }

    public function onAuthenticationFailure(Request $request, AuthenticationException $exception): ?Response
    {
        $data = [
            // you may want to customize or obfuscate the message first
            'message' => strtr($exception->getMessageKey(), $exception->getMessageData())
        ];

        return new JsonResponse($data, Response::HTTP_UNAUTHORIZED);
    }
}
```

ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦ã¯ã€

* Googleã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ç§˜å¯†éµï¼ˆ `$firebaseCredentialsPath` ï¼‰ã‚’ä½¿ã£ã¦ Firebase SDKã‚’åˆæœŸåŒ–ã—ã¦ã„ã‚‹ï¼ˆã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ï¼‰
* `Authorization` ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æŒã¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã¿ã‚’èªè¨¼ã®å¯¾è±¡ã«ã—ã¦ã„ã‚‹ï¼ˆ`supports()`ï¼‰
* `Authorization: Bearer {IDãƒˆãƒ¼ã‚¯ãƒ³}` ã¨ã„ã†å½¢å¼ã§IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’èª­ã¿å–ã£ã¦ã„ã‚‹ï¼ˆ`authenticate()` ã®å‰åŠéƒ¨åˆ†ï¼‰
* Firebase SDKã‚’ä½¿ã£ã¦IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼ã—ã€Firebaseã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼UIDã‚’å–å¾—ã—ã¦ã„ã‚‹ï¼ˆ`authenticate()` ã®å¾ŒåŠéƒ¨åˆ†ï¼‰
* Firebaseã®ãƒ¦ãƒ¼ã‚¶ãƒ¼UIDã‚’ã‚‚ã¨ã«Symfonyå´ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ `findOrCreate()` ã—ã¦ã„ã‚‹ï¼ˆ`authenticate()` ã®å¾ŒåŠéƒ¨åˆ†ï¼‰
    * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—æ™‚ã«ã€ä½•ã‹ã®æ‰‹é•ã„ã§Firebaseå´ã«ã ã‘ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œã‚‰ã‚Œã¦Symfonyå´ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œã‚‰ã‚Œã¦ã„ãªã„ã¨ã„ã†ã“ã¨ãŒã‚ã‚Šå¾—ã‚‹ã®ã§ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰æ­£ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼UIDãŒé€ã‚‰ã‚Œã¦ããŸã‘ã©å¯¾å¿œã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒSymfonyå´ã«è¦‹ã¤ã‹ã‚‰ãªã„ã¨ã„ã†å ´åˆã«ã¯ã€ãã®æ™‚ç‚¹ã§Symfonyå´ã«æ–°ãŸã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œã‚‹ã®ãŒå¦¥å½“ã¨ã„ã†è€ƒãˆ
* [`SelfValidatingPassport` ã‚¯ãƒ©ã‚¹](https://symfony.com/doc/current/security/authenticator_manager.html#self-validating-passport) ã‚’ä½¿ã£ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼UIDã«è©²å½“ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã«ã—ã¦ã„ã‚‹ï¼ˆ`authenticate()` ã®æœ€å¾Œï¼‰
    * å¾Œè¿°ã® `security.yaml` ã®è¨­å®šã§ `property: firebaseUid` ã¨ã—ã¦ã„ã‚‹ã®ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼UIDã‚’ã‚‚ã¨ã«è©²å½“ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å¼•ã‘ã‚‹

ã¨ã„ã£ãŸã‚ãŸã‚Šã§ã—ã‚‡ã†ã‹ã€‚

`Passport` ã¨ `Badge` ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’èªè¨¼èªå¯ã™ã‚‹ã¨ã“ã‚ãŒæ–°ã—ã„èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®è¦ç‚¹ã ã¨æ€ã„ã¾ã™ãŒã€ä»Šå›ã®ã‚ˆã†ã«èªè¨¼ã¯Firebase SDKã§è¡Œã£ã¦Symfonyã¨ã—ã¦ã¯èªå¯ã™ã‚‹/ã—ãªã„ã®åˆ¤æ–­ã‚’ã™ã‚‹ã ã‘ã¨ã„ã†ã‚±ãƒ¼ã‚¹ã§ã¯ã€ã‚ã¾ã‚Šã“ã®æ©Ÿæ§‹ã‚’æ„è­˜ã™ã‚‹ã“ã¨ã¯ãªã‹ã£ãŸã§ã™ã­ã€‚

## 4. `security.yaml` ã‚’è¨­å®šã™ã‚‹

æœ€å¾Œã« `config/packages/security.yaml` ã‚’è¨­å®šã—ã¦ã€ã“ã“ã¾ã§ã«å®Ÿè£…ã—ã¦ããŸã‚‚ã®ãŸã¡ãŒã¡ã‚ƒã‚“ã¨é€£å‹•ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã‚ã’ã¾ã™ã€‚

ç‰¹ã«ã€æ–°ã—ã„èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ã†å ´åˆã¯ `enable_authenticator_manager: true` ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§å¿˜ã‚Œãªã„ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚

å…·ä½“çš„ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå†…å®¹ã«ãªã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

```yaml
security:
    enable_authenticator_manager: true

    providers:
        app_user_provider:
            entity:
                class: App\Entity\User
                property: firebaseUid
    firewalls:
        dev:
            pattern: ^/(_(profiler|wdt)|css|images|js)/
            security: false
        main:
            lazy: true
            provider: app_user_provider

            custom_authenticators:
                - App\Security\FirebaseIdTokenAuthenticator

    access_control:
        - { path: ^/, role: ROLE_USER }
```


# ã¾ã¨ã‚

ã¨ã„ã†ã‚ã‘ã§ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«Symfony5ï¼ˆ5.1+ï¼‰ã‚’ä½¿ã£ã¦ã„ã‚‹SPAã§èªè¨¼æ©Ÿæ§‹ã«Firebase Authenticationã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã—ãŸã€‚

Symfony + Firebase Authenticationã®æ—¥æœ¬èªæƒ…å ±ã¯ã‚ã¾ã‚Šè¦‹ãŸã“ã¨ãŒãªã„ã®ã¨ã€ä¸€å¿œ [Symfony 5.1+ ã®æ–°ã—ã„èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ](https://symfony.com/blog/new-in-symfony-5-1-updated-security-system) ã«å¯¾å¿œã—ãŸå†…å®¹ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€ã©ãªãŸã‹ã®å‚è€ƒã«ãªã‚Œã°ã„ã„ãªã¨æ€ã„ã¾ã™ğŸ˜‡

# å‚è€ƒãƒªãƒ³ã‚¯

* [New in Symfony 5.1: Updated Security System (Symfony Blog)](https://symfony.com/blog/new-in-symfony-5-1-updated-security-system)
* [Using the new Authenticator-based Security (Symfony Docs)](https://symfony.com/doc/current/security/authenticator_manager.html)
* [Firebase Auth ã®ãƒ¦ãƒ¼ã‚¶èªè¨¼æ©Ÿèƒ½ã‚’è‡ªå‰ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨é€£æºã™ã‚‹ - Qiita](https://qiita.com/geerpm/items/165c31302edce1e52146)
* [Laravel + Nuxt.js + Firebase ã§ã„ã„æ„Ÿã˜ã«Twitterã«ã‚ˆã‚‹ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ­ã‚°ã‚¤ãƒ³ã‚’å®Ÿç¾ã™ã‚‹ - Qiita](https://qiita.com/maguro_tuna/items/4b3ecd7502e218f103ca)
* [ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒSymfonyãªSPAã‚’Firebase Authenticationã§ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ | QUARTETCOM TECH BLOG](https://tech.quartetcom.co.jp/2018/12/19/symfony4-firebase-authentication/)
