---
title: "[Symfony][Doctrine] JOINã•ã‚ŒãŸã‚¯ã‚¨ãƒªã®ãƒ«ãƒ¼ãƒˆã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ã¿ã«count/offset/limitã‚’é©ç”¨ã™ã‚‹æ–¹æ³•"
emoji: "ğŸ»"
type: "tech"
topics: ["php", "symfony", "doctrine"]
published: true
published_at: 2020-07-29
---

:::message
ã“ã®è¨˜äº‹ã¯ã€2020-07-29ã«åˆ¥ã®ãƒ–ãƒ­ã‚°åª’ä½“ã«æŠ•ç¨¿ã—ãŸè¨˜äº‹ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ã™ã€‚
:::

# ã‚„ã‚ŠãŸã„ã“ã¨

ä»¥ä¸‹ã®ã‚ˆã†ãªã€å­ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚„å­«ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®å†…å®¹ã‚’æ¤œç´¢æ¡ä»¶ã«ä½¿ã†ã‚¯ã‚¨ãƒªã‚’è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```php
$parentRepository->createQueryBuilder('p')
    ->leftJoin('p.children', 'c')
    ->leftJoin('c.children', 'gc')
    ->orWhere('c.name like :query')
    ->orWhere('gc.name like :query')
    ->setParameter('query', '%'.str_replace('%', '\%', $criteria->query).'%')
;
```

ã“ã“ã§ã€

* æ¤œç´¢ã—ãŸçµæœã«å¯¾ã—ã¦
    * è¦ªã®ã¿ã®ç·ä»¶æ•°ã‚’çŸ¥ã‚ŠãŸã„
    * å…ˆé ­ã®20ä»¶ã‚’é£›ã°ã—ã¦ã€ãã‚Œä»¥é™ã®10ä»¶ã‚’å–å¾—ã—ãŸã„

ã¨ã„ã†è¦ä»¶ãŒã‚ã‚‹ã¨ã—ã¾ã™ã€‚

ä½•ã‚‚è€ƒãˆãšã«æ™®é€šã«å®Ÿè£…ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã—ã¾ã†ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚

```php
$qb = $parentRepository->createQueryBuilder('p')
    ->leftJoin('p.children', 'c')
    ->leftJoin('c.children', 'gc')
    ->orWhere('c.name like :query')
    ->orWhere('gc.name like :query')
    ->setParameter('query', '%'.str_replace('%', '\%', $criteria->query).'%')
;

$parentCount = (int) $qb
    ->select('count(p)')
    ->getQuery
    ->getSingleScalarResult()
;

$parentSlice = $qb
    ->select('p')
    ->setFirstResult(20)
    ->setMaxResults(10)
    ->getQuery()
    ->getResult()
;
```

å®Ÿã¯ã“ã‚Œã ã¨æ„å›³ã—ãŸçµæœãŒå¾—ã‚‰ã‚Œã¾ã›ã‚“ğŸ¤”

# JOINã•ã‚Œã¦ã„ã‚‹ã‚¯ã‚¨ãƒªã§ã¯ãƒ«ãƒ¼ãƒˆã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ã¿ã‚’ `count` `offset` `limit` ã§ããªã„

å­ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚„å­«ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒJOINã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€

* `count` ã‚‚
* `setFirstResult()` ï¼ˆ `offset` ï¼‰ã‚‚
* `setMaxResults()` ï¼ˆ `limit` ï¼‰ã‚‚

JOINã•ã‚ŒãŸçµæœã«å¯¾ã—ã¦é©ç”¨ã•ã‚Œã¦ã—ã¾ã†ãŸã‚ã§ã™ã€‚

Doctrine ORMã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã‚‚ä»¥ä¸‹ã®ã¨ãŠã‚Šè¨€åŠã•ã‚Œã¦ã„ã¾ã™ã€‚

> If your query contains a fetch-joined collection specifying the result limit methods are not working as you would expect. Set Max Results restricts the number of database result rows, however in the case of fetch-joined collections one root entity might appear in many rows, effectively hydrating less than the specified number of results.
> 
> [Doctrine Query Language - Doctrine Object Relational Mapper (ORM)](https://www.doctrine-project.org/projects/doctrine-orm/en/latest/reference/dql-doctrine-query-language.html#first-and-max-result-items-dql-query-only)

æ™®é€šã«QueryBuilderã‚’ä½¿ã†æ–¹æ³•ã ã¨ã€ã‚¯ã‚¨ãƒªã®ãƒ«ãƒ¼ãƒˆã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã§ã‚ã‚‹è¦ªã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã ã‘ã‚’ `count` `offset` `limit` ã™ã‚‹ã“ã¨ã¯ã§ããªã„ã¨ã„ã†ã‚ã‘ã§ã™ã­ã€‚

> å‚è€ƒï¼š[symfony - doctrine querybuilder limit and offset - Stack Overflow](https://stackoverflow.com/questions/14884183/doctrine-querybuilder-limit-and-offset#answer-14886847)

# è§£æ±ºæ–¹æ³•ï¼šDoctrine ORM Toolsã®Paginatorã‚’ä½¿ã†

ã“ã®ã‚ˆã†ãªå ´åˆã¯ã€[Doctrine ORM Toolsã®Paginator](https://www.doctrine-project.org/projects/doctrine-orm/en/2.7/tutorials/pagination.html) ã‚’ä½¿ã†ã“ã¨ã§ã‚„ã‚ŠãŸã„ã“ã¨ãŒå®Ÿç¾ã§ãã¾ã™ã€‚

```php
use Doctrine\ORM\Tools\Pagination\Paginator;

// ...

$qb = $parentRepository->createQueryBuilder('p')
    ->leftJoin('p.children', 'c')
    ->leftJoin('c.children', 'gc')
    ->orWhere('c.name like :query')
    ->orWhere('gc.name like :query')
    ->setParameter('query', '%'.str_replace('%', '\%', $criteria->query).'%')
;

$paginator = new Paginator($qb);

$parentCount = count($paginator); // int

$paginator->getQuery()
    ->setFirstResult(20)
    ->setMaxResults(10)
;

$parentSlice = $paginator->getIterator(); // \ArrayIterator
```

1. QueryBuilderã‚’ã‚‚ã¨ã«Paginatorã‚’ä½œã‚‹
1. ä»¶æ•°ã®ã‚«ã‚¦ãƒ³ãƒˆã¯Paginatorè‡ªä½“ã‚’ `count()` ã™ã‚Œã°OK
1. offset/limitã¯ã€Paginatorã‹ã‚‰ `getQuery()` ã—ãŸã‚¯ã‚¨ãƒªã«å¯¾ã—ã¦ `setFirstResult()` `setMaxResults()` ã‚’é©ç”¨ã—ã¦ãŠã„ãŸä¸Šã§ã€Paginatorã® `getIterator()` ã§å–å¾—

ã¨ã„ã†æ„Ÿã˜ã§ã™ã€‚

> ã¡ãªã¿ã« [pagerfanta](https://github.com/BabDev/Pagerfanta) ã® [å®Ÿè£…ã§ã‚‚PaginatorãŒä½¿ã‚ã‚Œã¦ã„ã¾ã™](https://github.com/BabDev/Pagerfanta/blob/43ab8ba41c382f35ca6fae3ccb8d19eb01e8d266/lib/Adapter/Doctrine/ORM/QueryAdapter.php)ã€‚

# ã¾ã¨ã‚

* Doctrineã§ã€JOINã•ã‚Œã¦ã„ã‚‹ã‚¯ã‚¨ãƒªã«å¯¾ã—ã¦ãƒ«ãƒ¼ãƒˆã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ã¿ã«count/offset/limitã‚’é©ç”¨ã™ã‚‹ã«ã¯ã€[Doctrine ORM Toolsã®Paginator](https://www.doctrine-project.org/projects/doctrine-orm/en/2.7/tutorials/pagination.html)
