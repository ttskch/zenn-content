---
title: "ã€å€‹äººé–‹ç™ºã€‘ #è²·ã£ã¦ã‚ˆã‹ã£ãŸ ãŒé›†ã¾ã‚‹SNSã€Œpocittaï¼ˆãƒãƒãƒƒã‚¿ï¼‰ã€ã‚’æ”¯ãˆã‚‹æŠ€è¡“"
emoji: "ğŸš€"
type: "tech"
topics: ["nextjs", "vercel", "php", "render", "å€‹äººé–‹ç™º"]
published: true
---

# ã¯ã˜ã‚ã«

2023å¹´6æœˆ30æ—¥ã« [#è²·ã£ã¦ã‚ˆã‹ã£ãŸ ãŒé›†ã¾ã‚‹SNSã€Œpocittaï¼ˆãƒãƒãƒƒã‚¿ï¼‰ã€](https://pocitta.jp/) ã¨ã„ã†Webã‚µãƒ¼ãƒ“ã‚¹ã‚’ãƒªãƒªãƒ¼ã‚¹ã—ã¾ã—ãŸã€‚

https://pocitta.jp/

ã“ã®è¨˜äº‹ã§ã¯ã€pocittaã¨ã„ã†ã‚µãƒ¼ãƒ“ã‚¹ã®æ¦‚è¦ã¨ãã‚Œã‚’æ”¯ãˆã‚‹æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã«ã¤ã„ã¦ã”ç´¹ä»‹ã—ã¾ã™ã€‚

Webã‚µãƒ¼ãƒ“ã‚¹é–‹ç™ºè€…ã®æ–¹ã€…ã«ä½•ã‹ã—ã‚‰å‚è€ƒã«ã—ã¦ã„ãŸã ã‘ã‚Œã°å¹¸ã„ã§ã™ã€‚

# ã©ã‚“ãªã‚µãƒ¼ãƒ“ã‚¹ï¼Ÿ

pocittaã¯ã€**è²·ã£ã¦ã‚ˆã‹ã£ãŸã‚‚ã®ã‚’ã‚·ã‚§ã‚¢ã™ã‚‹å°‚ç”¨ã®SNS** ã§ã™ã€‚

ä¸»ãªç‰¹å¾´ã¯ä»¥ä¸‹ã®3ç‚¹ã§ã™ã€‚

* **Amazonã‚„æ¥½å¤©ã®å•†å“ãƒšãƒ¼ã‚¸URLã‚’è²¼ã‚Šä»˜ã‘ã‚‹ã ã‘ã§å•†å“æƒ…å ±ã‚’è‡ªå‹•ã§å–å¾—** ã—ã¦ãã‚Œã¦ã€ç°¡å˜ã«æŠ•ç¨¿ã§ãã‚‹
* ã€Œâ—‹å¹´â—‹æœˆã®è²·ã£ã¦ã‚ˆã‹ã£ãŸã‚‚ã®ä¸€è¦§ã€ã®ã‚ˆã†ãªãƒšãƒ¼ã‚¸ï¼ˆã€Œã¾ã¨ã‚ã€ï¼‰ã‚‚ç°¡å˜ã«ä½œã‚Œã‚‹
* **Amazonã‚¢ã‚½ã‚·ã‚¨ã‚¤ãƒˆãƒ»æ¥½å¤©ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆã¨ç°¡å˜ã«é€£æº** ã§ãã¦ã€ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆæ´»å‹•ã®å ´ã¨ã—ã¦ã‚‚æ´»ç”¨ã§ãã‚‹

![image](https://github.com/ttskch/zenn-content/assets/4360663/28b8d85f-b04c-4b66-8872-073ec405cd46)

![image](https://github.com/ttskch/zenn-content/assets/4360663/7343ec14-efe9-433a-b9cd-e3cf8b01f28c)

# ãªãœä½œã£ãŸã®ã‹

**ã‚‚ã¨ã‚‚ã¨è²·ã£ã¦ã‚ˆã‹ã£ãŸã‚‚ã®ã‚’ã‚·ã‚§ã‚¢ã™ã‚‹æ–‡åŒ–ãŒå¥½ãã™ããŸ** ã®ã§ã€ç´ æœ´ã«ã€Œå°‚ç”¨ã®SNSãŒã‚ã£ãŸã‚‰ã„ã„ã®ã«ã€ã¨æ€ã£ã¦ä½œã‚Šå§‹ã‚ã¾ã—ãŸã€‚

å®Ÿã¯pocittaã®æœ€åˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ä»Šã‹ã‚‰5å¹´ã‚‚å‰ã€2018å¹´ã«ä¸€åº¦ä½œã£ã¦èº«å†…é™å®šã§å…¬é–‹ã—ãŸã“ã¨ãŒã‚ã‚Šã¾ã—ãŸã€‚å€‹äººçš„ã«å‰²ã¨æ‰‹å¿œãˆã‚’æ„Ÿã˜ãŸã®ã§ã€ã‚‚ã†å°‘ã—ã¡ã‚ƒã‚“ã¨ä½œã‚Šè¾¼ã‚“ã§æ­£å¼ç‰ˆã¨ã—ã¦ãƒªãƒªãƒ¼ã‚¹ã—ãŸã„ã¨è€ƒãˆãŸã®ã§ã™ãŒã€ã¡ã‚‡ã†ã©ã“ã®é ƒã‹ã‚‰ã€å‰è·ã§ã®ä»•äº‹ãŒå¿™ã—ããªã£ãŸã‚Šã€ã†ã¤ç—…ã‚’å†ç™ºã—ãŸã‚Šã€å€‹äººäº‹æ¥­ä¸»ã¨ã—ã¦ç‹¬ç«‹ã—ãŸã‚Šã¨è‰²ã€…ãªã‚¤ãƒ™ãƒ³ãƒˆãŒç«‹ã¦ç¶šã‘ã«èµ·ã“ã‚Šã€ãƒã‚¿ãƒã‚¿ã—ã¦ã„ã‚‹é–“ã«4å¹´ãã‚‰ã„ã®æ™‚é–“ãŒçµŒéã—ã¦ã—ã¾ã„ã¾ã—ãŸã€‚

ãã—ã¦ä»Šå¹´ã®æ˜¥é ƒã‹ã‚‰ä¹…ã—ã¶ã‚Šã«é–‹ç™ºã«å†ç€æ‰‹ã—ã€6æœˆ30æ—¥ã«ã‚ã§ãŸããƒªãƒªãƒ¼ã‚¹ã«æ¼•ãç€ã‘ãŸã¨ã„ã†æ¬¡ç¬¬ã§ã™ã€‚

ã“ã®è¾ºã‚Šã®ã€pocittaã®èª•ç”Ÿã®è£å´ã¿ãŸã„ãªè©±ã¯PR TIMES STORYã•ã‚“ã«å¯„ç¨¿ã—ãŸä»¥ä¸‹ã®è¨˜äº‹ã§è©³ç´°ã‚’èªã£ã¦ã„ã¾ã™ã®ã§ã€ã‚‚ã—èˆˆå‘³ãŒãŠã‚ã‚Šã§ã—ãŸã‚‰ã”å‚ç…§ãã ã•ã„ã€‚

https://prtimes.jp/story/detail/xzm4gYIdXNB

### æ¥½å¤©ROOMã‚’å€’ã—ãŸã„

ã¡ãªã¿ã«ã€ç¾æ™‚ç‚¹ã§æ˜ç¢ºã«æ„è­˜ã—ã¦ã„ã‚‹ç«¶åˆã‚µãƒ¼ãƒ“ã‚¹ã¯ [æ¥½å¤©ROOM](https://room.rakuten.co.jp/) ã•ã‚“ã§ã™ã€‚

**pocittaã¯ã€æ¥½å¤©ROOMã¨é•ã£ã¦Amazonã®å•†å“ã‚„ä»»æ„ã®ECã‚µã‚¤ãƒˆã®å•†å“ã‚‚è¼‰ã›ã‚‰ã‚Œã‚‹** ã®ã§ã€ã¾ãšã¯Amazonæ´¾ã®äººãŸã¡ã«ãœã²ä½¿ã£ã¦ã‚‚ã‚‰ã„ãŸã„ã§ã™ã—ã€æ¥½å¤©ROOMã§ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆæ´»å‹•ã‚’ã—ã¦ã„ã‚‹äººãŸã¡ã«ã‚‚pocittaã«ä¹—ã‚Šæ›ãˆã¦ã‚‚ã‚‰ãˆã‚‹ã‚ˆã†ã«é ‘å¼µã£ã¦ã„ããŸã„ãªã¨æ€ã£ã¦ã„ã¾ã™ï¼

# ã‚µãƒ¼ãƒ“ã‚¹ã®æ§‹æˆã¨ä½¿ç”¨æŠ€è¡“

ã¨ã„ã†ã‚ã‘ã§ã€ã“ã“ã‹ã‚‰ã¯pocittaã‚’æ”¯ãˆã‚‹æŠ€è¡“ã«ã¤ã„ã¦è§£èª¬ã—ã¦ã„ãã¾ã™ã€‚

## ã‚µãƒ¼ãƒ“ã‚¹æ§‹æˆå›³

å¤§ã¾ã‹ãªæ§‹æˆã¯ä¸‹å›³ã®ã¨ãŠã‚Šã§ã™ã€‚

![image](https://github.com/ttskch/zenn-content/assets/4360663/e9bc047d-2663-4468-a4df-d2360c3fb6bb)

ä»¥ä¸‹ã«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã”ã¨ã®è©³ç´°ã‚’è§£èª¬ã—ã¾ã™ã€‚

## ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯PHPã§å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚[Symfony](https://symfony.com/) ã¨ã„ã†Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨ã€Symfonyã‚’ãƒ™ãƒ¼ã‚¹ã¨ã—ã¦Web APIã®é«˜é€Ÿé–‹ç™ºã‚’å¯èƒ½ã«ã—ã¦ãã‚Œã‚‹ [API Platform](https://api-platform.com/) ã¨ã„ã†ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

API Platformã¯ã€PHPç•Œéšˆã§è¿‘å¹´äººæ°—ãŒé«˜ã¾ã£ã¦ã„ã‚‹æ–°èˆˆã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã€ã¾ã ç™ºå±•é€”ä¸Šãªéƒ¨åˆ†ã‚‚å¤šã„ã®ã§ã™ãŒã€ãã‚Œã‚’åŠ å‘³ã—ã¦ã‚‚Symfony + API Platformã«ã‚ˆã‚‹Web APIã®é–‹ç™ºã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šéå¸¸ã«é–‹ç™ºä½“é¨“ãŒã‚ˆã„ã§ã™ã€‚

* ãã‚‚ãã‚‚Symfonyã¯PHPã«ãŠã‘ã‚‹è‡³é«˜ã®WAFã§ã‚ã‚‹ï¼ˆå¼·ã„æ€æƒ³ï¼‰
* API Platformã¯ã€Symfonyã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«å¯¾ã—ã¦ç–çµåˆã«Web APIï¼ˆREST or GraphQLï¼‰ã¨ã—ã¦ã®æŒ¯ã‚‹èˆã„ã‚’è¿½åŠ ã§ãã‚‹
* **OpenAPIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è‡ªå‹•ã§ç”Ÿæˆã—ã¦ãã‚Œã‚‹** ï¼ˆè¨­å®šã«ã‚ˆã£ã¦ç´°ã‹ã„èª¿æ•´ã‚‚å¯èƒ½ï¼‰

è‡ªåˆ†ã¯ä»Šå›ã®pocittaã®é–‹ç™ºã«é™ã‚‰ãšã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ¯ãƒ¼ã‚¯ã§ã‚‚ã“ã®æ§‹æˆã‚’å¤šãæ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã‹ã‚‰PHPã§Web APIã‚’é–‹ç™ºã™ã‚‹æ–¹ã«ã¯ãŠå‹§ã‚ã®æ§‹æˆã§ã™ã€‚

API Platformã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®Zennæœ¬ã§è©³ç´°ã«ã”ç´¹ä»‹ã—ã¦ã„ã‚‹ã®ã§ã‚ˆã‚ã—ã‘ã‚Œã°ã”å‚ç…§ãã ã•ã„ã€‚

https://zenn.dev/ttskch/books/a3800fc0912fbb

### Amazonã‹ã‚‰ã®å•†å“æƒ…å ±å–å¾—

pocittaã§ã¯ã€Amazonã¾ãŸã¯æ¥½å¤©ã®å•†å“ãƒšãƒ¼ã‚¸URLã‚’è²¼ã‚Šä»˜ã‘ã‚‹ã ã‘ã§ã€å•†å“åã‚„å•†å“ç”»åƒã€ä¾¡æ ¼ãªã©ã®æƒ…å ±ã‚’è‡ªå‹•ã§å–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

Amazonã‹ã‚‰ã®å•†å“æƒ…å ±å–å¾—ã¯ [Amazon Product Advertising APIï¼ˆAmazon PA-APIï¼‰](https://affiliate.amazon.co.jp/help/node/topic/GMEDADBTCJ9KD8DQ) çµŒç”±ã§è¡Œã£ã¦ã„ã¾ã™ã€‚

PA-APIã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã¯ [thewirecutter/paapi5-php-sdk](https://github.com/thewirecutter/paapi5-php-sdk) ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ´»ç”¨ã—ã¦ã„ã¾ã™ã€‚

PA-APIã®ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ã‚’ãã®ã¾ã¾å†ç¾ã—ãŸã‚ˆã†ãªã‚·ã‚°ãƒãƒãƒ£ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€ä»¥ä¸‹ã®PA-APIã®ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã‚’å‚ç…§ã—ãªãŒã‚‰ã‚³ãƒ¼ãƒ‰ã‚’çµ„ã¿ç«‹ã¦ã¦ã„ã‘ã°ãã‚Œã»ã©è¿·ã‚ãšã«æ›¸ã‘ã‚‹æ„Ÿã˜ã§ã™ã€‚

https://webservices.amazon.com/paapi5/documentation/get-items.html

å‚è€ƒã¾ã§ã«ã€PA-APIã‹ã‚‰å¿…è¦ãªå•†å“æƒ…å ±ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®ã‚³ãƒ¼ãƒ‰ã¯ãŠãŠã‚ˆãä»¥ä¸‹ã®ã‚ˆã†ãªå½¢ã«ãªã‚Šã¾ã™ã€‚

```php
$response = $this->client->getItems(new GetItemsRequest([
    'partnerTag' => $tag,
    'languagesOfPreference' => ['ja_JP'],
    'itemIdType' => 'ASIN',
    'partnerType' => 'Associates',
    'marketplace' => 'www.amazon.co.jp',
    'itemIds' => [$asin],
    'resources' => [
        GetItemsResource::ITEM_INFOTITLE,
        GetItemsResource::OFFERSLISTINGSPRICE,
        GetItemsResource::IMAGESPRIMARYLARGE,
        GetItemsResource::IMAGESVARIANTSLARGE,
    ],
]));

$item = $response->getItemsResult()->getItems()[0] ?? null;

$url = $item->getDetailPageURL();
$title = $item->getItemInfo()->getTitle()->getDisplayValue();
$listing = $item->getOffers()?->getListings()[0] ?? null;
$price = $listing?->getPrice()->getAmount();
$price = $price ? intval($price) : null;
$imageUrls = [
    ...array_filter([$item->getImages()->getPrimary()?->getLarge()->getURL()]),
    ...array_map(fn (ImageType $image) => $image->getLarge()->getURL(), $item->getImages()->getVariants() ?? []),
];

$model = [$url, $title, $price, $imageUrls];
```

### æ¥½å¤©ã‹ã‚‰ã®å•†å“æƒ…å ±å–å¾—

æ¥½å¤©ã‹ã‚‰ã®å•†å“æƒ…å ±å–å¾—ã¯ [æ¥½å¤©å•†å“æ¤œç´¢API](https://webservice.rakuten.co.jp/documentation/ichiba-item-search) çµŒç”±ã§è¡Œã£ã¦ã„ã¾ã™ã€‚

ã“ã®APIã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã¤ã‘ã¦GETã™ã‚‹ã ã‘ãªã®ã§ã€å°‚ç”¨ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ä½¿ã‚ãšã€æ™®é€šã« [symfony/http-client](https://symfony.com/doc/current/http_client.html) ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦ã„ã¾ã™ã€‚

[æ¥½å¤©APIã®ã‚¯ã‚ªãƒ¼ã‚¿ã¯1ç§’1ãƒªã‚¯ã‚¨ã‚¹ãƒˆ](https://webservice.faq.rakuten.net/hc/ja/articles/900001974383) ã§çµæ§‹å³ã—ã„ã®ã§ã€ã‚‚ã—ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¢—ãˆãŸã‚‰ [åˆ¶é™ç·©å’Œã‚’ç”³è«‹](https://webservice.faq.rakuten.net/hc/ja/articles/900001974403) ã™ã‚‹å¿…è¦ãŒã‚ã‚Šãã†ã§ã™ã€‚

## ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰/BFF

ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰/BFFã¯ [Next.js](https://nextjs.org/) v12ã§å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚ï¼ˆãã®ã†ã¡v13ã«ä¸Šã’ã¦App Routerã«ç§»è¡Œã™ã‚‹æ„æ€ã¯ã‚ã‚Šã¾ã™ï¼‰

UIãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¯ChakraUIã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚ï¼ˆæœ€è¿‘ [shadcn/ui](https://ui.shadcn.com/) ãŒã¨ã¦ã‚‚æ°—ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€ãã®ã†ã¡ç§»è¡Œã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰

APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã¯ [aspida](https://github.com/aspida/aspida) ã‚’ä½¿ã£ã¦ãŠã‚Šã€[openapi2aspida](https://github.com/aspida/openapi2aspida) ã«ã‚ˆã£ã¦ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨å‹æƒ…å ±ã‚’å…±æœ‰ã—ã¦ã„ã¾ã™ã€‚**è¶…çµ¶ã«é–‹ç™ºä½“é¨“ãŒã‚ˆã„ã§ã™ã€‚**

![image](https://github.com/ttskch/zenn-content/assets/4360663/9c5a64c1-1752-4f98-8190-0dd5ccd01277)

ã“ã‚“ãªæ„Ÿã˜ã§ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã®ã™ã¹ã¦ãŒå‹ä»˜ã‘ã•ã‚Œã¦è£œå®Œã•ã‚Œã¾ã™ã€‚

ã¡ãªã¿ã«aspidaã®é–‹ç™ºè€…ã¯æ—¥æœ¬äººã®Solufaã•ã‚“ã¨ã„ã†æ–¹ã§ã™ã€‚å¿œæ´ã—ã¾ã—ã‚‡ã†ã€‚

aspidaã®ä½¿ã„æ–¹ã®è©³ç´°ã«ã¤ã„ã¦ã¯ã€Solufaã•ã‚“ã”æœ¬äººãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹ä»¥ä¸‹ã®è¨˜äº‹ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

https://zenn.dev/solufa/articles/getting-started-with-aspida

ã‚ã¨ã¯åŒã˜ãSolufaã•ã‚“ã® [pathpida](https://github.com/aspida/pathpida) ã‚‚ä¾¿åˆ©ã«ä½¿ã‚ã›ã¦ã„ãŸã ã„ã¦ã„ã¾ã™ã€‚

https://zenn.dev/solufa/articles/renewed-pathpida

ä»–ã«ã€çŠ¶æ…‹ç®¡ç†ã« [TanStack React Query](https://tanstack.com/query/latest) ã¨ [Recoil](https://recoiljs.org/) ã‚’å°å…¥ã—ã¦ã„ã¾ã™ã€‚Recoilã¯ã‹ãªã‚Šé™å®šçš„ãªç¯„å›²ã§ã—ã‹ä½¿ã£ã¦ã„ãªã„ã®ã§ã€ã‚ˆã‚Šè»½é‡ãª [Jotai](https://jotai.org/) ã¸ã®ç§»è¡Œã‚’æ¤œè¨ä¸­ã§ã™ã€‚

### å‹•çš„OGP

æŠ•ç¨¿ã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãªã©ã®ç”»é¢ã¯å‹•çš„OGPã«å¯¾å¿œã—ã¦ãŠã‚Šã€**ã‚ãˆã¦ [@vercel/og](https://vercel.com/docs/functions/edge-functions/og-image-generation) ã‚’ä½¿ã‚ãªã„å®Ÿè£…ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚**

èƒŒæ™¯ã‚„å®Ÿè£…ã®è©³ç´°ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®è¨˜äº‹ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

https://zenn.dev/ttskch/articles/c317b41935c617

## ã‚¤ãƒ³ãƒ•ãƒ©

ã‚¤ãƒ³ãƒ•ãƒ©ã¯ã™ã¹ã¦PaaSã«å¯„ã›ã¦ã„ã¦ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯ [Render](https://render.com/) ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰/BFFã¯ [Vercel](https://vercel.com/) ã§ãƒ›ã‚¹ãƒˆã—ã¦ã„ã¾ã™ã€‚ã¾ãŸã€èªè¨¼ã«ã¯ [Supabase Auth](https://supabase.com/docs/guides/auth) ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

### Render

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯ [Render](https://render.com/) ã§ãƒ›ã‚¹ãƒˆã—ã¦ã„ã¾ã™ã€‚

Renderã¯ã€æœ‰æ–™åŒ–ã•ã‚ŒãŸHerokuã«ä»£ã‚ã£ã¦ç„¡æ–™ã¾ãŸã¯å®‰ä¾¡ã«åˆ©ç”¨ã§ãã‚‹PaaSã®ç­†é ­ã¨ã—ã¦æ³¨ç›®ã‚’é›†ã‚ã¦ãŠã‚Šï¼ˆå¤šåˆ†ï¼‰ã€æ±äº¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ï¼ˆ[æ¤œè¨ä¸­](https://feedback.render.com/features/p/tokyo-region)ï¼‰ãŒã€æ—¥æœ¬ã®æœ€å¯„ã¨ã—ã¦ã‚·ãƒ³ã‚¬ãƒãƒ¼ãƒ«ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ãŒé¸æŠå¯èƒ½ã§ã™ã€‚

pocittaã§ã¯ã€Renderã®

* `Web Service` ï¼ˆWebã‚µãƒ¼ãƒãƒ¼ï¼‰
* `Background Worker` ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¸ãƒ§ãƒ–ã‚µãƒ¼ãƒãƒ¼ï¼‰
* `PostgreSQL` ï¼ˆDBã‚µãƒ¼ãƒãƒ¼ï¼‰

ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€ãã‚Œãã‚Œä»¥ä¸‹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ã§é‹ç”¨ã—ã¦ã„ã¾ã™ã€‚

| ã‚µãƒ¼ãƒ“ã‚¹ | ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ— | æœˆé¡ |
| --- | --- | --- |
| `Web Service` | Starter | $7 |
| `Background Worker` | Starter | $7 |
| `PostgreSQL` | Starter | $7 |

> å„ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ã”ã¨ã®ã‚¹ãƒšãƒƒã‚¯ã¨æ–™é‡‘ã¯ [ã“ã¡ã‚‰ã‚’ã”å‚ç…§](https://render.com/pricing#compute) ãã ã•ã„ã€‚

ã¡ãªã¿ã«GitHub Actionsã‹ã‚‰Renderã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãŸã‚ã®Actionã¯ã€ä»¥ä¸‹ã®è‡ªä½œã®ã‚‚ã®ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

https://zenn.dev/ttskch/articles/33250dc0a5845c

### Amazon S3

ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¯S3ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

PHPã§å¤–éƒ¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’æŠ½è±¡åŒ–ã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦ [thephpleague/flysystem](https://github.com/thephpleague/flysystem) ã‚’å°å…¥ã—ã¦ãŠã‚Šã€S3ã¨ã®ç¹‹ãè¾¼ã¿ã¯ [league/flysystem-async-aws-s3](https://flysystem.thephpleague.com/docs/adapter/async-aws-s3/) + [async-aws/simple-s3](https://github.com/async-aws/simple-s3) ã§è¡Œã£ã¦ã„ã¾ã™ã€‚

Symfonyã¸ã®ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ãƒˆã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå½¢ã«ãªã£ã¦ã„ã¾ã™ã€‚

```yaml
# config/services.yaml
services:
  AsyncAws\SimpleS3\SimpleS3Client:
    arguments:
      $configuration:
        accessKeyId: '%env(AWS_S3_ACCESS_KEY)%'
        accessKeySecret: '%env(AWS_S3_SECRET_KEY)%'
        region: '%env(AWS_S3_REGION)%'
```

```yaml
# config/packages/flysystem.yaml
flysystem:
  storages:
    default.storage:
      adapter: asyncaws
      options:
        client: AsyncAws\SimpleS3\SimpleS3Client # service id
        bucket: '%env(AWS_S3_BUCKET)%'
        prefix: '%env(AWS_S3_PREFIX)%'
```

ã“ã‚Œã§ã€`League\Flysystem\FilesystemOperator $defaultStorage` ã§ã©ã“ã«ã§ã‚‚DIã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ã¾ãŸã€

* DBã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã ã¨ãã«è‡ªå‹•ã§S3ã® [ç½²åä»˜ãä¸€æ™‚URL](https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/userguide/ShareObjectPreSignedURL.html) ã‚’ç™ºè¡Œã—ã¦ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«æŒãŸã›ã‚‹
* DBã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ãŸã¨ãã«è‡ªå‹•ã§S3ã‹ã‚‰ã‚‚å¯¾å¿œã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã™ã‚‹

ãŸã‚ã«ã€Symfonyã® [Entity Listener](https://symfony.com/bundles/DoctrineBundle/current/entity-listeners.html) ã‚’ä½¿ã£ã¦ä»¥ä¸‹ã®ã‚ˆã†ãªå®Ÿè£…ã‚’ã—ã¦ã„ã¾ã™ã€‚

```php
<?php

declare(strict_types=1);

namespace App\EntityListener;

use App\Entity\File;
use Cake\Chronos\Chronos;
use Doctrine\Bundle\DoctrineBundle\Attribute\AsEntityListener;
use Doctrine\ORM\Event\PostLoadEventArgs;
use Doctrine\ORM\Event\PreRemoveEventArgs;
use League\Flysystem\FilesystemOperator;
use Symfony\Component\DependencyInjection\Attribute\Autowire;

#[AsEntityListener(entity: File::class)]
class FileListener
{
    public function __construct(
        private readonly FilesystemOperator $defaultStorage,
        #[Autowire('%env(int:FILE_URL_LIFETIME)%')]
        private readonly int $temporaryUrlLifetime,
    ) {
    }

    public function postLoad(File $file, PostLoadEventArgs $event): void
    {
        $url = $this->defaultStorage->temporaryUrl(strval($file->getLocation()), Chronos::now()->addSeconds($this->temporaryUrlLifetime), [
            'get_object_options' => [
                'ResponseContentDisposition' => sprintf('attachment;filename=%s', $file->getName()),
                'ResponseCacheControl' => sprintf('max-age=%s', $this->temporaryUrlLifetime),
            ],
        ]);
        $file->setUrl($url);
    }

    public function preRemove(File $file, PreRemoveEventArgs $event): void
    {
        $this->defaultStorage->delete(strval($file->getLocation()));
    }
}
```

> å®Ÿéš›ã«ã¯ `postLoad()` ã§ã¯S3ã‹ã‚‰å–å¾—ã—ãŸç½²åä»˜ãä¸€æ™‚URLã‚’ [symfony/cache](https://symfony.com/doc/current/components/cache.html) çµŒç”±ã§Redisã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦ã„ã‚‹ã®ã§ã™ãŒã€ã“ã“ã§ã¯çœç•¥ã—ã¦ã”ç´¹ä»‹ã—ã¦ã„ã¾ã™ã€‚

### Upstash

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ã‚¢ãƒ—ãƒªãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä¸€éƒ¨ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°ï¼ˆå¤–éƒ¨APIã®çµæœã‚»ãƒƒãƒˆãªã©ï¼‰ã« [Upstash](https://upstash.com/) ã®Redisã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

Japanãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚‚ã‚ã‚‹ã—ã€å½“é¢ã¯ [Freeãƒ—ãƒ©ãƒ³](https://upstash.com/pricing) ã§ååˆ†ã«å›ã‚Šã¾ã™ã€‚

Renderã«ã‚‚Redisã®ã‚µãƒ¼ãƒ“ã‚¹ã¯ã‚ã‚‹ã®ã§ã™ãŒã€[ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šæ€§ãŒä¿è¨¼ã•ã‚Œã‚‹Persistent Instanceã¯æœˆ$10ã®Starterãƒ—ãƒ©ãƒ³ä»¥ä¸Šã§ãªã„ã¨ä½¿ãˆãªã„](https://render.com/docs/redis#persistent-instance-types) ãŸã‚ã€Redisã ã‘ã¯Upstashã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

### Vercel

ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰/BFFã¯Next.jsã§å®Ÿè£…ã—ã¦ã„ã‚‹ã“ã¨ã‚‚ã‚ã‚Šã€è„³æ­»ã§ [Vercel](https://vercel.com/) ã§ãƒ›ã‚¹ãƒˆã—ã¦ã„ã¾ã™ã€‚

ã‚¹ãƒšãƒƒã‚¯çš„ã«ã¯Hobbyãƒ—ãƒ©ãƒ³ã§ã‚‚å…¨ç„¶å›ã‚‹ã¨æ€ã†ã®ã§ã™ãŒã€[Vercelã®å®šã‚ã‚‹Commercial Usage](https://vercel.com/docs/limits/fair-use-policy#commercial-usage) ã«ãŠãã‚‰ãè©²å½“ã™ã‚‹ãŸã‚ã€Proãƒ—ãƒ©ãƒ³ã«å…¥ã£ã¦ãŠã‚Šã€æœˆé¡$20ãŒã‹ã‹ã£ã¦ã„ã¾ã™ã€‚

ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¾å­˜ã—ãªã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ã™ã¹ã¦ [Vercel Edge Cache](https://vercel.com/docs/edge-network/caching) ã«ã‚ˆã£ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦é«˜é€ŸåŒ–ã—ã¦ã„ã¾ã™ã€‚

Vercel Edge Cacheã®å°å…¥æ‰‹é †ã¯ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒ©ãƒƒãƒ—ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

https://zenn.dev/ttskch/scraps/73d7f83040341e

### Amazon CloudFront

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ã®å‰æ®µã« [Amazon CloudFront](https://aws.amazon.com/jp/cloudfront/) ã‚’é…ç½®ã—ã¦ã€APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã‚¨ãƒƒã‚¸ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ã“ã¨ã§é«˜é€ŸåŒ–ã—ã¦ã„ã¾ã™ã€‚

REST APIã®å‰æ®µã«CloudFrontã‚’é…ç½®ã™ã‚‹ãŸã‚ã®ä¸€èˆ¬çš„ãªæ‰‹é †ã¯ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒ©ãƒƒãƒ—ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

https://zenn.dev/ttskch/scraps/e37a50f2a2d8bf

ã¾ãŸã€API Platformã§å®Ÿè£…ã—ãŸREST APIã®å‰æ®µã«CloudFrontã‚’é…ç½®ã™ã‚‹ã«ã‚ãŸã£ã¦ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å´ã§è¡Œã£ãŸå¯¾å‡¦ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒ©ãƒƒãƒ—ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

https://zenn.dev/ttskch/scraps/c7382ec1d1349b

### Supabase Auth

ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã«ã¯ [Supabase Auth](https://supabase.com/docs/guides/auth) ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚[5ä¸‡MAUã¾ã§ã¯Freeãƒ—ãƒ©ãƒ³ã§å¯¾å¿œã§ãã¾ã™](https://supabase.com/pricing)ã€‚

> Freeãƒ—ãƒ©ãƒ³ã¯1é€±é–“ä½•ã‚‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒãªã„ã¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè‡ªä½“ãŒè‡ªå‹•ã§ä¸€æ™‚åœæ­¢ã•ã‚Œã€Web UIã‹ã‚‰æ‰‹å‹•ã§å†èµ·å‹•ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€æ¥µç«¯ã«ã‚¢ã‚¯ã‚»ã‚¹ãŒå°‘ãªã„ã‚µãƒ¼ãƒ“ã‚¹ã‚’é‹ç”¨ã™ã‚‹å ´åˆã¯æ³¨æ„ãŒå¿…è¦ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

Supabaseã¨ã„ãˆã°Firebaseï¼ˆFirestoreï¼‰ã®RDBç‰ˆã¨ã—ã¦äººæ°—æ€¥ä¸Šæ˜‡ä¸­ã®DBaaSã§ã™ãŒã€DBã ã‘ã§ãªãèªè¨¼ã‚„ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚‚ä»˜éšã—ã¦ã„ã¾ã™ã€‚

pocittaã§ã¯ã“ã®ã†ã¡èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹ã ã‘ã‚’IDaaSã¨ã—ã¦åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

å®Ÿã¯ã€pocittaã¯é–‹ç™ºåˆæœŸã«ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒè‡ªå‰å®Ÿè£…ã§ã¯ãªãSupabaseã‚’ä½¿ã£ã¦ã„ãŸã®ã§ã€ãã®åæ®‹ã§ä»Šã‚‚èªè¨¼ã ã‘Supabase Authã‚’ä½¿ã£ã¦ã„ã‚‹ã¨ã„ã†çµŒç·¯ãŒã‚ã‚Šã¾ã™ã€‚

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’è‡ªå‰å®Ÿè£…ã«åˆ‡ã‚Šæ›¿ãˆãŸã¨ãã«ã€ã‚ã‚ã›ã¦èªè¨¼ã‚‚åˆ¥ã®IDaaSã«ç§»è¡Œã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã—ãŸã®ã§ã™ãŒã€ã„ãã¤ã‹è©¦ã—ãŸçµæœã€IDaaSã¨ã—ã¦ã‚‚Supabase AuthãŒä»Šã®ã¨ã“ã‚ä¸€ç•ªä½¿ã„ã‚„ã™ã„ã¨ã„ã†çµè«–ã«ãªã‚Šã€ä¸€æ—¦ãã®ã¾ã¾ã«ãªã£ã¦ã„ã¾ã™ã€‚

æ§‹æˆã¨ã—ã¦ã¯ã€

1. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§Supabsae Authã‹ã‚‰èªè¨¼ã‚’å—ã‘ã‚‹
1. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã« `Authorization: Bearer {Supabase Authã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³}` ã‚’æ·»ãˆã‚‹
1. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ã€`Authorization` ãƒ˜ãƒƒãƒ€ãƒ¼ã§å—ã‘å–ã£ãŸã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã§Supabaseã«ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹
1. ãƒ­ã‚°ã‚¤ãƒ³çµæœã«å¿œã˜ã¦ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«å¯¾ã—ã¦é©åˆ‡ãªèªå¯ã‚’è¡Œã†

ã¨ã„ã†ãµã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

Supabase Authã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦ã¯ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å´ã¯ [@supabase/auth-helpers-nextjs](https://github.com/supabase/auth-helpers)ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å´ã¯ [rafaelwendel/phpsupabase](https://github.com/rafaelwendel/phpsupabase) ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

> ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å´ã§åˆ©ç”¨ã—ã¦ã„ã‚‹ `rafaelwendel/phpsupabase` ã¯ã€[Supabaseã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼](https://supabase.com/docs/guides/cli/local-development) å†…ã®Supabase Authç’°å¢ƒã«ã¯æ¥ç¶šã§ããªã„ä»•æ§˜ãªã®ã§ã€**é–‹ç™ºç’°å¢ƒã«ãŠã„ã¦ã‚‚ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã®Supabase Authã‚’åˆ©ç”¨ã—ãªã‘ã‚Œã°ãªã‚‰ãªã‹ã£ãŸã‚Š** ã—ã¦ã¡ã‚‡ã£ã¨ã‚¤ãƒã‚¤ãƒãªã®ã§ã™ãŒã€ç¾çŠ¶ä»–ã«åŒæ§˜ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå­˜åœ¨ã—ãªã„ã‚ˆã†ãªã®ã§ä»•æ–¹ãªãã“ã‚Œã‚’ä½¿ã‚ã›ã¦ã‚‚ã‚‰ã£ã¦ã„ã¾ã™ã€‚ä»Šå¾Œã«æœŸå¾…ã€‚

# ã¾ã¨ã‚

[#è²·ã£ã¦ã‚ˆã‹ã£ãŸ ãŒé›†ã¾ã‚‹SNSã€Œpocittaï¼ˆãƒãƒãƒƒã‚¿ï¼‰ã€](https://pocitta.jp/) ã¨ã„ã†Webã‚µãƒ¼ãƒ“ã‚¹ã‚’æ”¯ãˆã‚‹æŠ€è¡“ã«ã¤ã„ã¦ç°¡å˜ã«ã”ç´¹ä»‹ã—ã¾ã—ãŸã€‚

ã‚‚ã—ã‚µãƒ¼ãƒ“ã‚¹è‡ªä½“ã«èˆˆå‘³ã‚’æŒã£ã¦ã„ãŸã ã‘ãŸã‚‰ã€ãœã²è¦—ã„ã¦ã¿ã¦ãã ã•ã„ï¼ãã—ã¦ã‚ˆã‚ã—ã‘ã‚Œã°ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã—ã¦ä½•ã‹æŠ•ç¨¿ã—ã¦ã¿ã¦ãã ã•ã„ï¼ğŸ™

https://pocitta.jp/

ã‚ã¨ã¯ã“ã¡ã‚‰ã®ãƒã‚¹ãƒˆã®æ‹¡æ•£ã«ã”å”åŠ›ã„ãŸã ã‘ã‚‹ã®ã‚‚ã¨ã¦ã‚‚å¬‰ã—ã„ã§ã™ğŸ™

https://twitter.com/ttskch/status/1674600586501836800

ä»¥ä¸Šã€pocittaã‚’æ”¯ãˆã‚‹æŠ€è¡“ã®ã”ç´¹ä»‹ã§ã—ãŸï¼
