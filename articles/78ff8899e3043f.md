---
title: "[esa] Generic webhookã®Signatureã‚’Node.jsã§ãƒã‚§ãƒƒã‚¯ã™ã‚‹"
emoji: "ğŸ’»"
type: "tech"
topics: ["esa", "javascript", "nodejs"]
published: true
published_at: 2020-05-24
---

:::message
ã“ã®è¨˜äº‹ã¯ã€2020-05-24ã«åˆ¥ã®ãƒ–ãƒ­ã‚°åª’ä½“ã«æŠ•ç¨¿ã—ãŸè¨˜äº‹ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ã™ã€‚
:::

# ã¯ã˜ã‚ã«

esaã® [Generic webhook](https://docs.esa.io/posts/37) ã«ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®æ”¹ç«„ã‚’é˜²ããŸã‚ã« [Signatureã‚’ä»˜åŠ ã™ã‚‹ä»•çµ„ã¿ãŒã‚ã‚Šã¾ã™](https://docs.esa.io/posts/37#X-Esa-Signature)ã€‚

Generic webhookã®è¨­å®šç”»é¢ã§ä¸‹å›³ã®ã‚ˆã†ã« `Secret (optional)` ã‚’è¨­å®šã—ã¦ãŠãã¨ã€é€ä¿¡ã•ã‚Œã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã« `X-Esa-Signature` ã¨ã„ã†ãƒ˜ãƒƒãƒ€ãƒ¼ãŒä»˜åŠ ã•ã‚Œã¾ã™ã€‚

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gf3f8m57tkj30vz0u00x0.jpg)

ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®å†…å®¹ã‹ã‚‰ç®—å‡ºã•ã‚Œã‚‹ [MACå€¤](https://ja.wikipedia.org/wiki/%E3%83%A1%E3%83%83%E3%82%BB%E3%83%BC%E3%82%B8%E8%AA%8D%E8%A8%BC%E7%AC%A6%E5%8F%B7) ãŒ `X-Esa-Signature` ã®å€¤ã¨ä¸€è‡´ã™ã‚‹ã“ã¨ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å†…å®¹ãŒæ”¹ç«„ã•ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

# ãƒã‚§ãƒƒã‚¯ã®æ‰‹é †

Signatureã®æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã€[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.esa.io/posts/37#X-Esa-Signature) ã®èª¬æ˜ã«æ²¿ã£ã¦ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚æ‰‹é †ã¨ã—ã¦ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

1. ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã«å¯¾ã—ã€ `Secret (optional)` ã«è¨­å®šã—ãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ–‡å­—åˆ—ã‚’å…±æœ‰ã‚­ãƒ¼ã¨ã—ãŸ [HMAC](https://ja.wikipedia.org/wiki/HMAC) å€¤ï¼ˆãƒãƒƒã‚·ãƒ¥é–¢æ•°ã¯ `SHA-265` ï¼‰ã‚’ç®—å‡º
1. `X-Esa-Signature` ã®ä¸­èº«ãŒ `sha265=5c2cd89667226539b34ea930781b8bf3e7f1236da7624eee6b748cd52899f91f` ã®ã‚ˆã†ãªæ–‡å­—åˆ—ã¨ãªã£ã¦ã„ã‚‹ã®ã§ã€ `sha265=` ã«ç¶šãMACå€¤ã®éƒ¨åˆ†ã‚’ä¸Šè¨˜ã§ç®—å‡ºã—ãŸå€¤ã¨æ¯”è¼ƒã™ã‚‹
1. ä¸€è‡´ã—ã¦ã„ã‚Œã°ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ”¹ç«„ã•ã‚Œã¦ã„ãªã„ã“ã¨ã®è¨¼æ˜ã«ãªã‚‹

# Node.jsã§ã®å®Ÿè£…ä¾‹

rubyï¼ˆrackï¼‰ã§ã®å®Ÿè£…ä¾‹ã¯ [å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.esa.io/posts/37#X-Esa-Signature) ã®ã¨ãŠã‚Šã§ã™ãŒã€Node.jsã§ã®å®Ÿè£…ä¾‹ã‚’Webã§ã‚ã¾ã‚Šè¦‹ã‹ã‘ãªã„ã®ã§æ›¸ã„ã¦ãŠãã¾ã™ã€‚

ä¾‹ã¨ã—ã¦ [zeit/micro](https://github.com/zeit/micro) ã‚’ä½¿ã£ãŸå ´åˆã®å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```js
const {json, send} = require('micro')
const crypto = require('crypto')

module.exports = async (req, res) => {
  const body = await json(req)
  const signature = req.headers['x-esa-signature']
  const computedSignature = 'sha256=' + crypto.createHmac('sha256', process.env.ESA_SECRET).update(JSON.stringify(body)).digest('hex')
  if (signature !== computedSignature) {
    send(res, 403, 'Invalid signature')
  }
  
  // ... your code
}
```

Node.jsçµ„ã¿è¾¼ã¿ã® [Cryptoãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«](https://nodejs.org/api/crypto.html) ã§æä¾›ã•ã‚Œã¦ã„ã‚‹ [Hmacã‚¯ãƒ©ã‚¹](https://nodejs.org/api/crypto.html#crypto_class_hmac) ã‚’ä½¿ã£ã¦å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

`crypto.createHmac('sha256', process.env.ESA_SECRET)` ã§ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¨ãƒãƒƒã‚·ãƒ¥é–¢æ•°ã‚’æŒ‡å®šã—ã¦Hmacã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã—ã€ `.update(JSON.stringify(body))` ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®å†…å®¹ã‚’æ¸¡ã—ã€ `.digest('hex')` ã§å®Ÿéš›ã®MACå€¤ã‚’ç®—å‡ºã—ã¦ã„ã¾ã™ã€‚

ã¡ãªã¿ã«Node.jsã§ã¯ [ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚­ãƒ¼ã¯ã™ã¹ã¦å°æ–‡å­—ã«å¤‰æ›ã•ã‚Œã¦ã„ã¾ã™](https://nodejs.org/api/http.html#http_message_headers)ã€‚

# See also

æ‹™ä½œã® [esa2github](https://zenn.dev/ttskch/articles/7423c0ab5104fd) ã« [å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹](https://github.com/ttskch/esa2github/blob/ee9b24c268a4b188c27cdaa99c00bd187dfae2c8/src/index.js#L17-L24) ã®ã§ã€ã‚ã‚ã›ã¦å‚è€ƒã«ã—ã¦ã¿ã¦ãã ã•ã„âœ‹
