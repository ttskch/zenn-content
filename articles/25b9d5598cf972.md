---
title: "AngularFirestoreã§referenceå‹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å†å¸°çš„ã«è§£æ±ºã—ã¤ã¤ã‚¢ãƒ—ãƒªå´ã®ãƒ¢ãƒ‡ãƒ«ã«å¤‰æ›ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹"
emoji: "ğŸ˜"
type: "tech"
topics: ["php", "javascript", "typescript", "angular"]
published: true
published_at: 2020-06-08
---

:::message
ã“ã®è¨˜äº‹ã¯ã€2020-06-08ã«åˆ¥ã®ãƒ–ãƒ­ã‚°åª’ä½“ã«æŠ•ç¨¿ã—ãŸè¨˜äº‹ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ã™ã€‚
:::

Angular + [@angular/fire](https://github.com/angular/angularfire) + [Cloud Firestore](https://firebase.google.com/docs/firestore?hl=ja) ã§ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«è‹¦å¿ƒã—ãŸã®ã§å‚™å¿˜éŒ²ã§ã™ğŸ˜“

# Firestoreã®ãƒ‡ãƒ¼ã‚¿ã«referenceã®é…åˆ—ãŒã‚ã‚‹ã‚±ãƒ¼ã‚¹

ä¸‹å›³ã®ã‚ˆã†ãªã€ŒæŠ•ç¨¿ï¼ˆ `posts` ï¼‰ã€ã¨ã€Œã‚³ãƒ¡ãƒ³ãƒˆï¼ˆ `comments` ï¼‰ã€ã¨ã„ã†ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™ã€‚

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gfj3g88y2kj31yu0n4gon.jpg)

`posts` ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ `comments` ã¨ã„ã†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŒã£ã¦ã„ã¦ã€ã“ã‚Œã¯ `comments` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¸ã®å‚ç…§ï¼ˆ `reference` å‹ï¼‰ã«ãªã£ã¦ã„ã¾ã™ã€‚

ã“ã®ã‚ˆã†ãªå ´åˆã«ã€æŠ•ç¨¿ã‚’å–å¾—ã™ã‚‹ã¨åŒæ™‚ã«é…ä¸‹ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚‚å…¨ä»¶å†å¸°çš„ã«å–å¾—ã—ã¦ã€AngularFirestoreã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ãªãã‚¢ãƒ—ãƒªå´ã§ä½œã£ãŸãƒ¢ãƒ‡ãƒ«ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ã—ã¦å—ã‘å–ã‚ŠãŸã„ã¨ã„ã†ã®ãŒä»Šå›ã®è¦ä»¶ã§ã™ã€‚

> å¤§å‰æã¨ã—ã¦ã€Firestoreã® `reference` å‹ã¯è¦ªã‚’å–å¾—ã—ãŸã‚‰å­ã‚‚èŠ‹ã¥ã‚‹å¼ã«å–å¾—ã§ããŸã‚Šã¯ã—ã¾ã›ã‚“ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§å‚ç…§ã‚’è¾¿ã£ã¦å–å¾—ã—ã¦ã‚ã’ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
>
> å‚è€ƒï¼š [angular - access data from document referenced inside firestore collection - Stack Overflow](https://stackoverflow.com/questions/46663160/access-data-from-document-referenced-inside-firestore-collection)

# 1. ãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ç”¨æ„

```ts
// src/models/post.ts
import { Comment } from './comment';

export interface Post {
  title: string,
  body: string,
  comments: Comment[],
}
```

```ts
export interface Comment {
  body: string,
}
```

# 2. ãƒªãƒã‚¸ãƒˆãƒªã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹ã‚’ç”¨æ„

```bash
$ ng g s post-repository
$ ng g s comment-repository
```

```ts
// src/repositories/post-repository.service.ts
import { Injectable } from '@angular/core';
import { Observable } from 'rxjs';
import { AngularFirestore } from '@angular/fire/firestore';
import { Post } from '../models/post';

@Injectable({
  providedIn: 'root'
})
export class PostRepositoryService {
  constructor(
    private firestore: AngularFirestore,
  ) {}

  get(id: string): Observable<Post> {
    // ã“ã“ã‚’ã©ã†å®Ÿè£…ã™ã‚‹ã‹
  }
}
```

```ts
// src/repositories/comment-repository.service.ts
import { Injectable } from '@angular/core';
import { Observable } from 'rxjs';
import { AngularFirestore } from '@angular/fire/firestore';
import { Comment } from '../models/comment';

@Injectable({
  providedIn: 'root'
})
export class CommentRepositoryService {
  constructor(
    private firestore: AngularFirestore,
  ) {}

  get(id: string): Observable<Comment> {
    // ã“ã“ã‚’ã©ã†å®Ÿè£…ã™ã‚‹ã‹
  }
}
```

ã“ã‚“ãªæ„Ÿã˜ã§ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ä¼šè©±ã™ã‚‹è²¬å‹™ã‚’ãƒªãƒã‚¸ãƒˆãƒªã«é–‰ã˜è¾¼ã‚ã¦ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰ã¯ãƒªãƒã‚¸ãƒˆãƒªã® `get()` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã†ã‚ˆã†ã«ã—ã¾ã™ã€‚

ã‚ã¨ã¯ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’å®Ÿè£…ã™ã‚‹ã ã‘ã§ã™ã€‚ï¼ˆãã‚ŒãŒä¸€ç•ªé›£ã—ã„ï¼‰

# 3. ãƒªãƒã‚¸ãƒˆãƒªã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹ã‚’å®Ÿè£…

å¿…æ­»ã§Observableè·äººã«ãªã£ãŸçµæœã€ä»Šå›ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå®Ÿè£…ã«ãªã‚Šã¾ã—ãŸã€‚

```ts
// src/repositories/post-repository.service.ts
import { Injectable } from '@angular/core';
import { Observable, zip } from 'rxjs';
import { map, switchMap } from 'rxjs/operators';
import { AngularFirestore } from '@angular/fire/firestore';
import { Post } from '../models/post';
import { Comment } from '../models/comment';
import { CommentRepositoryService } from './comment-repository.service';

@Injectable({
  providedIn: 'root'
})
export class PostRepositoryService {
  constructor(
    private firestore: AngularFirestore,
    private commentRepository: CommentRepositoryService,
  ) {}

  get(id: string): Observable<Post> {
    return this.firestore.doc<Post>(`posts/${id}`).valueChanges().pipe(
      map((post: Post) => {
        return {
          post: post,
          commentIds: post.comments.map((comment: any) => comment.path.replace(/^comments\//, '')),
        };
      }),
      switchMap(({post, commentIds}) => {
        return zip(...commentIds.map(commentId => this.commentRepository.get(commentId))).pipe(
          map((comments: Comment[]) => {
            return Object.assign(post, {comments: comments}) as Post;
          }),
        );
      })
    );
  }
}
```

```ts
// src/repositories/commenï½”-repository.service.ts
import { Injectable } from '@angular/core';
import { Observable } from 'rxjs';
import { AngularFirestore } from '@angular/fire/firestore';
import { Comment } from '../models/comment';

@Injectable({
  providedIn: 'root'
})
export class CommentRepositoryService {
  constructor(
    private firestore: AngularFirestore,
  ) {}

  get(id: string): Observable<Comment> {
    return this.firestore.doc<Comment>(`comments/${id}`).valueChanges();
  }
}
```

`CommentRepositoryService` ã®ã»ã†ã¯æ™®é€šã« [ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://github.com/angular/angularfire/blob/master/docs/firestore/documents.md) ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ã¨ãŠã‚Šã®ä½¿ã„æ–¹ã‚’ã—ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚

å•é¡Œã¯ `PostRepositoryService` ã®ã»ã†ã§ã™ã­ã€‚ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã®æµã‚Œã¯ã€

1. æ™®é€šã« `post` ã‚’å–å¾—
1. ã“ã®æ™‚ç‚¹ã§ã¯ `post.comments` ã¯AngularFirestoreã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®é…åˆ—ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€ãã‚Œã‚’ä¸€æ—¦ **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã®é…åˆ—** ã«å¤‰æ›
1. `post` ã¨ `commentIds` ã‚’ã‚»ãƒƒãƒˆã«ã—ã¦æ¬¡ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ï¼ˆ `switchMap` ï¼‰ã«æµã™
1. å—ã‘å–ã£ãŸ `commentIds` ã‚’åˆ†è§£ã—ã¦ `CommentRepositoryService.get()` ã«æŠ•ã’ã‚‹ï¼ˆçµæœã€ `Observable<Comment>` ã®é…åˆ—ãŒã§ãã‚‹ï¼‰
1. [zip](https://www.learnrxjs.io/learn-rxjs/operators/combination/zip) ã‚’ä½¿ã£ã¦ã€ŒObservableã®é…åˆ—ã€ã‚’ã€Œé…åˆ—ã®Observableã€ã«å¤‰æ›
1. `post.comments` ã®ä¸­èº«ã‚’ã€å–å¾—å®Œäº†ã—ãŸã‚³ãƒ¡ãƒ³ãƒˆã®é…åˆ—ã§ä¸Šæ›¸ãã—ã¦ã€å®Œäº†

ã¨ã„ã†æ„Ÿã˜ã§ã™ã€‚

# ãŠã¾ã‘

ã¡ãªã¿ã«ä¸Šè¨˜ã®ã‚ˆã†ã« `.valueChanges()` ã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒ ã«å¤‰æ›ã™ã‚‹ã¨ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDãªã©ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¯å–å¾—ã™ã‚‹ã“ã¨ãŒã§ããšã€ã‚ãã¾ã§ãƒ‡ãƒ¼ã‚¿ã®å†…å®¹ã—ã‹æ‰‹ã«å…¥ã‚Šã¾ã›ã‚“ã€‚

ã‚‚ã—ã‚¢ãƒ—ãƒªå´ã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã‚’æŒã¤ã‚ˆã†ãªå®Ÿè£…ã«ã—ãŸã„å ´åˆã¯ã€ `.valueChanges()` ã®ä»£ã‚ã‚Šã« `.snapshotChanges()` ã‚’ä½¿ã£ã¦è‡ªåŠ›ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šå‡ºã™ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã‘ã°å¯¾å¿œã§ãã¾ã™ã€‚

> å‚è€ƒï¼š[angularfire2 - How to include the document id in Firestore collection in Angular 5 - Stack Overflow](https://stackoverflow.com/questions/47254978/how-to-include-the-document-id-in-firestore-collection-in-angular-5)
