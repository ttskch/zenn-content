---
title: "[Symfony] @UniqueEntityã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ãŸã‚‰ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒæ›´æ–°ã§ããªããªã£ãŸä»¶"
emoji: "ğŸ»"
type: "tech"
topics: ["php", "symfony", "doctrine"]
published: true
published_at: 2020-10-15
---

:::message
ã“ã®è¨˜äº‹ã¯ã€2020-10-15ã«åˆ¥ã®ãƒ–ãƒ­ã‚°åª’ä½“ã«æŠ•ç¨¿ã—ãŸè¨˜äº‹ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ã™ã€‚
:::

# `@UniqueEntity` ã‚’ä½¿ã£ãŸã‚‰è¬ã®æŒ™å‹•ã§ãƒ•ã‚©ãƒ¼ãƒ çµŒç”±ã®æ›´æ–°ãŒã§ããªããªã‚Šã¾ã—ãŸ


https://twitter.com/ttskch/status/1305428273820647424


https://twitter.com/ttskch/status/1305431648368910336


https://twitter.com/ttskch/status/1305492467223990283


https://twitter.com/ttskch/status/1305506984997740545

# èµ·ã“ã£ãŸç¾è±¡ã‚’æ•´ç†

* `handleRequest()` ä¸­ã« `@UniqueEntity` åˆ¶ç´„ãŒã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦å¤‰æ›´å†…å®¹ãŒç ´æ£„ã•ã‚Œã¦ã„ãŸ
* ã«ã‚‚ã‹ã‹ã‚ã‚‰ãš `Form` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã‚¨ãƒ©ãƒ¼ã¯ç™»éŒ²ã•ã‚Œã¦ãŠã‚‰ãšï¼ˆ `$form->getErrors()` ã®çµæœãŒç©ºï¼‰
* `$form->isValid()` ã¯ `true`
* ãªã®ã§ã€æ­£å¸¸ã«å‡¦ç†ãŒå®Œäº†ã—ãŸã‚ˆã†ãªç”»é¢é·ç§»ã‚’ã™ã‚‹ã‘ã©ãƒ‡ãƒ¼ã‚¿ã¯å¤‰æ›´ã•ã‚Œã¦ã„ãªã„ã€ã¨ã„ã†çµæœã«ãªã£ã¦ã„ãŸ

# å†ç¾æ¡ä»¶

å³å¯†ãªå†ç¾æ¡ä»¶ã¾ã§èª¿ã¹ã‚‹æ™‚é–“ã¨æ°—åŠ›ãŒãªã‹ã£ãŸã®ã§ã™ãŒã€å°‘ãªãã¨ã‚‚åƒ•ã®ã‚±ãƒ¼ã‚¹ã§ã¯

* ã‚ã‚‹ç‰¹å®šã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«ãŠã„ã¦ã€ `@UniqueEntity` åˆ¶ç´„ã‚’ä½¿ã†ã¨ä¸Šè¨˜ã®ç¾è±¡ãŒç™ºç”Ÿã™ã‚‹
    * ä»–ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã§ã¯ `@UniqueEntity` ãŒæ­£å¸¸ã«æ©Ÿèƒ½ã—ã¦ã„ã‚‹
* `@UniqueEntity` ã‚’ä½¿ã†ã®ã‚’ã‚„ã‚ã¦ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚¿ã‚’ä½œã£ã¦è‡ªåŠ›ã§é‡è¤‡ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¦ã‚‚ã€ **ãã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†ã®ä¸­ã§ãƒªãƒã‚¸ãƒˆãƒªã® `findBy()` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã†ã¨åŒæ§˜ã®ç¾è±¡ç™ºç”Ÿã™ã‚‹**
    * `findAll()` ã‚‚NGã€ `find()` ã¯OK
* `findBy()` ã‚’ä½¿ã‚ãšã«QueryBuilderã‚’ä½¿ã†å®Ÿè£…ã«ã—ãŸã‚‰ç¾è±¡ãŒç™ºç”Ÿã—ãªããªã‚‹

ã¨ã„ã†çµæœã§ã—ãŸã€‚è¬ã™ãã€‚

ä»Šå›ã®ã‚±ãƒ¼ã‚¹ã§ã¯ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«å¯¾ã—ã¦ `@UniqueEntity` ã‚’ä½¿ã£ã¦ã„ãŸã®ã§ã€ãã‚ŒãŒåŸå› ã‹ãªï¼Ÿã¨ä¸€ç¬æ€ã£ãŸã®ã§ã™ãŒã€[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://symfony.com/doc/current/reference/constraints/UniqueEntity.html) ã‚’è¦‹ã‚‹ã¨ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«å¯¾ã—ã¦ `@UniqueEntity` ã‚’ä½¿ã†ä¾‹ãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹ã®ã§ã‚„ã£ã±ã‚Šã“ã‚Œã¯å•é¡Œãªã„ã‚ˆã†ã§ã™ã€‚

> Doctrineã‹Symfony/Validatorã®ãƒã‚°ã ã¨æ€ã†ã®ã§ã™ãŒã€è»½ãæ¤œç´¢ã—ãŸé™ã‚Šã§ã¯issueã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã§ã—ãŸğŸ˜“

# è§£æ±ºç­–

å…ˆè¿°ã®ã¨ãŠã‚Šã€

* ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚¿ã‚’ä½œã£ã¦è‡ªåŠ›ã§é‡è¤‡ãƒã‚§ãƒƒã‚¯ã™ã‚‹
* ãŸã ã—ãã®éš›ã«ãƒªãƒã‚¸ãƒˆãƒªã® `findBy()` ãƒ¡ã‚½ãƒƒãƒ‰ã¯ä½¿ã‚ãšã€QueryBuilderã‚’ä½¿ã£ã¦æ¤œç´¢ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹

ã§ä¸€å¿œè§£æ±ºã§ãã¾ã—ãŸã€‚

å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚

**ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£**

```diff
  use App\Repository\FooRepository;
+ use App\Validator\Constraints as AppAssert;
- use Symfony\Bridge\Doctrine\Validator\Constraints\UniqueEntity;
  
  /**
   * @ORM\Entity(repositoryClass=FooRepository::class)
-  * @UniqueEntity(fields="bar", message="ãã®barã¯ã™ã§ã«ä»–ã®fooã¨ç´ã¥ã„ã¦ã„ã¾ã™")
   */
  class Foo
  {
      /**
       * @ORM\OneToOne(targetEntity=Bar::class, inversedBy="foo")
+      * @AppAssert\Foo\UniqueBar()
       */
      private $bar;
  
      // ...
  }
```

**ãƒªãƒã‚¸ãƒˆãƒª**

```diff
  class FooRepository extends ServiceEntityRepository
  {
      public function __construct(ManagerRegistry $registry)
      {
          parent::__construct($registry, Foo::class);
      }
+
+     public function findByBar(Bar $bar, Foo $self = null)
+     {
+         $qb = $this->createQueryBuilder('f')
+             ->andWhere('f.bar = :bar')
+             ->setParameter('bar', $bar)
+         ;
+ 
+         if ($self) {
+             $qb
+                 ->andWhere('f != :self')
+                 ->setParameter('self', $self)
+             ;
+         }
+ 
+         return $qb->getQuery()->getResult();
+     }
  }
```

**ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚¿**

```php
namespace App\Validator\Constraints\Foo;

use Symfony\Component\Validator\Constraint;

/**
 * @Annotation
 */
class UniqueBar extends Constraint
{
    public $message = 'ã“ã®fooã¯ã™ã§ã«ä»–ã®barã¨ç´ã¥ã„ã¦ã„ã¾ã™';
}
```

```php
namespace App\Validator\Constraints\Foo;

use App\Entity\Foo;
use App\Repository\FooRepository;
use Symfony\Component\Validator\Constraint;
use Symfony\Component\Validator\ConstraintValidator;
use Symfony\Component\Validator\Exception\UnexpectedTypeException;
use Symfony\Component\Validator\Exception\UnexpectedValueException;

class UniqueBarValidator extends ConstraintValidator
{
    /**
     * @var FooRepository
     */
    private $fooRepository;

    public function __construct(FooRepository $fooRepository)
    {
        $this->fooRepository = $fooRepository;
    }

    public function validate($value, Constraint $constraint)
    {
        if (!$constraint instanceof UniqueBar) {
            throw new UnexpectedTypeException($constraint, UniqueBar::class);
        }

        $foo = $this->context->getObject();

        if (!$foo instanceof Foo) {
            throw new UnexpectedValueException($foo, Foo::class);
        }

        // findByã‚’ä½¿ã†ã¨è¬ç¾è±¡ãŒç™ºç”Ÿã—ã¦ã—ã¾ã†
//        foreach ($this->fooRepository->findBy(['bar' => $value]) as $found) {
//            if ($found->getId() !== $foo->getId()) {
//                $this->context->buildViolation($constraint->message)->addViolation();
//                return;
//            }
//        }

        // QueryBuilderã‚’ä½¿ãˆã°è¬ç¾è±¡ã¯ç™ºç”Ÿã—ãªã„
        if ($this->fooRepository->findByBar($value, $foo)) {
            $this->context->buildViolation($constraint->message)->addViolation();
        }
    }
}
```


# å‚è€ƒãƒªãƒ³ã‚¯

* [Symfony 3 UniqueEntity validation on update - Stack Overflow](https://stackoverflow.com/questions/42652272/symfony-3-uniqueentity-validation-on-update)
    * ä¼¼ãŸç¾è±¡ã£ã½ã‹ã£ãŸã‘ã©è§£æ±ºã®ç³¸å£ã«ã¯ãªã‚‰ãš
* [php - Symfony UniqueEntity shows an error on when updating existing entity - Stack Overflow](https://stackoverflow.com/questions/55723946/symfony-uniqueentity-shows-an-error-on-when-updating-existing-entity)
    * ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚¿ã‚’ä½œã£ã¦è§£æ±ºã—ã¦ã„ãŸä¾‹
