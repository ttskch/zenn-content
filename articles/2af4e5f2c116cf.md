---
title: "API Platformã§ç‰¹å®šã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«ã ã‘ã‚«ã‚¹ã‚¿ãƒ Normalizerã‚’é©ç”¨ã™ã‚‹"
emoji: "ğŸ»"
type: "tech"
topics: ["php", "symfony", "apiplatform"]
published: true
---

[API Platform](https://api-platform.com/) ã§ä»¥ä¸‹ã®ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã«é­é‡ã—ã¦ã‚«ã‚¹ã‚¿ãƒ Normalizerã‚’æ›¸ã„ãŸã®ã§ãƒ¡ãƒ¢ã§ã™ã€‚

# ã‚„ã‚ŠãŸã‹ã£ãŸã“ã¨

* [DBAL TypeãŒ `time`](https://www.doctrine-project.org/projects/doctrine-dbal/en/latest/reference/types.html#time) ã§å‹ãŒ `\DateTimeInterface` ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŒã¤ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒã‚ã£ãŸ
* ã“ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚‹ã¨ã€æ¨™æº–ã®å‹•ä½œã§ã¯ `1970-01-01T12:34:56+09:00` ã®ã‚ˆã†ãªæ–‡å­—åˆ—ã«ãªã£ãŸ
* ã“ã‚Œã‚’ `12:34`ï¼ˆ`H:i`ï¼‰å½¢å¼ã®æ–‡å­—åˆ—ã«ãªã‚‹ã‚ˆã†ã«ã—ãŸã‹ã£ãŸ

# ã‚„ã£ãŸã“ã¨

**API Platformæ¨™æº–ã®Normalizerã‚’ãƒ‡ã‚³ãƒ¬ãƒ¼ãƒˆã—ãŸã‚«ã‚¹ã‚¿ãƒ Normalizerã‚’æ›¸ãã¾ã—ãŸã€‚**

API Platformã§ã¯ã€[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://api-platform.com/docs/core/serialization/) ã«è©³ç´°ãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹ã¨ãŠã‚Šã€[Symfony Serializer](https://symfony.com/doc/current/components/serializer.html) ã‚’ä½¿ã£ã¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºãŒè¡Œã‚ã‚Œã¦ã„ã¾ã™ã€‚

ãªã®ã§ã€Symfony Serializerã®æµå„€ã«å¾“ã£ã¦ [ã‚«ã‚¹ã‚¿ãƒ Normalizerã‚’æ›¸ã‘ã°](https://symfony.com/doc/current/serializer/custom_normalizer.html) OKã§ã™ã€‚

ã¾ãšã€`src/Serializer/Normalizer/FooNormalizer.php` ã‚’ä»¥ä¸‹ã®ã‚ˆã†ãªå†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```php
<?php

declare(strict_types=1);

namespace App\Serializer\Normalizer;

use ApiPlatform\Core\JsonLd\Serializer\ItemNormalizer as JsonLdItemNormalizer;
use ApiPlatform\Core\Serializer\ItemNormalizer;
use App\Entity\Foo;
use Symfony\Component\Serializer\Normalizer\NormalizerInterface;

class FooNormalizer implements NormalizerInterface
{
    // API Platformæ¨™æº–ã®Normalizerã‚’ã€application/jsonç”¨ã¨application/ld+jsonç”¨ã®2ã¤ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆ
    public function __construct(private ItemNormalizer $itemNormalizer, private JsonLdItemNormalizer $jsonLdItemNormalizer)
    {
    }

    public function normalize(mixed $foo, string $format = null, array $context = []): array
    {
        // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¿œã˜ãŸæ¨™æº–Normalizerã§ä¸€æ—¦ãƒãƒ¼ãƒãƒ©ã‚¤ã‚ºã™ã‚‹
        $data = (array) match ($format) {
            JsonLdItemNormalizer::FORMAT => $this->jsonLdItemNormalizer->normalize($foo, $format, $context),
            default => $this->itemNormalizer->normalize($foo, $format, $context),
        };

        // å¯¾è±¡ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å€¤ã ã‘æ›¸ãæ›ãˆã‚‹
        $data['timeProperty'] = (new \DateTime($data['timeProperty']))->format('H:i');

        return $data;
    }

    public function supportsNormalization(mixed $data, string $format = null, array $context = []): bool
    {
        // ã“ã®ã‚«ã‚¹ã‚¿ãƒ Normalizerã¯Fooã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«ã¤ã„ã¦ã®ã¿å®Ÿè¡Œã•ã‚Œã‚‹
        return $data instanceof Foo;
    }
}
```

API Platformæ¨™æº–ã®Noarmalizerã¯ä»¥ä¸‹ã®6ç¨®é¡ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã®ã†ã¡å¿…è¦ãªã‚‚ã®ã‚’ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆã—ã¦ã€`normalize()` ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¿œã˜ã¦ä½¿ã„åˆ†ã‘ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

| ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ | ã‚¯ãƒ©ã‚¹ |
| --- | --- |
| ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | `ApiPlatform\Core\Serializer\ItemNormalizer` |
| `jsonld` | `ApiPlatform\Core\JsonLd\Serializer\ItemNormalizer` |
| `jsonapi` | `ApiPlatform\Core\JsonApi\Serializer\ItemNormalizer` |
| `hal` | `ApiPlatform\Core\Hal\Serializer\ItemNormalizer` |
| `graphql` | `ApiPlatform\Core\GraphQl\Serializer\ItemNormalizer` |
| `elasticsearch` | `ApiPlatform\Core\Bridge\Elasticsearch\Serializer\ItemNormalizer` |

ã‚ã¨ã¯ `config/services.yaml` ã§ä»¥ä¸‹ã®ã‚ˆã†ã«ç™»éŒ²ã—ã¦ã‚ã’ã‚Œã°OKã§ã™ã€‚

```yml
services:
  App\Serializer\Normalizer\FooNormalizer:
    arguments:
      - '@api_platform.serializer.normalizer.item'
      - '@api_platform.jsonld.normalizer.item'
      # - '@api_platform.jsonapi.normalizer.item'
      # - '@api_platform.hal.normalizer.item'
      # - '@api_platform.graphql.normalizer.item'
      # - '@api_platform.elasticsearch.normalizer.item'
    tags: [{name: serializer.normalizer, priority: 1}]
```

[Symfony Serializerã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://symfony.com/doc/current/serializer/custom_normalizer.html#registering-it-in-your-application) ã§è¨€åŠã•ã‚Œã¦ã„ã‚‹ã¨ãŠã‚Šã€`Symfony\Component\Serializer\Normalizer\NormalizerInterface` ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã‚¯ãƒ©ã‚¹ã¯è‡ªå‹•ã§ `serializer.normalizer` ã§ã‚¿ã‚°ä»˜ã‘ã•ã‚Œã‚‹ã®ã§ã€æœ€å¾Œã®è¡Œã¯ãªãã¦ã‚‚å‹•ããã†ã§ã™ãŒã€**API Platformæ¨™æº–ã®Normalizerã§ã¯ãªãå¿…ãšã‚«ã‚¹ã‚¿ãƒ NormalizerãŒé©ç”¨ã•ã‚Œã¦ã»ã—ã„** ã®ã§ã€`priority` ã‚’æ˜ç¤ºã™ã‚‹ãŸã‚ã«ã‚ãˆã¦æ›¸ã„ã¦ã„ã¾ã™ã€‚

# çµæœ

`Accept: application/ld+json` ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ãŸã¨ãï¼š

```json
{
    "@context": "\/api\/contexts\/Foo",
    "@id": "\/api\/v1\/foos\/1",
    "@type": "Foo",
    "timeProperty": "12:34",
    :
    :
}
```

`Accept: application/json` ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ãŸã¨ãï¼š

```json
{
    "timeProperty": "12:34",
    :
    :
}
```

ç„¡äº‹ã€æœŸå¾…ã©ãŠã‚Šã®å‹•ä½œã‚’å®Ÿç¾ã§ãã¾ã—ãŸğŸ‘Œ
