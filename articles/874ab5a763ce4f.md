---
title: "[Symfony][Doctrine] STIã®åŸºåº•ã‚¯ãƒ©ã‚¹ã‚’OneToManyã§æŒã¤ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’STIã®æ´¾ç”Ÿã‚¯ãƒ©ã‚¹ã¨JOINã™ã‚‹"
emoji: "ğŸ»"
type: "tech"
topics: ["php", "symfony", "doctrine"]
published: true
---

ã‚¿ã‚¤ãƒˆãƒ«ã‚’èª­ã‚“ã ã ã‘ã§ã¯ã•ã£ã±ã‚Šåˆ†ã‹ã‚Šã¾ã›ã‚“ãŒã€Doctrineã®QueryBuilderã§ã¡ã‚‡ã£ã¨å¤‰ã‚ã£ãŸã“ã¨ã‚’ã‚„ã‚‹æ–¹æ³•ã®ãƒ¡ãƒ¢ã§ã™ã€‚

# ã‚„ã‚ŠãŸã„ã“ã¨

* Doctrineã® [Single Table Inheritanceï¼ˆSTIï¼‰](https://www.doctrine-project.org/projects/doctrine-orm/en/2.7/reference/inheritance-mapping.html#single-table-inheritance) ã‚’ä½¿ã£ã¦ã„ã‚‹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒã‚ã‚‹
* ã“ã®STIã®åŸºåº•ã‚¯ãƒ©ã‚¹ã‚’OneToManyã§æ‰€æœ‰ã™ã‚‹åˆ¥ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒã‚ã‚‹
* ã“ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ã€QueryBuilderã‚’ä½¿ã£ã¦STIã®æ´¾ç”Ÿã‚¯ãƒ©ã‚¹ã¨JOINã—ãŸã„

# ã‚„ã‚Šæ–¹

## ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ä¾‹

é©å½“ãªä¾‹ãŒæ€ã„æµ®ã‹ã°ãªã‹ã£ãŸã®ã§ã¡ã‚‡ã£ã¨å¾®å¦™ãªä¾‹ã§ã™ãŒã€ä¼šå“¡åˆ¶ã®ECã§ã€åº—èˆ—ã¨é¡§å®¢ãŒåŒã˜ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã¨ã„ã†æ‰±ã„ã§ã‚ã‚‹ã‚ˆã†ãªã‚·ã‚¹ãƒ†ãƒ ã‚’æƒ³å®šã—ã€`User` ã‚’ç¶™æ‰¿ã—ãŸ `Shop` ã¨ `Customer` ãŒã‚ã‚‹ã¨ã—ã¾ã—ã‚‡ã†ã€‚

```php
// src/Entity/User.php

#[ORM\Entity(repositoryClass: UserRepository::class)]
#[ORM\InheritanceType('SINGLE_TABLE')]
#[ORM\DiscriminatorColumn('type')]
#[ORM\DiscriminatorMap([
    'shop' => Shop::class,
    'customer' => Customer::class,
])]
#[ORM\EntityListeners([UserListener::class])]
abstract class User
{
}
```

ãã—ã¦ã€`Shop` ã¨ `Customer` ã¯ãã‚Œãã‚Œãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’æŒã¤ã®ã§ã™ãŒã€ãã‚Œãã‚Œã‚¹ã‚­ãƒ¼ãƒãŒç•°ãªã‚‹ãŸã‚ã€`ShopProfile` ã¨ `CustomerProfile` ã¨ã„ã†ç•°ãªã‚‹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã§ã‚ã‚‹ã¨ã—ã¾ã—ã‚‡ã†ã€‚

```php
// src/Entity/Shop.php

#[ORM\Entity(repositoryClass: ShopRepository::class)]
class Shop extends User
{
    #[ORM\OneToOne(targetEntity: ShopProfile::class, mappedBy: 'shop', orphanRemoval: true)]
    protected ?ShopProfile $shopProfile = null;
}
```

```php
// src/Entity/Customer.php

#[ORM\Entity(repositoryClass: CustomerRepository::class)]
class Customer extends User
{
    #[ORM\OneToOne(targetEntity: CustomerProfile::class, mappedBy: 'customer', orphanRemoval: true)]
    protected ?CustomerProfile $customerProfile = null;
}
```

ã•ã‚‰ã«ã€ï¼ˆã©ã†ã„ã†ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹è¬ã§ã™ãŒï¼‰è¤‡æ•°ã® `User` ã‚’æŸã­ã‚‹ `Cluster` ã¨ã„ã†ã‚‚ã®ã‚’è€ƒãˆã¾ã™ã€‚

```php
// src/Entity/Customer.php

#[ORM\Entity(repositoryClass: ClusterRepository::class)]
class Cluster
{
    #[ORM\OneToMany(targetEntity: User::class, mappedBy: 'cluster')]
    private Collection $users;
}
```

## QueryBuilderã®ä¾‹

ã“ã®ã¨ãã€`Cluster::$users` ã«å¯¾ã—ã¦ `Shop` `Customer` ã‚’JOINã—ã€ã•ã‚‰ã«ãã®å…ˆã® `ShopProfile` `CustomerProfile` ã‚’JOINï¼ˆã—ã¦ã€`ShopProfile` `CustomerProfile` ã®å†…å®¹ã§ `WHERE` ãªã©ã‚’ï¼‰ã—ãŸã„ã€ã¨ã„ã†ã®ãŒä»Šå›ã‚„ã‚ŠãŸã‹ã£ãŸã“ã¨ã§ã™ã€‚

QueryBuilderã§ã“ã‚Œã‚’ã‚„ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãã¾ã™ã€‚

```php
$qb = $clusterRepository->createQueryBuilder('cl')
    ->leftJoin('cl.users')
    ->leftJoin(Shop::class, 'sh', Doctrine\ORM\Query\Expr\Join::WITH, 'u.id = sh.id') // ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆ
    ->leftJoin(Customer::class, 'cu', Doctrine\ORM\Query\Expr\Join::WITH, 'u.id = cu.id') // ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆ
    ->leftJoin('sh.shopProfile', 'sp')
    ->leftJoin('cu.customerProfile', 'cp')
    // ->orWhere('sp.shopName like :query')
    // ->orWhere('cp.customerName like :query')
    // ã¿ãŸã„ãª
;
```

# å‚è€ƒ

* [php - Doctrine2: Polymorphic Queries: Searching on properties of subclasses - Stack Overflow `#27284741`](https://stackoverflow.com/questions/7720138/doctrine2-polymorphic-queries-searching-on-properties-of-subclasses/27284741#27284741)
