---
title: "API Platformã®OpenAPIç”Ÿæˆã§ã€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®requiredã‚’readã®ã‚¹ã‚­ãƒ¼ãƒã«ã ã‘é©ç”¨ã™ã‚‹"
emoji: "ğŸ»"
type: "tech"
topics: ["php", "symfony", "apiplatform", "openapi"]
published: true
published_at: 2022-12-04 00:00
---

[Symfony Advent Calendar 2022](https://qiita.com/advent-calendar/2022/symfony) ã®4æ—¥ç›®ã®è¨˜äº‹ã§ã™ï¼ğŸ„ğŸŒ™

> ã¡ãªã¿ã«ã€åƒ•ã¯ã‚ˆã [Twitterã«ã‚‚Symfonyãƒã‚¿ã‚’å‘Ÿã„ã¦ã„ã‚‹](https://twitter.com/search?q=from%3Attskch%20(symfony%20OR%20doctrine)&src=typed_query&f=live) ã®ã§ã€ã‚ˆã‚ã—ã‘ã‚Œã°ãœã² [ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã‚„ã£ã¦ãã ã•ã„ğŸ•ŠğŸ¤²](https://twitter.com/ttskch)

æ˜¨æ—¥ã¯ [@bezeklik](https://twitter.com/BezeklikTecnica) ã•ã‚“ã® "Symfony 6 + EasyAdmin 4 ã§ç®¡ç†ç”»é¢ã‚’ç”Ÿæˆã™ã‚‹" ã§ã—ãŸâœ¨

# ã¯ã˜ã‚ã«

* æœ¬ç¨¿ã§å–ã‚Šæ‰±ã†API Platformã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ã€è¨˜äº‹åŸ·ç­†æ™‚ç‚¹ã§ [`old-stable`](https://api-platform.com/docs/extra/releases/) ã«ã‚ãŸã‚‹ [2.6.8](https://packagist.org/packages/api-platform/core#v2.6.8) ã§ã™
    * 2.7 ãŒ `stable` ãªã®ã§ã™ãŒã€2.6â†’2.7ã§è‰²ã€…ã¨å¾Œæ–¹äº’æ›æ€§ãŒå£Šã•ã‚Œã¦ã„ã‚‹ï¼ˆsemverã¨ã¯â€¦ï¼‰ãŸã‚ã€ã©ã†ã›ä¿®æ­£ãŒå¿…è¦ãªã‚‰ã°ã¨ã€åƒ•ã¯ v3 ãŒ `stable` ã«ãªã‚‹ã¾ã§å¾…ã¤æˆ¦ç•¥ã‚’ã¨ã£ã¦ã„ã¾ã™ğŸ˜“
* æœ¬ç¨¿ã®å†…å®¹ã¯ã€éå»è¨˜äº‹ [API Platformã®OpenAPIç”Ÿæˆã§ã€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®idã‚’requiredã«ã™ã‚‹](https://zenn.dev/ttskch/articles/0c97d3aec97b71) ã«ã‚‚é–¢é€£ã™ã‚‹ã®ã§ã€ã‚ˆã‚ã—ã‘ã‚Œã°ã‚ã‚ã›ã¦ã©ã†ãğŸµ

# èƒŒæ™¯

[API Platform](https://api-platform.com/) ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸOpenAPIã«ãŠã„ã¦ã€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ `required` ã«ã™ã‚‹ã«ã¯ã€

**PHPã‚¢ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ãƒˆã®å ´åˆ**

```php
class Foo
{
    #[ApiProperty(required: true)]
    private ?string $name = null;
}
```

**YAMLã®å ´åˆ**

```yaml
App\Entity\Foo:
  properties:
    name:
      required: true
```

ã®ã‚ˆã†ã«è¨­å®šã™ã‚Œã°ã‚ˆã„ã§ã™ã€‚

ã—ã‹ã—ã€ã“ã®ã‚ˆã†ã«è¨­å®šã—ãŸå ´åˆã€ã“ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ **ç”Ÿæˆã•ã‚Œã‚‹ã™ã¹ã¦ã®ã‚¹ã‚­ãƒ¼ãƒã«ãŠã„ã¦ `required` ã¨ã—ã¦å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚**

readæ–‡è„ˆã¨writeæ–‡è„ˆã§ [Serialization Groups](https://symfony.com/doc/current/serializer.html#using-serialization-groups-attributes) ã‚’åˆ†ã‘ã¦ã„ã‚‹å ´åˆã«ã€**readã®ã¨ãã¯ `required` ã«ã—ãŸã„ã‘ã©ã€`write` ã®ã¨ãã¯ã—ãŸããªã„** ã¨ã„ã†ã“ã¨ãŒå¤šã€…ã‚ã‚Šã¾ã™ã€‚ï¼ˆè©³ã—ãã¯å¾Œè¿°ã—ã¾ã™ï¼‰

æ®‹å¿µãªãŒã‚‰ã€å°‘ãªãã¨ã‚‚API Platform 2.6.8ã«ã¯ã“ã®ã‚ˆã†ãªãƒ‹ãƒ¼ã‚ºã«å¿œãˆã‚‹ãŸã‚ã®è¨­å®šã‚„æ©Ÿèƒ½ã¯ç”¨æ„ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

ãã“ã§ã€**API Platformã®OpenAPIç”Ÿæˆå‡¦ç†ã‚’æ‹¡å¼µã™ã‚‹ã“ã¨ã§å¼·å¼•ã«è§£æ±ºã™ã‚‹æ–¹æ³•ã‚’è§£èª¬ã—ã¾ã™ã€‚**

# å…·ä½“ä¾‹

ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```php
/**
 * Foo
 */
#[ORM\Entity(repositoryClass: FooRepository::class)]
class Foo
{
    #[ORM\Id]
    #[ORM\GeneratedValue]
    #[ORM\Column(type: 'integer')]
    private ?int $id = null;

    /**
     * å†…å®¹
     */
    #[ORM\Column(type: 'text')]
    #[Assert\NotBlank]
    private ?string $content = null;

    /**
     * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
     */
    #[ORM\Column(type: 'string', length: 255)]
    #[Assert\Choice(choices: ['æœªç€æ‰‹', 'å¯¾å¿œä¸­', 'å®Œäº†'])]
    private string $state = 'æœªç€æ‰‹';
}
```

* `$content` ã¯PHPãƒ¬ãƒ™ãƒ«ã§ã¯ `nullable` ã ãŒDBãƒ¬ãƒ™ãƒ«ã§ã¯ `non-nullable`
* `$state` ã¯PHPãƒ¬ãƒ™ãƒ«ã§ã‚‚DBãƒ¬ãƒ™ãƒ«ã§ã‚‚ `non-nullable`

ã¨ã„ã†ç‚¹ãŒãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚

ã“ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«ã¤ã„ã¦ã€CollectionPostã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨ItemGetã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’YAMLã§å®šç¾©ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

> æœ¬ç¨¿ã§ã¯ã“ã‚Œä»¥é™ã€APIãƒªã‚½ãƒ¼ã‚¹å®šç¾©ã¯PHPã‚¢ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ãƒˆã§ã¯ãªãYAMLã§è¨˜è¿°ã—ã¾ã™ã€‚ï¼ˆåƒ•ã®å¥½ã¿ã«ã‚ˆã‚Šï¼‰

```yaml
App\Entity\Foo:
  attributes:
    route_prefix: /v1/foos

  properties:
    content:
      required: true # æ³¨ç›®
    state:
      required: true # æ³¨ç›®
      attributes:
        openapi_context:
          enum: [å‡¦ç†ä¸­, å®Œäº†]

  collectionOperations:

    post:
      normalization_context:
        groups: [foo:read] # æ³¨ç›®
      denormalization_context:
        groups: [foo:write] # æ³¨ç›®

  itemOperations:

    get:
      normalization_context:
        groups: [foo:read] # æ³¨ç›®
```

å„ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¯ [`normalization_context` `denormalization_context` ã§readæ™‚ã¨writeæ™‚ãã‚Œãã‚Œã®Serialization Groupsã‚’è¨­å®š](https://api-platform.com/docs/v2.6/core/serialization/#using-serialization-groups) ã—ã¦ã„ã¾ã™ã€‚

ã“ã®ä¾‹ã§ã¯ã€readæ–‡è„ˆã§ã¯ `foo:read` ã‚°ãƒ«ãƒ¼ãƒ—ã€writeæ–‡è„ˆã§ã¯ `foo:write` ã‚°ãƒ«ãƒ¼ãƒ—ã«å«ã¾ã‚Œã‚‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã ã‘ãŒã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºï¼ˆã¾ãŸã¯ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºï¼‰ã•ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

ã¾ãŸã€`$content` `$state` ã¯ã„ãšã‚Œã‚‚DBãƒ¬ãƒ™ãƒ«ã§ `non-nullable` ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãªã®ã§ã€å–å¾—æ™‚ã«å¿…ãšå€¤ãŒå…¥ã£ã¦ã„ã‚‹ã¨ã„ã†æ„å‘³ã§ä¸¡æ–¹ã¨ã‚‚ `required` ã«ã—ã¦ã‚ã‚Šã¾ã™ã€‚

ã§ã¯ã€ã“ã®å†…å®¹ã«åˆã‚ã›ã¦ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºè¨­å®šã‚‚YAMLã§æ›¸ã„ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

> æœ¬ç¨¿ã§ã¯ã“ã‚Œä»¥é™ã€ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºè¨­å®šã‚‚PHPã‚¢ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ãƒˆã§ã¯ãªãYAMLã§è¨˜è¿°ã—ã¾ã™ã€‚ï¼ˆåƒ•ã®å¥½ã¿ã«ã‚ˆã‚Šï¼‰

```yaml
App\Entity\Foo:
  attributes:
    id:
      groups:
        - foo:read
    content:
      groups:
        - foo:read
        - foo:write
    state:
      groups:
        - foo:read
```

ï¼ˆ`id` ã¯å½“ç„¶ã¨ã—ã¦ï¼‰ã‚ãˆã¦ `state` ã« `foo:write` ã‚’ã‚»ãƒƒãƒˆã—ã¦ã„ãªã„ç‚¹ã«æ³¨ç›®ã—ã¦ãã ã•ã„ã€‚

`$state` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯PHPãƒ¬ãƒ™ãƒ«ã§åˆæœŸå€¤ãŒ `æœªç€æ‰‹` ã¨ãªã£ã¦ã„ã¦ã€**ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æ–°è¦ä½œæˆæ™‚ã« `$state` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å€¤ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒãªã„ãŸã‚ã€writeæ™‚ã®ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã®å¯¾è±¡ã‹ã‚‰å¤–ã—ã¦ã„ã‚‹** ã‚ã‘ã§ã™ã€‚

> `Foo` ã‚¯ãƒ©ã‚¹ã®å®Ÿè£…ã‚’è¦‹è¿”ã—ã¦ã„ãŸã ãã¨ã€`$content` ã«ã¯ `#[Assert\NotBlank]` ã‚’ä»˜ã‘ã¦ã„ã‚‹ã®ã« `$state` ã«ã¯ã‚ãˆã¦ä»˜ã‘ã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚ã“ã‚Œã¯ã€`$state` ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã—ãŸå€¤ã‚’ç›´æ¥ã‚»ãƒƒãƒˆã™ã‚‹ã“ã¨ã‚’æƒ³å®šã—ã¦ã„ãªã‹ã£ãŸãŸã‚ã§ã™ã€‚

ã¨ã“ã‚ã§ã€API Platformã§ã¯ã€ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«Serialization Groupsã‚’è¨­å®šã—ãŸå ´åˆã€**Serialization Groupsã”ã¨ã«åˆ¥ã€…ã®ã‚¹ã‚­ãƒ¼ãƒãŒç”Ÿæˆã•ã‚Œã€ãã‚Œãã‚ŒãŒå„ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«é©åˆ‡ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã™ã€‚**

ã¤ã¾ã‚Šã€ä»Šå›ã®ä¾‹ã§ã¯ã€

1ï¸âƒ£ `foo:read` æ–‡è„ˆã«ãŠã‘ã‚‹ `Foo` ã®ã‚¹ã‚­ãƒ¼ãƒ
2ï¸âƒ£ `foo:write` æ–‡è„ˆã«ãŠã‘ã‚‹ `Foo` ã®ã‚¹ã‚­ãƒ¼ãƒ

ã®2ã¤ãŒç”Ÿæˆã•ã‚Œã€

| å¯¾è±¡ | ã‚¹ã‚­ãƒ¼ãƒ |
| --- | --- |
| `POST /api/v1/foos` ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ | 2ï¸âƒ£ |
| `POST /api/v1/foos` ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ | 1ï¸âƒ£ |
| `GET /api/v1/foos/{id}` ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ | 1ï¸âƒ£ |

ã®ã‚ˆã†ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

ã•ã¦ã€å‰ç½®ããŒã¨ã¦ã‚‚é•·ããªã‚Šã¾ã—ãŸãŒã€ã“ã®çŠ¶æ…‹ã§ã€API Platformã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹OpenAPIã‚’Swagger UIã§è¦‹ã¦ã¿ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

**1ï¸âƒ£ `foo:read` æ–‡è„ˆã«ãŠã‘ã‚‹ `Foo` ã®ã‚¹ã‚­ãƒ¼ãƒ**

![](https://tva1.sinaimg.cn/large/008vxvgGgy1h88tii3iq4j30fa0jm3z2.jpg)

**2ï¸âƒ£ `foo:write` æ–‡è„ˆã«ãŠã‘ã‚‹ `Foo` ã®ã‚¹ã‚­ãƒ¼ãƒ**

![](https://tva1.sinaimg.cn/large/008vxvgGgy1h88vhu433ej30fa0jm3z2.jpg)

ã©ã¡ã‚‰ã‚‚ã¾ã£ãŸãåŒã˜å†…å®¹ã§ã€**ä¸¡æ–¹ã¨ã‚‚ `$state` ãŒ `required` ã«ãªã£ã¦ã„ã¾ã™ã€‚**ï¼ˆãã†è¨­å®šã—ãŸã®ã ã‹ã‚‰å½“ç„¶ã§ã™ãŒï¼‰

ã—ã‹ã—æ€ã„å‡ºã—ã¦ãã ã•ã„ã€‚`foo:write` æ–‡è„ˆã«ãŠã„ã¦ã¯ `$state` ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã«å«ã‚ãŸã¨ã“ã‚ã§ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œãšç„¡è¦–ã•ã‚Œã¾ã™ã€‚**ã¤ã¾ã‚Šã€writeæ–‡è„ˆã«ãŠã„ã¦ã¯ `$state` ã¯ `required` ã¨ã™ã‚‹ã¹ãã§ã¯ãªã„** ã®ã§ã™ã€‚

readæ–‡è„ˆã«ãŠã„ã¦ã¯ `$state` ã¯å¿…ãšå€¤ãŒå…¥ã£ã¦ã„ã‚‹ã¨ã„ã†æ„å‘³ã§ `required` ã¨ã—ã¦ãŠããŸã„ã®ã§ã€**readæ–‡è„ˆã‹writeæ–‡è„ˆã‹ã«ã‚ˆã£ã¦ `required` ã«ã™ã‚‹ã‹ã—ãªã„ã‹ã‚’åˆ¶å¾¡ã—ãŸã„** ã¨ã„ã†ãƒ‹ãƒ¼ã‚ºãŒã“ã“ã«ã‚ã‚‹ã‚ã‘ã§ã™ã€‚

# è§£æ±ºæ–¹æ³•

ã‚„ã£ã¨å‰æã®èª¬æ˜ãŒçµ‚ã‚ã‚Šã¾ã—ãŸï½—

æœ¬ç¨¿ã®å†’é ­ã«ã‚‚æ›¸ã„ãŸã‚ˆã†ã«ã€ç¾çŠ¶ã€API Platformã«ã¯ï¼ˆå°‘ãªãã¨ã‚‚ 2.6.8 ã«ã¯ï¼‰ã“ã®ã‚ˆã†ãªãƒ‹ãƒ¼ã‚ºã«å¿œãˆã‚‹ãŸã‚ã®è¨­å®šã‚„æ©Ÿèƒ½ã¯ç”¨æ„ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

ãã“ã§ã€API Platformã®OpenAPIç”Ÿæˆå‡¦ç†ã‚’æ‹¡å¼µã™ã‚‹ã“ã¨ã§å¼·å¼•ã«è§£æ±ºã—ã¾ã™ã€‚

OpenAPIã®ã‚¹ã‚­ãƒ¼ãƒã®ç”Ÿæˆã¯ [SchemaFactory](https://github.com/api-platform/core/blob/v2.6.8/src/Hydra/JsonSchema/SchemaFactory.php) ã¨ã„ã†ã‚¯ãƒ©ã‚¹ãŒè¡Œã£ã¦ã„ã¾ã™ã€‚

> è©³ç´°ã¯ [API Platformã®OpenAPIç”Ÿæˆã§ã€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®idã‚’requiredã«ã™ã‚‹ `#api-platformã®ã‚³ãƒ¼ãƒ‰ã«ãŠã‘ã‚‹åŸå› ç®‡æ‰€`](https://zenn.dev/ttskch/articles/0c97d3aec97b71#api-platform%E3%81%AE%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E5%8E%9F%E5%9B%A0%E7%AE%87%E6%89%80) ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

ã“ã®ã‚¯ãƒ©ã‚¹ã‚’ [Symfonyã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚³ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½](https://symfony.com/doc/current/service_container/service_decoration.html) ã‚’ä½¿ã£ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚µãƒ¼ãƒ“ã‚¹ã‚’å·®ã—æ›¿ãˆã¦ã‚ã’ã¾ã™ã€‚

```yaml
# config/services.yaml
services:
  App\ApiPlatform\SchemaFactory: # ã¨ã„ã†ã‚¯ãƒ©ã‚¹ã‚’è‡ªä½œã™ã‚‹
    decorates: api_platform.hydra.json_schema.schema_factory
```

è‡ªä½œã™ã‚‹ã‚¯ãƒ©ã‚¹ã®å†…å®¹ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

> ã“ã¡ã‚‰ã‚‚ [API Platformã®OpenAPIç”Ÿæˆã§ã€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®idã‚’requiredã«ã™ã‚‹ `#api-platformã®-schemafactory-ã‚’æ‹¡å¼µã™ã‚‹`](https://zenn.dev/ttskch/articles/0c97d3aec97b71#api-platform%E3%81%AE-schemafactory-%E3%82%92%E6%8B%A1%E5%BC%B5%E3%81%99%E3%82%8B) ã«ã‚‚ã†å°‘ã—è©³ç´°ãªèª¬æ˜ãŒã‚ã‚Šã¾ã™ã®ã§ã‚ã‚ã›ã¦ã”å‚ç…§ãã ã•ã„ã€‚

```php
<?php

declare(strict_types=1);

namespace App\ApiPlatform;

use ApiPlatform\Core\JsonSchema\Schema;
use ApiPlatform\Core\JsonSchema\SchemaFactoryInterface;

/**
 * @see \ApiPlatform\Core\Hydra\JsonSchema\SchemaFactory
 */
final class SchemaFactory implements SchemaFactoryInterface
{
    public function __construct(private SchemaFactoryInterface $decorated)
    {
    }

    public function buildSchema(string $className, string $format = 'json', string $type = Schema::TYPE_OUTPUT, ?string $operationType = null, ?string $operationName = null, ?Schema $schema = null, ?array $serializerContext = null, bool $forceCollection = false): Schema
    {
        $schema = $this->decorated->buildSchema($className, $format, $type, $operationType, $operationName, $schema, $serializerContext, $forceCollection);

        /** @var \ArrayObject<string, array<array<array<string>>>> $definitions */
        $definitions = $schema->getDefinitions();
        if ($key = $schema->getRootDefinitionKey()) {
            // descriptionã« "#requiredOnRead" ãŒå«ã¾ã‚Œã‚‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ã€"read" ã¨åã®ä»˜ãã‚¹ã‚­ãƒ¼ãƒã«ãŠã„ã¦ã®ã¿requiredã«
            foreach ($definitions[$key]['properties'] ?? [] as $name => $property) {
                $description = $property['description'] ?? '';
                $definitions[$key]['properties'][$name]['description'] = preg_replace('/\s*#requiredOnRead\s*/', '', $description);
                if (preg_match('/#requiredOnRead/', $description) && preg_match('/\.read(\.|$)/i', $key)) {
                    $definitions[$key]['required'][] = $name;
                }
            }
        }

        return $schema;
    }
}
```

ã‚³ãƒ¼ãƒ‰ã®ç´°ã‹ãªè§£èª¬ã¯ä»Šå›ã¯å‰²æ„›ã•ã›ã¦ã„ãŸã ãã¾ã™ãŒã€**ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®descriptionã« `#requiredOnRead` ã¨ã„ã†æ–‡å­—åˆ—ãŒå«ã¾ã‚Œã‚‹å ´åˆã«ã€ãã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ã€ã€Œ`read` ã¨åã®ã¤ãã‚¹ã‚­ãƒ¼ãƒã«ãŠã„ã¦ã®ã¿ã€`required` ã«ã™ã‚‹** ã¨ã„ã†ä½•ã¨ã‚‚å¼·å¼•ãªã“ã¨ã‚’ã‚„ã£ã¦ã„ã¾ã™ã€‚

å½“ç„¶ãªãŒã‚‰ã€readç³»/writeç³»ã®Serialization Groupsã®å‘½åè¦å‰‡ã¨ã—ã¦ã€readç³»ã«ã¯å¿…ãš `read` ã¨ã„ã†æ–‡å­—åˆ—ã‚’å«ã‚ã‚‹ã€writeç³»ã«ã¯ `read` ã¨ã„ã†æ–‡å­—åˆ—ã¯å«ã‚ãªã„ã€ã‚’å¾¹åº•ã™ã‚‹ã“ã¨ãŒå‰æã¨ãªã‚Šã¾ã™ã€‚

> ä¸€èˆ¬çš„ãª `{ãƒªã‚½ãƒ¼ã‚¹å}:read` `{ãƒªã‚½ãƒ¼ã‚¹å}:write` ã‚„ã€`{ãƒªã‚½ãƒ¼ã‚¹å}:collection:read` `{ãƒªã‚½ãƒ¼ã‚¹å}:item:write` ã®ã‚ˆã†ãªå‘½åè¦å‰‡ã‚’æ¡ç”¨ã—ã¦ãŠã‘ã°ã€ç‰¹ã«å•é¡Œã«ãªã‚‹ã“ã¨ã¯ãªã„ã§ã—ã‚‡ã†ã€‚

ã“ã®ä¸Šã§ã€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®Docã‚³ãƒ¡ãƒ³ãƒˆï¼ˆã“ã‚ŒãŒè‡ªå‹•ã§OpenAPIã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®descriptionã«ãªã‚Šã¾ã™ï¼‰ã« `#requiredOnRead` ã¨ã„ã†æ–‡å­—åˆ—ã‚’è¿½è¨˜ã™ã‚Œã°å¯¾å¿œå®Œäº†ã§ã™ã€‚

```diff
  /**
   * Foo
   */
  #[ORM\Entity(repositoryClass: FooRepository::class)]
  class Foo
  {
      #[ORM\Id]
      #[ORM\GeneratedValue]
      #[ORM\Column(type: 'integer')]
      private ?int $id = null;
  
      /**
       * å†…å®¹
       */
      #[ORM\Column(type: 'text')]
      #[Assert\NotBlank]
      private ?string $content = null;
  
      /**
-      * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
+      * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ #requiredOnRead
       */
      #[ORM\Column(type: 'string', length: 255)]
      #[Assert\Choice(choices: ['æœªç€æ‰‹', 'å¯¾å¿œä¸­', 'å®Œäº†'])]
      private string $state = 'æœªç€æ‰‹';
  }
```

# çµæœ

**1ï¸âƒ£ `foo:read` æ–‡è„ˆã«ãŠã‘ã‚‹ `Foo` ã®ã‚¹ã‚­ãƒ¼ãƒ**

![](https://tva1.sinaimg.cn/large/008vxvgGgy1h88tii3iq4j30fa0jm3z2.jpg)

**2ï¸âƒ£ `foo:write` æ–‡è„ˆã«ãŠã‘ã‚‹ `Foo` ã®ã‚¹ã‚­ãƒ¼ãƒ**

![](https://tva1.sinaimg.cn/large/008vxvgGgy1h88wsb7e3kj30fa0jmwf1.jpg)

ã¨ã„ã†æ„Ÿã˜ã§ã€ç„¡äº‹ã« **`$state` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã® `required` ã‚’ã€readã®ã‚¹ã‚­ãƒ¼ãƒã«ã ã‘é©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸ** ğŸ™Œ

ã‚ã§ãŸã—ã‚ã§ãŸã—ğŸµ

[Symfony Advent Calendar 2022](https://qiita.com/advent-calendar/2022/symfony)ã€æ˜æ—¥ã¯ [@mako5656](https://twitter.com/mako5656_i) ã•ã‚“ã§ã™ï¼ãŠæ¥½ã—ã¿ã«ï¼
