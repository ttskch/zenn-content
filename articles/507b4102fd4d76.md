---
title: "[Symfony] ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ isGranted() ã™ã‚‹æ–¹æ³•"
emoji: "ğŸ»"
type: "tech"
topics: ["php", "symfony"]
published: true
---

# ã¯ã˜ã‚ã«

Symfonyã«ãŠã„ã¦ã€ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ã‚’æ¤œè¨¼ã™ã‚‹éš›ã«ã¯ `isGranted()` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```php
class Foo
{
    public function __construct(private Security $security)
    {
    }
    
    public function bar(): void
    {
        // ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ 'ROLE_XXX' æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã®ã¿ä½•ã‹ã‚’ã™ã‚‹
        if ($this->security->isGranted('ROLE_XXX')) {
            // do something
        }
    }
}
```

> ã¡ãªã¿ã« `AbstractController` ã‚’ç¶™æ‰¿ã—ãŸã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©å†…ã§ã¯ã€`Secuirity` ãªã©ã‚’ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆã—ãªãã¦ã‚‚ `$this->isGranted()` ã¨ã„ã†ã‚·ãƒ§ãƒ¼ãƒˆãƒãƒ³ãƒ‰ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚
> 
> ```php
> class FooController extends AbstractController
> {
>     public function barAction(): Response
>     {
>         // ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ 'ROLE_XXX' æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã®ã¿ä½•ã‹ã‚’ã™ã‚‹
>         if ($this->isGranted('ROLE_XXX')) {
>             // do something
>         }
> 
>         return new Response();
>     }
> }
> ```

ã—ã‹ã—ã€ã“ã‚Œã¯ã‚ãã¾ã§ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ã«å¯¾ã™ã‚‹æ¤œè¨¼ã«ã—ã‹ä½¿ãˆãšã€**ã€Œä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚ã‚‹æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹ã‹ã©ã†ã‹ã€ã‚’æ¤œè¨¼ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚**

ã“ã‚Œã‚’è§£æ±ºã§ãã‚‹å®Ÿè£…ã‚’è€ƒãˆã¦ã¿ã¾ã™ã€‚

# âŒ ä¸å®Œå…¨ãªè§£æ±ºç­–

`symfony security isgranted specific user` ã¨ã‹ã§ã‚°ã‚°ã‚‹ã¨ã€

[symfony - Is granted for other user - Stack Overflow](https://stackoverflow.com/questions/31140903/is-granted-for-other-user)

ã“ã‚“ãªæ„Ÿã˜ã®è§£æ±ºç­–ãŒè¦‹ã¤ã‹ã‚Šã¾ã™ã€‚

`RoleHierarchyInterface::getReachableRoleNames()` ã‚’ä½¿ã£ã¦ã€ã€ŒæŒ‡å®šã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€æŒ‡å®šã—ãŸROLEã‚’æŒã£ã¦ã„ã‚‹ã‹ã©ã†ã‹ã€ã‚’æ¤œè¨¼ã—ã‚ˆã†ã¨ã„ã†ã‚‚ã®ã§ã™ã­ã€‚

ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ãªã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹ã‚’ä½œã£ã¦ãŠãã“ã¨ã§ã€ä¾¿åˆ©ã«ä½¿ãˆãã†ã§ã™ã€‚

```php
namespace App\Security;

use Symfony\Component\Security\Core\Role\RoleHierarchyInterface;
use Symfony\Component\Security\Core\User\UserInterface;

class SecurityManager
{
    public function __construct(private RoleHierarchyInterface $roleHierarchy)
    {
    }

    public function isGranted(UserInterface $user, string $role): bool
    {
        return in_array($role, $this->roleHierarchy->getReachableRoleNames($user->getRoles()), true);
    }
}
```
```php
use App\Security\SecurityManager;

class Foo
{
    public function __construct(private SecurityManager $sm)
    {
    }
    
    public function bar(UserInterface $user): void
    {
        // æŒ‡å®šã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ 'ROLE_XXX' æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã®ã¿ä½•ã‹ã‚’ã™ã‚‹
        if ($this->sm->isGranted($user, 'ROLE_XXX')) {
            // do something
        }
    }
}
```

ã—ã‹ã—ã€[symfony - Is granted for other user - Stack Overflow](https://stackoverflow.com/questions/31140903/is-granted-for-other-user) ã®å›ç­”ã«ã‚‚æ³¨æ„æ›¸ãã•ã‚Œã¦ã„ã‚‹ã¨ãŠã‚Šã€ã“ã®æ–¹æ³•ã¯ [Security Voter](https://symfony.com/doc/current/security/voters.html) ã«ã‚ˆã‚‹æ¤œè¨¼ã«å¯¾å¿œã§ãã¦ã„ã¾ã›ã‚“ã€‚

ã¤ã¾ã‚Šã€**ã€Œä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚ã‚‹å¯¾è±¡ç‰©ã«å¯¾ã—ã¦ç‰¹å®šã®æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹ã‹ã€ã‚’æ¤œè¨¼ã™ã‚‹ã“ã¨ãŒã§ããš**ã€å¯¾å¿œã¨ã—ã¦ã¯ä¸å®Œå…¨ã§ã™ã€‚

# â­• å®Œå…¨ãªè§£æ±ºç­–

ã‚‚ã¨ã® `isGranted()` ãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿè£…ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€æœ€çµ‚çš„ã«ã¯ [`AuthorizationCheckerInterface`](https://github.com/symfony/security/blob/b3eab8b37ff7b24d9c582770fd1cd57725895e3b/Core/Authorization/AuthorizationCheckerInterface.php) ã«ãƒã‚¤ãƒ³ãƒ‰ã•ã‚Œã¦ã„ã‚‹ [`security.authorization_checker` ã¨ã„ã†ã‚µãƒ¼ãƒ“ã‚¹ã® `isGranted()` ã‚’å‘¼ã‚“ã§ã„ã‚‹](https://github.com/symfony/security/blob/b3eab8b37ff7b24d9c582770fd1cd57725895e3b/Core/Security.php#L65-L69) ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

ã¤ã¾ã‚Šã€å®Œå…¨ãªå¯¾å¿œã‚’ã™ã‚‹ã«ã¯ã€**æŒ‡å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå®Ÿéš›ã«ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã«ã‚ã‚‹ã‚ˆã†ãª `AuthorizationCheckerInterface` ã®å®Ÿä½“ã‚’ç”¨æ„ã—ã¦ã€ãã‚Œã«å¯¾ã—ã¦ `isGranted()` ã‚’å‘¼ã‚“ã§ã‚ã’ã‚Œã°** ã‚ˆã•ãã†ã§ã™ã€‚

å…·ä½“çš„ã«ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã§å®Ÿç¾å¯èƒ½ã§ã™ã€‚

> ãªãœã“ã†ã„ã†ã‚³ãƒ¼ãƒ‰ã«ãªã‚‹ã‹ã¯ã€Symfonyã®ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚“ã§ã¿ã¦ãã ã•ã„ğŸ™

```php
namespace App\Security;

use Symfony\Component\Security\Core\Authentication\Token\Storage\TokenStorage;
use Symfony\Component\Security\Core\Authorization\AccessDecisionManagerInterface;
use Symfony\Component\Security\Core\Authorization\AuthorizationChecker;
use Symfony\Component\Security\Core\User\UserInterface;
use Symfony\Component\Security\Http\Authenticator\Token\PostAuthenticationToken;

class SecurityManager
{
    public function __construct(private AccessDecisionManagerInterface $adm)
    {
    }

    public function isGranted(UserInterface $user, mixed $attribute, mixed $subject = null): bool
    {
        $tokenStorage = new TokenStorage();
        $token = new PostAuthenticationToken($user, 'main', $user->getRoles());
        $tokenStorage->setToken($token);
        $authorizationChecker = new AuthorizationChecker($tokenStorage, $this->adm);

        return $authorizationChecker->isGranted($attribute, $subject);
    }
}
```

ã“ã‚Œã§ã€æ¨™æº–ã® `isGranted()` ã¨ã¾ã£ãŸãåŒç­‰ã®æ¤œè¨¼ã‚’ã€ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦è¡Œã†ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

```php
use App\Security\SecurityManager;

class Foo
{
    public function __construct(private SecurityManager $sm)
    {
    }
    
    public function bar(UserInterface $user, Baz $baz): void
    {
        // æŒ‡å®šã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ $baz ã«å¯¾ã—ã¦ 'EDIT' æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã®ã¿ä½•ã‹ã‚’ã™ã‚‹
        if ($this->sm->isGranted($user, 'EDIT', $baz)) {
            // do something
        }
    }
}
```

ã‚ã§ãŸã—ã‚ã§ãŸã—ğŸ£
