---
title: "Next.js + Supabase + Vercel + Inngestã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¸ãƒ§ãƒ–ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã—ã¦DBã‚’æ“ä½œ"
emoji: "ğŸ”¯"
type: "tech"
topics: ["nextjs", "supabase", "vercel", "inngest"]
published: true
---

# ã¯ã˜ã‚ã«

Vercelã§ãƒ›ã‚¹ãƒˆã—ã¦ã„ã‚‹Next.jsï¼ˆv12ï¼‰+ Supabaseè£½ã®ã‚¢ãƒ—ãƒªã«ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè£…ã—ãŸéš›ã€[Inngest](https://www.inngest.com/) ã¨ã„ã†ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ã£ãŸã‚‰ã„ã„æ„Ÿã˜ã«ã§ããŸã®ã§ã‚„ã£ãŸã“ã¨ã‚’ã¾ã¨ã‚ã¦ãŠãã¾ã™ã€‚

Inngestã®Vercelã¸ã®ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ [å…¬å¼ã®ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹](https://vercel.com/integrations) ã« [ç”¨æ„ã•ã‚Œã¦ãŠã‚Š](https://vercel.com/integrations/inngest)ã€ç°¡å˜ã«é€£æºã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

# å‰æ

å„ç¨®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚

```json
{
  "dependencies": {
    "next": "12.3.4",
    "@supabase/supabase-js": "2.22.0",
    "@supabase/auth-helpers-nextjs": "0.7.2",
    "@supabase/auth-helpers-react": "0.4.0",
    "inngest": "2.0.1"
  },
  "devDependencies": {
    "inngest-cli": "0.14.0"
  }
}
```

ã™ã§ã«Next.jsï¼ˆv12ï¼‰+ Supabaseè£½ã®ã‚¢ãƒ—ãƒªãŒVercelã§ãƒ›ã‚¹ãƒˆã•ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ã§ã€Inngestã‚’å°å…¥ã—ã¦ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè£…ã™ã‚‹éƒ¨åˆ†ã®æ‰‹é †ã‚’è§£èª¬ã—ã¾ã™ã€‚

> å¤§ã¾ã‹ãªæµã‚Œã¯
> 
> * [Quick start - Inngest Documentation](https://www.inngest.com/docs/quick-start)
> * [Writing Functions - Inngest Documentation](https://www.inngest.com/docs/functions)
> * [Vercel - Inngest Documentation](https://www.inngest.com/docs/deploy/vercel)
> 
> ã“ã®è¾ºã‚’çœºã‚ã‚Œã°å¤§ä½“åˆ†ã‹ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

# 1. Inngestã®SDKãŠã‚ˆã³CLIãƒ„ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```shell
$ yarn add inngest
$ yarn add -D inngest-cli
```

# 2. Inngestã‚µãƒ¼ãƒãƒ¼ã«å¯¾ã™ã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ãªã‚‹APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ 

```ts
// pages/api/inngest.ts

import {serve} from 'inngest/next'
import {inngest} from '../../inngest/client'

export default serve(inngest, [/* ã“ã“ã«ã‚¸ãƒ§ãƒ–ã‚’å‡¦ç†ã™ã‚‹é–¢æ•°ã‚’åˆ—æŒ™ */])
```

ã“ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒInngestã‚µãƒ¼ãƒãƒ¼ã«å¯¾ã™ã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ãªã‚Šã¾ã™ã€‚ï¼ˆã®ã§ã€ã‚µã‚¤ãƒˆå…¨ä½“ã«BASICèªè¨¼ã‚’æ›ã‘ã¦ã„ã‚‹å ´åˆãªã©ã¯ã€ã“ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’BASICèªè¨¼ã®å¯¾è±¡ã‹ã‚‰å¤–ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ç”Ÿæˆè‡ªä½“ã¯ã‚ã¨ã‚ã¨ã‚³ãƒ¼ãƒ‰ã®è¦‹é€šã—ã‚’è‰¯ãã™ã‚‹ãŸã‚ã«åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ†ã‘ã¦ãŠãã¾ã™ã€‚

```ts
// inngest/client.ts

import {Inngest} from 'inngest'

const inngestOptions = {  
  name: '{ã‚¢ãƒ—ãƒªå}',
}

export const inngest = new Inngest(inngestOptions)
```

# 3. ã‚¸ãƒ§ãƒ–ã‚’å‡¦ç†ã™ã‚‹é–¢æ•°ã‚’å®Ÿè£…

ç¶šã„ã¦ã€å®Ÿéš›ã«ã‚¸ãƒ§ãƒ–ã‚’å‡¦ç†ã™ã‚‹é–¢æ•°ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

ã¾ãšã¯APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã‚³ãƒ¼ãƒ‰ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚

```diff
  // pages/api/inngest.ts
  
  import {serve} from 'inngest/next'
  import {inngest} from '../../inngest/client'
+ import helloJob from '../../inngest/hello'
  
- export default serve(inngest, [/* ã“ã“ã«ã‚¸ãƒ§ãƒ–ã‚’å‡¦ç†ã™ã‚‹é–¢æ•°ã‚’åˆ—æŒ™ */])
+ export default serve(inngest, [helloJob])
```

```diff
  // inngest/client.ts
  
- import {Inngest} from 'inngest'
+ import {EventSchemas, Inngest} from 'inngest'
+ import {HelloEvent, helloEventName} from './hello'
+
+ // â‘ 
+ export type Events = {
+   [helloEventName]: HelloEvent
+ }
  
  const inngestOptions = {  
    name: '{ã‚¢ãƒ—ãƒªå}',
+   schemas: new EventSchemas().fromRecord<Events>(), // â‘¡
  }  
    
  export const inngest = new Inngest(inngestOptions)
```

`inngeset/hello.ts` ã«é–¢æ•°ã‚’å®Ÿè£…ã™ã‚‹æƒ³å®šã§ã™ã€‚

â‘ ã®ç®‡æ‰€ã¯

```ts
{
  ã‚¤ãƒ™ãƒ³ãƒˆå: ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†ã™ã‚‹é–¢æ•°ã«æ¸¡ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã®å‹
}
```

ã‚’å®šç¾©ã—ã¦ã„ã¦ã€ã“ã‚Œã‚’â‘¡ã§ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹å¼•æ•°ã«æ¸¡ã™ã“ã¨ã§ã€é–¢æ•°ã®å®Ÿè£…ã‚³ãƒ¼ãƒ‰å´ã§å‹æ¨è«–ãŒåŠ¹ãã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

> å‚è€ƒï¼š[TypeScript - Inngest Documentation](https://www.inngest.com/docs/typescript)

â‘ ã®ç®‡æ‰€ã§ã¯ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã›ãšã€`hello.ts` å´ã§å®šç¾©ã™ã‚‹ã“ã¨ã§DRYã«ã—ã¦ã„ã¾ã™ã€‚

ã§ã¯ã€`hello.ts` ã®å†…å®¹ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

```ts
// inngest/hello.ts

import {inngest} from './client'

export const helloEventName = '{ã‚¢ãƒ—ãƒªå}/hello'

export type HelloEvent = {
  name: typeof helloEventName
  data: {
    name: string
  }
}

export default inngest.createFunction(
  {name: helloEventName},
  {event: helloEventName},

  // æ¸¡ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ãŸå®Ÿéš›ã®å‡¦ç†
  async ({event}) => {
    console.log(`Hello, ${event.data.name}!`)
  },
)
```

ä¸€æ—¦ã®ä¾‹ã¨ã—ã¦éª¨çµ„ã¿ã ã‘ã®å†…å®¹ã§æ›¸ãã¨ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚

ã“ã®ä¾‹ã§ã¯ã€æ¸¡ã•ã‚ŒãŸ `data.name` ã‚’ä½¿ã£ã¦ `Hello, {æ¸¡ã•ã‚ŒãŸåå‰}!` ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã™ã‚‹ã¨ã„ã†å†…å®¹ã«ãªã£ã¦ã„ã¾ã™ã€‚

# 4. å®Ÿéš›ã«ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã—ã¦ã¿ã‚‹

ã‚ã¨ã¯ã€ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¸ãƒ§ãƒ–ã‚’ã‚­ãƒ¥ãƒ¼ã™ã‚‹ãŸã‚ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ç”¨æ„ã™ã‚Œã°OKã§ã™ã€‚

```tsx
// pages/api/hello.ts

import type {NextApiRequest, NextApiResponse} from 'next'
import {inngest} from '../inngest/client'
import {helloEventName} from '../inngest/hello'

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse,
) {
  await inngest.send({
    name: helloEventName,
    data: {
      name: 'Takashi'
    },
  })

  res.status(200).json({status: 'success'})
}
```

è©³ç´°ã¯å¾Œè¿°ã—ã¾ã™ãŒã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰Inngestã‚µãƒ¼ãƒãƒ¼ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡ã™ã‚‹ã«ã¯ã€`INNGEST_EVENT_KEY` ã¨ã„ã†ç’°å¢ƒå¤‰æ•°ã« "Event Key" ã¨å‘¼ã°ã‚Œã‚‹ç‰¹å®šã®å€¤ãŒæ ¼ç´ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã«ãŠã„ã¦ã¯ã€å€¤ã¯ãªã‚“ã§ã‚‚ã‚ˆã„ã®ã§ã€`.env.local` ã«

```
INNGEST_EVENT_KEY=local
```

ãªã©ã¨æ›¸ã„ã¦ãŠã‘ã°OKã§ã™ã€‚

ã“ã®çŠ¶æ…‹ã§ã€

```shell
$ yarn inngest-cli dev
```

ã§ãƒ­ãƒ¼ã‚«ãƒ«ã«é–‹ç™ºç’°å¢ƒç”¨ã®Inngestã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¡ä¸Šã’ã€`http://localhost:3000/api/hello` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã‚‹ã¨ã€`yarn dev` ã—ã¦ã„ã‚‹ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã« `Hello, Takashi!` ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

# 5. ã‚¸ãƒ§ãƒ–å‡¦ç†é–¢æ•°ã«Supabaseã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ¸¡ã—ã¦DBã‚’æ“ä½œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼ˆã‚¸ãƒ§ãƒ–ã‚’ã‚­ãƒ¥ãƒ¼ã™ã‚‹ã¨ã“ã‚ã¾ã§ï¼‰

ã•ã¦ã€ã“ã“ã¾ã§ã§åŸºæœ¬çš„ãªæµã‚Œã¯å®Œæˆã§ã™ã€‚

ç¶šã„ã¦ã€ã‚¸ãƒ§ãƒ–å‡¦ç†é–¢æ•°ã«Supabaseã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ¸¡ã—ã¦ã€ã‚¸ãƒ§ãƒ–ã‹ã‚‰DBã®æ“ä½œãªã©ã‚’ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ã¾ãšå‰æã¨ã—ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ãªå½¢ã® `jobs` ãƒ†ãƒ¼ãƒ–ãƒ«ãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã¨ã—ã¾ã™ã€‚

```sql
CREATE TABLE "public"."jobs" (
  "id" int8 NOT NULL,
  "uuid" uuid NOT NULL,
  "status" varchar NOT NULL,
  "context" json,
  "started_at" timestamptz,
  "ended_at" timestamptz,
  "created_at" timestamptz NOT NULL DEFAULT now(),
  CONSTRAINT "jobs_uuid_fkey" FOREIGN KEY ("uuid") REFERENCES "auth"."users"("id"),
  PRIMARY KEY ("id")
);
```

* `uuid`ï¼šãã®ã‚¸ãƒ§ãƒ–ã®å®Ÿè¡Œè€…ã§ã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®id
* `status`ï¼šã‚¸ãƒ§ãƒ–ã®å®Ÿè¡ŒçŠ¶æ³ï¼ˆ`waiting` `runnning` `finished` `failed` ã¨ã„ã£ãŸæ–‡å­—åˆ—ï¼‰
* `context`ï¼šã‚¸ãƒ§ãƒ–ã«æ¸¡ã™ãƒ‡ãƒ¼ã‚¿ã‚„ã‚¸ãƒ§ãƒ–ã®å®Ÿè¡Œçµæœãªã©
* `started_at` `ended_at`ï¼šãã‚Œãã‚Œã‚¸ãƒ§ãƒ–ã®é–‹å§‹ãƒ»çµ‚äº†æ—¥æ™‚

ã‚’å…¥ã‚Œã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚

ã“ã®ä¸Šã§ã€ã‚¸ãƒ§ãƒ–ã‚’ã‚­ãƒ¥ãƒ¼ã™ã‚‹APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚

```ts
// pages/api/hello.ts

import {createPagesServerClient} from '@supabase/auth-helpers-nextjs'
import {createClient} from '@supabase/supabase-js'
import type {NextApiRequest, NextApiResponse} from 'next'
import {inngest} from '../inngest/client'
import {helloEventName} from '../inngest/hello'

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse,
) {
  // â‘ 
  const {data: {session}} = await createPagesServerClient({req, res}).auth.getSession()

  if (session === null) {
    res.status(403).json({status: 'error', message: 'ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚'})
    return
  }

  // â‘¡
  const adminClient = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL ?? '',
    process.env.SUPABASE_SERVICE_ROLE_KEY ?? '', // ã¨ã„ã†ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ã‚ã‚‹ã¨ã—ã¦
    {
      auth: {
        autoRefreshToken: false,
        persistSession: false,
      },
    },
  )

  // â‘¢
  const job = await insertJob({
    uuid: session.user.id,
    status: 'waiting',
    context: {
      name: 'Takashi',
    },
  }, adminClient) // ã¿ãŸã„ãªé–¢æ•°ã‚’ä½œã£ã¦ã‚ã‚‹ã¨ã—ã¦ğŸ™

  // â‘£
  await inngest.send({
    name: helloEventName,
    data: {
      accessToken: session.access_token,
      refreshToken: session.refresh_token,
      jobId: job.id
    },
  })

  res.status(200).json({status: 'success'})
}
```

ã¾ãšâ‘ ã§ãƒ­ã‚°ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å†…å®¹ã‚’å–å¾—ã—ã¾ã™ã€‚

ç¶šã„ã¦â‘¡ã§Supabaseã®adminã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚ã“ã‚Œã¯ã€`jobs` ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã®æŒ¿å…¥ã¯adminã ã‘ã—ã‹ã§ããªã„ã‚ˆã†ã« [RLS](https://supabase.com/docs/guides/auth/row-level-security) ã§åˆ¶ç´„ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒè¨­è¨ˆä¸Šå¦¥å½“ãªã®ã§ã€ãã®æƒ³å®šã«ã‚ˆã‚‹ã‚‚ã®ã§ã™ã€‚

> å‚è€ƒï¼š[Supabase Javascript Client `#Auth Admin`](https://supabase.com/docs/reference/javascript/admin-api)

ãã—ã¦â‘¢ã§ãã®adminã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½¿ã£ã¦ `jobs` ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚

æœ€å¾Œã«â‘£ã§ã‚¸ãƒ§ãƒ–ã‚’ã‚­ãƒ¥ãƒ¼ã—ã¾ã™ãŒã€ã“ã®ã¨ãã€ã‚¸ãƒ§ãƒ–ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã€ãŠã‚ˆã³ä»Šã—ãŒãŸè¿½åŠ ã—ãŸã‚¸ãƒ§ãƒ–ã®idã‚’ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æ¸¡ã™ã‚ˆã†ã«ã—ã¾ã™ã€‚

ã‚¸ãƒ§ãƒ–å‡¦ç†é–¢æ•°å´ã§ã¯ã€ã“ã‚Œã‚‰ã‚’å—ã‘å–ã£ã¦ãƒ­ã‚°ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å¾©å…ƒã—ã€ãã®ä¸Šã§æŒ‡å®šã•ã‚ŒãŸidã®ã‚¸ãƒ§ãƒ–ã‚’æ©‹æ¸¡ã—ã«ã—ã¦å‡¦ç†ã‚’è¡Œã†ã¨ã„ã†æµã‚Œã«ãªã‚Šã¾ã™ã€‚

# 6. ã‚¸ãƒ§ãƒ–å‡¦ç†é–¢æ•°ã®å®Ÿè£…ã‚’ä¿®æ­£

ã§ã¯ `hello.ts` ã®å†…å®¹ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã¡ã‚‡ã£ã¨é•·ã„ã§ã™ãŒä¸€æ°—ã«æ›¸ã„ã¡ã‚ƒã„ã¾ã™ã€‚

```ts
// inngest/hello.ts

import {createClient} from '@supabase/supabase-js'
import {inngest} from './client'

const adminClient = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL ?? '',
  process.env.SUPABASE_SERVICE_ROLE_KEY ?? '', // ã¨ã„ã†ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ã‚ã‚‹ã¨ã—ã¦
  {
    auth: {
      autoRefreshToken: false,
      persistSession: false,
    },
  },
)

export const helloEventName = '{ã‚¢ãƒ—ãƒªå}/hello'

// â‘ 
export type HelloEvent = {
  name: typeof helloEventName
  data: {
    accessToken: string
    refreshToken: string
    jobId: number
  }
}

export default inngest.createFunction(
  {name: helloEventName},
  {event: helloEventName},

  async ({event}) => {
    // â‘¡
    const client = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL ?? '',
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY ?? '',
      {auth: {persistSession: false}},
    )
    await client.auth.setSession({
      access_token: event.data.accessToken,
      refresh_token: event.data.refreshToken,
    })

    const user = (await client.auth.getUser()).data.user

    if (!user) {
      throw 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚'
    }

    // â‘¢
    const job = await selectJob({id: event.data.jobId}, client) // ã¿ãŸã„ãªé–¢æ•°ã‚’ä½œã£ã¦ã‚ã‚‹ã¨ã—ã¦ğŸ™

    if (!job) {
      throw 'ã‚¸ãƒ§ãƒ–ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚'
    }

    if (user.id !== job.uuid) {
      throw 'æŒ‡å®šã•ã‚ŒãŸã‚¸ãƒ§ãƒ–ã¨ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä¸€è‡´ã—ã¾ã›ã‚“ã§ã—ãŸã€‚'
    }

    // â‘£
    try {
      await start(job.id)
      console.log(`Hello, ${job.context.name}!`)
      await finish(job.id)
    } catch (err) {
      await fail(job.id, err)
    }
  },
)

const start = async (jobId: number): Promise<void> => {
  await updateJob({
    id: jobId,
    status: 'running',
    started_at: new Date(),
  }, adminClient)
}

const finish = async (jobId: number, context?: object): Promise<void> => {
  await updateJob({
    id: jobId,
    status: 'finished',
    context,
    ended_at: new Date(),
  }, adminClient)
}

const fail = async (jobId: number, error?: object) => {
  await updateJob({
    id: jobId,
    status: 'failed',
    context: error,
    ended_at: new Date(),
  }, adminClient)
}
```

ã¾ãšâ‘ ã§ `HelloEvent` å‹ã®å®šç¾©ã‚’ä¿®æ­£ã—ã¦ã‚ã‚Šã¾ã™ã€‚ï¼ˆã‚ã‚‰ã‹ã˜ã‚DRYã«ã—ã¦ãŠã„ãŸãŠã‹ã’ã§ä¿®æ­£ç®‡æ‰€ã¯ã“ã“ã ã‘ã§æ¸ˆã¿ã¾ã—ãŸã­ğŸ‘Œï¼‰

â‘¡ã§ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å¾©å…ƒã—ãŸSupabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™ã€‚

`createClient()` ã®ç¬¬3å¼•æ•°ã« `{auth: {persistSession: false}}` ã‚’æ¸¡ã•ãªã„ã¨ãã®å¾Œ `setSession()` ã—ã¦ã‚‚ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå¾©å…ƒã•ã‚Œãªã„ã¨ã„ã†ç½ ãŒã‚ã‚‹ã®ã§è¦æ³¨æ„ã§ã™ã€‚ï¼ˆãƒãƒã‚Šã¾ã—ãŸï¼‰

> å‚è€ƒï¼š[supabase.auth.setSession doesn't set and persist session for the current client Â· Issue #474 Â· supabase/gotrue-js `#issuecomment-1353637328`](https://github.com/supabase/gotrue-js/issues/474#issuecomment-1353637328)

â‘¢ã§ã€å—ã‘å–ã£ãŸã‚¸ãƒ§ãƒ–idã‚’ã‚‚ã¨ã«å®Ÿéš›ã«DBã‹ã‚‰ã‚¸ãƒ§ãƒ–ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚

æœ€å¾Œã«â‘£ã§

1. ã‚¸ãƒ§ãƒ–ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ `running` ã«æ›´æ–°
2. ã‚¸ãƒ§ãƒ–ã®å‡¦ç†ã‚’å®Ÿè¡Œ
3. æˆåŠŸã—ãŸå ´åˆã¯ã‚¸ãƒ§ãƒ–ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ `finished` ã«æ›´æ–°
4. å¤±æ•—ã—ãŸå ´åˆã¯ã‚¸ãƒ§ãƒ–ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ `failed` ã«æ›´æ–°

ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

ä»Šå›ã®ä¾‹ã§ã¯å®Ÿå‡¦ç†ãŒãŸã ã® `console.log()` ãªã®ã§ä¸€ç¬ã§ `finished` ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ãŒã€æœ¬æ¥ãªã‚‰é•·æ™‚é–“ã‹ã‹ã‚‹å‡¦ç†ã‚’è¡Œã†ã¯ãšãªã®ã§ã€DBã‚’é€šã—ã¦ã‚¸ãƒ§ãƒ–ã®é€²è¡ŒçŠ¶æ³ãŒåˆ†ã‹ã‚‹ã‚ˆã†ã«ã—ã¦ãŠã‘ã°ä½•ã‹ã¨ä¾¿åˆ©ã¨ã„ã†æƒ³å®šã§ã™ã€‚

ã“ã‚Œã§ã€Next.jsï¼ˆv12ï¼‰+ Supabase + Inngestã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¸ãƒ§ãƒ–ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã—ã¦DBã‚’æ“ä½œã™ã‚‹å®Ÿè£…ãŒã§ãã¾ã—ãŸğŸ™Œ

# 7. Inngestã‚µãƒ¼ãƒãƒ¼ã«é–¢æ•°ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤

ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§ã®ä½œæ¥­ã¯ä»¥ä¸Šã§ã™ã€‚

æœ€å¾Œã«ã€Inngestã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã®æ‰‹é †ã«ã¤ã„ã¦è»½ãè§¦ã‚Œã¦ãŠãã¾ã™ã€‚

ã¾ãš <https://vercel.com/integrations/inngest> ã“ã“ã‹ã‚‰Inngestã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’Vercelãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã€Inngestã®ä¸‹å›³ã®ç”»é¢ã§ç›®çš„ã®Vercelãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¹ã‚¤ãƒƒãƒã‚’ONã«ã—ã¦ãã ã•ã„ã€‚

![](https://img.esa.io/uploads/production/attachments/15064/2023/06/13/77821/77499b30-b5aa-4852-87be-8527f4529c1b.png)

æ¬¡ã«ã€Inngestå´ã§ç™ºè¡Œã•ã‚ŒãŸ "Signing Key" ã¨ "Event Key" ã¨ã„ã†ã‚‚ã®ã‚’Vercelã«ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦ç™»éŒ²ã—ã¾ã™ã€‚

> <https://www.inngest.com/docs/deploy/vercel> ã«ã‚ˆã‚‹ã¨ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚Œã°ã“ã‚Œã‚‰ã®ç’°å¢ƒå¤‰æ•°ã‚‚è‡ªå‹•ã§ç™»éŒ²ã•ã‚Œã‚‹ã¯ãšã®ã‚ˆã†ãªã®ã§ã™ãŒã€ãªã‚“ã‹åƒ•ã®ç’°å¢ƒã ã¨ãã†ã¯ãªã‚‰ãªã‹ã£ãŸã®ã§æ‰‹å‹•ã§ç™»éŒ²ã—ã¾ã—ãŸğŸ¤”
> è‰²ã€…è©¦è¡ŒéŒ¯èª¤ã—ã¦ãŸã®ã§ãã®éç¨‹ã§ãªã‚“ã‹ãŠã‹ã—ããªã£ã¦ãŸã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

æœ€çµ‚çš„ã«Vercelã«ç™»éŒ²ã—ãŸç’°å¢ƒå¤‰æ•°ã¯ä¸‹å›³ã®4ã¤ã§ã™ã€‚

![](https://img.esa.io/uploads/production/attachments/15064/2023/06/13/77821/0aefde49-c4f5-4776-ab17-2f0ea3f29738.png)

åƒ•ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯GitHubã® `release` ãƒ–ãƒ©ãƒ³ãƒã‚’æœ¬ç•ªç’°å¢ƒã«ã€`main` ãƒ–ãƒ©ãƒ³ãƒã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã«ã‚¢ã‚µã‚¤ãƒ³ã—ã¦ãŠã‚Šã€Inngestã¨ã®é€£æºã‚’æœ‰åŠ¹ã«ã™ã‚‹ã®ã‚‚ã“ã®2ã¤ã®ç’°å¢ƒã ã‘ã§ã‚ˆã„ã¨åˆ¤æ–­ã—ã¦ã‚ãˆã¦ç’°å¢ƒå¤‰æ•°ã®ç¯„å›²ã‚’åˆ¶é™ã—ã¦ã„ã¾ã™ã€‚

ãã‚Œãã‚ŒInngestã®ä¸‹å›³ã®ç”»é¢ã§å¾—ã‚‰ã‚Œã¾ã™ã€‚

`INNGEST_EVENT_KEY (Preview on main)`

![](https://img.esa.io/uploads/production/attachments/15064/2023/06/14/77821/62d3dbf1-76d3-4182-b953-b1db42890b9f.png)

`INNGEST_EVENT_KEY (Production)`

![](https://img.esa.io/uploads/production/attachments/15064/2023/06/14/77821/1d777673-1ebf-46c6-9a8b-715939c06e29.png)

`INNGEST_SIGNING_KEY (Preview on main)`

![](https://img.esa.io/uploads/production/attachments/15064/2023/06/13/77821/b9fe372a-9f4c-455d-b71b-60326a031a6e.png)

`INNGEST_SIGNING_KEY (Production)`

![](https://img.esa.io/uploads/production/attachments/15064/2023/06/13/77821/d307d551-8c7b-4a22-bd9e-b017846e1a79.png)

> å‚è€ƒï¼š
>
> * [Vercel - Inngest Documentation](https://www.inngest.com/docs/deploy/vercel)
> * [Creating an event key - Inngest Documentation](https://www.inngest.com/docs/events/creating-an-event-key)

ã“ã®çŠ¶æ…‹ã§Vercelã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€Inngesté–¢æ•°ãŒInngestã‚µãƒ¼ãƒãƒ¼ã«è‡ªå‹•ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã€Vercelã¨Inngestã®é€£æºãŒå‹•ä½œã—å§‹ã‚ã¾ã™ğŸ‘Œ

ä»¥ä¸Šã€ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼

# ãã®ä»–å‚è€ƒ

* [Next.js + Vercelã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ã—ãŸãã¦Inngestä½¿ã£ã¦ã¿ãŸã‚‰ä¾¿åˆ©ã ã£ãŸè©±](https://zenn.dev/masamiki/articles/e5a9f426164a7b)

> ã€ŒInngestä½¿ã‚ãªãã¦ã‚‚Edge Functionsã§ `waitUntil()` ã™ã‚Œã°ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã‚¿ã‚¹ã‚¯å®Ÿè¡Œã§ãã‚‹ã‚ˆã­ï¼ˆæ„è¨³ï¼‰ã€ã¨ã„ã†è¨€åŠãŒãªã•ã‚Œã¦ã„ã¾ã™ãŒã€Edge Functionsã¯ [`waitUntil()` å†…ã®å‡¦ç†ã§ã‚ã£ã¦ã‚‚30ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¦ä¸­æ–­ã•ã‚Œã¦ã—ã¾ã†](https://zenn.dev/catnose99/scraps/b4752fac25cd92) ã®ã§ã€30ç§’ä»¥ä¸Šã‹ã‹ã‚‹ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã—ãŸã„å ´åˆã¯åˆ¥é€”ã‚¸ãƒ§ãƒ–ã‚µãƒ¼ãƒãƒ¼ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚
