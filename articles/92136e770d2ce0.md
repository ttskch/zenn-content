---
title: "[Symfony] Doctrineã§ã€Œã‚°ãƒ«ãƒ¼ãƒ—ã®ä¸­ã§æœ€å¤§ãªã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã€ã®ãƒªã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹"
emoji: "ğŸ»"
type: "tech"
topics: ["php", "symfony", "doctrine"]
published: true
published_at: 2020-04-25
---

:::message
ã“ã®è¨˜äº‹ã¯ã€2020-04-25ã«åˆ¥ã®ãƒ–ãƒ­ã‚°åª’ä½“ã«æŠ•ç¨¿ã—ãŸè¨˜äº‹ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ã™ã€‚
:::

Doctrineã§

* ã‚ã‚‹åŸºæº–ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦
* å„ã‚°ãƒ«ãƒ¼ãƒ—ã®ä¸­ã§ã‚ã‚‹ã‚«ãƒ©ãƒ ã®å€¤ãŒæœ€å¤§ãªã‚‚ã®ã ã‘ã‚’
* ãƒªã‚¹ãƒˆã¨ã—ã¦å–å¾—ã™ã‚‹

ã¨ã„ã†ã®ãŒæ„å¤–ã¨é›£ã—ã‹ã£ãŸã®ã§ãƒ¡ãƒ¢ã«æ®‹ã—ã¦ãŠãã¾ã™ã€‚

å®Ÿéš›ã«å‹•ã‹ã›ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã‚’GitHubã«ä¸Šã’ãŸã®ã§ã€ã‚ã‚ã›ã¦å‚è€ƒã«ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

<https://github.com/ttskch/doctrine-sub-query-sample>

# è¦ä»¶

ä¾‹ã¨ã—ã¦ä»¥ä¸‹ã®è¦ä»¶ã‚’è€ƒãˆã¾ã™ã€‚

* ã€ŒæŠ•ç¨¿ã€ã¨ã€Œã‚³ãƒ¡ãƒ³ãƒˆã€ã¨ã„ã†ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒã‚ã‚‹
* æŠ•ç¨¿ã¯è¤‡æ•°ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŒã¤
* ã‚³ãƒ¡ãƒ³ãƒˆã«ã¯ã€ŒæŠ•ç¨¿æ—¥æ™‚ã€ã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚‹
* ã“ã®ã¨ãã€å„æŠ•ç¨¿ã®ã‚³ãƒ¡ãƒ³ãƒˆã®ã†ã¡ã€æŠ•ç¨¿æ—¥æ™‚ãŒæœ€æ–°ã®ã‚‚ã®ã ã‘ã‚’ãƒªã‚¹ãƒˆåŒ–ã—ã¦å–å¾—ã—ãŸã„

PHPå´ã§ã‚„ã£ã¦ã—ã¾ãˆã°ã¨ã¦ã‚‚ç°¡å˜ã§ã™ã€‚

```php
$newestComments = [];

foreach ($posts as $post) {
    $newestComment = null;

    foreach ($post->getComments() as $comment) {
        if (!$newestComment || $newestComment->getCreatedAt() <= $comment->getCreatedAt()) {
            $newestComment = $comment;
        }
    }

    $newestComments[] = $newestComment;
}
```

ã“ã‚“ãªæ„Ÿã˜ã§å®Ÿè£…ã§ãã¾ã™ã­ã€‚

ã§ã‚‚ã€ã“ã‚Œã ã¨ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ãŒå¤šã„ã¨ãã«è¨ˆç®—é‡ãŒã‚„ã°ã„ã®ã§ã€ã§ãã‚Œã°DBãƒ¬ã‚¤ãƒ¤ãƒ¼ã§è§£æ±ºã—ãŸã„ã§ã™ã€‚

# SQLãƒ¬ãƒ™ãƒ«ã§è€ƒãˆã‚‹

ã¾ãšã¯SQLãƒ¬ãƒ™ãƒ«ã§è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚

çµè«–ã¨ã—ã¦ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªSQLã§ï¼ˆã¡ã‚‡ã£ã¨å¼·å¼•ã§ã™ãŒï¼‰ç›®å½“ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```sql
SELECT
    c.*
FROM
    comment c
WHERE
    c.created_at = (
        SELECT
            max(c2.created_at)
        FROM
            comment c2
        WHERE
            c2.post_id = c.post_id
    )
;
```

* ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ã‚’ä½œæˆæ—¥æ™‚ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦å–å¾—
* ä½œæˆæ—¥æ™‚ã¯ã€ŒåŒã˜æŠ•ç¨¿ã‚’è¦ªã«æŒã¤ã‚³ãƒ¡ãƒ³ãƒˆã®ä¸­ã§æœ€å¤§ã®å€¤ã€ã‚’ã‚µãƒ–ã‚¯ã‚¨ãƒªã§å–å¾—ã—ã¦ã€ãã‚Œã¨ä¸€è‡´ã™ã‚‹ã‚‚ã®ã‚’æŠ½å‡º

ã¨ã„ã†æ–¹æ³•ã§ã™ã€‚

ãŠå¯Ÿã—ã®ã¨ãŠã‚Šã€ãŸã¾ãŸã¾å¶ç„¶æŠ•ç¨¿æ—¥æ™‚ãŒç§’å˜ä½ã§åŒã˜ãªã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹ã¨é–“é•ã£ã¦å–å¾—ã•ã‚Œã¦ã—ã¾ã„ã¾ã™ğŸ˜“ãŒã€ãŠãŠã‚ˆãã®ã‚±ãƒ¼ã‚¹ã§å¤§ä¸ˆå¤«ã ã‚ã†ã¨ã„ã†ã“ã¨ã§ã€ä»Šå›ã¯ã“ã®æ–¹æ³•ã§ã‚„ã£ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

> ã‚‚ã£ã¨ã‚¨ãƒ¬ã‚¬ãƒ³ãƒˆãªè§£æ³•ã‚’æ€ã„ã¤ãæ–¹ã¯ãœã² [Twitter](https://twitter.com/ttskch) ç­‰ã§ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã„ãŸã ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™ï¼

# QueryBuilderã§SQLã‚’çµ„ã¿ç«‹ã¦ã‚‹

å…ˆã»ã©ã®SQLã‚’Doctrineã®QueryBuilderã‚’ä½¿ã£ã¦çµ„ã¿ç«‹ã¦ã¦ã„ãã¾ã™ã€‚

ä¸€æ—¦DQLãƒ¬ãƒ™ãƒ«ã§è€ƒãˆã¦ã¿ã‚‹ã¨ã€æ¬²ã—ã„ã‚¯ã‚¨ãƒªã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‚‚ã®ã«ãªã‚Šã¾ã™ã€‚

```
SELECT c FROM App\Entity\Comment c WHERE c.createdAt = (SELECT max(c2.createdAt) FROM App\Entity\Comment c2 WHERE c2.post = c.post)
```

ã“ã‚ŒãŒãªã‹ãªã‹é›£å„€ã—ãŸã®ã§ã™ãŒã€çµè«–ã¨ã—ã¦ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã§å®Ÿç¾ã§ãã¾ã™ã€‚

```php
class CommentRepository extends ServiceEntityRepository
{
    // ...

    public function findLastCommentsGroupedByPost()
    {
        $expr = $this->getEntityManager()->getExpressionBuilder();

        // sub query to select comments have latest createdAt
        $subQueryDQL = $this->createQueryBuilder('c2')
            ->select('max(c2.createdAt)')
            ->andWhere('c2.post = c.post')
            ->getDQL()
        ;

        return $this->createQueryBuilder('c')
            ->andWhere($expr->eq('c.createdAt', sprintf('(%s)', $subQueryDQL)))
            ->getQuery()
            ->getResult()
        ;
    }
}
```

**ã‚µãƒ–ã‚¯ã‚¨ãƒªã®çµæœã‚’ãƒ¡ã‚¤ãƒ³ã‚¯ã‚¨ãƒªã®WHEREå¥ã«ä½¿ã„ãŸã„å ´åˆã«ã¯ `\Doctrine\ORM\Query\Expr` ã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚‹** ã¨ã„ã†ã¨ã“ã‚ãŒãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚

ã¾ãŸã€ã‚µãƒ–ã‚¯ã‚¨ãƒªã‚’å±•é–‹ã™ã‚‹éš›ã« `sprintf('(%s)', $subQueryDQL)` ã¨ `()` ã§æ‹¬ã£ã¦ã„ã‚‹ã“ã¨ã«ã‚‚æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

DQLã§è¨€ã†

`WHERE c.createdAt = (SELECT max(c2.createdAt) ...)`

ã® `()` ã§ã™ã€‚ã“ã® `()` ãŒãªã„ã¨æ­£ã—ã„SQLãŒä½œã‚Œãšä»¥ä¸‹ã®ã‚ˆã†ãªSyntaxã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚

```
[Syntax Error] line 0, col 55: Error: Expected Literal, got 'SELECT'
```

# å‹•ã‹ã—ã¦ã¿ã‚‹

ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã—ã¦ã€

```sql
INSERT INTO post (id, content, created_at) VALUES
(1, "post1", "2020-01-01"),
(2, "post2", "2020-01-01"),
(3, "post3", "2020-01-01");

INSERT INTO comment (id, content, post_id, created_at) VALUES
(1, "older comment for post1", 1, "2020-01-01")
(2, "newer comment for post1", 1, "2020-01-02")
(3, "older comment for post2", 2, "2020-01-03")
(4, "newer comment for post2", 2, "2020-01-04")
(5, "older comment for post3", 3, "2020-01-05")
(6, "newer comment for post3", 3, "2020-01-06");
```

ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã‚’ç”¨æ„ã—ã¦ã€

```
public function index(CommentRepository $commentRepository)
{
    $comments = $commentRepository->findLastCommentsGroupedByPost();

    return new JsonResponse($comments);
}
```

å®Ÿéš›ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

å„æŠ•ç¨¿ã«ãã‚Œãã‚Œ2ã¤ãšã¤ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã™ãŒã€ã€ŒåŒã˜æŠ•ç¨¿ã«å¯¾ã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã®ä¸­ã§ä½œæˆæ—¥æ™‚ãŒæœ€æ–°ã®ã‚³ãƒ¡ãƒ³ãƒˆã®ã¿ã€ã‚’å–å¾—ã—ã¦ã„ã‚‹ã¯ãšãªã®ã§ã€

**idãŒå¶æ•°ã®ã€contentãŒ `newer comment for ... ` ã¨ãªã£ã¦ã„ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã®ã¿ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã“ã¨**

ãŒæœŸå¾…å€¤ã§ã™ã­ã€‚

ã§ã¯ã€å‹•ã‹ã—ã¦ã¿ã¾ã™ã€‚

```bash
$ curl localhost:8000 | jq .
[
  {
    "id": 2,
    "post_id": 1,
    "content": "newer comment for post1",
    "created_at": {
      "date": "2020-01-02 00:00:00.000000",
      "timezone_type": 3,
      "timezone": "UTC"
    }
  },
  {
    "id": 4,
    "post_id": 2,
    "content": "newer comment for post2",
    "created_at": {
      "date": "2020-01-04 00:00:00.000000",
      "timezone_type": 3,
      "timezone": "UTC"
    }
  },
  {
    "id": 6,
    "post_id": 3,
    "content": "newer comment for post3",
    "created_at": {
      "date": "2020-01-06 00:00:00.000000",
      "timezone_type": 3,
      "timezone": "UTC"
    }
  }
]
```

ãƒãƒƒãƒãƒªæœŸå¾…ã©ãŠã‚Šã§ã™ã­ï¼ğŸ™Œ

# å°‘ã—ã ã‘è¦ä»¶ã‚’è¤‡é›‘ã«ã—ã¦ã¿ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³

æœ€å¾Œã«ãŠã¾ã‘ã§ã€

* ã‚³ãƒ¡ãƒ³ãƒˆã«ã¯ã€Œå…¬é–‹çŠ¶æ…‹ã€ã¨ã„ã†ãƒ•ãƒ©ã‚°ãŒã‚ã‚Šã€ã“ã‚ŒãŒ `true` ãªã‚³ãƒ¡ãƒ³ãƒˆã—ã‹å‡ºåŠ›ã—ãŸããªã„
* æŒ‡å®šã—ãŸæŠ•ç¨¿ã«å¯¾ã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã®ä¸­ã§æœ€æ–°ã®ã‚‚ã®ã‚’å‡ºåŠ›ã™ã‚‹ã€ã¨ã„ã†æ©Ÿèƒ½ã‚‚ã»ã—ã„

ã¨ã„ã†è¦ä»¶ã‚’è¶³ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ã“ã®å ´åˆã€ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã§ã—ã‚‡ã†ã€‚

```php
public function findLastCommentsGroupedByPost(Post $post = null)
{
    $expr = $this->getEntityManager()->getExpressionBuilder();

    // sub query to select comments have latest createdAt
    $subQueryDQL = $this->createQueryBuilder('c2')
        ->select('max(c2.createdAt)')
        ->andWhere('c2.post = c.post')
        ->andWhere('c2.published = 1')
        ->getDQL()
    ;

    $qb = $this->createQueryBuilder('c')
        ->andWhere($expr->eq('c.createdAt', sprintf('(%s)', $subQueryDQL)))
    ;

    if ($post) {
        $qb
            ->andWhere('c.post = :post')
            ->setParameter('post', $post)
        ;
    }

    return $qb->getQuery()->getResult();
}
````

ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã‚’é©å½“ã«ç”¨æ„ã—ã¦å‹•ã‹ã—ã¦ã¿ã¾ã™ã€‚

```bash
$ curl localhost:8000 | jq .
[
  {
    "id": 2,
    "post_id": 1,
    "content": "newer comment for post1",
    "created_at": {
      "date": "2020-01-02 00:00:00.000000",
      "timezone_type": 3,
      "timezone": "UTC"
    },
    "published": true
  },
  {
    "id": 3,
    "post_id": 2,
    "content": "older comment for post2",
    "created_at": {
      "date": "2020-01-03 00:00:00.000000",
      "timezone_type": 3,
      "timezone": "UTC"
    },
    "published": true
  }
]
```

```bash
$ curl localhost:8000/1 | jq .
[
  {
    "id": 2,
    "post_id": 1,
    "content": "newer comment for post1",
    "created_at": {
      "date": "2020-01-02 00:00:00.000000",
      "timezone_type": 3,
      "timezone": "UTC"
    },
    "published": true
  }
]
```

```bash
$ curl localhost:8000/2 | jq .
[
  {
    "id": 3,
    "post_id": 2,
    "content": "older comment for post2",
    "created_at": {
      "date": "2020-01-03 00:00:00.000000",
      "timezone_type": 3,
      "timezone": "UTC"
    },
    "published": true
  }
]
```

```bash
$ curl localhost:8000/3 | jq .
[]
```

è¦ä»¶ã©ãŠã‚Šå‹•ã„ã¦ã„ã¾ã™ã­ğŸ‘

# ã¾ã¨ã‚

* Doctrineã§ã€Œã‚°ãƒ«ãƒ¼ãƒ—ã®ä¸­ã§æœ€å¤§ãªã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã€ã®ãƒªã‚¹ãƒˆã‚’å–å¾—ã—ãŸã„å ´åˆã€ã‚µãƒ–ã‚¯ã‚¨ãƒªã§ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®æœ€å¤§å€¤ã‚’å–å¾—ã—ã¦ã€ `\Doctrine\ORM\Query\Expr` ã‚’ä½¿ã£ã¦ãƒ¡ã‚¤ãƒ³ã‚¯ã‚¨ãƒªã®WHEREå¥ã§ã‚µãƒ–ã‚¯ã‚¨ãƒªã‚’ä½¿ãˆã°ã‚ˆã„

# å‚è€ƒãƒªãƒ³ã‚¯

* <http://labs.timedia.co.jp/2014/10/selecting-max-record-in-group-by.html>
* <https://riptutorial.com/ja/symfony2/example/23132/>
* <https://stackoverflow.com/questions/6637506/doing-a-where-in-subquery-in-doctrine-2>
* <https://stackoverrun.com/ja/q/12099025>
