---
title: "[Symfony/Validation] ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ä»–ã®åˆ¶ç´„ã‚¯ãƒ©ã‚¹ã‚’å‘¼ã³å‡ºã—ã¦ä½¿ã†æ–¹æ³•"
emoji: "ðŸŽ»"
type: "tech"
topics: ["php", "symfony", "validation"]
published: true
published_at: 2020-07-27
---

:::message
ã“ã®è¨˜äº‹ã¯ã€2020-07-27ã«åˆ¥ã®ãƒ–ãƒ­ã‚°åª’ä½“ã«æŠ•ç¨¿ã—ãŸè¨˜äº‹ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ã™ã€‚
:::

# ã‚„ã‚ŠãŸã„ã“ã¨

ã‚ã‚‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã®ä¸­ã‹ã‚‰ã€åˆ¥ã®æ—¢å­˜ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶ç´„ã‚¯ãƒ©ã‚¹ã‚’å‘¼ã³å‡ºã—ã¦ä½¿ã„ãŸã„ã¨ã„ã†è©±ã§ã™ã€‚

å®Ÿéš›ã«ä¾‹ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

# Before

[[Symfony/Validation] Callbackåˆ¶ç´„ã®ä½¿ã„æ–¹ | blog.ttskch](https://blog.ttskch.com/symfony-validation-callback-constraints/)

ã“ã¡ã‚‰ã®éŽåŽ»è¨˜äº‹ ã®ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¾‹ã«ã¨ã‚Šã¾ã™ã€‚

```php
use Symfony\Component\Validator\Constraints as Assert;

class User
{
    /**
     * @Assert\NotBlank()
     */
    private $name;

    /**
     * @Assert\NotBlank()
     * @Assert\Email()
     */
    private $email;
    
    /**
     * @Assert\NotBlank()
     */
    private $password;
    
    /**
     * @Assert\Callback()
     */
    public function validatePassword(ExecutionContextInterface $context)
    {
        if (strpos($this->name, $this->password) !== false || strpos($this->email, $this->password) !== false) {
            $context->buildViolation('åå‰ã‚„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«å«ã¾ã‚Œã‚‹æ–‡å­—åˆ—ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«è¨­å®šã§ãã¾ã›ã‚“')->atPath('password')->addViolation();
        }
    }
}
```

ã“ã‚“ãªæ„Ÿã˜ã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¨­å®šã•ã‚ŒãŸã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒã‚ã‚‹ã¨ã—ã¾ã™ã€‚

ä»Šå›žã¯ä¾‹ã¨ã—ã¦ã€ `validatePassword()` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ `validate()` ãƒ¡ã‚½ãƒƒãƒ‰ã«æ”¹åã—ã€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ã‚¢ãƒŽãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§å®Ÿæ–½ã—ã¦ã„ã‚‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚å«ã‚ã¦ã™ã¹ã¦ã®æ¤œè¨¼ã‚’ `validate()` ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§è¡Œã†ã‚ˆã†ã«ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

> æ™®é€šã‚ã–ã‚ã–ãã‚“ãªå®Ÿè£…ã«ã¯ã—ãªã„ã¨æ€ã„ã¾ã™ðŸ˜…ã“ã“ã§ã¯ã‚ãã¾ã§ä¾‹ã ã¨æ€ã£ã¦ãŠä»˜ãåˆã„ãã ã•ã„ðŸ™

# Afterï¼ˆå¾®å¦™ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰

```php
use Symfony\Component\Validator\Constraints as Assert;

class User
{
    private $name;
    private $email;
    private $password;
    
    /**
     * @Assert\Callback()
     */
    public function validate(ExecutionContextInterface $context)
    {
        if (empty($this->name)) {
            $context->buildViolation('ã“ã®é …ç›®ã¯å¿…é ˆã§ã™')->atPath('name')->addViolation();
        }

        if (empty($this->email)) {
            $context->buildViolation('ã“ã®é …ç›®ã¯å¿…é ˆã§ã™')->atPath('email')->addViolation();
        }

        if (empty($this->password)) {
            $context->buildViolation('ã“ã®é …ç›®ã¯å¿…é ˆã§ã™')->atPath('password')->addViolation();
        }

        if (!preg_match(Assert\EmailValidator::PATTERN_HTML5, $this->email)) {
            $context->buildViolation('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“')->atPath('email')->addViolation();
        }

        if (strpos($this->name, $this->password) !== false || strpos($this->email, $this->password) !== false) {
            $context->buildViolation('åå‰ã‚„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«å«ã¾ã‚Œã‚‹æ–‡å­—åˆ—ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«è¨­å®šã§ãã¾ã›ã‚“')->atPath('password')->addViolation();
        }
    }
}
```

ã™ã¹ã¦ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è‡ªåŠ›ã§ã‚„ã‚‹ã¨ã“ã‚“ãªæ„Ÿã˜ã«ãªã£ã¦ã—ã¾ã†ã§ã—ã‚‡ã†ã€‚

ã—ã‹ã—ã“ã‚Œã ã¨å®Œå…¨ã«æ—¢å­˜ã® `NotBlank` ã‚„ `Email` ã®å†å®Ÿè£…ã§ã™ã—ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã—ãªã„ã¨ã„ã‘ãªã„ã®ã‚‚å¾®å¦™ã§ã™ã€‚

# Afterï¼ˆã„ã„æ„Ÿã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰

ã¨ã„ã†ã‚ã‘ã§ã€ `validate()` ãƒ¡ã‚½ãƒƒãƒ‰ã®ä¸­ã‹ã‚‰ `NotBlank` ã‚„ `Email` ã¨ã„ã£ãŸæ—¢å­˜ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶ç´„ã‚¯ãƒ©ã‚¹ã‚’å‘¼ã³å‡ºã—ã¦ä½¿ã„ãŸããªã‚Šã¾ã™ã€‚

çµè«–ã¨ã—ã¦ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ–¹æ³•ã§å®Ÿç¾ã§ãã¾ã™ðŸ‘

```php
use Symfony\Component\Validator\Constraints as Assert;

class User
{
    private $name;
    private $email;
    private $password;
    
    /**
     * @Assert\Callback()
     */
    public function validate(ExecutionContextInterface $context)
    {
        $notBlankConstraint = new Assert\NotBlank();
        $emailConstraint = new Assert\Email();
        
        $validator = $context->getValidator()->inContext($context);

        $validator
            ->atPath('name')
            ->validate($this->name, $notBlankConstraint)
        ;

        $validator
            ->atPath('email')
            ->validate($this->email, $notBlankConstraint)
            ->validate($this->email, $emailConstraint)
        ;

        $validator
            ->atPath('password')
            ->validate($this->password, $notBlankConstraint)
        ;

        if (strpos($this->name, $this->password) !== false || strpos($this->email, $this->password) !== false) {
            $context->buildViolation('åå‰ã‚„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«å«ã¾ã‚Œã‚‹æ–‡å­—åˆ—ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«è¨­å®šã§ãã¾ã›ã‚“')->atPath('password')->addViolation();
        }
    }
}
```

ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãªã©ã®ä¸­ã‹ã‚‰æ—¢å­˜ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶ç´„ã‚¯ãƒ©ã‚¹ã‚’ä½¿ã„ãŸã„ãªãƒ¼ã¨æ€ã£ãŸã¨ãã«ã€æ€ã„å‡ºã—ã¦ãã ã•ã„ðŸ˜‡

> å‚è€ƒï¼š[How to use Dynamic Constraints with Symfony/Validator | DÄ›lÃ¡Å¡ v PHP? Jsi jednÃ­m z nÃ¡s](https://pehapkari.cz/blog/2017/02/24/symfony-validator-dynamic-constraints)

# å¼•æ•°ã‚ã‚Šã®åˆ¶ç´„ã‚¯ãƒ©ã‚¹ã®å ´åˆ

ã¡ãªã¿ã«ã€åˆ¶ç´„ã‚¯ãƒ©ã‚¹ã®ä¸­ã«ã¯ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãŒå¼•æ•°ã‚’ã¨ã‚‹ã‚‚ã®ã‚‚ã‚ã‚‹ã®ã§ã€ãã®ä¾‹ã‚‚ä¸€å¿œæ›¸ã„ã¦ãŠãã¾ã™âœ‹

ä¾‹ãˆã° `Choice` åˆ¶ç´„ã« `callback` å¼•æ•°ã‚’ã¤ã‘ã¦ä½¿ã†å ´åˆã®Before/Afterã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚ï¼ˆã“ã‚Œã‚‚ã€Afterã®ã»ã†ãŒè‰¯ã„å®Ÿè£…ã ã¨ã‹ãã†ã„ã†è©±ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚ãã¾ã§ä¾‹ã§ã™ðŸ™ï¼‰

> å‚è€ƒï¼š[[Symfony] ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå®šæ•°ã‚’ã¨ã‚‹ã¨ãã«åƒ•ãŒã‚ˆãã‚„ã‚‹å®Ÿè£… | blog.ttskch](https://blog.ttskch.com/symfony-entity-property-only-for-constants/)

## Before

```php
use Symfony\Component\Validator\Constraints as Assert;

class User
{
    const DIVISION_SALES = 'å–¶æ¥­éƒ¨';
    const DIVISION_DEVELOPMENT = 'é–‹ç™ºéƒ¨':
    const DIVISION_GENERAL = 'ç·å‹™éƒ¨';
    
    public static function getValidDivisions(): array
    {
        return [
            self::DIVISION_SALES,
            self::DIVISION_DEVELOPMENT,
            self::DIVISION_GENERAL,
        ];
    }

    /**
     * Assert\Choice(callback="getValidDivisions")
     */
    private $division;
}
```

## After

```php
use Symfony\Component\Validator\Constraints as Assert;

class User
{
    const DIVISION_SALES = 'å–¶æ¥­éƒ¨';
    const DIVISION_DEVELOPMENT = 'é–‹ç™ºéƒ¨':
    const DIVISION_GENERAL = 'ç·å‹™éƒ¨';
    
    public static function getValidDivisions(): array
    {
        return [
            self::DIVISION_SALES,
            self::DIVISION_DEVELOPMENT,
            self::DIVISION_GENERAL,
        ];
    }

    private $division;

    /**
     * @Assert\Callback()
     */
    public function validate(ExecutionContextInterface $context)
    {
        $choiceConstraint = new Assert\Choice([
            'callback' => [$this, 'getValidDivisions'],
        ]);
        
        $context
            ->getValidator()
            ->inContext($context)
            ->atPath('division')
            ->validate($this->division, $choiceConstraint)
        ;
    }
}
```

å¿œç”¨ã™ã‚‹ã¨ã€Œä»–ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å€¤ã«å¿œã˜ã¦é¸æŠžè‚¢ã‚’å¤‰ãˆã‚‹ã€ã¨ã„ã£ãŸå®Ÿè£…ã‚‚ç°¡å˜ã«ã§ããã†ã§ã™ã­ðŸ‘

```php
switch ($this->type) {
    case self::TYPE_A:
        $callback = [$this, 'getValidChoicesForTypeA'];
        break;
    case self::TYPE_B:
        $callback = [$this, 'getValidChoicesForTypeB'];
        break;
    case self::TYPE_C:
    default:
        $callback = [$this, 'getValidChoicesForTypeC'];
        break;
}

$choiceConstraint = new Assert\Choice([
    'callback' => $callback,
]);
```
