---
title: "[Symfony][Doctrine] ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ç‰¹å®šã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’èª¿ã¹ã‚‹"
emoji: "ğŸ»"
type: "tech"
topics: ["php", "symfony", "doctrine"]
published: true
published_at: 2021-12-16
---

:::message
ã“ã®è¨˜äº‹ã¯ã€2021-12-16ã«åˆ¥ã®ãƒ–ãƒ­ã‚°åª’ä½“ã«æŠ•ç¨¿ã—ãŸè¨˜äº‹ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ã™ã€‚
:::

[Symfony Advent Calendar 2021](https://qiita.com/advent-calendar/2021/symfony) ã®16æ—¥ç›®ã®è¨˜äº‹ã§ã™ï¼ğŸ„ğŸŒ™å°ãƒã‚¿ã§ã™ã¿ã¾ã›ã‚“ï¼

> ã¡ãªã¿ã«ã€åƒ•ã¯ã‚ˆã [Twitterã«ã‚‚Symfonyãƒã‚¿ã‚’å‘Ÿã„ã¦ã„ã‚‹](https://twitter.com/search?q=from%3Attskch%20(symfony%20OR%20doctrine)&src=typed_query&f=live) ã®ã§ã€ã‚ˆã‚ã—ã‘ã‚Œã°ãœã² [ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã‚„ã£ã¦ãã ã•ã„ğŸ•ŠğŸ¤²](https://twitter.com/ttskch)

æ˜¨æ—¥ã¯ [@77web](https://twitter.com/77web) ã•ã‚“ã® [SymfonyUX Turboã‚’ä½¿ã£ã¦ã¿ã‚‹](https://tech.quartetcom.co.jp/2021/12/15/symfony-ux-turbo/) ã§ã—ãŸâœ¨

# ã¯ã˜ã‚ã«

ã“ã®è¨˜äº‹ã¯ã»ã¼ä»¥ä¸‹ã®éå»è¨˜äº‹ã®ç„¼ãå¢—ã—ã§ã™ğŸ˜‚

> [[Symfony] Doctrineã®preUpdateã§ä»–ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ç”Ÿæˆã‚’ã‚„ã‚ã†ã¨ã—ãŸã‘ã©ã§ããªã‹ã£ãŸè©±ï¼ˆè§£æ±ºç­–ã‚ã‚Šï¼‰ | blog.ttskch](https://blog.ttskch.com/symfony-doctrine-preupdate/)

é€šå¸¸ã€ã€Œã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ç‰¹å®šã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå¤‰æ›´ã•ã‚Œã¦ã„ãŸã‚‰ã“ã†ã„ã†å‡¦ç†ã‚’ã™ã‚‹ã€ã¨ã„ã£ãŸã‚‚ã®ã¯ [EntityListener](https://symfony.com/bundles/DoctrineBundle/current/entity-listeners.html) ã® [`preUpdate`](https://www.doctrine-project.org/projects/doctrine-orm/en/2.10/reference/events.html#preupdate) ã«æ›¸ãã“ã¨ãŒå¤šã„ã¨æ€ã„ã¾ã™ã€‚

ã—ã‹ã—ã€ä¸Šè¨˜ã®éå»è¨˜äº‹ã§ã‚‚è§£èª¬ã—ã¦ã„ã‚‹ã¨ãŠã‚Šã€`preUpdate` ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã¯ **åˆ¥ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚**

ãªã®ã§ã€ã€Œã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£Aã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£XãŒå¤‰æ›´ã•ã‚Œã¦ã„ãŸã‚‰ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£Bã‚’ç”Ÿæˆã™ã‚‹ã€ã¨ã„ã£ãŸå‡¦ç†ï¼ˆä¾‹ãˆã°ã€å¤‰æ›´ã®å±¥æ­´ã‚’ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨ã—ã¦æ®‹ã™ç­‰ï¼‰ã‚’å®Ÿç¾ã—ãŸã„å ´åˆã€

* è‡ªåˆ†ã§ `Event` ã¨ `EventSubscriber`ï¼ˆã¾ãŸã¯ `EventListener`ï¼‰ã‚’å®Ÿè£…ã™ã‚‹
* ãã® `EventSubscriber`ï¼ˆã¾ãŸã¯ `EventListener`ï¼‰ã§ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£Bã‚’ç”Ÿæˆã™ã‚‹ã‚ˆã†ã«ã™ã‚‹
* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã§ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£Aã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£Xã®å¤‰æ›´ã‚’æ¤œçŸ¥ã—ã€å¤‰æ›´ã•ã‚Œã¦ã„ãŸã‚‰ãã® `Event` ã‚’ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã™ã‚‹ã‚ˆã†ã«ã™ã‚‹

ã¨ã„ã†å®Ÿè£…ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

# ç‰¹å®šã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’èª¿ã¹ã‚‹æ–¹æ³•

ä¸Šè¨˜ã®

> ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã§ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£Aã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£Xã®å¤‰æ›´ã‚’æ¤œçŸ¥ã—ã€

ã®éƒ¨åˆ†ã®å®Ÿè£…æ–¹æ³•ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚

çµè«–ã¨ã—ã¦ã¯ã€ä¾‹ãˆã° `$entity->property` ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’èª¿ã¹ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã‘ã°ã‚ˆã„ã§ã™ã€‚

```php
$em->getUnitOfWork()->computeChangeSets();

$changeSets = $em->getUnitOfWork()->getEntityChangeSet($entity);

if (isset($changeSets['property']) && $changeSets['property'][0] !== $changeSets['property'][1]) {
    // $entity->property ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹
}
```

ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ã€Doctrineã® [`UnitOfWork`](https://github.com/doctrine/orm/blob/02a4e4099db319c8f1f2660e246cc2401dacc935/lib/Doctrine/ORM/UnitOfWork.php) ã‹ã‚‰ `getEntityChangeSet()` ã§å¤‰æ›´å†…å®¹ã‚’å–å¾—ã—ã€å¤‰æ›´å†…å®¹ã®ä¸€è¦§ã®ä¸­ã« `'property'` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚Šã€å†…å®¹ã‚‚ç¢ºã‹ã«å¤‰åŒ–ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’èª¿ã¹ã¦ã„ã¾ã™ã€‚

`getEntityChangeSet()` ã™ã‚‹å‰ã«ã€1è¡Œç›®ã§ `$em->getUnitOfWork()->computeChangeSets()` ã—ã¦ã„ã‚‹ã¨ã“ã‚ãŒãƒã‚¤ãƒ³ãƒˆã§ã€ã“ã‚Œã‚’ã‚„ã‚‰ãªã„ã¨ã“ã®æ™‚ç‚¹ã§ã¯ã¾ã ãƒã‚§ãƒ³ã‚¸ã‚»ãƒƒãƒˆãŒç©ºã«ãªã£ã¦ã„ã¾ã™ã€‚

> å‚è€ƒï¼š[php - Is there a built-in way to get all of the changed/updated fields in a Doctrine 2 entity - Stack Overflow](https://stackoverflow.com/questions/9057558/is-there-a-built-in-way-to-get-all-of-the-changed-updated-fields-in-a-doctrine-2)

ã¡ãªã¿ã« `UnitOfWork` ã¨ã‹ãŒãƒ”ãƒ³ã¨æ¥ãªã„æ–¹ã¯ [å¾Œè—¤ã•ã‚“ã®ã“ã®ãƒã‚¹ãƒˆ](https://ja.stackoverflow.com/questions/3104/) ãŒã‚ã¡ã‚ƒã‚ã¡ã‚ƒåˆ†ã‹ã‚Šã‚„ã™ã„ã®ã§ãœã²èª­ã‚“ã§ã¿ã¦ãã ã•ã„ã€‚

# ä½¿ã„å›ã—ã‚„ã™ã„ã‚ˆã†ã«ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹ã«ã—ã¦ãŠã

è¤‡é›‘ãªã‚¢ãƒ—ãƒªã ã¨ã“ã®å¤‰æ›´æ¤œçŸ¥ã®å‡¦ç†ãŒè‰²ã€…ãªã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã«ç™»å ´ã™ã‚‹ã“ã¨ã‚‚ã‚ˆãã‚ã‚‹ã®ã§ã€ä½¿ã„å›ã—ã‚„ã™ã„ã‚ˆã†ã«ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹ã«ã—ã¦ãŠãã¨ã‚ˆã„ã§ã™ã€‚

åƒ•ã¯ã„ã¤ã‚‚ä¸‹è¨˜ã®ã‚ˆã†ãªã‚¯ãƒ©ã‚¹ã‚’ä½œã‚Šã¾ã™ã€‚

```php
// src/Doctrine/ChangeDetector.php

namespace App\Doctrine;

use Doctrine\ORM\EntityManagerInterface;

class ChangeDetector
{
    private EntityManagerInterface $em;

    public function __construct(EntityManagerInterface $em)
    {
        $this->em = $em;
    }

    public function isChanged($entity, string $property): bool
    {
        $this->em->getUnitOfWork()->computeChangeSets();

        $changeSets = $this->em->getUnitOfWork()->getEntityChangeSet($entity);

        return isset($changeSets[$property]) && $changeSets[$property][0] !== $changeSets[$property][1];
    }
}
```


https://twitter.com/ttskch/status/1440577292808323072

ã“ã‚Œã‚’ä½œã£ã¦ãŠãã¨ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã®ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«éå¸¸ã«ã‚¹ãƒƒã‚­ãƒªã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```php
public function edit(Foo $foo, ChangeDetector $detector, EventDispatcherInterface $dispatcher)
{
    $form = $this->createForm(FooType::class, $foo);
    $form->handleRequest($request);

    if ($form->isSubmitted() && $form->isValid()) {
        // $foo->bar ãŒå¤‰æ›´ã•ã‚Œã¦ã„ãŸã‚‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œ
        if ($detector->isChanged($foo, 'bar')) {
            $dispatcher->dispatch(new \App\Event\Foo\BarChangedEvent($foo));
        }

        // ...
    }

    // ...
}
```

# ã¾ã¨ã‚

ã¨ã„ã†ã‚ã‘ã§ã€Symfonyã§ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ç‰¹å®šã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’èª¿ã¹ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ç°¡å˜ã«è§£èª¬ã—ã¾ã—ãŸã€‚ã©ã“ã‹ã®èª°ã‹ã®ãŠå½¹ã«ç«‹ã¦ã°å¹¸ã„ã§ã™ï¼

[Symfony Advent Calendar 2021](https://qiita.com/advent-calendar/2021/symfony)ã€æ˜æ—¥ã¯ [@kin29ma_n](https://twitter.com/kin29ma_n) ã•ã‚“ã§ã™ï¼ãŠæ¥½ã—ã¿ã«ï¼
