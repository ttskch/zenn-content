---
title: "[Symfony][Doctrine] EntityTypeã§ã‚ˆãèµ·ã“ã‚‹N+1å•é¡Œã®åŸå› ã¨å¯¾å‡¦æ–¹æ³•"
emoji: "ğŸ»"
type: "tech"
topics: ["php", "symfony", "doctrine"]
published: true
published_at: 2020-06-17
---

:::message
ã“ã®è¨˜äº‹ã¯ã€2020-06-17ã«åˆ¥ã®ãƒ–ãƒ­ã‚°åª’ä½“ã«æŠ•ç¨¿ã—ãŸè¨˜äº‹ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ã™ã€‚
:::

# ã¾ãšã¯å…·ä½“ä¾‹

ã“ã‚“ãªæ„Ÿã˜ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒã‚ã‚‹ã¨ã—ã¾ã—ã‚‡ã†ã€‚

* `User` ãŒ `OneToOne` ã§ `Profile` ã‚’æŒã£ã¦ã„ã‚‹ï¼ˆ[Owning Side](https://www.doctrine-project.org/projects/doctrine-orm/en/2.7/reference/unitofwork-associations.html)ï¼‰
* `Profile` ã¯ `User` ã¸ã®å‚ç…§ã‚’æŒã£ã¦ã„ãªã„ï¼ˆ[Inverse Side](https://www.doctrine-project.org/projects/doctrine-orm/en/2.7/reference/unitofwork-associations.html) ãªã—ï¼‰
* `User` ã® `__toString()` ã§ `Profile` ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å‚ç…§ã—ã¦ã„ã‚‹

> ä¸€ä¾‹ã§ã™ã€‚ä¾‹ãˆã° `Profile` ã‹ã‚‰ `User` ã¸ã®å‚ç…§ï¼ˆInverse Sideï¼‰ã‚ã‚Šã§ã‚‚çµæœã¯ã¾ã£ãŸãåŒã˜ã«ãªã‚Šã¾ã™ã€‚

```php
/**
 * @ORM\Entity(repositoryClass="App\Repository\UserRepository")
 */
class User
{
    /**
     * @ORM\Id()
     * @ORM\GeneratedValue()
     * @ORM\Column(type="integer")
     */
    private $id;

    /**
     * @ORM\OneToOne(targetEntity="App\Entity\Profile")
     * @ORM\JoinColumn(nullable=false)
     */
    private $profile;

    // ...
    
    public function __toString(): string
    {
        return $this->profile->name;
    }
}
```

```php
/**
 * @ORM\Entity(repositoryClass="App\Repository\ProfileRepository")
 */
class Profile
{
    /**
     * @ORM\Id()
     * @ORM\GeneratedValue()
     * @ORM\Column(type="integer")
     */
    private $id;

    /**
     * @ORM\Column(type="string", length=255)
     */
    private $name;

    // ...
}
```

ãã—ã¦ã€ `User` ã®EntityTypeã‚’æŒã¤FormTypeãŒã‚ã‚‹ã¨ã—ã¾ã—ã‚‡ã†ã€‚

```php
class FooType extends AbstractType
{
    public function buildForm(FormBuilderInterface $builder, array $options)
    {
        $builder
            ->add('user', EntityType::class, [
                'class' => User::class,
            ])
        ;
    }
}
```

ã“ã®ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ã¨ã€ **`User` ã®ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ã ã‘ã‚¯ã‚¨ãƒªãŒèµ°ã£ã¦ã—ã¾ã„ã¾ã™ã€‚**

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gfv1yf6vcoj308c01yq2x.jpg)

ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€

```
SELECT
  t0.id AS id_1,
  :
  :
FROM
  profile t0
WHERE
  t0.id = ?
```

ã“ã‚“ãªã‚¯ã‚¨ãƒªãŒ `User` ã®ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ã ã‘ç™ºè¡Œã•ã‚Œã¦ã„ã¾ã™ã€‚ã©ã†ã‚„ã‚‰ `User` ã¨ `Profile` ãŒ JOINã•ã‚Œã¦ãŠã‚‰ãšã€åˆ¥ã€…ã«å–å¾—ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚ã„ã‚ã‚†ã‚‹ **N+1å•é¡Œ** ã¨ã„ã†ã‚„ã¤ã§ã™ã­ã€‚

è©¦ã—ã« `User` ã® `__toString()` ã§ `Profile` ã‚’å‚ç…§ã—ãªã„ã‚ˆã†ã«ä¿®æ­£ã—ã¦ã¿ã‚‹ã¨ã€

```diff
    public function __toString(): string
    {
-       return $this->profile->name;
+       return $this->id;
    }
```

ã“ã®å•é¡Œã¯ç™ºç”Ÿã—ãªããªã‚Šã¾ã™ã€‚

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gfv2s4h984j306e01y747.jpg)

> ã¡ãªã¿ã«ã€ã“ã®å•é¡ŒãŒç™ºç”Ÿã™ã‚‹çŠ¶æ³ã«ãŠã„ã¦ã‚‚ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã‹ã‚‰ `UserRepository::findAll()` ã—ãŸå ´åˆã¯æ™®é€šã«JOINã—ã¦1ã‚¯ã‚¨ãƒªã§å–å¾—ã•ã‚Œã¾ã™ã€‚

# è§£æ±ºæ–¹æ³•

ã‚°ã‚°ã‚‹ã¨ä»¥ä¸‹ã®æƒ…å ±ãªã©ãŒè¦‹ã¤ã‹ã‚‹ã¨æ€ã„ã¾ã™ã€‚

> php - Symfony queryBuilder: too many queries - Stack Overflow  
> <https://stackoverflow.com/questions/45739810/symfony-querybuilder-too-many-queries#answer-45740886>

> Frequently Asked Questions - Doctrine Object Relational Mapper (ORM)  
> <https://www.doctrine-project.org/projects/doctrine-orm/en/latest/reference/faq.html#why-is-an-extra-sql-query-executed-every-time-i-fetch-an-entity-with-a-one-to-one-relation>

ä¸‹ã®Doctrineã®FAQã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚

> **Why is an extra SQL query executed every time I fetch an entity with a one-to-one relation?**
>
> If Doctrine detects that you are fetching an inverse side one-to-one association it has to execute an additional query to load this object, because it cannot know if there is no such object (setting null) or if it should set a proxy and which id this proxy has.
>
> To solve this problem currently a query has to be executed to find out this information.

è¦ç´„ã™ã‚‹ã¨

* `OneToOne` ã® `Inverse Side` ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’æ¤œçŸ¥ã—ãŸã‚‰ã€Doctrineã¯è‡ªå‹•ã§ãã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’åˆ¥ã‚¯ã‚¨ãƒªã§å–å¾—ã—ã‚ˆã†ã¨ã™ã‚‹
* ãªãœãªã‚‰ã€ãã“ã«ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒå­˜åœ¨ã—ãªã„ï¼ˆå‚ç…§ãŒ `null` ï¼‰ã‹ã‚‚ã—ã‚Œãªã„ã—ã€proxyã‚’ã‚»ãƒƒãƒˆã—ãªã„ã¨ã„ã‘ãªã„ã‹ã‚‚ã—ã‚Œãªã„ã—ã€ãã®proxyã®idã‚‚åˆ†ã‹ã‚‰ãªã„ã®ã§
* ç¾çŠ¶ã€ã“ã®å•é¡Œã¯å®Ÿéš›ã«ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¦ã¿ãªã„ã¨åˆ†ã‹ã‚‰ãªã„

ã¨ã„ã£ãŸæ„Ÿã˜ã§èª­ã‚ã¾ã™ã€‚

ã¨ã«ã‹ãã€ã€Œ `OneToOne` ã® `Inverse Side` ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã‚ˆã†ã¨ã™ã‚‹ã¨è¿½åŠ ã®ã‚¯ã‚¨ãƒªãŒç™ºè¡Œã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€ã¨ã„ã†ã®ãŒDoctrineã®æ—¢çŸ¥ã®å•é¡Œã ã¨ã„ã†ã“ã¨ã¯åˆ†ã‹ã‚Šã¾ã—ãŸã€‚

ãªã®ã§è§£æ±ºç­–ã¨ã—ã¦ã¯ã€Doctrineã®è‡ªå‹•çš„ãªå‡¦ç†ã«ã™ã¹ã¦ã‚’å§”ã­ãšã«ã€è‡ªåˆ†ã§ã‚¯ã‚¨ãƒªã‚’æŒ‡å®šã—ã¦ã‚ã’ã‚Œã°ã„ã„ã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

å…·ä½“çš„ã«ã¯ã€ä»Šå›ã®ã‚±ãƒ¼ã‚¹ãªã‚‰EntityTypeã® [query_builder](https://symfony.com/doc/current/reference/forms/types/entity.html#query-builder) ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦æ˜ç¤ºçš„ã«JOINã•ã›ã‚Œã°ã‚ˆã„ã§ã—ã‚‡ã†ã€‚

```php
class FooType extends AbstractType
{
    public function buildForm(FormBuilderInterface $builder, array $options)
    {
        $builder
            ->add('user', EntityType::class, [
                'class' => User::class,
                'query_builder' => function(UserRepository $repository) {
                    return $repository->createQueryBuilder('u')
                        ->select('u, p')
                        ->leftJoin('u.profile', 'p')
                    ;
                },
            ])
        ;
    }
}
```

ã“ã‚Œã§ã€ç„¡äº‹ç„¡é§„ãªã‚¯ã‚¨ãƒªã‚’ãªãã™ã“ã¨ãŒã§ãã¾ã—ãŸğŸ‘Œ

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gfv2u59rnyj306s01yglj.jpg)

# ã¾ã¨ã‚

* Symfonyã§ã€ `OneToOne` ã‚’æŒã£ãŸã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«å¯¾ã—ã¦EntityTypeã‚’ä½¿ã†ã¨ã€JOINã•ã‚Œãšå¤§é‡ã®ã‚¯ã‚¨ãƒªãŒç™ºè¡Œã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ï¼ˆN+1å•é¡Œï¼‰
* ã“ã‚Œã¯Doctrineã«ãŠã„ã¦ [æ—¢çŸ¥ã®å•é¡Œ](https://www.doctrine-project.org/projects/doctrine-orm/en/latest/reference/faq.html#why-is-an-extra-sql-query-executed-every-time-i-fetch-an-entity-with-a-one-to-one-relation) ã§ã‚ã‚‹
* ã“ã‚Œã‚’è§£æ±ºã™ã‚‹ã«ã¯ã€EntityTypeã® [query_builder](https://symfony.com/doc/current/reference/forms/types/entity.html#query-builder) ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦æ˜ç¤ºçš„ã«JOINã•ã›ã‚Œã°OK
