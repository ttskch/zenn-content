---
title: "[PHP] Monologã®ãƒ­ã‚°ã‚’Mailgunã§ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã™ã‚‹"
emoji: "ğŸ»"
type: "tech"
topics: ["php", "symfony", "mailgun"]
published: true
published_at: 2020-04-16
---

:::message
ã“ã®è¨˜äº‹ã¯ã€2020-04-16ã«åˆ¥ã®ãƒ–ãƒ­ã‚°åª’ä½“ã«æŠ•ç¨¿ã—ãŸè¨˜äº‹ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ã™ã€‚
:::

PHPã®ãƒ­ã‚¬ãƒ¼ã®ãƒ‡ãƒ•ã‚¡ã‚¯ãƒˆã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ã§ã‚ã‚‹ [Monolog](https://github.com/Seldaek/monolog) ã¯ã€ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã¨ã„ã†éƒ¨å“ã‚’äº¤æ›ã™ã‚‹ã“ã¨ã§æ§˜ã€…ãªæ–¹æ³•ã§ãƒ­ã‚°ã‚’é€ä¿¡ã§ãã¾ã™ã€‚

> Monologã®ä»•çµ„ã¿ã«ã¤ã„ã¦ã¯ [ã“ã¡ã‚‰ã®è¨˜äº‹](https://tech.quartetcom.co.jp/2018/05/31/monolog/) ãŒå‚è€ƒã«ãªã‚Šã¾ã™ã€‚

æ‹™ä½œã®Monologãƒãƒ³ãƒ‰ãƒ©ãƒ¼ [ttskch/monolog-mailgun](https://github.com/ttskch/monolog-mailgun) ã‚’ä½¿ãˆã°ã€[Mailgun](https://www.mailgun.com/) ã‚’ä½¿ã£ã¦ç°¡å˜ã«ãƒ­ã‚°ã‚’ãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡ã§ãã‚‹ã®ã§ã€ã”ç´¹ä»‹ã—ã¾ã™ã€‚

# ttskch/monolog-mailgun

ä½¿ã„æ–¹ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚

```bash
$ composer require ttskch/monolog-mailgun
```

ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã€

```php
$mg = \Mailgun\Mailgun::create('api_key');
$domain = 'mg.example.com';
$from = 'Alice <alice@example.com>';
$to = ['bob@foo.bar.com'];
$subject = '[Monolog] Error Report';
$handler = new \Ttskch\Monolog\Handler\MailgunHandler($mg, $domain, $from, $to, $subject);
$logger = new \Monolog\Logger('mailgun');
$logger->pushHandler($handler);
```

```
$logger->critical('Critical Error!');
```

ã¨ã„ã†æ„Ÿã˜ã§ä½¿ã„ã¾ã™ã€‚ç°¡å˜ã§ã—ã‚‡ï¼Ÿ

# Symfonyã‹ã‚‰ä½¿ã†

[symfony/monolog-bundle](https://github.com/symfony/monolog-bundle) ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹Symfony4/Symfony5ã«ã‚‚ç°¡å˜ã«å°å…¥ã§ãã¾ã™ã€‚

å˜ä½“ã§ä½¿ã†å ´åˆã¨åŒã˜ã

```bash
$ composer require ttskch/monolog-mailgun
```

ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨ã€ä¾å­˜ã—ã¦ã„ã‚‹ [mailgun/mailgun-php](https://github.com/mailgun/mailgun-php) ã® [ãƒ¬ã‚·ãƒ”](https://github.com/symfony/recipes-contrib/tree/4838b95a1d7469f3337aab224ad0e0eb39f364fb/mailgun/mailgun-php) ã«ã‚ˆã‚Šã€ä»¥ä¸‹ã® `config/packages/mailgun.yaml` ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚

```yaml
# config/packages/mailgun.yaml
services:
    Mailgun\Mailgun:
        class: Mailgun\Mailgun
        factory: ['Mailgun\Mailgun', create]
        arguments: ['%env(MAILGUN_API_KEY)%']
```

ã“ã‚Œã«åŠ ãˆã¦ã€ `config/packages/prod/monolog.yaml` ã‚’ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã§è¨­å®šã™ã‚Œã°OKã§ã™ã€‚

```yaml
# config/packages/prod/monolog.yaml
monolog:
    handlers:

        # ...

        email:
            type: fingers_crossed
            action_level: critical
            level: debug
            channels: ["!event"]
            handler: deduplicated
        deduplicated:
            type: deduplication # prevent multiply sending
            handler: mailgun
        mailgun:
            type: service
            id: Ttskch\Monolog\Handler\MailgunHandler

services:
    Ttskch\Monolog\Handler\MailgunHandler:
        arguments:
            - '@Mailgun\Mailgun'
            - mg.example.com # mailgun domain
            - Alice <alice@example.com> # from
            - [bob@foo.bar.com] # to
            - '[Monolog] Error Report' # subject
```

## è¨­å®šå†…å®¹ã®æ„å‘³

```
email:
    type: fingers_crossed
    action_level: critical
    level: debug
    channels: ["!event"]
    handler: deduplicated
```

* `fingers_crossed` ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ä½¿ã£ã¦ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ãƒ©ãƒƒãƒ—ã™ã‚‹
* `critical` ä»¥ä¸Šã®ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚ŒãŸã¨ãã«å‹•ä½œ
* ãã®ã¨ãã€å®Ÿéš›ã«å‡ºåŠ›ã™ã‚‹ã®ã¯ `debug` ä»¥ä¸Šã®ãƒ­ã‚°
* ãŸã ã— `event` ãƒãƒ£ãƒ³ãƒãƒ«ã®ãƒ­ã‚°ã¯å‡ºåŠ›ã—ãªã„
* ãƒ©ãƒƒãƒ—ã™ã‚‹å¯¾è±¡ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã¯ `deduplicated` ãƒãƒ³ãƒ‰ãƒ©ãƒ¼

```
deduplicated:
    type: deduplication # prevent multiply sending
    handler: mailgun
mailgun:
    type: service
    id: Ttskch\Monolog\Handler\MailgunHandler
```

* `deduplication` ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã§ãƒ©ãƒƒãƒ—ã™ã‚‹ã“ã¨ã§ã€ã—ã°ã‚‰ãã®é–“ï¼ˆ[ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯60ç§’é–“](https://github.com/Seldaek/monolog/blob/bec314a9c14ce8a40650cf13923f5941ef1bfe0a/src/Monolog/Handler/DeduplicationHandler.php#L58-L65)ï¼‰åŒã˜å†…å®¹ã®ãƒ­ã‚°ã‚’å‡ºåŠ›ã—ãªã„ã‚ˆã†ã«ï¼ˆãƒ¡ãƒ¼ãƒ«ãŒå¤§é‡ã«æ¥ã‚‹ã¨å›°ã‚‹ã®ã§ï¼‰
* ãƒ©ãƒƒãƒ—ã™ã‚‹å¯¾è±¡ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã¯ `mailgun` ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
* `mailgun` ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ `service` ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã¨ã—ã¦å®šç¾©
* å¯¾è±¡ã®ã‚µãƒ¼ãƒ“ã‚¹IDã¯ `Ttskch\Monolog\Handler\MailgunHandler`

```
services:
    Ttskch\Monolog\Handler\MailgunHandler:
        arguments:
            - '@Mailgun\Mailgun'
            - mg.example.com # mailgun domain
            - Alice <alice@example.com> # from
            - [bob@foo.bar.com] # to
            - '[Monolog] Error Report' # subject
```

* `Ttskch\Monolog\Handler\MailgunHandler` ã‚µãƒ¼ãƒ“ã‚¹ã‚’å®šç¾©
* æ³¨å…¥ã™ã‚‹å¼•æ•°ã¯
    * `Mailgun\Mailgun` ã‚µãƒ¼ãƒ“ã‚¹
    * ä½¿ç”¨ã™ã‚‹Mailgunã®ãƒ‰ãƒ¡ã‚¤ãƒ³å
    * ãƒ¡ãƒ¼ãƒ«ã®From
    * ãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡å…ˆï¼ˆé…åˆ—ï¼‰
    * ãƒ¡ãƒ¼ãƒ«ã®ã‚¿ã‚¤ãƒˆãƒ«

## SwiftMailerã‚’Mailgunã§è¨­å®šæ¸ˆã¿ã®å ´åˆã¯ã“ã£ã¡

ã™ã§ã«SwiftMailerãŒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã•ã‚Œã¦ã„ã‚‹Symfonyãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãªã‚‰ã€ttskch/monolog-mailgunã‚’å…¥ã‚Œã‚‹ã¾ã§ã‚‚ãªãä»¥ä¸‹ã®ã‚ˆã†ãªè¨­å®šã‚’è¿½åŠ ã™ã‚‹ã ã‘ã§ãƒ­ã‚°ã‚’ãƒ¡ãƒ¼ãƒ«ã§å—ã‘å–ã‚Œã¾ã™âœ‹

```yaml
# config/packages/prod/monolog.yaml
monolog:
    handlers:

        # ...
        
        email:
            type: fingers_crossed
            action_level: critical
            level: debug
            channels: ["!event"]
            handler: deduplicated
        deduplicated:
            type: deduplication # prevent multiply sending
            handler: swift
        swift:
            type: swift_mailer
            from_email: alice@example.com
            to_email: bob@foo.bar.com
            subject: '[Monolog] Error Report: %%message%%'
            formatter: monolog.formatter.html
            content_type: text/html
```

> å‚è€ƒï¼š<https://symfony.com/doc/current/logging/monolog_email.html>

# ã¾ã¨ã‚

* Monologãƒãƒ³ãƒ‰ãƒ©ãƒ¼ [ttskch/monolog-mailgun](https://github.com/ttskch/monolog-mailgun) ã‚’ä½¿ãˆã°ã€ç°¡å˜ã«Monologã®ãƒ­ã‚°ã‚’Mailgunã§é€ä¿¡ã§ãã‚‹
* Symfony4/Symfony5ã«ã‚‚ç°¡å˜ã«å°å…¥ã§ãã‚‹
* Symfonyã®å ´åˆã€SwiftMailerãŒè¨­å®šæ¸ˆã¿ãªã‚‰ [MonologBundleã®è¨­å®šã‚’æ›¸ãè¶³ã™ã ã‘ã§OK](https://symfony.com/doc/current/logging/monolog_email.html)
* ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã«ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ©Ÿèƒ½ã¯ãªã„ã‘ã©ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã ã‘ã¯Mailgunã‚’ä½¿ã£ã¦ãƒ¡ãƒ¼ãƒ«ã§é€ã‚ŠãŸã„ã€ã¿ãŸã„ãªã¨ãã«ttskch/monolog-mailgunã§ã‚µã‚¯ãƒƒã¨å°å…¥ã—ã¦ã¿ã¦ãã ã•ã„
