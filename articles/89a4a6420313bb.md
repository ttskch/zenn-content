---
title: "Symfony + API Platformã§GraphQL APIã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•"
emoji: "ğŸ»"
type: "tech"
topics: ["php", "symfony", "apiplatform", "graphql"]
published: true
published_at: 2021-12-24
---

:::message
ã“ã®è¨˜äº‹ã¯ã€2021-12-24ã«åˆ¥ã®ãƒ–ãƒ­ã‚°åª’ä½“ã«æŠ•ç¨¿ã—ãŸè¨˜äº‹ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ã™ã€‚
:::

ãƒ¡ãƒªãƒ¼ã‚¯ãƒªã‚¹ãƒã‚¹ã‚¤ãƒ–ï¼

[Symfony Advent Calendar 2021](https://qiita.com/advent-calendar/2021/symfony) ã®24æ—¥ç›®ã®è¨˜äº‹ã§ã™ï¼ğŸ„ğŸŒ™

> ã¡ãªã¿ã«ã€åƒ•ã¯ã‚ˆã [Twitterã«ã‚‚Symfonyãƒã‚¿ã‚’å‘Ÿã„ã¦ã„ã‚‹](https://twitter.com/search?q=from%3Attskch%20(symfony%20OR%20doctrine)&src=typed_query&f=live) ã®ã§ã€ã‚ˆã‚ã—ã‘ã‚Œã°ãœã² [ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã‚„ã£ã¦ãã ã•ã„ğŸ•ŠğŸ¤²](https://twitter.com/ttskch)

æ˜¨æ—¥ã¯ [@ippey_s](https://twitter.com/ippey_s) ã•ã‚“ã® [Symfonyç‰ˆLivewireã“ã¨ã€Live Componentã•ã‚“](https://qiita.com/ippey_s/items/0766880c185a2bca7b1f) ã§ã—ãŸâœ¨

# API Platformã¨ã¯

[API Platform](https://api-platform.com/) ã¯Symfony + Doctrineãƒ™ãƒ¼ã‚¹ã®ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹APIãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã€ç°¡å˜ãªè¨­å®šã‚’æ›¸ãã ã‘ã§Symfonyã‚¢ãƒ—ãƒªã«REST APIã‚„GraphQL APIã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ä¾¿åˆ©ãªã‚„ã¤ã§ã™ã€‚

ä»Šå›ã¯Symfony + API Platformã§GraphQL APIã‚’å®Ÿè£…ã™ã‚‹æ‰‹é †ã‚’é †ã‚’è¿½ã£ã¦è§£èª¬ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ğŸ‘

ãªãŠã€ã“ã®è¨˜äº‹ã§å®Ÿè£…ã—ãŸã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã§å…¬é–‹ã—ã¦ã„ã¾ã™ã®ã§ã€ãœã²ã‚ã‚ã›ã¦ã”å‚ç…§ãã ã•ã„ã€‚

> <https://github.com/ttskch/symfony-api-platform-graphql-example>

# 1. ã¾ãšã¯Symfonyã‚¢ãƒ—ãƒªã‚’ä½œæˆ

è¨˜äº‹åŸ·ç­†æ™‚ç‚¹ï¼ˆ2021/12/22æ™‚ç‚¹ï¼‰ã§ [API PlatformãŒã¾ã Symfony 6ã«å¯¾å¿œã—ã¦ã„ãªã„](https://github.com/api-platform/core/pull/4582) ã®ã§ã€ä»Šå›ã¯Symfony 5ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```bash
$ composer create-project symfony/skeleton:^5.0 symfony-api-platform-graphql-example
$ cd symfony-api-platform-graphql-example
```

# 2. API Platformã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
$ composer require api -n # ç¢ºèªãªã—ã§ãƒ¬ã‚·ãƒ”ã‚’å®Ÿè¡Œ
```

ã“ã®æ™‚ç‚¹ã§ã€Symfonyã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¦ `/api` ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚Œã°ã€Swagger UIã§æ›¸ã‹ã‚ŒãŸREST APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ï¼ˆã¾ã å†…å®¹ã¯ç©ºã§ã™ãŒï¼‰

```bash
$ symfony serve -d
$ open -a "Google Chrome" http://localhost:8000/api
```

![](https://tva1.sinaimg.cn/large/008i3skNgy1gxmdnh7ejgj31sf0u00v4.jpg)

GraphQLã«å¯¾å¿œã•ã›ã‚‹ã«ã¯å°‘ã—è¿½åŠ ã®è¨­å®šãŒå¿…è¦ãªã®ã§ã™ãŒã€ã¾ãšã¯ä¸€æ—¦REST APIã®å‹•ä½œã‚’ç¢ºèªã—ãªãŒã‚‰åŸºæœ¬çš„ãªæº–å‚™ã‚’é€²ã‚ã¦ã„ãã“ã¨ã«ã—ã¾ã—ã‚‡ã†âœ‹

# 3. ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ä½œã‚‹

ã§ã¯ã¾ãšä½•ã‹é©å½“ãªã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ä½œã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

API Platformã®ä¾å­˜ã¨ã—ã¦Doctrineã¯ã™ã§ã«ä¸€å¼ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€`.env` ã§ `DATABASE_URL` ã‚’è¨­å®šã™ã‚‹ã ã‘ã§ã™ãã«DBã‚’åˆ©ç”¨ã§ãã¾ã™ã€‚ä»Šå›ã¯SQLiteã‚’ä½¿ã†ã“ã¨ã«ã—ã¾ã™ã€‚

```diff
# .env

- # DATABASE_URL="sqlite:///%kernel.project_dir%/var/data.db"
+ DATABASE_URL="sqlite:///%kernel.project_dir%/var/data.db"
  # DATABASE_URL="mysql://db_user:db_password@127.0.0.1:3306/db_name?serverVersion=5.7"
- DATABASE_URL="postgresql://symfony:ChangeMe@127.0.0.1:5432/app?serverVersion=13&charset=utf8"
+ # DATABASE_URL="postgresql://symfony:ChangeMe@127.0.0.1:5432/app?serverVersion=13&charset=utf8"
```

```bash
$ bin/console doctrine:database:create
```

ã“ã‚Œã§DBã¯é–‹é€šãªã®ã§ã€æ¬¡ã¯å®Ÿéš›ã«ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ä½œã‚Šã¾ã™ã€‚

æ¥½ã‚’ã—ãŸã„ã®ã§ [MakerBundle](https://symfony.com/bundles/SymfonyMakerBundle/current/index.html) ã‚’å…¥ã‚Œã¦ãŠãã¾ã—ã‚‡ã†ã€‚

```bash
$ composer require maker
```

`make` ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ä½œã‚Šã¾ã™ã€‚ã“ã“ã§ã¯ã€Œãƒ–ãƒ­ã‚°æŠ•ç¨¿ã€ã‚’è¡¨ã™ `Post` ã¨ã„ã†ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ä½œã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```bash
$ bin/console make:entity Post

 created: src/Entity/Post.php
 created: src/Repository/PostRepository.php

 # ç•¥

 New property name (press <return> to stop adding fields):
 > title

 Field type (enter ? to see all types) [string]:
 > text

 Can this field be null in the database (nullable) (yes/no) [no]:
 >

 updated: src/Entity/Post.php

 Add another property? Enter the property name (or press <return> to stop adding fields):
 > body

 Field type (enter ? to see all types) [string]:
 > text

 Can this field be null in the database (nullable) (yes/no) [no]:
 >

 updated: src/Entity/Post.php

 Add another property? Enter the property name (or press <return> to stop adding fields):
 > published

 Field type (enter ? to see all types) [string]:
 > boolean

 Can this field be null in the database (nullable) (yes/no) [no]:
 > yes

 updated: src/Entity/Post.php

 Add another property? Enter the property name (or press <return> to stop adding fields):
 > date

 Field type (enter ? to see all types) [string]:
 > date

 Can this field be null in the database (nullable) (yes/no) [no]:
 >

 updated: src/Entity/Post.php

 Add another property? Enter the property name (or press <return> to stop adding fields):
 >

  Success!
```

ã“ã‚Œã§ã€ä»¥ä¸‹ã®4ã¤ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŒã¤ `Post` ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒã§ãã¾ã—ãŸã€‚

| ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å | å‹ | ç”¨é€” |
| --- | --- | --- |
| `$title` | text | ã‚¿ã‚¤ãƒˆãƒ« |
| `$body` | text | æœ¬æ–‡ |
| `$published` | boolean | å…¬é–‹æ¸ˆã¿ãƒ•ãƒ©ã‚° |
| `$date` | date | æŠ•ç¨¿æ—¥ |

DBã«åæ˜ ã—ã¾ã™ã€‚

```bash
$ bin/console doctrine:migrations:diff
$ bin/console doctrine:migrations:migrate -n
```

æœ€å¾Œã«ã€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’API Platformã«èªè­˜ã•ã›ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ã‚ˆã†ã« `@ApiResource()` ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä»˜åŠ ã—ã¾ã™ã€‚

> ä»Šå›ã¯Symfony 5ã®æµå„€ã«å¾“ã£ã¦ã‚¢ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ãƒˆã§ã¯ãªãã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§æ›¸ãã¾ã™ğŸ™

```diff
+ use ApiPlatform\Core\Annotation\ApiResource;
  use App\Repository\PostRepository;
  use Doctrine\ORM\Mapping as ORM;
  
  /**
   * @ORM\Entity(repositoryClass=PostRepository::class)
+  * @ApiResource()
   */
  class Post
```

ã“ã®çŠ¶æ…‹ã§ `/api` ã®ç”»é¢ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã¿ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã« `Post` ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®CRUDã®APIãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚ä¾¿åˆ©ï¼

![](https://tva1.sinaimg.cn/large/008i3skNgy1gxmqcu0rm0j30zj0u0jts.jpg)

è©¦ã—ã«ã€REST APIçµŒç”±ã§å®Ÿéš›ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

![](https://tva1.sinaimg.cn/large/008i3skNgy1gxmstjp8hcj31ib0u076x.jpg)

![](https://tva1.sinaimg.cn/large/008i3skNgy1gxmstzlavnj31ib0u0wh9.jpg)

å‹•ã„ã¦ã„ã¾ã™ã­ï¼

# 4. GraphQL APIã‚’æœ‰åŠ¹ã«ã™ã‚‹

REST APIã§å‹•ä½œç¢ºèªã™ã‚‹ã®ã¯ã“ã“ã¾ã§ã«ã—ã¦ã€ã“ã“ã‹ã‚‰ã¯GraphQL APIã‚’ä½œã£ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

API Platformã¯REST APIã ã‘ã§ãªã [GraphQL APIã«ã‚‚å¯¾å¿œã—ã¦ã„ã¾ã™](https://api-platform.com/docs/core/graphql/)ã€‚

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã« [webonyx/graphql-php](https://github.com/webonyx/graphql-php) ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚Œã°ã€ãã‚Œã ã‘ã§GraphQL APIãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚

```bash
$ composer require webonyx/graphql-php
```

ã“ã‚Œã§ã€`/api/graphql` ã§ [GraphiQL](https://github.com/graphql/graphiql) ãŒã€`/api/graphql/graphql_playground` ã§ [GraphQL Playground](https://github.com/graphql/graphql-playground) ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

![](https://tva1.sinaimg.cn/large/008i3skNgy1gxmfih3qktj31sf0u0q59.jpg)

![](https://tva1.sinaimg.cn/large/008i3skNgy1gxmfld8j1ij31sf0u0gn6.jpg)

> ã‚‚ã—ã“ã‚Œã‚‰ã®IDEãŒä¸è¦ãªå ´åˆã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦ç„¡åŠ¹ã«ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
>
> ```yaml
> # api/config/packages/api_platform.yaml
> api_platform:
>     graphql:
>         graphiql:
>             enabled: false
>         graphql_playground:
>             enabled: false
> ```

è©¦ã—ã«GraphiQLã‚’ä½¿ã£ã¦å®Ÿéš›ã« `Post` ã®ä¸€è¦§ã‚’å–å¾—ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

![](https://tva1.sinaimg.cn/large/008i3skNgy1gxmsv0p9qcj31sf0u0783.jpg)

å•é¡Œãªãå–å¾—ã§ãã¦ã„ã¾ã™ã­ï¼

# 5. ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è‡ªä½œã™ã‚‹ï¼ˆ`Resolver`ï¼‰

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯åŸºæœ¬çš„ãªCRUDã«å¿…è¦ãªä»¥ä¸‹ã®ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒã™ã¹ã¦æœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚ï¼ˆ[å‚è€ƒ](https://api-platform.com/docs/core/graphql/#operations)ï¼‰

* Query
    * `item_query`
    * `collection_query`
* Mutation
    * `create`
    * `update`
    * `delete`

ç‰¹å®šã®ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã ã‘ã‚’æœ‰åŠ¹ã«ã—ãŸã„å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã® `@ApiResource()` ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å†…ã§æœ‰åŠ¹ã«ã—ãŸã„ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ˜ç¤ºã—ã¾ã™ã€‚

```php
/**
 * @ORM\Entity(repositoryClass=PostRepository::class)
 * @ApiResource(
 *     graphql={"item_query", "create"}
 * )
 */
class Post
```

ã“ã†ã™ã‚‹ã¨ `item_query` ã¨ `create` ä»¥å¤–ã®ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚

ã¾ãŸã€ã‚ˆã‚Šè¤‡é›‘ãªAPIã‚’å®Ÿè£…ã™ã‚‹å ´åˆã€ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è‡ªä½œã™ã‚‹ã“ã¨ã‚‚å¿…è¦ã«ãªã£ã¦ãã‚‹ã§ã—ã‚‡ã†ã€‚ã“ã®ã‚ˆã†ãªå ´åˆã«ã¯ã€`Resolver` ã¨å‘¼ã°ã‚Œã‚‹ã‚¯ãƒ©ã‚¹ã‚’ä½œã‚Šã€ãã“ã«ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å†…å®¹ã‚’è¨˜è¿°ã—ã¾ã™ã€‚

ã“ã“ã§ã¯ä¾‹ã¨ã—ã¦ã€`create` ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¦ã€æŠ•ç¨¿ä½œæˆæ™‚ã« `date` å¼•æ•°ãŒçœç•¥ã•ã‚ŒãŸå ´åˆã«ã¯ `Post::date` ã‚’è‡ªå‹•ã§ã‚»ãƒƒãƒˆã™ã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

> ã“ã®ã‚ˆã†ãªå‡¦ç†ã¯APIã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§è¡Œã†ã‚ˆã‚ŠDoctrineã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§æ°¸ç¶šåŒ–ã®ç›´å‰ã«è¡Œã†ã»ã†ãŒä¸€èˆ¬çš„ã‹ã¤é©åˆ‡ã ã¨æ€ã„ã¾ã™ãŒã€ä»–ã«é©å½“ãªä¾‹ãŒæ€ã„ã¤ã‹ãªã‹ã£ãŸã®ã§ã“ã“ã§ã¯æ°—ã«ã›ãšå—ã‘å…¥ã‚Œã¦ãã ã•ã„ğŸ™

ã¾ãšã€ä»¥ä¸‹ã®ã‚ˆã†ãª `Resolver` ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚

```php
<?php
// src/ApiPlatform/GraphQL/Resolver/Post/CreateResolver.php

namespace App\ApiPlatform\GraphQL\Resolver\Post;

use ApiPlatform\Core\GraphQl\Resolver\MutationResolverInterface;
use App\Entity\Post;

class CreateResolver implements MutationResolverInterface
{
    /**
     * @param Post|null $post
     */
    public function __invoke($post, array $context): ?Post
    {
        if (!$post instanceof Post) {
            return null;
        }

        // $context['args'] ã«ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«æ¸¡ã•ã‚ŒãŸå¼•æ•°ãŒå…¥ã£ã¦ã„ã‚‹
        $post->setDate(new \DateTime($context['args']['input']['date'] ?? 'today'));

        return $post;
    }
}
```

ãã—ã¦ã€`Post` ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã® `@ApiResource()` ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

```php
/**
 * @ORM\Entity(repositoryClass=PostRepository::class)
 * @ApiResource(
 *     graphql={
 *         "item_query",
 *         "collection_query",
 *         "create"={
 *             "mutation"=CreateResolver::class,
 *             "args"={
 *                 "title"={
 *                     "type"="String!",
 *                 },
 *                 "body"={
 *                     "type"="String!",
 *                 },
 *                 "published"={
 *                     "type"="Boolean",
 *                 },
 *                 "date"={
 *                     "type"="String",
 *                 },
 *             },
 *         },
 *         "update",
 *         "delete",
 *     }
 * )
 */
class Post
```

* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®5ã¤ã®ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ˜ç¤ºï¼ˆ`create` ã ã‘ã—ã‹æ›¸ã‹ãªã„ã¨ä»–ã®ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒç„¡åŠ¹ã«ãªã£ã¦ã—ã¾ã†ã®ã§ï¼‰
* `create` ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ `CreateResolver` ã‚’ä½¿ã£ãŸMutationã¨ã—ã¦å®šç¾©
* `create` ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å¼•æ•°ã‚’ã€`date` ã®å‹ã ã‘ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® `String!` ã‹ã‚‰ `String`ï¼ˆä»»æ„ï¼‰ã«å¤‰ãˆã¦åˆ—æŒ™ï¼ˆ`date` ã ã‘ã—ã‹æ›¸ã‹ãªã„ã¨ä»–ã®å¼•æ•°ãŒç„¡åŠ¹ã«ãªã£ã¦ã—ã¾ã†ã®ã§ï¼‰

ã¨ã„ã†ã“ã¨ã‚’ã‚„ã£ã¦ã„ã¾ã™ã€‚

ã§ã¯ã€å®Ÿéš›ã« `date` å¼•æ•°ã‚’æŒ‡å®šã›ãšã« `create` ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

> å®Ÿéš›ã®ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åã«ã¯ã€API Platformã«ã‚ˆã£ã¦æœ«å°¾ã«ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£åï¼ˆã“ã“ã§ã¯ `Post`ï¼‰ãŒä»˜åŠ ã•ã‚Œã¾ã™ã€‚
>
> å…·ä½“çš„ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¯GraphiQLã®å³ã‚«ãƒ©ãƒ ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰çŸ¥ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![](https://tva1.sinaimg.cn/large/008i3skNgy1gxmt56179qj31sf0u0djr.jpg)

æœŸå¾…ã©ãŠã‚Šã«å‹•ãã¾ã—ãŸã­ï¼ï¼ˆè¨˜äº‹åŸ·ç­†æ™‚ç‚¹ã®æ—¥ä»˜ãŒ2021/12/22ãªã®ã§ã€`date` ãŒè‡ªå‹•çš„ã«2021/12/22ã«ãªã£ã¦ã„ã¾ã™ï¼‰

`mutation` ã ã‘ã§ãªãã€`item_query` ã‚„ `collection_query` ã®è‡ªä½œã‚‚ã»ã¼åŒæ§˜ã®æ‰‹é †ã§å¯¾å¿œå¯èƒ½ã§ã™ã€‚

ã¾ãŸã€ã‚‚ã¡ã‚ã‚“ä»Šå›ã®ã‚ˆã†ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¸Šæ›¸ãã™ã‚‹ã ã‘ã§ãªãã€æ–°ãŸãªã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

è©³ç´°ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ä»¥ä¸‹ã®ç®‡æ‰€ã‚ãŸã‚Šã‚’ã”å‚ç…§ãã ã•ã„ã€‚

> * <https://api-platform.com/docs/core/graphql/#custom-queries>
> * <https://api-platform.com/docs/core/graphql/#custom-mutations>

# 6. ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ãªãYAMLã§è¨­å®šã™ã‚‹

ã¨ã“ã‚ã§ã€`Post` ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã® `@ApiResource()` ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒã™ã§ã«é•·ã™ãã¦å¯èª­æ€§ãŒä½ã„ã®ã§ã€ã“ã“ã‚‰ã§ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ãªãYAMLã§è¨­å®šã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¦ãŠãã¾ã—ã‚‡ã†âœ‹

ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã”ã£ãã‚Šå‰Šé™¤ã—ã¦ã€

```diff
  /**
   * @ORM\Entity(repositoryClass=PostRepository::class)
-  * @ApiResource(
-  *     graphql={
-  *         "item_query",
-  *         "collection_query",
-  *         "create"={
-  *             "mutation"=CreateResolver::class,
-  *             "args"={
-  *                 "title"={
-  *                     "type"="String!",
-  *                 },
-  *                 "body"={
-  *                     "type"="String!",
-  *                 },
-  *                 "published"={
-  *                     "type"="Boolean",
-  *                 },
-  *                 "date"={
-  *                     "type"="String",
-  *                 },
-  *             },
-  *         },
-  *         "update",
-  *         "delete",
-  *     }
-  * )
   */
  class Post
```

ä»£ã‚ã‚Šã« `config/packages/api_platform/post.yaml` ã¨ã„ã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ã«ä»¥ä¸‹ã®ã‚ˆã†ã«YAMLå½¢å¼ã§è¨˜è¿°ã—ã¾ã™ã€‚

```yaml
App\Entity\Post:
  graphql:
     item_query: ~
     collection_query: ~
     create:
       mutation: App\ApiPlatform\GraphQL\Resolver\Post\CreateResolver
       args:
         title:
           type: String!
         body:
           type: String!
         published:
           type: Boolean
         date:
           type: String
     update: ~
     delete: ~
```

ãã—ã¦ã€`config/packages/api_platform.yaml` ã§ä»¥ä¸‹ã®ã‚ˆã†ã«ã“ã®YAMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã‚ˆã†ã«ã—ã¾ã™ã€‚

```diff
  api_platform:
      mapping:
-         paths: ['%kernel.project_dir%/src/Entity']
+         paths:
+             - '%kernel.project_dir%/src/Entity'
+             - '%kernel.project_dir%/config/packages/api_platform'
```

ã“ã‚Œã§ã€`@ApiResource()` ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã«åŠ ãˆã¦ `config/packages/api_platform/` é…ä¸‹ã®YAMLãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚‚APIãƒªã‚½ãƒ¼ã‚¹ã‚’å®šç¾©ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

# 7. ã‚¯ã‚¨ãƒªã®çµæœã‚»ãƒƒãƒˆã‚’ã‚«ã‚¹ã‚¿ãƒ ã™ã‚‹ï¼ˆ`DataProvider`ï¼‰

ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®è‡ªä½œã ã‘ã§ãªãã€ã‚¯ã‚¨ãƒªã®çµæœã‚»ãƒƒãƒˆã‚’ã‚«ã‚¹ã‚¿ãƒ ã—ãŸããªã‚‹ã“ã¨ã‚‚å¤šã€…ã‚ã‚Šã¾ã™ã€‚ã“ã®ã‚ˆã†ãªå ´åˆã«ã¯ã€[`DataProvider`](https://api-platform.com/docs/core/data-providers/) ã¨å‘¼ã°ã‚Œã‚‹ã‚¯ãƒ©ã‚¹ã‚’ä½œã‚Šã€ãã“ã«çµæœã‚»ãƒƒãƒˆã®æ§‹ç¯‰å‡¦ç†ã‚’è¨˜è¿°ã—ã¾ã™ã€‚

ä¾‹ã¨ã—ã¦ã€æŠ•ç¨¿ã®ä¸€è¦§å–å¾—ã§ã¯ **å…¬é–‹æ¸ˆã¿ãƒ•ãƒ©ã‚°ãŒ `true` ã®ã‚‚ã®ã ã‘ã—ã‹å‡ºåŠ›ã—ãªã„** ã‚ˆã†ã«ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ãª `DataProvider` ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã™ã‚Œã°ã€`supports()` ãƒ¡ã‚½ãƒƒãƒ‰ã®åƒãã«ã‚ˆã£ã¦è‡ªå‹•ã§APIã®æŒ™å‹•ã«é©ç”¨ã•ã‚Œã¾ã™ã€‚ï¼ˆãŸã ã—ã€å¾Œè¿°ã—ã¾ã™ãŒã“ã®æ™‚ç‚¹ã§ã¯å®Ÿè£…ã¨ã—ã¦æœªå®Œæˆã§ã™ï¼‰

```php
<?php
// src/ApiPlatform/DataProvider/PostCollectionDataProvider.php

namespace App\ApiPlatform\DataProvider;

use ApiPlatform\Core\DataProvider\ArrayPaginator;
use ApiPlatform\Core\DataProvider\ContextAwareCollectionDataProviderInterface;
use ApiPlatform\Core\DataProvider\RestrictedDataProviderInterface;
use App\Entity\Post;
use App\Repository\PostRepository;

class PostCollectionDataProvider implements ContextAwareCollectionDataProviderInterface, RestrictedDataProviderInterface
{
    public function __construct(private PostRepository $repository)
    {
    }

    public function supports(string $resourceClass, string $operationName = null, array $context = []): bool
    {
        return $resourceClass === Post::class;
    }

    public function getCollection(string $resourceClass, string $operationName = null, array $context = []): iterable
    {
        $array = $this->repository->createQueryBuilder('p')
            ->andWhere('p.published = 1')
            ->getQuery()
            ->getResult()
        ;

        // æˆ»ã‚Šå€¤ã¯ \ApiPlatform\Core\DataProvider\PartialPaginatorInterface ã®å®Ÿè£…ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹
        return new ArrayPaginator($array, 0, count($array));
    }
}
```

`collection_query` ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ã¿ã‚‹ã¨ã€

![](https://tva1.sinaimg.cn/large/008i3skNgy1gxmtsh974wj31sf0u00vv.jpg)

æŠ•ç¨¿è‡ªä½“ã¯ç¾åœ¨2ä»¶å­˜åœ¨ã—ã¦ã„ã‚‹ã¯ãšã§ã™ãŒã€å…¬é–‹æ¸ˆã¿ã®æŠ•ç¨¿ãŒå­˜åœ¨ã—ãªã„ãŸã‚çµæœãŒ0ä»¶ã¨ãªã£ã¦ã„ã¾ã™ğŸ‘Œ

`update` ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦2ä»¶ç›®ã®æŠ•ç¨¿ã®ã¿å…¬é–‹æ¸ˆã¿ã«å¤‰æ›´ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

![](https://tva1.sinaimg.cn/large/008i3skNgy1gxmtw4v8wuj31sf0u0tco.jpg)

ã“ã‚Œã§å†åº¦ `collection_query` ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ã¿ã‚‹ã¨ã€

![](https://tva1.sinaimg.cn/large/008i3skNgy1gxmtxrexv6j31sf0u0gpf.jpg)

ç¢ºã‹ã«å…¬é–‹æ¸ˆã¿ã«ã—ãŸ1ä»¶ã ã‘ãŒå‡ºåŠ›ã•ã‚Œã¾ã—ãŸğŸ‘Œ

# 8. è‡ªä½œã—ãŸ `DataProvider` ã§ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚„ãƒ•ã‚£ãƒ«ã‚¿ãªã©ã®åŸºæœ¬æ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã™ã‚‹

ã¨ã“ã‚ã§ã€å®Ÿã¯å…ˆã»ã©ã® `PostCollectionDataProvider` ã®å®Ÿè£…ã§ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ç‰¹ã«ä½•ã‚‚è€ƒãˆãªãã¦ã‚‚ä½¿ãˆã¦ã„ãŸ **ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚„ãƒ•ã‚£ãƒ«ã‚¿ã¨ã„ã£ãŸåŸºæœ¬æ©Ÿèƒ½ãŒä½¿ãˆãªããªã£ã¦ã„ã¾ã™ã€‚**

è©¦ã—ã« `collection_query` ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ `(first: 0)` ï¼ˆæœ€åˆã®0ä»¶ã‚’å–å¾—ã€ã¤ã¾ã‚Š1ä»¶ã‚‚å–å¾—ã—ãªã„ï¼‰ã¨ã„ã†å¼•æ•°ä»˜ãã§å®Ÿè¡Œã—ã¦ã¿ã‚‹ã¨ã€

![](https://tva1.sinaimg.cn/large/008i3skNgy1gxmu29p02sj31sf0u0q6t.jpg)

æ™®é€šã«1ä»¶ãŒå–å¾—ã•ã‚Œã¦ã—ã¾ã£ã¦ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãŒåŠ¹ã„ã¦ã„ãªã„ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

å®Ÿã¯API Platformã§ã¯ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å®Ÿè£…ã‚‚å«ã‚ãŸï¼‰`DataProvider` ç”¨ã®åŸºæœ¬æ©Ÿèƒ½ãŒ `Extension` ã¨ã„ã†å½¢ã§ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ã•ã‚Œã¦ãŠã‚Šã€`DataProvider` ã‚’è‡ªä½œã—ãŸå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ `Extension` ã‚’æ˜ç¤ºçš„ã«é©ç”¨ã—ã¦ã‚ã’ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ï¼ˆ[å‚è€ƒ](https://api-platform.com/docs/core/data-providers/#injecting-extensions-pagination-filter-eagerloading-etc)ï¼‰

å…·ä½“çš„ã«ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã§ `iterable $collectionExtensions` ã‚’å—ã‘å–ã£ã¦ã€ãã‚Œã‚‰ã‚’é †ã«é©ç”¨ã—ã¦ã„ãã€ã¨ã„ã†ã‚³ãƒ¼ãƒ‰ã‚’è¿½è¨˜ã—ã¾ã™ã€‚

> ã€Œé©ç”¨ã™ã‚‹ã€æ‰‹é †ã«ã¤ã„ã¦ã¯ç‰¹ã«æ·±ãè€ƒãˆãšã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã¨ãŠã‚Šã«æ›¸ã„ã¦ã‚‚å‹•ãã¾ã™ãŒã€è©³ã—ãçŸ¥ã‚ŠãŸã„æ–¹ã¯ä»¥ä¸‹ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å®Ÿè£…ã‚’è¦‹ã‚‹ã¨å‚è€ƒã«ãªã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚
>
> * [`ApiPlatform\Core\Bridge\Doctrine\Orm\ItemDataProvider`](https://github.com/api-platform/core/blob/v2.6.6/src/Bridge/Doctrine/Orm/ItemDataProvider.php#L97-L103)
> * [`ApiPlatform\Core\Bridge\Doctrine\Orm\CollectionDataProvider`](https://github.com/api-platform/core/blob/v2.6.6/src/Bridge/Doctrine/Orm/CollectionDataProvider.php#L68-L74)

```diff
  <?php
  
  namespace App\ApiPlatform\DataProvider;
  
+ use ApiPlatform\Core\Bridge\Doctrine\Orm\Extension\QueryResultCollectionExtensionInterface;
+ use ApiPlatform\Core\Bridge\Doctrine\Orm\Util\QueryNameGenerator;
  use ApiPlatform\Core\DataProvider\ArrayPaginator;
  use ApiPlatform\Core\DataProvider\ContextAwareCollectionDataProviderInterface;
  use ApiPlatform\Core\DataProvider\RestrictedDataProviderInterface;
  use App\Entity\Post;
  use App\Repository\PostRepository;
  
  class PostCollectionDataProvider implements ContextAwareCollectionDataProviderInterface, RestrictedDataProviderInterface
  {
-     public function __construct(private PostRepository $repository)
-     {
-     }
+     public function __construct(
+         private PostRepository $repository,
+         private iterable $collectionExtensions,
+     ) {}
  
      public function supports(string $resourceClass, string $operationName = null, array $context = []): bool
      {
          return $resourceClass === Post::class;
      }
  
      public function getCollection(string $resourceClass, string $operationName = null, array $context = []): iterable
      {
-         $array = $this->repository->createQueryBuilder('p')
+         $qb = $this->repository->createQueryBuilder('p')
              ->andWhere('p.published = 1')
-             ->getQuery()
-             ->getResult()
          ;
  
+         $queryNameGenerator = new QueryNameGenerator();
+         foreach ($this->collectionExtensions as $extension) {
+             $extension->applyToCollection($qb, $queryNameGenerator, $resourceClass, $operationName, $context);
+ 
+             if ($extension instanceof QueryResultCollectionExtensionInterface && $extension->supportsResult($resourceClass, $operationName, $context)) {
+                 return $extension->getResult($qb);
+             }
+         }
+ 
+         $array = $qb->getQuery()->getResult();
+ 
          return new ArrayPaginator($array, 0, count($array));
      }
  }
```

ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å¼•æ•°ã® `iterable $collectionExtensions` ã¯ `config/services.yaml` ã§ä»¥ä¸‹ã®ã‚ˆã†ã«æ˜ç¤ºçš„ã«æ¸¡ã—ã¦ã‚ã’ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```yaml
services:
    App\ApiPlatform\DataProvider\PostCollectionDataProvider:
        arguments:
            $collectionExtensions: !tagged api_platform.doctrine.orm.query_extension.collection
```

ã“ã‚Œã‚‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ã¨ãŠã‚Šã§ã™ãŒã€åŸºæœ¬æ©Ÿèƒ½ã® `Extension` ã¯ã™ã¹ã¦ `api_platform.doctrine.orm.query_extension.collection` ã§ã‚¿ã‚°ä»˜ã‘ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ä½•ã‚‚è€ƒãˆãšã«ã“ã‚Œã‚‰ã‚’ã¾ã¨ã‚ã¦æ³¨å…¥ã—ã¦ã‚ã’ã‚Œã°ã‚ˆã„ã¨ã„ã†ã‚ã‘ã§ã™ã€‚

ã“ã‚Œã§ã€ç„¡äº‹ã«ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆç­‰ã®åŸºæœ¬æ©Ÿèƒ½ï¼‰ãŒå‹•ä½œã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸğŸ‘

![](https://tva1.sinaimg.cn/large/008i3skNgy1gxmupyt2xaj31sf0u0dj1.jpg)

![](https://tva1.sinaimg.cn/large/008i3skNgy1gxmuqgemluj31sf0u0gpf.jpg)

ã¡ãªã¿ã«ã€è¤‡æ•°ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«ã¤ã„ã¦ä¸€è¦§ç³»ã® `DataProvider` ã‚’è‡ªä½œã™ã‚‹å ´åˆã€ã™ã¹ã¦ã® `DataProvider` ã«ã€Œ`Extension` ã‚’é©ç”¨ã™ã‚‹å‡¦ç†ã€ã‚’æ›¸ã‹ãªã‘ã‚Œã°ãªã‚‰ãªã„ã®ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã§ `Trait` ã«ã—ã¦ãŠãã¨ä¾¿åˆ©ã ã¨æ€ã„ã¾ã™ã€‚

```php
<?php
// src/ApiPlatform/DataProvider/Traits/CollectionDataProviderTrait.php

namespace App\ApiPlatform\DataProvider\Traits;

use ApiPlatform\Core\Bridge\Doctrine\Orm\Extension\QueryCollectionExtensionInterface;
use ApiPlatform\Core\Bridge\Doctrine\Orm\Extension\QueryResultCollectionExtensionInterface;
use ApiPlatform\Core\Bridge\Doctrine\Orm\Util\QueryNameGenerator;
use ApiPlatform\Core\DataProvider\ArrayPaginator;
use Doctrine\ORM\QueryBuilder;

/**
 * @property iterable<QueryCollectionExtensionInterface> $collectionExtensions
 */
trait CollectionDataProviderTrait
{
    protected function getResult(QueryBuilder $qb, string $resourceClass, string $operationName = null, array $context = []): iterable
    {
        $queryNameGenerator = new QueryNameGenerator();

        foreach ($this->collectionExtensions as $extension) {
            $extension->applyToCollection($qb, $queryNameGenerator, $resourceClass, $operationName, $context);

            if ($extension instanceof QueryResultCollectionExtensionInterface && $extension->supportsResult($resourceClass, $operationName, $context)) {
                return $extension->getResult($qb);
            }
        }

        $array = $qb->getQuery()->getResult();

        return new ArrayPaginator($array, 0, count($array));
    }
}
```

```diff
  <?php
  
  namespace App\ApiPlatform\DataProvider;
  
- use ApiPlatform\Core\Bridge\Doctrine\Orm\Extension\QueryResultCollectionExtensionInterface;
- use ApiPlatform\Core\Bridge\Doctrine\Orm\Util\QueryNameGenerator;
- use ApiPlatform\Core\DataProvider\ArrayPaginator;
  use ApiPlatform\Core\DataProvider\ContextAwareCollectionDataProviderInterface;
  use ApiPlatform\Core\DataProvider\RestrictedDataProviderInterface;
+ use App\ApiPlatform\DataProvider\Traits\CollectionDataProviderTrait;
  use App\Entity\Post;
  use App\Repository\PostRepository;
  
  class PostCollectionDataProvider implements ContextAwareCollectionDataProviderInterface, RestrictedDataProviderInterface
  {
+     use CollectionDataProviderTrait;
+ 
      public function __construct(
          private PostRepository $repository,
          private iterable $collectionExtensions,
      ) {}
  
      public function supports(string $resourceClass, string $operationName = null, array $context = []): bool
      {
          return $resourceClass === Post::class;
      }
  
      public function getCollection(string $resourceClass, string $operationName = null, array $context = []): iterable
      {
          $qb = $this->repository->createQueryBuilder('p')
              ->andWhere('p.published = 1')
          ;
  
-         $queryNameGenerator = new QueryNameGenerator();
-         foreach ($this->collectionExtensions as $extension) {
-             $extension->applyToCollection($qb, $queryNameGenerator, $resourceClass, $operationName, $context);
- 
-             if ($extension instanceof QueryResultCollectionExtensionInterface && $extension->supportsResult($resourceClass, $operationName, $context)) {
-                 return $extension->getResult($qb);
-             }
-         }
- 
-         $array = $qb->getQuery()->getResult();
- 
-         return new ArrayPaginator($array, 0, count($array));
+         return $this->getResult($qb, $resourceClass, $operationName, $context);
      }
  }
```

ã¾ãŸã€`collection_query` ã ã‘ã§ãªã `item_query` ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã‚‚ã»ã¼åŒæ§˜ã®æ‰‹é †ã§å¯¾å¿œå¯èƒ½ã§ã™ã€‚

è©³ç´°ã¯ï¼ˆæ—¢å‡ºã§ã™ãŒï¼‰ä¸‹è¨˜ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã”å‚ç…§ãã ã•ã„ã€‚

> <https://api-platform.com/docs/core/data-providers/>

# 9. ä¸€è¦§å–å¾—APIã«çµã‚Šè¾¼ã¿ã¨ä¸¦ã¹æ›¿ãˆã‚’å®Ÿè£…ã™ã‚‹

`collection_query` ã®çµæœã‚»ãƒƒãƒˆã‚’çµã‚Šè¾¼ã‚“ã ã‚Šä¸¦ã¹æ›¿ãˆãŸã‚Šã§ãã‚‹ [ãƒ•ã‚£ãƒ«ã‚¿](https://api-platform.com/docs/core/filters/) ã¨ã„ã†æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚

ä¾‹ãˆã°ã€æŠ•ç¨¿ä¸€è¦§ã«ã¤ã„ã¦

* æŠ•ç¨¿æ—¥ã§çµã‚Šè¾¼ã‚ã‚‹ã‚ˆã†ã«
* æŠ•ç¨¿æ—¥ã§ä¸¦ã¹æ›¿ãˆã‚‰ã‚Œã‚‹ã‚ˆã†ã«

ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã™ã‚Œã°ã‚ˆã„ã§ã™ã€‚

ã¾ãšã€çµã‚Šè¾¼ã¿ç”¨ã¨ä¸¦ã¹æ›¿ãˆç”¨ã®ãƒ•ã‚£ãƒ«ã‚¿ã‚’ãã‚Œãã‚Œã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦å®šç¾©ã—ã¾ã™ã€‚

```yaml
# config/services.yaml

services:
    api.post.date_filter:
        parent: api_platform.doctrine.orm.date_filter
        arguments: [{date: ~}]
        tags: [api_platform.filter]
        autowire: false
        autoconfigure: false
    api.post.order_filter:
        parent: api_platform.doctrine.orm.order_filter
        arguments:
            $properties: {date: ~}
            $orderParameterName: order
        tags: [api_platform.filter]
        autowire: false
        autoconfigure: false
```

ãã—ã¦ã€`config/packages/api_platform/post.yaml` ã«ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã‚’è¿½åŠ ã—ã¾ã™ã€‚

```diff
  App\Entity\Post:
+   attributes:
+     filters:
+       - api.post.date_filter
+       - api.post.order_filter
    graphql:
      # ç•¥
```

> ã‚ã‚‹ã„ã¯ã€YAMLã¨ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã«è¨­å®šãŒåˆ†æ•£ã™ã‚‹ã“ã¨ã‚’è¨±å®¹ã™ã‚‹ãªã‚‰ï¼ˆã¾ãŸã¯è¨­å®šã‚’ã™ã¹ã¦ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§æ›¸ããªã‚‰ï¼‰ã€ã‚ã–ã‚ã–ã‚µãƒ¼ãƒ“ã‚¹ã‚’å®šç¾©ã›ãšã«ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’2è¡Œæ›¸ãã ã‘ã§ã‚‚åŒã˜è¨­å®šãŒå¯èƒ½ã§ã™ã€‚
>
> ```diff
> + use ApiPlatform\Core\Bridge\Doctrine\Orm\Filter\DateFilter;
> + use ApiPlatform\Core\Bridge\Doctrine\Orm\Filter\OrderFilter;
>  
>   /**
>    * @ORM\Entity(repositoryClass=PostRepository::class)
> +  * @ApiFilter(DateFilter::class, properties={"date"})
> +  * @ApiFilter(OrderFilter::class, properties={"date"}, arguments={"orderParameterName"="order"})
>    */
>   class Post
> ```

ï¼ˆã„ãã¤ã‹å…¬é–‹æ¸ˆã¿ã®æŠ•ç¨¿ã‚’å¢—ã‚„ã—ãŸä¸Šã§ï¼‰å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã«ãªã‚Šã¾ã™ğŸ‘Œ

![](https://tva1.sinaimg.cn/large/008i3skNgy1gxn0ugbbrnj31sf0u0n2m.jpg)

è©³ç´°ã¯ä¸‹è¨˜ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã”å‚ç…§ãã ã•ã„ã€‚

> * <https://api-platform.com/docs/core/filters/>
> * <https://api-platform.com/docs/core/graphql/#filters>

## ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®é–“é•ã„ï¼Ÿ

ã¡ãªã¿ã«ã€<https://api-platform.com/docs/core/graphql/#filters> ã‚’è¦‹ã‚‹ã¨

```yaml
App\Entity\Post:
  attributes:
    filters:
      - api.post.date_filter
      - api.post.order_filter
```

ã§ã¯ãªã

```yaml
App\Entity\Post:
  graphql:
    collection_query:
      filters:
        - api.post.date_filter
        - api.post.order_filter
```

ã¨ã™ã‚‹ã“ã¨ã§ã€REST APIã‚„ä»–ã®ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«æ³¢åŠã•ã›ãšã«GraphQL APIã® `collection_query` ã«ã ã‘ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ãªã“ã¨ãŒæ›¸ã„ã¦ã‚ã‚Šã¾ã™ãŒã€è¨˜äº‹åŸ·ç­†æ™‚ç‚¹ã§ã¯ã“ã®æ›¸ãæ–¹ã ã¨æœŸå¾…ã©ãŠã‚Šå‹•ä½œã—ã¾ã›ã‚“ğŸ¤”

* [`ApiPlatform\Core\Bridge\Doctrine\Orm\Extension\FilterExtension` ã®ã“ã“](https://github.com/api-platform/core/blob/v2.6.6/src/Bridge/Doctrine/Orm/Extension/FilterExtension.php#L58)
* [`ApiPlatform\Core\Bridge\Doctrine\Orm\Extension\OrderExtension` ã®ã“ã“](https://github.com/api-platform/core/blob/v2.6.6/src/Bridge/Doctrine/Orm/Extension/OrderExtension.php#L55)

ã‚ãŸã‚Šã§ `ApiPlatform\Core\Metadata\Resource\ResourceMetadata::getCollectionOperationAttribute()` ã‚’å‘¼ã‚“ã§ã„ã¾ã™ãŒã€ãã®å…ˆã§å‘¼ã°ã‚Œã‚‹ [`ApiPlatform\Core\Metadata\Resource\ResourceMetadata::findOperationAttribute()` ã®å®Ÿè£…](https://github.com/api-platform/core/blob/v2.6.6/src/Metadata/Resource/ResourceMetadata.php#L299) ã‚’è¦‹ã‚‹é™ã‚Šã€[APIãƒªã‚½ãƒ¼ã‚¹è¨­å®šã® `'graphql'` ã‚­ãƒ¼ã«å¯¾ã™ã‚‹è¨­å®šå€¤ã¯åˆ¥ã®å¤‰æ•°ã«æ ¼ç´ã•ã‚Œã¦ã„ã¦](https://github.com/api-platform/core/blob/v2.6.6/src/Metadata/Resource/ResourceMetadata.php#L31-L32) ã“ã“ã§ã¯ä½¿ç”¨ã•ã‚Œãªã„ã‚ˆã†ã«è¦‹ãˆã¾ã™ã€‚

Issueã‚„PRã‚‚è¦‹ã¤ã‘ã‚‰ã‚Œãšã€ãƒã‚°ãªã®ã‹ä»•æ§˜ãªã®ã‹ã‚‚ã‚ˆãåˆ†ã‹ã£ã¦ã„ã¾ã›ã‚“ğŸ˜“ã‚‚ã—è©³ã—ã„æ–¹ã„ã‚‰ã£ã—ã‚ƒã£ãŸã‚‰ãœã² [æ•™ãˆã¦ã„ãŸã ã‘ã‚‹ã¨](https://twitter.com/ttskch) å¬‰ã—ã„ã§ã™ğŸ™

# 10. REST APIã‚’ç„¡åŠ¹ã«ã™ã‚‹

GraphQL APIã ã‘ã‚’æœ‰åŠ¹ã«ã—ã¦REST APIã¯ç„¡åŠ¹ã«ã—ã¦ãŠããŸã„ã¨ã„ã†å ´åˆã‚‚å¤šã„ã¨æ€ã„ã¾ã™ãŒã€æ®‹å¿µãªãŒã‚‰ã‚·ãƒ¥ãƒƒã¨è¨­å®šã™ã‚‹æ–¹æ³•ã¯ç”¨æ„ã•ã‚Œã¦ãŠã‚‰ãšã€

* æœ‰åŠ¹ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ã‚¢ã‚¤ãƒ†ãƒ ã®GETã¨ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®GETã®ã¿ã«ã™ã‚‹
* ãã‚Œãã‚Œã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å¸¸ã«404ã«ã™ã‚‹

ã¨ã„ã†æ³¥è‡­ã„è¨­å®šã‚’ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```diff
  api_platform:
      mapping:
          paths:
              - '%kernel.project_dir%/src/Entity'
              - '%kernel.project_dir%/config/packages/api_platform'
      patch_formats:
          json: ['application/merge-patch+json']
      swagger:
          versions: [3]
+ 
+     defaults:
+         item_operations:
+             get:
+                 controller: ApiPlatform\Core\Action\NotFoundAction
+                 read: false
+                 output: false
+         collection_operations:
+             get:
+                 controller: ApiPlatform\Core\Action\NotFoundAction
+                 read: false
+                 output: false
```

> å‚è€ƒï¼š<https://github.com/api-platform/core/issues/2796#issuecomment-606729715>

![](https://tva1.sinaimg.cn/large/008i3skNgy1gxn1mc84naj31sf0u077k.jpg)

![](https://tva1.sinaimg.cn/large/008i3skNgy1gxn1lyuqx9j31ib0u0te9.jpg)

# ãŠã¾ã‘ï¼šãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«ã‚¢ã‚¯ã‚»ã‚¹å¯å¦ã‚’åˆ¶å¾¡

Securityã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å°å…¥ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«ã‚¢ã‚¯ã‚»ã‚¹å¯å¦ã‚’åˆ¶å¾¡ã—ãŸã„å ´åˆã¯ã€APIãƒªã‚½ãƒ¼ã‚¹è¨­å®šã« `security` ã¨ã„ã†ã‚­ãƒ¼ãŒç”¨æ„ã•ã‚Œã¦ã„ã¦ã€ãŠé¦´æŸ“ã¿ã® `is_granted` ãªã©ãŒä½¿ãˆã‚‹ã®ã§ã€é€šå¸¸ã®Symfonyã‚¢ãƒ—ãƒªã‚’ä½œã‚‹ã¨ãã¨åŒã˜è¦é ˜ã§å¯¾å¿œå¯èƒ½ã§ã™ğŸ‘

```yaml
App\Entity\Post:
  graphql:
    item_query:
      security: is_granted('VIEW', object) # Postã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç”¨ã®Security Voterã§VIEWã¨ã„ã†æ¨©é™ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸
    collection_query:
      security: is_granted('ROLE_USER')
```

è©³ç´°ã¯ä¸‹è¨˜ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã”å‚ç…§ãã ã•ã„ã€‚

* <https://api-platform.com/docs/core/security/>
* <https://api-platform.com/docs/core/graphql/#security>

# ãŠã‚ã‚Šã«

ã¨ã„ã†ã‚ã‘ã§ã€Symfony + [API Platform](https://api-platform.com/) ã§GraphQL APIã‚’å®Ÿè£…ã™ã‚‹æ‰‹é †ã‚’ã¾ã‚ã¾ã‚ç´°ã‹ãè§£èª¬ã—ã¦ã¿ã¾ã—ãŸï¼

ã“ã‚Œã ã‘çŸ¥ã£ã¦ã„ã‚Œã°åŸºæœ¬çš„ãªGraphQL APIã¯ã¾ã‚ã ã„ãŸã„å®Ÿè£…ã§ãã‚‹ã®ã§ã¯ãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚ã‚ˆã‚ã—ã‘ã‚Œã°å‚è€ƒã«ã—ã¦ã¿ã¦ãã ã•ã„ï¼

[Symfony Advent Calendar 2021](https://qiita.com/advent-calendar/2021/symfony)ã€æ˜æ—¥ã¯ [@77web](https://twitter.com/77web) ã•ã‚“ã§ã™ï¼ãŠæ¥½ã—ã¿ã«ï¼
