---
title: "Render.comã®PostgreSQLã®ãƒ€ãƒ³ãƒ—ã‚’S3ã«æ¯æ—¥ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¦ç›´è¿‘1ãƒ¶æœˆåˆ†ã ã‘ã‚’æ®‹ã™"
emoji: "ğŸ’½"
type: "tech"
topics: ["render", "database", "postgresql", "backup", "aws", "s3"]
published: true
---

ãƒ¡ãƒ¢ã§ã™ã€‚

# Render.comã®PostgreSQLã®è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½

https://render.com/docs/postgresql-backups

ã“ã¡ã‚‰ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ã¨ãŠã‚Šã€Render.comã®PostgreSQLã«ã¯è‡ªå‹•ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿æŒã—ã€Web UIã‹ã‚‰ç°¡å˜ã«ãƒªã‚«ãƒãƒªãƒ¼ã‚’å®Ÿè¡Œã§ãã‚‹æ©Ÿèƒ½ãŒæ­è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

ãŸã ã—ã€ã“ã®æ©Ÿèƒ½ã¯Hobbyãƒ—ãƒ©ãƒ³ã§ã¯ç›´è¿‘3æ—¥åˆ†ã®ã¿ã€Professionalä»¥ä¸Šã®ãƒ—ãƒ©ãƒ³ã§ã‚‚ç›´è¿‘7æ—¥åˆ†ã®ã¿ã—ã‹ä¿æŒã—ã¦ãã‚Œãšã€ã‚„ã‚„å¿ƒè¨±ãªã„ã§ã™ã€‚

# pg_dumpã«ã‚ˆã‚‹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’S3ã«æ¯æ—¥è‡ªå‹•ã§ä¿å­˜ã•ã›ã‚‹

é•·æœŸé–“ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ä¿æŒãŒå¿…è¦ãªå ´åˆã€pg_dumpã«ã‚ˆã‚‹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’S3ã«æ¯æ—¥è‡ªå‹•ã§ä¿å­˜ã•ã›ã‚‹Cron Jobã‚µãƒ¼ãƒ“ã‚¹ã‚’è‡ªå‰ã§å»ºã¦ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

å…·ä½“çš„ãªã‚„ã‚Šæ–¹ã¯ä»¥ä¸‹ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§èª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ã€‚

https://render.com/docs/backup-postgresql-to-s3

ãŸã ã€ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§è§£èª¬ã•ã‚Œã¦ã„ã‚‹æ–¹æ³•ã«ã¯ã‚„ã‚„å†—é•·ãªå†…å®¹ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã®ã§ã€æœ¬ç¨¿ã§ã¯å¿…è¦æœ€ä½é™ã®éƒ¨åˆ†ã ã‘ã«çµã£ã¦ç°¡æ½”ã«è§£èª¬ã—ã¾ã™ã€‚

# 1. Render.comã«Cron Jobã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½œæˆã™ã‚‹

ã¾ãšã¯Cron Jobã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½œã‚Šã¾ã—ã‚‡ã†ã€‚

ã‚µãƒ¼ãƒ“ã‚¹ã®å®Ÿè£…ã‚³ãƒ¼ãƒ‰ã®é››å½¢ãŒä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã§å…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚

https://github.com/render-examples/postgres-s3-backups

ã“ã‚Œã‚’ãƒ•ã‚©ãƒ¼ã‚¯ã—ã¦ä¿®æ­£ã‚’åŠ ãˆã¦ã„ãã¾ã™ã€‚

- `Dockerfile`ï¼šä¿®æ­£ä¸è¦
- `render.yaml`ï¼šå®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å†…å®¹ã«åˆã‚ã›ã¦è¦ä¿®æ­£
- `backup.sh`ï¼šåŠåˆ†ä»¥ä¸Šä¸è¦ãªã‚³ãƒ¼ãƒ‰ãªã®ã§ã€ä¸è¦éƒ¨åˆ†ã‚’ãƒãƒƒã‚µãƒªå‰Šé™¤ã—ã¤ã¤ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ã‚¡ã‚¤ãƒ«åã«ä½¿ã†æ—¥ä»˜ã‚’UTCã‹ã‚‰JSTã«è¦ä¿®æ­£

## `render.yaml` ã‚’ä¿®æ­£

ã¾ãš `render.yaml` ã§ã™ãŒã€ã“ã‚Œã¯Cron Jobã‚µãƒ¼ãƒ“ã‚¹ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãªã®ã§ã€å®Ÿéš›ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¯¾è±¡ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å†…å®¹ã«å¿œã˜ã¦ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚

ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã§ä¿®æ­£ã™ã‚‹ã“ã¨ã«ãªã‚‹ã§ã—ã‚‡ã†ã€‚

```diff
  services:
    - name: backup-db
      type: cron
-     schedule: "0 3 * * *"
+     schedule: "0 18 * * *" # 3am JST everyday
-     region: oregon
+     region: singapore
      env: docker
-     plan: standard
+     plan: starter
      dockerfilePath: ./Dockerfile
      autoDeploy: false
      envVars:
        - key: DATABASE_URL
          fromDatabase:
-           name: replace-with-your-postgres-instance-name
+           name: {å¯¾è±¡ã®PostgreSQLã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å}
            property: connectionString
        - key: AWS_REGION
-         sync: false
+         value: ap-northeast-1 # ä¾‹ãˆã°
        - key: S3_BUCKET_NAME
-         sync: false
+         value: {S3ãƒã‚±ãƒƒãƒˆå}
        - key: AWS_ACCESS_KEY_ID
          sync: false
        - key: AWS_SECRET_ACCESS_KEY
          sync: false
        - key: POSTGRES_VERSION
-         sync: false
+         value: 16 # ä¾‹ãˆã°
        - key: ALPINE_VERSION
-         sync: false
+         value: 3.20 # ä¾‹ãˆã°
```

ã“ã®å ´åˆã€`AWS_ACCESS_KEY_ID` `AWS_SECRET_ACCESS_KEY` ã®2ã¤ã®ç’°å¢ƒå¤‰æ•°ã ã‘ã¯ï¼ˆ`sync: false` ã®ã¾ã¾ã¨ã—ãŸã®ã§ï¼‰Web UIã‹ã‚‰æ‰‹å‹•ã§è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã‚Œã‚‰ã®ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã™ã¹ãå€¤ã¯å¾Œã»ã©å–å¾—ã—ã¾ã™ã€‚

## `backup.sh` ã‚’ä¿®æ­£

æ¬¡ã« `backup.sh` ã§ã™ãŒã€ã“ã¡ã‚‰ã¯ **ãƒã‚±ãƒƒãƒˆã®ä½œæˆã‚‚Cron Jobã‹ã‚‰è¡Œãˆã‚‹ã‚ˆã†ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹** ãŸã‚ã«ä¸è¦ãªã‚³ãƒ¼ãƒ‰ãŒãŸãã•ã‚“ã‚ã‚Šã¾ã™ã€‚

ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å…ˆã®ãƒã‚±ãƒƒãƒˆã¯æœ€åˆã«æ‰‹å‹•ã§ä½œæˆã™ã‚Œã°ãã®å¾Œã¯Cron Jobã‹ã‚‰ä½œæˆã—ç›´ã™ã“ã¨ã¯ãªã„ã®ã§ã€ä¸è¦ãªã‚³ãƒ¼ãƒ‰ã‚’ãƒãƒƒã‚µãƒªå‰Šé™¤ã—ã¦ã—ã¾ã„ã¾ã—ã‚‡ã†ã€‚

ã¾ãŸã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ã‚¡ã‚¤ãƒ«åã«ä½¿ã†æ—¥ä»˜ãŒã€ãã®ã¾ã¾ã ã¨UTCã«ãªã£ã¦ã—ã¾ã†ã®ã§ã€ã“ã‚Œã‚’JSTã§å‡ºåŠ›ã•ã‚Œã‚‹ã‚ˆã†ã«ä¿®æ­£ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

å…·ä½“çš„ãªä¿®æ­£å†…å®¹ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚

```diff
  #!/bin/bash
  
  set -o errexit -o nounset -o pipefail
  
  export AWS_PAGER=""
  
  s3() {
      aws s3 --region "$AWS_REGION" "$@"
  }
  
  s3api() {
      aws s3api "$1" --region "$AWS_REGION" --bucket "$S3_BUCKET_NAME" "${@:2}"
  }
  
- bucket_exists() {
-     s3 ls "$S3_BUCKET_NAME" &> /dev/null
- }
- 
- create_bucket() {
-     echo "Bucket $S3_BUCKET_NAME doesn't exist. Creating it now..."
- 
-     # create bucket
-     s3api create-bucket \
-         --create-bucket-configuration LocationConstraint="$AWS_REGION" \
-         --object-ownership BucketOwnerEnforced
- 
-     # block public access
-     s3api put-public-access-block \
-         --public-access-block-configuration \
-         "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true"
- 
-     # enable versioning for objects in the bucket 
-     s3api put-bucket-versioning --versioning-configuration Status=Enabled
- 
-     # encrypt objects in the bucket
-     s3api put-bucket-encryption \
-       --server-side-encryption-configuration \
-       '{"Rules": [{"ApplyServerSideEncryptionByDefault": {"SSEAlgorithm": "AES256"}}]}'
- }
- 
- ensure_bucket_exists() {
-     if bucket_exists; then
-         return
-     fi    
-     create_bucket
- }
- 
  pg_dump_database() {
      pg_dump  --no-owner --no-privileges --clean --if-exists --quote-all-identifiers "$DATABASE_URL"
  }
  
  upload_to_bucket() {
      # if the zipped backup file is larger than 50 GB add the --expected-size option
      # see https://docs.aws.amazon.com/cli/latest/reference/s3/cp.html
-     s3 cp - "s3://$S3_BUCKET_NAME/$(date +%Y/%m/%d/backup-%H-%M-%S.sql.gz)"
+     s3 cp - "s3://$S3_BUCKET_NAME/$(TZ=JST-9 date +%Y-%m-%d-%H-%M-%S.sql.gz)"
  }
  
  main() {
-     ensure_bucket_exists
      echo "Taking backup and uploading it to S3..."
      pg_dump_database | gzip | upload_to_bucket
      echo "Done."
  }
  
  main
```

ã‚³ãƒ¼ãƒ‰ã‚’GitHubã«pushã—ãŸã‚‰ã€Render.comã§Cron Jobã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½œæˆã—ã€GitHubãƒªãƒã‚¸ãƒˆãƒªã¨é€£æºã•ã›ã¦ãã ã•ã„ã€‚

# 2. AWSã®IAMãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã™ã‚‹ï¼ˆãƒã‚±ãƒƒãƒˆä½œæˆæ¨©é™ã¯ä¸è¦ï¼‰

å®Ÿéš›ã«Cron Jobã‚µãƒ¼ãƒ“ã‚¹ã‚’å‹•ã‹ã™ã«ã‚ãŸã‚Šã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å…ˆã®S3ãƒã‚±ãƒƒãƒˆã®ãƒ•ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ã®ã¿ã‚’è¨±å¯ã•ã‚Œã¦ã„ã‚‹IAMãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã™ã‚‹ãªã©ã—ã¦èªè¨¼æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ã‚‡ã†ã€‚

[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://render.com/docs/backup-postgresql-to-s3#create-aws-credentials) ã®èª¬æ˜ã§ã¯ã€ãƒã‚±ãƒƒãƒˆã®ä½œæˆã‚‚ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«ã€Œãƒã‚±ãƒƒãƒˆæŒ‡å®šãªã—ã®S3ãƒ•ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ã€ã‚’è¨±å¯ã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ãŠã‚Šã€ã¨ã¦ã‚‚å¾®å¦™ã§ã™ã€‚

å‰é …ã§è¿°ã¹ãŸã¨ãŠã‚Šã€ãƒã‚±ãƒƒãƒˆã®ä½œæˆã¯æœ€åˆã«ä¸€å›ã ã‘æ‰‹å‹•ã§è¡Œã†ã¨ã„ã†å‰æã«ã™ã‚Œã°ã€ãƒã‚±ãƒƒãƒˆæŒ‡å®šã§S3ãƒ•ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã§ãã‚‹ã®ã§å®‰å…¨ã‹ã¤ç°¡å˜ã§ã™ã€‚

S3ãƒã‚±ãƒƒãƒˆã¨IAMãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ãŸã‚‰ã€ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã‚’å–å¾—ã—ã€Cron Jobã‚µãƒ¼ãƒ“ã‚¹ã® `AWS_ACCESS_KEY_ID` `AWS_SECRET_ACCESS_KEY` ã®2ã¤ã®ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚

# 3. å®Ÿè¡Œã—ã¦ã¿ã‚‹

`Trigger Run` ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦Cron Jobã‚’å®Ÿè¡Œã•ã›ã¦ã¿ã¾ã™ã€‚

<img width="671" alt="image.png (15.4 kB)" src="https://img.esa.io/uploads/production/attachments/15064/2025/04/01/77821/4dacb6c0-090f-4cde-97cb-7c4ac16791cd.png">

S3ãƒã‚±ãƒƒãƒˆã‚’è¦—ã„ã¦ã¿ã¦ã€`2025-04-01-00-00-12.sql.gz` ã®ã‚ˆã†ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ã‚Œã°æˆåŠŸã§ã™ã€‚

# 4. ç›´è¿‘1ãƒ¶æœˆåˆ†ã ã‘ã‚’æ®‹ã—ã¦å¤ããªã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒè‡ªå‹•ã§å‰Šé™¤ã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹

æœ€å¾Œã«ã€ç›´è¿‘1ãƒ¶æœˆåˆ†ã ã‘ã‚’æ®‹ã—ã¦å¤ããªã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒè‡ªå‹•ã§å‰Šé™¤ã•ã‚Œã‚‹ã‚ˆã†ã«S3ãƒã‚±ãƒƒãƒˆã‚’è¨­å®šã—ã¾ã™ã€‚

ã“ã‚Œã¯ [å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://render.com/docs/backup-postgresql-to-s3) ã§ã¯ç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã›ã‚“ãŒã€S3ã® [ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒ«ãƒ¼ãƒ«](https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/userguide/object-lifecycle-mgmt.html) ã‚’ä½¿ã£ã¦ç°¡å˜ã«å®Ÿç¾ã§ãã¾ã™ã€‚

ãƒã‚±ãƒƒãƒˆã®ã€Œç®¡ç†ã€ã‚’é–‹ã„ã¦ã€ã€Œãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒ«ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

<img width="1071" alt="image.png (119.1 kB)" src="https://img.esa.io/uploads/production/attachments/15064/2025/04/01/77821/3fc1a732-d103-42f9-a9e5-9d2bee6f468b.png">

ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ãªå†…å®¹ã§ä½œæˆã™ã‚Œã°ã€ä½œæˆã•ã‚Œã¦ã‹ã‚‰31æ—¥ãŒçµŒéã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒè‡ªå‹•ã§å®Œå…¨ã«å‰Šé™¤ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

<img width="1356" alt="image.png (363.1 kB)" src="https://img.esa.io/uploads/production/attachments/15064/2025/04/01/77821/13c39614-b143-423d-9c22-a5908c501ea3.png">
