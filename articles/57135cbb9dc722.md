---
title: "[PHP] Herokuã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã§require-devã®ä¾å­˜ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹"
emoji: "ğŸ»"
type: "tech"
topics: ["php", "symfony", "heroku"]
published: true
published_at: 2020-05-19
---

:::message
ã“ã®è¨˜äº‹ã¯ã€2020-05-19ã«åˆ¥ã®ãƒ–ãƒ­ã‚°åª’ä½“ã«æŠ•ç¨¿ã—ãŸè¨˜äº‹ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ã™ã€‚
:::

# èª²é¡Œ

[Herokuæ¨™æº–ã®PHP buildpack](https://elements.heroku.com/buildpacks/heroku/heroku-buildpack-php) ã‚’ä½¿ã£ã¦PHPã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹éš›ã€å®Ÿè¡Œã•ã‚Œã‚‹ãƒ“ãƒ«ãƒ‰ã‚³ãƒãƒ³ãƒ‰ã¯

```bash
$ composer install --no-dev --prefer-dist --optimize-autoloader --no-interaction
```

ã¨ãªã£ã¦ã„ã¾ã™ã€‚ï¼ˆ[å‚è€ƒ](https://devcenter.heroku.com/articles/php-support#build-behavior)ï¼‰

ã¤ã¾ã‚Šã€ `require-dev` ã§ä¾å­˜ã—ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã›ã‚“ã€‚

ã—ã‹ã—ã€ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã¨ã—ã¦Herokuã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆãªã©ã€ä¸€æ™‚çš„ã«ã‚¢ãƒ—ãƒªã®ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’ONã«ã™ã‚‹ãŸã‚ã« `require-dev` ã®ä¾å­˜ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

> ä¾‹ãˆã°Symfonyãªã‚‰ã€ç„¡é€ ä½œã«Herokuã®ç’°å¢ƒå¤‰æ•°ã§ [`APP_ENV`](https://symfony.com/doc/current/configuration.html#selecting-the-active-environment) ã‚’ `dev` ã«ã—ã¦ã—ã¾ã†ã¨ã€ `require-dev` ã§ä¾å­˜ã—ã¦ã„ã‚‹ã‚¯ãƒ©ã‚¹ãŒè¦‹ã¤ã‹ã‚‰ãš `ClassNotFoundError` ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚
> 
> ![](https://tva1.sinaimg.cn/large/007S8ZIlgy1get3jye81gj31n808mjtm.jpg)

# è§£æ±ºç­–

Herokuã§ã¯ `composer install` ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œå¾Œã«

```bash
composer compile --no-dev --no-interaction
```

ã¨ã„ã† [ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒãƒ³ãƒ‰](https://getcomposer.org/doc/articles/scripts.md#writing-custom-commands) ãŒå®Ÿè¡Œã•ã‚Œã‚‹ä»•æ§˜ï¼ˆ[å‚è€ƒ](https://devcenter.heroku.com/articles/php-support#custom-compile-step)ï¼‰ãªã®ã§ã€ã“ã“ã§æ”¹ã‚ã¦ `require-dev` ã®ä¾å­˜ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã‚ã’ã‚Œã°è§£æ±ºã§ãã¾ã™ã€‚

```json
# composer.json
{
    "scripts": {
        "compile": [
            "composer install --prefer-dist --optimize-autoloader --no-interaction",
        ]
    },
}
```

ãŸã ã—ã€ã“ã‚Œã ã¨æ™®æ®µ `APP_ENV=prod` ã§é‹ç”¨ã—ã¦ã„ã‚‹ã¨ãã«ã‚‚å¸¸ã« `composer install` ãŒ2å›å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã«ãªã‚ŠéåŠ¹ç‡ãªã®ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã« `APP_ENV=dev` ã®å ´åˆã«ã®ã¿å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã®ãŒã‚ˆã„ã§ã—ã‚‡ã†ã€‚

```json
{
    "scripts": {
        "compile": [
            "if [ $APP_ENV = 'dev' ]; then composer install --prefer-dist --optimize-autoloader --no-interaction; fi",
        ]
    },
}
```

> ã¡ãªã¿ã«ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒãƒ³ãƒ‰ãªã‚“ã‹ã‚‚ã“ã® `compile` ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒãƒ³ãƒ‰å†…ã§å®Ÿè¡Œã™ã‚‹ã®ãŒã‚»ã‚ªãƒªãƒ¼ã§ã™ã­ã€‚
> 
> ```json
> {
>     "scripts": {
>         "compile": [
>             "if [ $APP_ENV = 'dev' ]; then composer install --prefer-dist --optimize-autoloader --no-interaction; fi",
>             "php bin/console doctrine:migrations:migrate -n --no-debug"
>         ]
>     },
> }
> ```

# `app.json` ã® `scripts.postdeploy` ã§ã‚‚ã§ãã‚‹ï¼Ÿ

* [app.json ã®ã‚¹ã‚­ãƒ¼ãƒ | Heroku Dev Center `#scripts`](https://devcenter.heroku.com/ja/articles/app-json-schema#scripts)
* [ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ—ãƒª (æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³) | Heroku Dev Center `#the-postdeploy-script`](https://devcenter.heroku.com/ja/articles/github-integration-review-apps#the-postdeploy-script)

ã“ã®è¾ºã‚’è¦‹ã‚‹é™ã‚Šã€`composer.json` ã® `compile` ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã‚ãšã« `app.json` ã‚’

```json
{
    "scripts": {
        "postdeploy": "composer install --prefer-dist --optimize-autoloader --no-interaction && php bin/console doctrine:migrations:migrate -n --no-debug"
    }
}
```

ã¿ãŸã„ãªå†…å®¹ã§ä½œã£ã¦ãŠãã§ã‚‚æœŸå¾…ã©ãŠã‚Šå‹•ãã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ãŒã€æœªç¢ºèªã§ã™ã”ã‚ã‚“ãªã•ã„ğŸ™

# ã¡ãªã¿ã«ï¼šSymfonyã®å ´åˆã®æ³¨æ„ç‚¹

## æ³¨æ„ç‚¹1

ãªãŠã€å…ˆã«æŒ™ã’ãŸSymfonyã‚’ `APP_ENV=dev` ã§å‹•ã‹ã—ãŸã„ã¨ã„ã†ã‚±ãƒ¼ã‚¹ã§ã¯ã€ãŸã¨ãˆã“ã®æ–¹æ³•ã§ `require-dev` ã®ä¾å­˜ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨ã—ã¦ã‚‚ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã®æ™‚ç‚¹ã§ `APP_ENV=dev` ã‚’ã‚»ãƒƒãƒˆã—ã¦ã—ã¾ã£ã¦ã„ã‚‹ã¨ `ClassNotFoundError` ã«ãªã‚Šã¾ã™ã€‚

ãªãœãªã‚‰ã€1å›ç›®ã® `composer install --no-dev` ã®ç›´å¾Œã« `post-install-cmd` ãƒ•ãƒƒã‚¯ã§ `bin/console cache:clear` ãªã©ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«SymfonyãŒèµ·å‹•ã•ã‚Œã¦ã—ã¾ã†ã‹ã‚‰ã§ã™ã€‚

~~ãªã®ã§ã€ã‚ãã¾ã§æ™®æ®µã¯ `APP_ENV=prod` ã«ã—ã¦ãŠã„ã¦ã€ã„ã–ãƒ‡ãƒãƒƒã‚°ã—ãŸã„ã¨ãã« `APP_ENV=dev` ã«å¤‰æ›´ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã€ã¨ã„ã†ã‚ˆã†ãªä½¿ã„æ–¹ã«ãªã‚Šã¾ã™ã€‚~~

ã“ã‚Œã‚’å›é¿ã™ã‚‹ã«ã¯ã€`post-install-cmd` ã§ `@auto-scripts` ï¼ˆ`cache:clear` ãªã©ã‚’å«ã‚€ï¼‰ã‚’ `--no-dev` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒä»˜ã„ã¦ã„ãªã„å ´åˆã®ã¿å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ã™ã‚Œã°ã‚ˆã„ã§ã™ã€‚

å…·ä½“çš„ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã« `COMPOSER_DEV_MODE` ç’°å¢ƒå¤‰æ•°ãŒ `0` ã§ãªã„ï¼ˆï¼ `--no-dev` ãŒä»˜ã„ã¦ã„ãªã„ï¼‰å ´åˆã«ã®ã¿ `composer auto-scripts` ã«ã‚ˆã£ã¦ `@auto-scripts` ã‚’å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```diff
  "post-install-cmd": [
-     "@auto-scripts"
+     "if [ $COMPOSER_DEV_MODE -ne 0 ]; then composer auto-scripts; fi"
  ]
```

> å‚è€ƒï¼š[Symfony4.4ã‚’GAE/phpã§å‹•ã‹ã™ | polidog lab](https://polidog.jp/2020/06/17/symfony_gae/)

## æ³¨æ„ç‚¹2

ã“ã“ã¾ã§ã®å¯¾å¿œã ã¨ã€Herokuã§å®Ÿéš›ã«ç”»é¢ã‚’é–‹ã„ãŸã¨ãã«

```
Mixed Content: The page at 'https://xxx.herokuapp.com' was loaded over HTTPS, but requested an insecure XMLHttpRequest endpoint 'http://xxx.herokuapp.com/_wdt/xxxxxx'. This request has been blocked; the content must be served over HTTPS.
```

ã¨ã„ã£ãŸã‚¨ãƒ©ãƒ¼ã«ã‚ˆã‚Šãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ãŒè¡¨ç¤ºã•ã‚Œãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ã“ã®å ´åˆã€`config/packages/framework.yaml` ã«ä»¥ä¸‹ã®ã‚ˆã†ãªè¨­å®šã‚’è¿½è¨˜ã™ã‚‹ã“ã¨ã§ã‚¨ãƒ©ãƒ¼ã‚’è§£æ¶ˆã§ãã¾ã™ã€‚

> ä¿¡é ¼ã§ãã‚‹ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã«å¯¾ã—ã¦ã—ã‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒãƒ¼ãŒå¿œç­”ã—ãªã„ã‚ˆã†ã«æ§‹æˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒå‰æã®è¨­å®šã§ã™ã€‚Herokuä»¥å¤–ã®ç’°å¢ƒã§åŒæ§˜ã®è¨­å®šã‚’è¡Œã†å ´åˆã¯ååˆ†ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

```yaml
when@dev:
  framework:
    trusted_proxies: REMOTE_ADDR
```

> å‚è€ƒï¼š[How to Configure Symfony to Work behind a Load Balancer or a Reverse Proxy (Symfony Docs) `#but-what-if-the-ip-of-my-reverse-proxy-changes-constantly`](https://symfony.com/doc/current/deployment/proxies.html#but-what-if-the-ip-of-my-reverse-proxy-changes-constantly)


# ã¾ã¨ã‚

* PHPãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’Herokuã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹éš›ã«require-devã®ä¾å­˜ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã‘ã‚Œã°ã€`APP_ENV=dev` ã®å ´åˆã«ã®ã¿ `compile` ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã§æ”¹ã‚ã¦ `composer install` ã—ã¦ã‚ã’ã‚Œã°ã‚ˆã„
