---
title: "[Symfony] Doctrineã®Embeddableã§ValueObjectã«ã‚‚ã‚¹ã‚­ãƒ¼ãƒã‚’æŒãŸã›ã‚‹"
emoji: "ğŸ»"
type: "tech"
topics: ["php", "symfony", "doctrine"]
published: true
published_at: 2020-06-02
---

:::message
ã“ã®è¨˜äº‹ã¯ã€2020-06-02ã«åˆ¥ã®ãƒ–ãƒ­ã‚°åª’ä½“ã«æŠ•ç¨¿ã—ãŸè¨˜äº‹ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ã™ã€‚
:::

# ValueObjectã¨ã¯

DDDã®æ–‡è„ˆã«ãŠã‘ã‚‹ValueObjectï¼ˆå€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰ã®æ­£ã—ã„å®šç¾©ã¯ [ã€ã‚¨ãƒªãƒƒã‚¯ãƒ»ã‚¨ãƒ´ã‚¡ãƒ³ã‚¹ã®ãƒ‰ãƒ¡ã‚¤ãƒ³é§†å‹•è¨­è¨ˆã€](https://www.amazon.co.jp/dp/4798121967?tag=ttskch-22) ãªã©ã‚’ã”å‚ç…§ãã ã•ã„ğŸ™

ã“ã“ã§ã¯ã€

* å€¤ã¨è¨€ã£ã¦ã‚‚ã€Œæ•´æ•°ã€ã‚„ã€Œæ–‡å­—åˆ—ã€ã®ã‚ˆã†ãªãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–ãªå€¤ã§ã¯ãªãã€ã€Œè²¨å¹£ã€ã‚„ã€Œä½æ‰€ã€ã®ã‚ˆã†ã«ã‚¹ã‚­ãƒ¼ãƒã‚’æŒã£ã¦ã„ã¦ãƒ—ãƒ­ã‚°ãƒ©ãƒ ä¸Šã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦è¡¨ç¾ã•ã‚Œã‚‹ã‚ˆã†ãªå€¤

ã¨ã„ã†ãã‚‰ã„ã®æ„å‘³ã§ValueObjectã¨ã„ã†è¨€è‘‰ã‚’ä½¿ã„ã¾ã™ğŸ™

# Doctrineã§ValueObjectã‚’æ‰±ã†æ–¹æ³•

## ã‚ˆããªã„ä¾‹ï¼š ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã—ã¦1ã‚«ãƒ©ãƒ ã«ã¶ã£è¾¼ã‚€

ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ãª `Person` ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’è€ƒãˆã¾ã™ã€‚ `Person` ã¯ `$address` ã¨ã„ã† `Address` ã‚¯ãƒ©ã‚¹å‹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŒã£ã¦ã„ã¾ã™ã€‚

```php
/**
 * @ORM\Entity(repositoryClass="PersonRepository")
 */
class Person
{
    /**
     * @ORM\Id()
     * @ORM\GeneratedValue()
     * @ORM\Column(type="integer")
     */
    private $id;

    /**
     * @ORM\Column(type="string", length=255)
     */
    private $name;
    
    /**
     * @ORM\Column(type="string", length=255)
     */
    private $email;
    
    /**
     * @var Address
     *
     * @ORM\Column(type="object")
     */
    private $address;
    
    // ...
}
```

```php
class Address
{
    /**
     * @var string
     */
    private $zipCode;
    
    /**
     * @var string
     */
    private $prefecture;
    
    /**
     * @var string
     */
    private $city;
    
    /**
     * @var string
     */
    private $line;
    
    // ...
}
```

`Person` ã‚¯ãƒ©ã‚¹ã®ä»¥ä¸‹ã®ç®‡æ‰€ã§ã€ `$address` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®DBAL Typeã¨ã—ã¦ [`object`](https://www.doctrine-project.org/projects/doctrine-dbal/en/2.10/reference/types.html#object) ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

```php
    /**
     * @var Address
     *
     * @ORM\Column(type="object")
     */
    private $address;
```

ã“ã‚Œã«ã‚ˆã‚Šã€ `$address` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯

* DBä¸Šã§ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã—ãŸæ–‡å­—åˆ—ã¨ã—ã¦ä¿å­˜ã•ã‚Œ
* ãƒ—ãƒ­ã‚°ãƒ©ãƒ ä¸Šã§ã¯ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã¦ `Address` ã‚¯ãƒ©ã‚¹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦åˆ©ç”¨ã§ãã‚‹

ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

å…·ä½“çš„ã«ã¯ã€DoctrineãŒç”Ÿæˆã™ã‚‹ `person` ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¹ã‚­ãƒ¼ãƒã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

| ã‚«ãƒ©ãƒ å | å‹ |
| --- | --- |
| `id` | `int` |
| `name` | `varchar(255)` |
| `email` | `varchar(255)` |
| `address` | `longtext` |

`longtext` ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºçµæœã®æ–‡å­—åˆ—ã‚’ãƒ‰ã‚«ãƒƒã¨ä¿å­˜ã™ã‚‹æ„Ÿã˜ã§ã™ã­ã€‚

> `object` ã®ä»£ã‚ã‚Šã« [`json`](https://www.doctrine-project.org/projects/doctrine-dbal/en/2.10/reference/types.html#json) ã‚’ä½¿ã£ã¦ã‚‚ã€ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã®æ–¹å¼ãŒé•ã†ã ã‘ã§åŒã˜ã‚ˆã†ãªçµæœãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚

### ã‚ˆããªã„ç‚¹

ã“ã®æ–¹æ³•ã ã¨ã€å…ˆã«è¿°ã¹ãŸã¨ãŠã‚ŠDBä¸Šã§ã¯1ã‚«ãƒ©ãƒ ã«æ–‡å­—åˆ—ã‚’ãƒ‰ã‚«ãƒƒã¨ä¿å­˜ã—ã¦ã„ã‚‹ã ã‘ãªã®ã§ã€ **æ­£å¸¸ã§ãªã„å€¤ãŒä¿å­˜ã•ã‚Œå¾—ã‚‹** ã¨ã„ã†ç‚¹ã§ã¨ã¦ã‚‚ä¸å®‰ã§ã™ã€‚

ä¾‹ãˆã°ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«ãƒŸã‚¹ãŒã‚ã£ã¦ `Address` ã‚¯ãƒ©ã‚¹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä»¥å¤–ã®ã‚‚ã®ã‚’ `$address` ã«å…¥ã‚Œã¦ã—ã¾ã£ã¦ã„ã¦ã‚‚ã€DBçš„ã«ã¯ä½•ã®ã‚¨ãƒ©ãƒ¼ã«ã‚‚ãªã‚‰ãšã«ä¿å­˜ã§ãã¦ã—ã¾ã„ã¾ã™ã‚ˆã­ã€‚

ã€Œãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’privateã«ã—ã¦setterã®å¼•æ•°å‹å®£è¨€ã‚’ `Address` ã«ã—ã¦ãŠã‘ã°ã„ã„ã ã‘ãªã‚“ã ã‹ã‚‰ã€ãƒŸã‚¹ã—ã‚ˆã†ãŒãªã„ã˜ã‚ƒã‚“ã€

ã¨ã„ã†å£°ãŒèã“ãˆã¦ããã†ã§ã™ãŒã€ãã®éä¿¡ã¯ã„ã¤ã‹å‘½å–ã‚Šã«ãªã‚Šã¾ã™ç¬‘

ã‚„ã¯ã‚Š **ã€ŒDBã«é–“é•ã£ãŸã‚‚ã®ã‚’å…¥ã‚Œã‚‹ã“ã¨ã¯ç‰©ç†çš„ã«ã§ããªã„ã€**  ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã«è¶Šã—ãŸã“ã¨ã¯ãªã„ã§ã—ã‚‡ã†ã€‚

## ã‚ˆã„ä¾‹ï¼šEmbeddableã‚’ä½¿ã£ã¦ValueObjectã‚’DBã‚¹ã‚­ãƒ¼ãƒã«å±•é–‹ã™ã‚‹

å®Ÿã¯Doctrineã«ã¯ValueObjectã‚’æ‰±ã†ãŸã‚ã® [`Embeddable`](https://www.doctrine-project.org/projects/doctrine-orm/en/2.7/tutorials/embeddables.html) ã¨ã„ã†æ©Ÿèƒ½ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã“ã‚Œã‚’ä½¿ãˆã°ã€ValueObjectã‚’DBã‚¹ã‚­ãƒ¼ãƒã«å±•é–‹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

å…ˆã»ã©ã® `Person` ã¨ `Address` ã®ä¾‹ã‚’ `Embedded` ã‚’ä½¿ã£ã¦æ›¸ãç›´ã™ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```diff
/**
 * @ORM\Entity(repositoryClass="PersonRepository")
 */
class Person
{
    /**
     * @ORM\Id()
     * @ORM\GeneratedValue()
     * @ORM\Column(type="integer")
     */
    private $id;

    /**
     * @ORM\Column(type="string", length=255)
     */
    private $name;
    
    /**
     * @ORM\Column(type="string", length=255)
     */
    private $email;
    
    /**
     * @var Address
     *
+    * @ORM\Embedded(class="Address")
-    * @ORM\Column(type="object")
     */
    private $address;
    
    // ...
```

```php
/**
 * @ORM\Embeddable()
 */
class Address
{
    /**
     * @ORM\Column(type="string", length=255)
     */
    private $zipCode;
    
    /**
     * @ORM\Column(type="string", length=255)
     */
    private $prefecture;
    
    /**
     * @ORM\Column(type="string", length=255)
     */
    private $city;
    
    /**
     * @ORM\Column(type="string", length=255)
     */
    private $line;
    
    // ...
```

ã“ã†ã—ã¦ãŠãã¨ã€ `person` ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¹ã‚­ãƒ¼ãƒã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

| ã‚«ãƒ©ãƒ å | å‹ |
| --- | --- |
| `id` | `int` |
| `name` | `varchar(255)` |
| `email` | `varchar(255)` |
| `address_zip_code` | `varchar(255)` |
| `address_prefecture` | `varchar(255)` |
| `address_city` | `varchar(255)` |
| `address_line` | `varchar(255)` |

`Address` ã‚¯ãƒ©ã‚¹ã®å„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚«ãƒ©ãƒ ã¨ã—ã¦ç‹¬ç«‹ã—ã€ `Address` ã‚¯ãƒ©ã‚¹ã®æ§‹é€ ãŒæ˜ç¢ºã«DBã‚¹ã‚­ãƒ¼ãƒã«åæ˜ ã•ã‚Œã¦ã„ã¾ã™ã­ã€‚

ã“ã‚Œãªã‚‰é–“é•ã£ãŸæ§‹é€ ã§å€¤ã‚’ä¿å­˜ã™ã‚‹ã“ã¨ãŒç‰©ç†çš„ã«ä¸å¯èƒ½ãªã®ã§ã€ã¨ã¦ã‚‚å®‰å¿ƒæ„ŸãŒã‚ã‚Šã¾ã™ğŸ‘

### ã¤ã„ã§ã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚ã—ã‚„ã™ã„

`Embeddable` ã‚’ä½¿ã£ã¦ãŠãã¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚ã—ã‚„ã™ã„ã§ã™ã€‚

ä¾‹ãˆã° `Address` ã‚¯ãƒ©ã‚¹ã®æ§‹é€ ã‚’

```diff
- private $line;
+ private $line1;
+ private $line2;
```

ã®ã‚ˆã†ã«å¤‰æ›´ã—ãŸããªã£ãŸã¨ãã€ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºæ–‡å­—åˆ—ã‚’ `longtext` ã«æ”¾ã‚Šè¾¼ã‚€æ–¹æ³•ã ã¨ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ãŠã„ã¦

* `adderss` ã‚«ãƒ©ãƒ ã®ä¸­èº«ã‚’PHPã§ `unserialize()` ã—ã¦
* æ–°ã—ã„æ§‹é€ ã® `Address` ã‚¯ãƒ©ã‚¹ã«å¯¾å¿œã™ã‚‹ã‚ˆã†æ•´å½¢ã—ã¦
* å†ã³ `serialize()` ã—ã¦ä¿å­˜ã™ã‚‹

ã¨ã„ã†ã“ã¨ã‚’å…¨ãƒ¬ã‚³ãƒ¼ãƒ‰ã«å¯¾ã—ã¦è¡Œã†å¿…è¦ãŒã‚ã‚‹ã§ã—ã‚‡ã†ã€‚

å˜ç´”ã«ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ›¸ãã“ã¨ãŒé¢å€’ã§ã™ã—ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè£…ã«ãƒŸã‚¹ãŒå…¥ã‚Šè¾¼ã‚€ä½™åœ°ãŒå¤§ã„ã«ã‚ã£ã¦ã“ã‚Œã‚‚æ€–ã„ã§ã™ã€‚

`Embeddable` ã‚’ä½¿ã£ã¦ã‚¹ã‚­ãƒ¼ãƒã‚’æŒãŸã›ã¦ãŠã‘ã°ã€ã“ã®ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã§ã‚‚å˜ç´”ã«

```diff
/**
 * @ORM\Embeddable()
 */
class Address
{
    /**
     * @ORM\Column(type="string", length=255)
     */
    private $zipCode;
    
    /**
     * @ORM\Column(type="string", length=255)
     */
    private $prefecture;
    
    /**
     * @ORM\Column(type="string", length=255)
     */
    private $city;
    
    /**
     * @ORM\Column(type="string", length=255)
     */
-   private $line;
+   private $line1;

+   /**
+    * @ORM\Column(type="string", length=255)
+    */
+   private $line2;

    // ...
```

ã¨ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¦

```bash
$ bin/console doctrine:migrations:diff
```

ã‚’å®Ÿè¡Œã™ã‚‹ã ã‘ã§é©åˆ‡ãªãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè‡ªå‹•ç”Ÿæˆã§ãã¦æ¥½ã§ã™ã—ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å†…å®¹ã‚‚PHPã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ã†å¿…è¦ã¯ãªãSQLæ–‡ã®å®Ÿè¡Œã ã‘ã§æ¸ˆã‚€ã®ã§ã€ãƒŸã‚¹ãŒå…¥ã‚Šè¾¼ã‚€ä½™åœ°ãŒãªãå®‰å¿ƒã§ã™ğŸ‘

# ã¾ã¨ã‚

ã¨ã„ã†ã‚ã‘ã§ã€

* Symfonyï¼ˆDoctrineï¼‰ã§ValueObjectã‚’æ‰±ã„ãŸã„ã¨ãã¯ã€[Embeddable](https://www.doctrine-project.org/projects/doctrine-orm/en/2.7/tutorials/embeddables.html) ã‚’ä½¿ã£ã¦ValueObjectã«ã‚‚ã‚¹ã‚­ãƒ¼ãƒã‚’æŒãŸã›ã‚‹ã¨ã‚ˆã„

ã¨ã„ã†ãŠè©±ã§ã—ãŸã€‚
