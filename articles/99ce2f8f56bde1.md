---
title: "jms/serializerã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å†å¸°çš„å‚ç…§ã‚’ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã§ããªã„"
emoji: "ğŸ»"
type: "tech"
topics: ["php", "symfony"]
published: true
published_at: 2018-06-26
---

:::message
ã“ã®è¨˜äº‹ã¯ã€2018-06-26ã«åˆ¥ã®ãƒ–ãƒ­ã‚°åª’ä½“ã«æŠ•ç¨¿ã—ãŸè¨˜äº‹ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ã™ã€‚
:::

# ã‚„ã‚ŠãŸã‹ã£ãŸã“ã¨

OneToMany/ManyToOneãªãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æŒã¤2ã¤ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ [jms/serializer](https://github.com/schmittjoh/serializer) ã§ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã—ãŸã‹ã£ãŸã€‚

## ã‚µãƒ³ãƒ—ãƒ«

```php
// User.php

class User
{
    public $name;

    /**
     * @var Post[]
     */
    public $posts;
}
```

```php
// Post.php

class Post
{
    public $title;

    /**
     * @var User
     */
    public $user;
}
```

```php
// index.php

function getUser() {
    $user = new User();
    $user->name = 'user1';

    for ($i = 0; $i < 2; $i++) {
        $post = new Post();
        $post->title = 'post' . ($i + 1);
        $post->user = $user;
        $user->posts[] = $post;
    }

    return $user;
}

$serializer = SerializerBuilder::create()->build();
$json = $serializer->serialize(getUser(), 'json');

echo $json;
```

## çµæœ1

```json
{
	"name": "user1",
	"posts": [
		{
			"title": "post1"
		},
		{
			"title": "post2"
		}
	]
}
```

`posts.user` ãŒæ¶ˆãˆå»ã£ã¦ã‚‹ã€‚

`posts.user` ã«ã¯ã©ã¡ã‚‰ã‚‚è¦ªã§ã‚ã‚‹ `user1` ã® `User` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå…¥ã£ã¦ã„ã‚‹ã®ã§ã€ç¢ºã‹ã«ã“ã®ã¾ã¾ã ã¨ç„¡é™ã«å†å¸°ã—ã¦ã—ã¾ã†ã®ã§æ¶ˆãˆã‚‹ä»•æ§˜ã¯æ­£ã—ã„ã‚ˆã†ã«æ€ã†ã€‚

ã˜ã‚ƒã‚ã€ [`MaxDepth` ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿](http://jmsyst.com/libs/serializer/master/reference/annotations#maxdepth) ã‚’ä½¿ã£ã¦å†å¸°ã®æ·±ã•ã‚’è¨­å®šã™ã‚Œã°å®‰å…¨ã«ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã§ãã‚‹ã®ã§ã¯ï¼Ÿã¨è€ƒãˆãŸã€‚

## ã‚„ã£ã¦ã¿ãŸ

```diff
// index.php

+ \Doctrine\Common\Annotations\AnnotationRegistry\AnnotationRegistry::registerLoader('class_exists');

function getUser() {
    $user = new User();
    :
    :

- $serializer = SerializerBuilder::create()->build();
+ $serializer = SerializerBuilder::create()
+     ->setSerializationContextFactory(function () {
+         return SerializationContext::create()
+             ->enableMaxDepthChecks()  // MaxDepthãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ä½¿ç”¨ã‚’æœ‰åŠ¹åŒ–
+         ;
+     })
+     ->build()
+ ;
```

```diff
// Post.php

+ use JMS\Serializer\Annotation\MaxDepth;

class Post
{
    public $title;

    /**
     * @var User
+    *
+    * @MaxDepth(1)
     */
    public $user;
}
```

> ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¯ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®ä»–ã«XMLã‚„YAMLã§ã‚‚è¨­å®šå¯èƒ½ï¼ˆ[å‚è€ƒ1](http://jmsyst.com/libs/serializer/master/configuration#configuring-metadata-locations)ã€[å‚è€ƒ2](http://jmsyst.com/libs/serializer/master/reference)ï¼‰

## çµæœ2

```json
{
	"name": "user1",
	"posts": [
		{
			"title": "post1"
		},
		{
			"title": "post2"
		}
	]
}
```

å¤‰ã‚ã‚‰ãšã€‚

## nullã‚’ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã‚‹

ï¼ˆprintãƒ‡ãƒãƒƒã‚°ã§ï¼‰èª¿ã¹ãŸã¨ã“ã‚ã€

> ```php
> // JsonSerializationVisitor.php
>
> if ((null === $v && $context->shouldSerializeNull() !== true)
>     || (true === $metadata->skipWhenEmpty && ($v instanceof \ArrayObject || \is_array($v)) && 0 === count($v))
> ) {
>     return;
> }
> ```
> <https://github.com/schmittjoh/serializer/blob/1.12.1/src/JMS/Serializer/JsonSerializationVisitor.php#L146-L150>

ã“ã“ã§returnã—ã¦ã‚‹ã‚ˆã†ã ã£ãŸã®ã§ã€åˆ†ã‹ã‚Šã‚„ã™ã•ã®ãŸã‚ã« `$context->shouldSerializeNull()` ãŒtrueã«ãªã‚‹ã‚ˆã†ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®šã—ã¦ã¿ãŸã€‚

```diff
// index.php

$serializer = SerializerBuilder::create()
    ->setSerializationContextFactory(function () {
        return SerializationContext::create()
            ->enableMaxDepthChecks()
+           ->setSerializeNull(true)
        ;
    })
    ->build()
;
```

## çµæœ3

```json
{
	"name": "user1",
	"posts": [
		{
			"title": "post1",
			"user": null
		},
		{
			"title": "post2",
			"user": null
		}
	]
}
```

ã†ã‚€ã€‚ç¢ºã‹ã« `posts.user` ã¯nullã«ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã¦ã„ã‚‹ã€‚

## nullã«ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã—ã¦ã„ã‚‹ç®‡æ‰€ã‚’ç‰¹å®š

ï¼ˆprintãƒ‡ãƒãƒƒã‚°ã§ï¼‰èª¿ã¹ãŸã¨ã“ã‚ã€

> ```php
> // GraphNavigator.php
>
> if ($context->isVisiting($data)) {
>     return null;
> }
> ```
> 
> <https://github.com/schmittjoh/serializer/blob/1.12.1/src/JMS/Serializer/GraphNavigator.php#L151-L153>

ã“ã“ã§ `$data` ï¼ˆä¸­èº«ã¯ `User` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼‰ãŒ `isVisiting` ã ã¨å•ç­”ç„¡ç”¨ã§nullãŒreturnã•ã‚Œã‚‹ã“ã¨ãŒåˆ†ã‹ã£ãŸã€‚

ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ãƒˆãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã§visitã—ã¤ã¤ã€visitä¸­ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¹ã‚¿ãƒƒã‚­ãƒ³ã‚°ã—ã¦ãŠã„ã¦ã€2å›ç›®ä»¥é™ã«visitã—ãŸå ´åˆã¯ `isVisiting` ã¨è¦‹ãªã—ã¦nullã‚’è¿”ã™ã¨ã„ã†å®Ÿè£…ã¿ãŸã„ã€‚

> <https://github.com/schmittjoh/serializer/blob/1.12.1/src/JMS/Serializer/SerializationContext.php#L65>

## å®Ÿé¨“ï¼šåŒä¸€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã˜ã‚ƒãªã‘ã‚Œã°è¡Œã‘ã‚‹ã®ã‹

visitã—ãŸ `User` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒã‚¹ã‚¿ãƒƒã‚­ãƒ³ã‚°æ¸ˆã¿ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ä¸€è‡´ã—ãŸå ´åˆã«ä¸Šè¨˜ã®æŒ™å‹•ã«ãªã‚‹ã®ã§ã€ `clone` ã—ã¦åˆ¥ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã™ã‚Œã° `isVisiting` ã¯falseã«ãªã‚‹ã¯ãšã€‚

```diff
// index.php

function getUser() {
    $user = new User();
    $user->name = 'user1';

    for ($i = 0; $i < 2; $i++) {
        $post = new Post();
        $post->title = 'post' . ($i + 1);
-       $post->user = $user;
+       $post->user = clone $user;
        $user->posts[] = $post;
    }

    return $user;
}
```

## çµæœ4

```json
{
	"name": "user1",
	"posts": [
		{
			"title": "post1",
			"user": {
				"name": "user1",
				"posts": null
			}
		},
		{
			"title": "post2",
			"user": {
				"name": "user1",
				"posts": [
					{
						"title": "post1",
						"user": {
							"name": "user1",
							"posts": null
						}
					}
				]
			}
		}
	]
}
```

ãªã‚‹ã»ã©è¡Œã‘ãŸã€‚

# çµè«–

åŒä¸€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå†å¸°çš„ã«å‚ç…§ã•ã‚Œã‚‹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¯ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã§ããªã„ã€‚`MaxDepth` ã®ãƒã‚§ãƒƒã‚¯ä»¥å‰ã«å¼¾ã‹ã‚Œã¦ã„ã‚‹ï¼ˆãŸã¶ã‚“ï¼‰ã€‚

å‹•ä½œç¢ºèªç’°å¢ƒã€ç½®ã„ã¨ãã¾ã™ã€‚
<https://github.com/ttskch/jms-serializer-recursion-sample>

# æ„Ÿæƒ³

ã“ã†ã„ã†å ´åˆã€APIã‚’åˆ†ã‘ã¦ã€ãƒ•ãƒ­ãƒ³ãƒˆã‹ã‚‰ã¯ `User` ã¨ `Post[]` ã¯åˆ¥ã€…ã®APIã§å–å¾—ã™ã‚‹ã®ãŒä¸€èˆ¬çš„ãªã‚“ã ã¨æ€ã‚ã‚Œã¾ã™ã€‚

Angularï¼ˆrxjs@6ï¼‰ã®å ´åˆã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã€‚

```ts
// user-repository.ts

get(id: string): Observable<User> {
  return this.http.get(`/users/${id}`).pipe(
    map(response => getUserFromResponse(response)),
    switchMap((user: User) => this.postRepository.cgetByUser(user).pipe(
      map((posts: Post[]) => {
        user.posts = posts;
        return user;
      })
    ))
  );
}
```
