---
title: "[Symfony][Doctrine] MappedSuperclassã‚’ä½¿ã£ã¦ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«åŸºåº•ã‚¯ãƒ©ã‚¹ã‚’æŒãŸã›ã‚‹"
emoji: "ğŸ»"
type: "tech"
topics: ["php", "symfony", "doctrine"]
published: true
published_at: 2020-07-18
---

:::message
ã“ã®è¨˜äº‹ã¯ã€2020-07-18ã«åˆ¥ã®ãƒ–ãƒ­ã‚°åª’ä½“ã«æŠ•ç¨¿ã—ãŸè¨˜äº‹ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ã™ã€‚
:::

# ã‚„ã‚ŠãŸã„ã“ã¨

`ä¼šç¤¾å“¡` ã¨ `ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹` ã¨ã„ã†2ç¨®é¡ã® `åŠ´åƒè€…` ã‚’Doctrineã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨ã—ã¦è¡¨ç¾ã—ãŸã„ã¨ã—ã¾ã™ã€‚

`åŠ´åƒè€…` ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã« `åŠ´åƒå½¢æ…‹` ã®ã‚ˆã†ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŒãŸã›ã‚‹ã®ãŒä¸€ç•ªæ™®é€šã®ã‚„ã‚Šæ–¹ã ã¨æ€ã„ã¾ã™ãŒã€è‰²ã€…ãªç†ç”±ã‹ã‚‰ `åŠ´åƒè€…` ã¨ã„ã†ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã‚’ç¶™æ‰¿ã—ãŸ `ä¼šç¤¾å“¡` ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨ `ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹` ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ä½œã‚ŠãŸã„ã¨ã„ã†çŠ¶æ³ãŒã‚ã‚Šå¾—ã¾ã™ã€‚

ã“ã®ã‚ˆã†ãªå®Ÿè£…ã¯ã€Doctrineã® [MappedSuperclass](https://www.doctrine-project.org/projects/doctrine-orm/en/2.7/reference/inheritance-mapping.html) ã¨ã„ã†æ©Ÿèƒ½ã‚’ä½¿ã†ã“ã¨ã§å®Ÿç¾ã§ãã¾ã™ã€‚

> [[Symfony][Doctrine] Single Table Inheritanceã‚’ä½¿ã£ã¦ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«åŸºåº•ã‚¯ãƒ©ã‚¹ã‚’æŒãŸã›ã‚‹](https://zenn.dev/ttskch/articles/890af3fe4e0a92)
>
> ã“ã¡ã‚‰ã®è¨˜äº‹ã§ [`Single Table Inheritance`](https://www.doctrine-project.org/projects/doctrine-orm/en/2.7/reference/inheritance-mapping.html#single-table-inheritance) ã‚’ä½¿ã£ãŸæ–¹æ³•ã‚‚ç´¹ä»‹ã—ã¦ã„ã¾ã™ã€‚

# ã‚„ã‚Šæ–¹

ã¾ãšã€ä»¥ä¸‹ã®ã‚ˆã†ã« `@MappedSuperclass` ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã¦ `åŠ´åƒè€…` æŠ½è±¡ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚

```php
/**
 * @ORM\MappedSuperclass(repositoryClass=WorkerRepository::class)
 */
abstract class Worker
{
    /**
     * @ORM\Id()
     * @ORM\GeneratedValue()
     * @ORM\Column(type="integer")
     */
    protected $id;

    /**
     * @ORM\Column(type="string", length=255)
     */
    protected $name;
}
```

ã‚ã¨ã¯æ™®é€šã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨åŒã˜ã‚ˆã†ã« `ä¼šç¤¾å“¡` `ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹` ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ä½œã£ã¦ã€ `åŠ´åƒè€…` æŠ½è±¡ã‚¯ãƒ©ã‚¹ã‚’ç¶™æ‰¿ã—ã¦ã‚ã’ã‚Œã°OKã§ã™ã€‚

```php
/**
 * @ORM\Entity(repositoryClass=EmployeeRepository::class)
 */
class Employee extends Worker
{
    /**
     * @ORM\Column(type="integer")
     */
    private $salary;
}
```

```php
/**
 * @ORM\Entity(repositoryClass=FreelancerRepository::class)
 */
class Freelancer extends Worker
{
    /**
     * @ORM\Column(type="integer")
     */
    private $sales;
}
```

ç°¡å˜ã§ã™ã­ğŸ‘

# ä»–ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‹ã‚‰åŸºåº•ã‚¯ãƒ©ã‚¹ã«å¯¾ã—ã¦ManyToOneã§ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã‚’å¼µã‚‹ã“ã¨ã¯ã§ããªã„

ä»–ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‹ã‚‰åŸºåº•ã‚¯ãƒ©ã‚¹ã«å¯¾ã—ã¦ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã‚’å¼µã‚ŠãŸããªã‚‹ã“ã¨ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ãŒã€ **åŸºåº•ã‚¯ãƒ©ã‚¹ã«å¯¾ã™ã‚‹ManyToOneã®ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯æ©Ÿèƒ½ã—ãªã„ã®ã§è¦æ³¨æ„ã§ã™ã€‚**

ä¾‹ãˆã°ã€ã€Œ `åŠ´åƒè€…` ãŒ `ä»•äº‹` ã‚’æ‰€æœ‰ã™ã‚‹ã€ã¨ã„ã£ãŸãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã®è¨­å®šã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãã¨ã€ `doctrine:migrations:diff` ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ç”Ÿæˆã«ã¯æˆåŠŸã™ã‚‹ã®ã§ã€ä¸€è¦‹ä¸Šæ‰‹ãã„ãã‚ˆã†ãªæ°—ãŒã—ã¦ã—ã¾ã„ã¾ã™ã€‚

```diff
  /**
   * @ORM\MappedSuperclass(repositoryClass=WorkerRepository::class)
   */
  abstract class Worker
  {
      /**
       * @ORM\Id()
       * @ORM\GeneratedValue()
       * @ORM\Column(type="integer")
       */
-     protected $id;
+     private $id;

      /**
       * @ORM\Column(type="string", length=255)
       */
      protected $name;
+
+     /**
+      * @ORM\OneToMany(targetEntity=Job::class, mappedBy="worker")
+      */
+     private $jobs;
  }
```

> ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã‚’å¼µã‚‹å ´åˆã¯ `id` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å¯è¦–æ€§ã¯ `private` ã«ã—ã¦ãŠã‹ãªã„ã¨ `doctrine:migrations:diff` ã—ãŸã¨ãã«
>
> ```
> Column name `id` referenced for relation from App\Entity\Job towards App\Entity\Worker does not exist.
> ```
>
> ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚

```php
/**
 * @ORM\Entity(repositoryClass=JobRepository::class)
 */
class Job
{
    /**
     * @ORM\Id()
     * @ORM\GeneratedValue()
     * @ORM\Column(type="integer")
     */
    private $id;

    /**
     * @ORM\ManyToOne(targetEntity=Worker::class, inversedBy="jobs")
     */
    private $worker;
}
```

ã—ã‹ã—ã€å®Ÿéš›ã«DBã®ã‚¹ã‚­ãƒ¼ãƒã‚’ç¢ºèªã—ã¦ã¿ã‚Œã°ã€ã“ã‚ŒãŒæ®‹å¿µãªãŒã‚‰æ©Ÿèƒ½ã—ãªã„ã“ã¨ãŒã™ãã«åˆ†ã‹ã‚Šã¾ã™ã€‚

å…·ä½“çš„ã«ã¯ã€

* `employee`
* `freelancer`
* `job`

ã¨ã„ã†3ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œã‚‰ã‚Œã€ `job` ãƒ†ãƒ¼ãƒ–ãƒ«ã« `worker_id` ã¨ã„ã†ã‚«ãƒ©ãƒ ãŒä½œã‚‰ã‚Œã¾ã™ã€‚

ãŒã€å½“ãŸã‚Šå‰ã§ã™ãŒã“ã® `worker_id` ã‚«ãƒ©ãƒ ã«ã¯ **å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ãŒè¨­å®šã•ã‚Œã¾ã›ã‚“ã€‚** ï¼ˆ `worker` ã¨ã„ã†ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ãªã„ã®ã§ï¼‰

ãªã®ã§ã€ä¾‹ãˆã° `worker_id` ã‚«ãƒ©ãƒ ã« `1` ãŒå…¥ã£ã¦ã„ãŸã¨ã—ã¦ã€ãã‚ŒãŒ `employee` ãƒ†ãƒ¼ãƒ–ãƒ«ã® `id=1` ã‚’è¡¨ã™ã®ã‹ã€ `freelancer` ãƒ†ãƒ¼ãƒ–ãƒ«ã® `id=1` ã‚’è¡¨ã™ã®ã‹ã¯åˆ¤åˆ¥ä¸å¯èƒ½ãªã®ã§ã€æ©Ÿèƒ½ã—ã¾ã›ã‚“ã€‚

> [ã€Symfony/Doctrineã€‘Single Table Inheritanceã‚’ä½¿ã£ã¦ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«åŸºåº•ã‚¯ãƒ©ã‚¹ã‚’æŒãŸã›ã‚‹](https://zenn.dev/ttskch/articles/890af3fe4e0a92)
>
> ã“ã¡ã‚‰ã®è¨˜äº‹ã§ [`Single Table Inheritance`](https://www.doctrine-project.org/projects/doctrine-orm/en/2.7/reference/inheritance-mapping.html#single-table-inheritance) ã‚’ä½¿ã£ãŸæ–¹æ³•ã‚’ç´¹ä»‹ã—ã¦ã„ã¾ã™ã€‚ã“ã¡ã‚‰ã®æ–¹æ³•ãªã‚‰ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã‚’æŒãŸã›ã‚‹ã“ã¨ã‚‚å¯èƒ½ãªã®ã§ã€å‚è€ƒã«ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

# ã¾ã¨ã‚

* Doctrineã® [MappedSuperclass](https://www.doctrine-project.org/projects/doctrine-orm/en/2.7/reference/inheritance-mapping.html) ã‚’ä½¿ãˆã°ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«åŸºåº•ã‚¯ãƒ©ã‚¹ã‚’æŒãŸã›ã‚‹ã“ã¨ãŒã§ãã‚‹
* ä»–ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‹ã‚‰åŸºåº•ã‚¯ãƒ©ã‚¹ã¸ã®ManyToOneãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã¯æ©Ÿèƒ½ã—ãªã„ã®ã§è¦æ³¨æ„
