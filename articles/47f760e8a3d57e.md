---
title: "[Symfony][Doctrine] å¤–éƒ¨ã‚­ãƒ¼ã®ä»˜ã‘æ›¿ãˆã‚’ä¼´ã†ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æ›¸ãæ–¹"
emoji: "ðŸŽ»"
type: "tech"
topics: ["php", "symfony", "doctrine"]
published: true
published_at: 2020-07-19
---

:::message
ã“ã®è¨˜äº‹ã¯ã€2020-07-19ã«åˆ¥ã®ãƒ–ãƒ­ã‚°åª’ä½“ã«æŠ•ç¨¿ã—ãŸè¨˜äº‹ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ã™ã€‚
:::

# ä¾‹

ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æ§‹é€ ã®å¤‰æ›´ã‚’è€ƒãˆã¾ã™ã€‚

* **Before**
    * `åº—èˆ—` ãŒ `å•†å“` ã‚’æŒã£ã¦ã„ã‚‹
* **After**
    * `åº—èˆ—` ã« `ã‚¹ã‚¿ãƒƒãƒ•` ãŒæ‰€å±žã—ã¦ã„ã¦ã€ `ã‚¹ã‚¿ãƒƒãƒ•` ã”ã¨ã«æ‹…å½“ã® `å•†å“` ã‚’æŒã£ã¦ã„ã‚‹

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1ggwblqmekwj30eh07tt8r.jpg)

ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚

## Before

```php
class Shop
{
    /**
     * @ORM\OneToMany(targetEntity=Item::class, mappedBy="shop")
     */
    private $items;
}
```

```php
class Item
{
    /**
     * @ORM\ManyToOne(targetEntity=Shop::class, inversedBy="items")
     * @ORM\JoinColumn(nullable=false)
     */
    private $shop;
}
```

## After

```php
class Shop
{
    /**
     * @ORM\OneToMany(targetEntity=Staff::class, mappedBy="shop")
     */
    private $staves;
}
```

```php
class Staff
{
    /**
     * @ORM\ManyToOne(targetEntity=Shop::class, inversedBy="staves")
     * @ORM\JoinColumn(nullable=false)
     */
    private $shop;

    /**
     * @ORM\OneToMany(targetEntity=Item::class, mappedBy="staff")
     */
    private $items;

    /**
     * @ORM\Column(type="string", length=255)
     */
    private $name;
}
```

```php
class Item
{
    /**
     * @ORM\ManyToOne(targetEntity=Staff::class, inversedBy="items")
     * @ORM\JoinColumn(nullable=false)
     */
    private $staff;
}
```

# ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã—ã¦ã¿ã‚‹

ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚’è¡Œã£ãŸå ´åˆã®ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¤ã„ã¦è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ã¾ãšã¯ `doctrine:migrations:diff` ã‚³ãƒžãƒ³ãƒ‰ã§ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã—ã¦ã¿ã¾ã™ã€‚

```bash
bin/console doctrime:migrations:diff
```

ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

```php
public function up(Schema $schema) : void
{
    $this->addSql('CREATE TABLE staff (id INT AUTO_INCREMENT NOT NULL, shop_id INT NOT NULL, name VARCHAR(255) NOT NULL, INDEX IDX_11111111111111 (shop_id), PRIMARY KEY(id)) DEFAULT CHARACTER SET utf8mb4 COLLATE `utf8mb4_unicode_ci` ENGINE = InnoDB');
    $this->addSql('ALTER TABLE staff ADD CONSTRAINT FK_11111111111111 FOREIGN KEY (shop_id) REFERENCES shop (id)');
    $this->addSql('ALTER TABLE item DROP FOREIGN KEY FK_22222222222222');
    $this->addSql('DROP INDEX IDX_22222222222222 ON item');
    $this->addSql('ALTER TABLE item CHANGE shop_id staff_id INT NOT NULL');
    $this->addSql('ALTER TABLE item ADD CONSTRAINT FK_33333333333333 FOREIGN KEY (staff_id) REFERENCES staff (id)');
    $this->addSql('CREATE INDEX IDX_33333333333333 ON item (staff_id)');
}

public function down(Schema $schema) : void
{
    $this->addSql('ALTER TABLE item DROP FOREIGN KEY FK_33333333333333');
    $this->addSql('DROP TABLE staff');
    $this->addSql('DROP INDEX IDX_33333333333333 ON item');
    $this->addSql('ALTER TABLE item CHANGE staff_id shop_id INT NOT NULL');
    $this->addSql('ALTER TABLE item ADD CONSTRAINT FK_22222222222222 FOREIGN KEY (shop_id) REFERENCES shop (id)');
    $this->addSql('CREATE INDEX IDX_22222222222222 ON item (shop_id)');
}
```

`up()`  ã®å†…å®¹ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã“ã¨ã‚’ã—ã¦ã„ã¾ã™ã€‚

1. `staff` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
1. `staff` ãƒ†ãƒ¼ãƒ–ãƒ«ã® `shop_id` ã‚«ãƒ©ãƒ ã« `shop` ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’è¿½åŠ 
1. `item` ãƒ†ãƒ¼ãƒ–ãƒ«ã® `shop_id` ã‚«ãƒ©ãƒ ã® `shop` ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’å‰Šé™¤
1. `item` ãƒ†ãƒ¼ãƒ–ãƒ«ã® `shop_id` ã‚«ãƒ©ãƒ ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤
1. `item` ãƒ†ãƒ¼ãƒ–ãƒ«ã® `shop_id` ã‚«ãƒ©ãƒ ã‚’ `staff_id` ã«åå‰å¤‰æ›´
1. `item` ãƒ†ãƒ¼ãƒ–ãƒ«ã® `staff_id` ã‚«ãƒ©ãƒ ã« `staff` ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’è¿½åŠ 
1. `item` ãƒ†ãƒ¼ãƒ–ãƒ«ã® `staff_id` ã‚«ãƒ©ãƒ ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ 

> `down()` ã¯ã“ã®é€†ã§ã™ã­ã€‚

ã•ã¦ã€ã“ã®ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯æœŸå¾…ã©ãŠã‚Šã®å†…å®¹ã«ãªã£ã¦ã„ã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ

ã‚ˆãè€ƒãˆã¦ã¿ã‚Œã°åˆ†ã‹ã‚Šã¾ã™ãŒã€æ®‹å¿µãªãŒã‚‰ã“ã®ã¾ã¾ã§ã¯ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®çŠ¶æ…‹ã§ã‚‚ãªã„é™ã‚Šæ­£å¸¸ã«ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ãã¾ã›ã‚“ðŸ˜“

`staff_id` ã‚«ãƒ©ãƒ ã«ã¯ã‚‚ã¨ã‚‚ã¨ `shop_id` ã®ã¤ã‚‚ã‚Šã§å…¥ã‚ŒãŸIDã¯å…¥ã£ã¦ã„ã‚‹ã®ã§ã€ãã“ã«æ–°ã—ãä½œã£ãŸ `staff` ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’è¿½åŠ ã—ã‚ˆã†ã¨ã—ã¦ã‚‚ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã¯ãšã§ã™ã€‚

```
SQLSTATE[HY000]: General error: 1215 Cannot add foreign key constraint
```

# ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ›¸ãæ›ãˆã‚‹

ã¨ã„ã†ã‚ã‘ã§ã€ã¡ã‚ƒã‚“ã¨è‡ªåŠ›ã§ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ›¸ãæ›ãˆã¦ã‚ã’ã¾ã—ã‚‡ã†ðŸ’ª

`up()` ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ‰‹é †ã‚’è¸ã‚ã°æ­£å¸¸ã«ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ãã‚‹ã¯ãšã§ã™ã€‚

1. `staff` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¦ã€ `shop_id` ã‚«ãƒ©ãƒ ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨ `shop` ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’è¿½åŠ 
1. `item` ãƒ†ãƒ¼ãƒ–ãƒ«ã« `staff_id` ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã—ã¦ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆ  **ï¼ˆã¾ã å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã¯è¿½åŠ ã—ãªã„ï¼‰**
1. `shop` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å·¡å›žã—ã¦ã€å„ `shop` ã«å¯¾ã—ã¦å¿…è¦ãªã ã‘ `staff` ã‚’ä½œæˆ
    * ã“ã®ã¨ãã€ã‚‚ã¨ã‚‚ã¨ `shop` ãŒæŒã£ã¦ã„ãŸ `item` ã‚’ä½•ã‚‰ã‹ã®æ¡ä»¶ã«å¿œã˜ã¦å¯¾å¿œã™ã‚‹ `staff` ã«é©åˆ‡ã«ç´ã¥ã‘ã‚‹
    * å·¡å›žã‚’çµ‚ãˆã‚‹ã¨ã€ `staff` ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¿…è¦ãªãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã™ã¹ã¦æŒ¿å…¥æ¸ˆã¿ã§ã€å„ãƒ¬ã‚³ãƒ¼ãƒ‰ã® `shop_id` ã«ã¯é©åˆ‡ã« `shop` ã®IDãŒå…¥ã£ã¦ãŠã‚Šã€ã‹ã¤ `staff` ãŒ `item` ã‹ã‚‰ã‚‚é©åˆ‡ã«å‚ç…§ã•ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ã«ãªã‚‹
1. `item` ãƒ†ãƒ¼ãƒ–ãƒ«ã® `staff_id` ã‚«ãƒ©ãƒ ã« `staff` ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’è¿½åŠ  **ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒæ•´ç†ã§ããŸã®ã§ã“ã“ã§å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’è¿½åŠ ã™ã‚‹ï¼‰**
1. `item` ãƒ†ãƒ¼ãƒ–ãƒ«ã® `shop_id` ã‚«ãƒ©ãƒ ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’å‰Šé™¤ã—ã¦ã€ `shop_id` ã‚«ãƒ©ãƒ è‡ªä½“ã‚‚å‰Šé™¤

ã“ã‚Œã‚’ã‚³ãƒ¼ãƒ‰ã«ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã§ã—ã‚‡ã†ã€‚

```php
public function up(Schema $schema) : void
{
    // staff ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¦ã€shop_id ã‚«ãƒ©ãƒ ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨ shop ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’è¿½åŠ 
    $this->addSql('CREATE TABLE staff (id INT AUTO_INCREMENT NOT NULL, shop_id INT NOT NULL, name VARCHAR(255) NOT NULL, INDEX IDX_11111111111111 (shop_id), PRIMARY KEY(id)) DEFAULT CHARACTER SET utf8mb4 COLLATE `utf8mb4_unicode_ci` ENGINE = InnoDB');
    $this->addSql('ALTER TABLE staff ADD CONSTRAINT FK_11111111111111 FOREIGN KEY (shop_id) REFERENCES shop (id)');

    // item ãƒ†ãƒ¼ãƒ–ãƒ«ã« staff_id ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã—ã¦ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆï¼ˆã¾ã å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã¯è¿½åŠ ã—ãªã„ï¼‰
    $this->addSql('ALTER TABLE item ADD staff_id INT NOT NULL');
    $this->addSql('CREATE INDEX IDX_33333333333333 ON item (staff_id)');

    // shop ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å·¡å›žã—ã¦ã€å„ shop ã«å¯¾ã—ã¦å¿…è¦ãªã ã‘ staff ã‚’ä½œæˆ
    $shops = $this->connection->query('SELECT id FROM shop')->fetchAll();
    foreach ($shops as $shop) {
        // shop ã”ã¨ã«ä½œæˆã™ã¹ã staff ã®æƒ…å ±ã‚’ä½•ã‹ã—ã‚‰ä¸€è¦§ãªã©ã«ã—ã¦ãŠãã‚¤ãƒ¡ãƒ¼ã‚¸.
        foreach ($this->getStavesForShop($shop['id']) as $staff) {
            $this->addSql('INSERT INTO staff (shop_id, name) VALUES (:shop_id, :name)', [
                'shop_id' => $shop['id'],
                'name' => $staff['name'],
            ]);
        }
        // shop ãŒã‚‚ã¨ã‚‚ã¨æŒã£ã¦ã„ãŸ item ãã‚Œãžã‚Œã«ã¤ã„ã¦ã©ã® staff ã«æŒãŸã›ã‚‹ã‹ã‚’ä½•ã‹ã—ã‚‰ã®ãƒ­ã‚¸ãƒƒã‚¯ã§æ±ºã‚ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸.
        $items = $this->connection->query('SELECT i.id FROM item i LEFT JOIN shop s ON i.shop_id = s.id WHERE s.id = :shop_id', [
            'shop_id' => $shop['id'],
        ])->fetchAll();
        foreach ($items as $item) {
            $this->addSql('UPDATE item SET staff_id = :staff_id WHERE id = :item_id', [
                'item_id' => $item['id'],
                'staff_id' => $this->getStaffForItem($item['id']),
            ]);
        }
    }

    // item ãƒ†ãƒ¼ãƒ–ãƒ«ã® staff_id ã‚«ãƒ©ãƒ ã« staff ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’è¿½åŠ ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒæ•´ç†ã§ããŸã®ã§ã“ã“ã§å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’è¿½åŠ ã™ã‚‹ï¼‰
    $this->addSql('ALTER TABLE item ADD CONSTRAINT FK_33333333333333 FOREIGN KEY (staff_id) REFERENCES staff (id)');

    // item ãƒ†ãƒ¼ãƒ–ãƒ«ã® shop_id ã‚«ãƒ©ãƒ ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨å¤–éƒ¨ã‚­ãƒ¼ã‚’å‰Šé™¤ã—ã¦ã€shop_id ã‚«ãƒ©ãƒ è‡ªä½“ã‚‚å‰Šé™¤
    $this->addSql('DROP INDEX IDX_22222222222222 ON item');
    $this->addSql('ALTER TABLE item DROP FOREIGN KEY FK_22222222222222');
    $this->addSql('ALTER TABLE item DROP shop_id');
}

private function getStavesForShop($shopId)
{
    // ã‚¹ã‚¿ãƒƒãƒ•ã®æƒ…å ±ã‚’é…åˆ—ã§è¿”ã™
}

private function getStaffForItem($itemId)
{
    // ã‚¹ã‚¿ãƒƒãƒ•ã®æƒ…å ±ã‚’è¿”ã™
}
```

ã“ã‚Œã§ã€æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’é©åˆ‡ã«ä»˜ã‘æ›¿ãˆã¤ã¤ã‚¹ã‚­ãƒ¼ãƒžå¤‰æ›´ãŒã§ãã‚‹ã¯ãšã§ã™ðŸ‘

# `down()` ã§ã‚‚é€†ã®ã“ã¨ã‚’ã™ã‚Œã°ã„ã„ã ã‘

åŒæ§˜ã«ã€ `down()` ã®ã»ã†ã‚‚ã‚³ãƒ¼ãƒ‰ã«è½ã¨ã—è¾¼ã‚€ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªã‚‚ã®ã«ãªã‚‹ã§ã—ã‚‡ã†ã€‚

```php
public function donw(Schema $schema) : void
{
    // item ãƒ†ãƒ¼ãƒ–ãƒ«ã« shop_id ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã—ã¦ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆ (ã¾ã å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã¯è¿½åŠ ã—ãªã„)
    $this->addSql('ALTER TABLE item ADD shop_id INT NOT NULL');
    $this->addSql('CREATE INDEX IDX_22222222222222 ON item (shop_id)');

    // item ãƒ†ãƒ¼ãƒ–ãƒ«ã® shop_id ã«ã€å¯¾å¿œã™ã‚‹ shop ã® id ã‚’ã‚»ãƒƒãƒˆ
    $this->addSql('UPDATE item a LEFT JOIN staff s ON a.staff_id = s.id SET a.shop_id = s.shop_id');

    // item ãƒ†ãƒ¼ãƒ–ãƒ«ã® shop_id ã«å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’è¿½åŠ ï¼ˆã“ã“ã§è¿½åŠ ï¼‰
    $this->addSql('ALTER TABLE item ADD CONSTRAINT FK_22222222222222 FOREIGN KEY (shop_id) REFERENCES shop (id)');

    // item ãƒ†ãƒ¼ãƒ–ãƒ«ã® staff_id ã‚«ãƒ©ãƒ ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’å‰Šé™¤ã—ã¦ã€staff_id ã‚«ãƒ©ãƒ è‡ªä½“ã‚‚å‰Šé™¤
    $this->addSql('DROP INDEX IDX_33333333333333 ON item');
    $this->addSql('ALTER TABLE item DROP FOREIGN KEY FK_33333333333333');
    $this->addSql('ALTER TABLE item DROP staff_id');

    // staff ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤
    $this->addSql('DROP TABLE staff');
}
```
