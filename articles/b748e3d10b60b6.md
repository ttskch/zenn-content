---
title: "Symfonyã§è¤‡æ•°è¨€èªã«\"ã„ã„æ„Ÿã˜ã«\"å¯¾å¿œã—ãŸWebã‚µã‚¤ãƒˆã‚’ä½œã‚‹"
emoji: "ğŸ»"
type: "tech"
topics: ["php", "symfony"]
published: true
---

ãƒ¡ãƒªãƒ¼ã‚¯ãƒªã‚¹ãƒã‚¹ï¼[Symfony Advent Calendar 2024](https://qiita.com/advent-calendar/2024/symfony) ã®25æ—¥ç›®ã®è¨˜äº‹ã§ã™ï¼ğŸ„âœ¨

> Twitter (X) ã§ã‚‚ã¡ã‚‡ã„ã¡ã‚‡ã„Symfonyãƒã‚¿ã‚’å‘Ÿã„ã¦ã¾ã™ã€‚ã‚ˆã‚ã—ã‘ã‚Œã° [ãƒ•ã‚©ãƒ­ãƒ¼](https://x.com/ttskch) ãŠé¡˜ã„ã—ã¾ã™ğŸ¤²

# ã¯ã˜ã‚ã«

æœ€è¿‘ã€ãŠä»•äº‹ã§ä¹…ã—ã¶ã‚Šã«å¤šè¨€èªå¯¾å¿œã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½œã‚‹æ©Ÿä¼šãŒã‚ã‚Šã¾ã—ãŸã€‚

Symfonyã§ã¯ [Translationã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ](https://symfony.com/doc/2.x/components/translation.html) ã‚’å°å…¥ã™ã‚Œã°åŸºæœ¬çš„ãªå¤šè¨€èªå¯¾å¿œã¯ã¨ã¦ã‚‚ç°¡å˜ã«å®Ÿè£…ã§ãã‚‹ã‚ã‘ã§ã™ãŒã€å®Ÿã¯ **è‰²ã€…ã„ã„æ„Ÿã˜ã«** å¯¾å¿œã—ã‚ˆã†ã¨ã™ã‚‹ã¨æ„å¤–ã¨è€ƒãˆã‚‹ã“ã¨ãŒãŸãã•ã‚“ã‚ã‚Šã¾ã™ã€‚

ãã“ã§ã“ã®è¨˜äº‹ã§ã¯ã€ç§ãŒç¾æ™‚ç‚¹ã§ã€Œã¾ã‚ã“ã‚“ãªæ„Ÿã˜ã§ã‚„ã‚‹ã®ãŒãˆãˆã‚“ã¡ã‚ƒã†ã‹ã€ã¨è€ƒãˆã¦ã„ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã”ç´¹ä»‹ã§ãã‚Œã°ã¨æ€ã„ã¾ã™ã€‚

> è€ƒæ…®æ¼ã‚Œã‚„ã‚ˆã‚Šè‰¯ã„æ–¹æ³•ãªã©ã«ã¤ã„ã¦è¦‹è­˜ã‚’ãŠæŒã¡ã®æ–¹ã¯ãŠæ°—è»½ã«ã‚³ãƒ¡ãƒ³ãƒˆã„ãŸã ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™ğŸ¤²

ãªãŠã€æœ¬ç¨¿ã§ã¯ã‚ªãƒ¼ã‚½ãƒ‰ãƒƒã‚¯ã‚¹ã«æ—¥æœ¬èªã¨è‹±èªã®2è¨€èªã«å¯¾å¿œã™ã‚‹ã‚±ãƒ¼ã‚¹ã‚’ä¾‹ã«ã¨ã‚Šã¾ã™ã€‚

# 0. Symfony Translationã‚’å°å…¥ã™ã‚‹

```shell
$ composer require symfony/translation
```

```yaml:config/packages/translation.yaml
framework:
  default_locale: ja
  translator:
    default_path: '%kernel.project_dir%/translations'
    fallbacks:
      - en
    providers:
```

```yaml:translations/messages.ja.yaml
symfony_advent_calendar: Symfonyã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
```

```yaml:translations/messages.en.yaml
symfony_advent_calendar: Symfony Advent Calendar
```

```twig:templates/home/index.html.twig
<p>{{ 'symfony_advent_calendar'|trans }}</p>
```

```:è¡¨ç¤ºçµæœ
Symfonyã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
```

# 1. URLã«ãƒ­ã‚±ãƒ¼ãƒ«åã‚’å«ã‚ã‚‹

å‰é …ã®æ™‚ç‚¹ã§ã¯ã€`default_locale` ãŒ `ja` ãªã®ã§ã€ãƒ­ã‚±ãƒ¼ãƒ«ã‚’æ˜ç¤ºçš„ã«æŒ‡å®šã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ãŒã©ã“ã«ã‚‚ãªã‘ã‚Œã°ã€å¸¸ã«æ—¥æœ¬èªã®è¡¨è¨˜ãŒå‡ºåŠ›ã•ã‚Œã‚‹çµæœã«ãªã‚Šã¾ã™ã€‚

ãã“ã§ã€æ—¥æœ¬èªã‚’èª­ã¿ãŸã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨è‹±èªã‚’èª­ã¿ãŸã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ãã‚Œãã‚Œæ˜ç¤ºçš„ã«ãƒ­ã‚±ãƒ¼ãƒ«ã‚’è¨­å®šã™ã‚‹å‡¦ç†ãŒã©ã“ã‹ã«å¿…è¦ã«ãªã‚Šã¾ã™ã€‚

ä¾‹ãˆã° **ã‚ã¾ã‚Šè‰¯ããªã„ä¾‹ã¨ã—ã¦**ã€`Accept-Language` ãƒ˜ãƒƒãƒ€ãƒ¼ã®å†…å®¹ã‚’ã‚‚ã¨ã«æš—é»™çš„ã«ãƒ­ã‚±ãƒ¼ãƒ«ã‚’è¨­å®šã™ã‚‹ï¼ˆ[ã‚³ãƒ³ãƒ†ãƒ³ãƒˆãƒã‚´ã‚·ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³](https://developer.mozilla.org/ja/docs/Web/HTTP/Guides/Content_negotiation)ï¼‰ã¨ã„ã†æ–¹æ³•ã‚‚è€ƒãˆã‚Œã¾ã™ã€‚

```php:src/Controller/HomeController.php
#[Route(path: '/', name: 'home_')]
class HomeController extends AbstractController
{
    #[Route(path: '/', name: 'index', methods: ['GET'])]
    public function index(Request $request): Response
    {
        $request->setLocale($request->getPreferredLanguage(['ja', 'en'])); // ã“ã‚Œ

        return $this->render('home/index.html.twig');
    }
}
```

ã—ã‹ã—ã€ã“ã‚Œã ã¨ã€åŒã˜URLã§ã‚‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨€èªè¨­å®šã«ã‚ˆã£ã¦å‡ºåŠ›ã•ã‚Œã‚‹å†…å®¹ãŒå¤‰ã‚ã£ã¦ã—ã¾ã†ã®ã§URLæ­£è¦åŒ–ã®åŸå‰‡ã«åã—ã¾ã™ã—ã€æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã®ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼ãŒä¸€æ–¹ã®è¨€èªã®ãƒšãƒ¼ã‚¸ã—ã‹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ãã‚Œãªã„ã“ã¨ã«ãªã‚‹ãŸã‚SEOã«ãŠã„ã¦ã‚‚éå¸¸ã«ä¸åˆ©ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

ãã®ãŸã‚ã€åŸºæœ¬çš„ã«ã¯URLã«ãƒ­ã‚±ãƒ¼ãƒ«åã‚’å«ã‚ã‚‹ã‚ˆã†ã«ã™ã‚‹ã®ãŒå¤§å‰æã¨ãªã‚Šã¾ã™ã€‚

```yaml:config/routes.yaml
controllers:
  resource:
    path: ../src/Controller/
    namespace: App\Controller
  type: attribute
  prefix: /{_locale}
  requirements:
    _locale: ja|en
```

`_locale` ã¯ãƒ­ã‚±ãƒ¼ãƒ«ã‚’ã‚»ãƒƒãƒˆã™ã‚‹ãŸã‚ã® [ç‰¹æ®Šãªãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿](https://symfony.com/doc/current/routing.html#special-parameters) ã§ã™ã€‚`ja` ã¾ãŸã¯ `en` ã«ã—ã‹ãƒãƒƒãƒã—ãªã„ã‚ˆã†ã«è¨­å®šã—ã¦ã„ã‚‹ã®ã§ã€

* `/ja/` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸå ´åˆï¼šãƒ­ã‚±ãƒ¼ãƒ«ã¨ã—ã¦ `ja` ãŒã‚»ãƒƒãƒˆã•ã‚ŒãŸçŠ¶æ…‹ã§ `HomeController::index()` ã«ãƒ«ãƒ¼ãƒˆã•ã‚Œã‚‹
* `/en/` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸå ´åˆï¼šãƒ­ã‚±ãƒ¼ãƒ«ã¨ã—ã¦ `en` ãŒã‚»ãƒƒãƒˆã•ã‚ŒãŸçŠ¶æ…‹ã§ `HomeController::index()` ã«ãƒ«ãƒ¼ãƒˆã•ã‚Œã‚‹
* `/ãã‚Œä»¥å¤–ã®æ–‡å­—åˆ—/` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸå ´åˆï¼š404 Not Foundã«ãªã‚‹

ã¨ã„ã†æŒ™å‹•ã«ãªã‚Šã¾ã™ã€‚

# 2. ãƒ­ã‚±ãƒ¼ãƒ«å…±é€šã®ãƒšãƒ¼ã‚¸ã—ã‹æä¾›ã—ãªã„URLã‚‚ã‚ã‚‹å ´åˆ

å‰é …ã®å¯¾å¿œã§ã¯ã€ã™ã¹ã¦ã®ãƒ«ãƒ¼ãƒˆã«ã¤ã„ã¦ `/{_locale}` ã¨ã„ã†prefixãŒé©ç”¨ã•ã‚Œã‚‹ãŸã‚ã€è¨€èªã«é–¢ä¿‚ãªãå¸¸ã«åŒä¸€ã®å†…å®¹ã‚’è¿”ã—ãŸã„ãƒ™ãƒ¼ã‚¸ãŒã‚ã‚‹å ´åˆã§ã‚‚ã€ãã®ãƒšãƒ¼ã‚¸ã®URLã‚‚ `ja` ã¨ `en` ã®2ãƒ‘ã‚¿ãƒ¼ãƒ³ä½œã‚‰ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚

ä¾‹ãˆã°ã€Symfonyã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã« `Image` ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒã‚ã‚Šã€ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®å®Ÿä½“ã¯S3ãªã©ã®å¤–éƒ¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ç½®ã„ã¦ã‚ã£ã¦ `Image` ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¯ãã®å‚ç…§ã ã‘ã‚’æŒã£ã¦ã„ã‚‹ã€ãã—ã¦ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ãƒ¼ãƒãƒªãƒ³ã‚¯ã¨ã—ã¦ `/image/1` ãªã©ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§S3ä¸Šã®ç”»åƒã‚’è¡¨ç¤ºã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€ã¨ã„ã†ä»•æ§˜ãŒã‚ã‚‹ã¨ã—ã¾ã—ã‚‡ã†ã€‚

ã“ã®å ´åˆã€`ImageController::show(Image $image)` ã®ã‚ˆã†ãªãƒ«ãƒ¼ãƒˆã§S3ã®ç½²åä»˜ãURLã‚’ç”Ÿæˆã—ã¦ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã¨ã„ã£ãŸå®Ÿè£…ã‚’ã™ã‚‹ã“ã¨ã«ãªã‚‹ã¨æ€ã†ã®ã§ã™ãŒã€ã“ã®ãƒ«ãƒ¼ãƒˆã«ã¯å¤šè¨€èªåŒ–ã¯å¿…è¦ãªã„ã§ã™ã‚ˆã­ã€‚

ã“ã®ã‚ˆã†ãªå ´åˆã«ã¯ã€`routes.yaml` ã«ä»¥ä¸‹ã®ã‚ˆã†ãªè¨­å®šã‚’è¿½è¨˜ã™ã‚‹ã“ã¨ã§ã€ç‰¹å®šã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã ã‘ã‚’å¤šè¨€èªåŒ–ã®å¯¾è±¡ã‹ã‚‰é™¤å¤–ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```diff:config/routes.yaml
  controllers:
    resource:
      path: ../src/Controller/
      namespace: App\Controller
    type: attribute
    prefix: /{_locale}
    requirements:
      _locale: ja|en
+ 
+ localeless_controllers:
+   resource: '../src/Controller/{Image,SomethingOther}Controller.php'
+   type: attribute
```

# 3. ãƒ­ã‚±ãƒ¼ãƒ«ã‚’çœç•¥ã—ãŸURLã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ­ã‚±ãƒ¼ãƒ«ã®URLã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹

å‰é …ã¾ã§ã§ãŠãŠã‚ˆãå¯¾å¿œå®Œäº†ãªã®ã§ã™ãŒã€ã§ãã‚Œã°ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã§ã€ãƒ­ã‚±ãƒ¼ãƒ«ã‚’çœç•¥ã—ãŸURLã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ­ã‚±ãƒ¼ãƒ«ã®URLã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã‚ˆã†ã«ã—ãŸã„ã§ã™ã‚ˆã­ã€‚

* `/` â†’ `/ja/`
* `/foo/bar` â†’ `/ja/foo/bar`

ã“ã‚Œã‚’å®Ÿç¾ã™ã‚‹ã«ã¯ã€ã€Œãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚Œã¦ã„ã‚‹URLã«ãƒ­ã‚±ãƒ¼ãƒ«ã‚’ä»˜åŠ ã—ã¦ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€ã‚’ä½œã£ã¦ã‚ã’ã‚Œã°ã‚ˆã„ã§ã™ã€‚

```php:src/Controller/AddLocaleController.php
class AddLocaleController extends AbstractController
{
    public function __invoke(Request $request): Response
    {
        $locale = $request->getDefaultLocale();

        $url = $request->getRequestUri();
        $url = "/{$locale}{$url}";

        return $this->redirect($url, 301);
    }
}
```

ã‚ã‚‹ã„ã¯ã€å¸¸ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ­ã‚±ãƒ¼ãƒ«ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ä»£ã‚ã‚Šã«ã€ã“ã“ã§ã¯ `Accept-Language` ãƒ˜ãƒƒãƒ€ãƒ¼ã®å†…å®¹ã«å¿œã˜ã¦é©åˆ‡ã¨æ€ã—ããƒ­ã‚±ãƒ¼ãƒ«ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã‚ˆã†ã«ã—ã¦ã‚‚ã‚ˆã„ã§ã—ã‚‡ã†ã€‚

```php:src/Controller/AddLocaleController.php
class AddLocaleController extends AbstractController
{
    private const array LOCALES = ['ja', 'en'];

    public function __invoke(Request $request): Response
    {
        $locale = $request->getPreferredLanguage(self::LOCALES);

        $url = $request->getRequestUri();
        $url = "/{$locale}{$url}";

        return $this->redirect($url, 301);
    }
}
```

ãã®ä¸Šã§ã€**`ja` ã§ã‚‚ `en` ã§ã‚‚ãªã„ãƒ‘ã‚¹ã‹ã‚‰å§‹ã¾ã‚‹URLã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã™ã¹ã¦ä¸€æ—¦ `AddLocaleController` ã«é€ã‚Šè¾¼ã‚€** ã‚ˆã†ã«ã™ã‚Œã°ã‚ˆã„ã§ã™ã€‚

```diff:config/routes.yaml
  controllers:
    resource:
      path: ../src/Controller/
      namespace: App\Controller
    type: attribute
    prefix: /{_locale}
    requirements:
      _locale: ja|en
  
  localeless_controllers:
    resource: '../src/Controller/{File,SomethingOther}Controller.php'
    type: attribute
+ 
+ add_locale:
+   path: /{path}
+   requirements:
+     path: ^(?!ja|en).*
+   defaults:
+     _controller: App\Controller\AddLocaleController
```

# 4. å…¨ãƒšãƒ¼ã‚¸ã« `hreflang` å±æ€§ã‚’é©åˆ‡ã«è¨­å®šã™ã‚‹

æœ€å¾Œã«ã€æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã®ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼ã«ã€Œã“ã®ãƒšãƒ¼ã‚¸ã«ã¯å¤šè¨€èªãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™ã‚ˆã€ã¨ä¼ãˆã‚‹ãŸã‚ã«ã€å¤šè¨€èªåŒ–ã•ã‚Œã¦ã„ã‚‹ã™ã¹ã¦ã®ãƒšãƒ¼ã‚¸ã« `hreflang` å±æ€§ã‚’é©åˆ‡ã«è¨­å®šã—ã¾ã™ã€‚

> å‚è€ƒï¼š[hreflangå±æ€§ã®æ›¸ãæ–¹ã¨æ³¨æ„ç‚¹ | HTMLã‚¿ã‚°ã¨ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ | ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«SEO BLOG](https://technical-seo.jp/hreflang/)

```twig:templates/base.html.twig
<head>
  {# ç•¥ #}

  {% set alternates = {'x-default': 'en', 'en': 'en', 'ja': 'ja'} %}
  {% for hreflang, lang in alternates %}
    {% set href = url(app.request.attributes.get('_route'), app.request.attributes.get('_route_params')|merge({'_locale': lang})) %}
    <link rel="alternate" href="{{ href }}" hreflang="{{ hreflang }}">
  {% endfor %}
</head>
```

```html:ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°çµæœ
<link rel="alternate" href="https://example.com/en/foo/bar" hreflang="x-default">
<link rel="alternate" href="https://example.com/en/foo/bar" hreflang="en">
<link rel="alternate" href="https://example.com/ja/foo/bar" hreflang="ja">
```

# ã¾ã¨ã‚

ã¨ã„ã†ã‚ã‘ã§ã€

* ã¾ãšã¯Symfony Translationã‚’å°å…¥ã—ã¦
* å‰æã¨ã—ã¦URLã«ãƒ­ã‚±ãƒ¼ãƒ«åã‚’å«ã‚ã‚‹ã‚ˆã†ã«ã—ã¦
* ãƒ­ã‚±ãƒ¼ãƒ«å…±é€šã®ãƒšãƒ¼ã‚¸ã—ã‹æä¾›ã—ãªã„URLã‚‚ã‚ã‚‹å ´åˆã¯ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®šã§é™¤å¤–ã™ã‚‹ã‚ˆã†ã«ã—ã¦
* ãƒ­ã‚±ãƒ¼ãƒ«ã‚’çœç•¥ã—ãŸURLã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ­ã‚±ãƒ¼ãƒ«ï¼ˆãªã©ï¼‰ã®URLã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã‚ˆã†ã«ã—ã¦
* `hreflang` å±æ€§ã‚‚é©åˆ‡ã«è¨­å®šã—ã¦ãŠã‘ã°

**ã„ã„æ„Ÿã˜ã«** ãªã‚‹ã¨æ€ã„ã¾ã™ã€ã¨ã„ã†ãŠè©±ã§ã—ãŸâœ‹

ä»Šå¹´ã‚‚1å¹´é–“ã€ãŸãã•ã‚“Symfonyä¸Šã§ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã¾ã—ãŸã€‚æ¥å¹´ã‚‚å¼•ãç¶šãSymfonyã¸ã®æ„Ÿè¬ã‚’èƒ¸ã«ã€OSSã‚„ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ¼ã¸ã®è²¢çŒ®ã‚’é ‘å¼µã£ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ï¼

ãã‚Œã§ã¯çš†ã•ã¾ã€ã‚ˆã„ãŠå¹´ã‚’ï¼
