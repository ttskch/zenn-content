---
title: "ã‚·ãƒ³ãƒ—ãƒ«ã§ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã‚„ã™ã„æœ€å¼·ã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ³ãƒ‰ãƒ« ttskch/paginator-bundle ã®ã”ç´¹ä»‹ 2023"
emoji: "ğŸ»"
type: "tech"
topics: ["php", "symfony", "pagination"]
published: true
published_at: 2023-12-24 00:00
---

ãƒ¡ãƒªãƒ¼ã‚¯ãƒªã‚¹ãƒã‚¹ã‚¤ãƒ–ï¼ğŸ…ğŸ

[Symfony Advent Calendar 2023](https://qiita.com/advent-calendar/2023/symfony) ã®24æ—¥ç›®ã®è¨˜äº‹ã§ã™ï¼ğŸ„âœ¨

> Twitter (X) ã§ã‚‚ã¡ã‚‡ã„ã¡ã‚‡ã„Symfonyãƒã‚¿ã‚’å‘Ÿã„ã¦ã¾ã™ã€‚ã‚ˆã‚ã—ã‘ã‚Œã° [ãƒ•ã‚©ãƒ­ãƒ¼](https://twitter.com/ttskch) ãŠé¡˜ã„ã—ã¾ã™ğŸ¤²

# ttskch/paginator-bundle

ãƒ€ã‚¤ãƒã§ã™ã€‚æ‹™ä½œã®ã‚·ãƒ³ãƒ—ãƒ«ã§ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã‚„ã™ã„æœ€å¼·ã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ³ãƒ‰ãƒ« `ttskch/paginator-bundle` ã‚’ç´¹ä»‹ã•ã›ã¦ãã ã•ã„ã€‚

https://github.com/ttskch/TtskchPaginatorBundle

![](https://img.esa.io/uploads/production/attachments/15064/2023/12/23/77821/44038844-bccb-4e43-80c7-6e4e0fe6ef81.png)

ã“ã‚“ãªæ„Ÿã˜ã®ç¾ã—ã„ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãŒç°¡å˜ã«å®Ÿè£…ã§ãã¾ã™ã€‚

åƒ•è‡ªèº«ãŒå®Ÿå‹™ã§ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã™ã‚‹ã«ã‚ãŸã£ã¦ã€æ—¢å­˜ã®ã©ã®ãƒãƒ³ãƒ‰ãƒ«ã«ã‚‚æº€è¶³ã§ããªã‹ã£ãŸã®ã§è‡ªä½œã—ã¾ã—ãŸã€‚

æœ€åˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å…¬é–‹ã—ã¦ã‹ã‚‰ã‚‚ã†3å¹´åŠãã‚‰ã„çµŒã£ã¦ã„ã¦æœªã ã«å®Ÿå‹™ã§ãƒãƒªãƒãƒªä½¿ã£ã¦ã‚‹ã‚“ã§ã™ãŒã€è‡ªåˆ†ã§ã‚‚ã¨ã¦ã‚‚æº€è¶³ã—ã¦ã„ã‚‹ã®ã§ã€ãœã²ã¿ãªã•ã‚“ã«ã‚‚ä½¿ã£ã¦ã¿ã¦ã»ã—ã„æ‰€å­˜ã§ã™ï¼

# ãƒ‡ãƒ¢

https://ttskchpaginatorbundle.herokuapp.com

ã“ã¡ã‚‰ã§å®Ÿéš›ã«å‹•ã„ã¦ã„ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã‚’è§¦ã‚Œã¾ã™ã€‚

# ç‰¹å¾´

* è¶…è»½é‡
* å‹å®‰å…¨ï¼ˆPHPStan level maxï¼‰
* Symfonyã¨Twigä»¥å¤–ã«ã¯ä¸€åˆ‡ä¾å­˜ãªã—
* ã«ã‚‚ã‹ã‹ã‚ã‚‰ãšã€ã»ã¨ã‚“ã©ã®Symfonyãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§æ¡ç”¨ã•ã‚Œã¦ã„ã‚‹Doctrine ORMã¨ã®é€£æºãŒã‚ã£ã¡ã‚ƒç°¡å˜
* ä»–ã«ã‚‚ä»»æ„ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ï¼ˆè‡ªåˆ†ã§ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’æ›¸ãã“ã¨ã§ï¼‰ãƒšãƒ¼ã‚¸ãƒãƒ¼ãƒˆå¯èƒ½
* ãƒšãƒ¼ã‚¸ãƒ£ãƒ¼éƒ¨åˆ†ã®HTMLã¯Twigã§ç°¡å˜ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½
* è¦‹å‡ºã—éƒ¨åˆ†ã‚’ç°¡å˜ã«ã‚½ãƒ¼ãƒˆã®ãŸã‚ã®ãƒªãƒ³ã‚¯ã«ã§ãã‚‹ï¼ˆã“ã“ã®HTMLã‚‚Twigã§ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ï¼‰
* æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã¨ã®é€£å‹•ã‚‚ç°¡å˜
* Bootstrap 4/5ãƒ™ãƒ¼ã‚¹ã®ç¾ã—ã„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ—ãƒªã‚»ãƒƒãƒˆ

ã¨ã„ã†æ„Ÿã˜ã®ãƒŠã‚¤ã‚¹ãªãƒãƒ³ãƒ‰ãƒ«ã§ã™ã€‚

* ãƒãƒ³ãƒ‰ãƒ«å›ºæœ‰ã®ã‚³ãƒ¼ãƒ‰ãŒå°‘ãªãæ¸ˆã‚“ã§ã€ã„ã–ã¨ãªã£ãŸã‚‰ã„ã¤ã§ã‚‚æ¨ã¦ã¦åˆ¥ã®å®Ÿè£…ã«ç§»è¡Œã§ãã‚‹
* ã ã‘ã©ã‚„ã‚ŠãŸã„ã“ã¨ã¯å…¨éƒ¨ã§ãã‚‹

ã¨ã„ã†ã®ã‚’æ„è­˜ã—ã¦ä½œã£ã¦ã„ã¾ã™ã€‚

ã„ã¤ã§ã‚‚æ¨ã¦ã‚‰ã‚Œã‚‹ã¨ã„ã†ã®ãŒç‰¹ã«å¤§äº‹ã ã¨æ€ã£ã¦ã„ã¦ã€å®Ÿéš›ã«ã€Œãƒãƒ³ãƒ‰ãƒ«ã‚’ä½¿ã‚ãšã«è‡ªåˆ†ã§å®Ÿè£…ã—ãŸã¨ã—ã¦ã‚‚ã©ã†ã›æ›¸ã‹ãªã„ã¨ã„ã‘ãªã„ã‚ˆã†ãªã‚‚ã®ã€ã ã‘ã—ã‹æä¾›ã—ã¦ã„ã¾ã›ã‚“ã€‚

ã‚‚ã—æ™®æ®µã‹ã‚‰ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’è‡ªåŠ›ã§æ›¸ã„ã¦ã„ã‚‹ã¨ã„ã†æ–¹ãŒã„ãŸã‚‰ã€è©¦ã—ã«ä½¿ã£ã¦ã¿ã¦ã„ãŸã ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™ï¼

# å‹•ä½œè¦ä»¶

æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã‚ã‚‹ v6 ç³»ã¯

* PHP: ^8.0
* Symfony: ^5.0|^6.0|^7.0

ã§ã™ã€‚

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

æ™®é€šã«Composerã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã€`bundles.php` ã«è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

```shell
$ composer require ttskch/paginator-bundle
```

```php
// config/bundles.php

return [
    // ...
    Ttskch\PaginatorBundle\TtskchPaginatorBundle::class => ['all' => true],
];
```

# Doctrine ORMã¨ã‚ã‚ã›ã¦ä½¿ã†

`ttskch/paginator-bundle` è‡ªä½“ã¯Doctrine ORMã«ãƒ­ãƒƒã‚¯ã‚¤ãƒ³ã¯ã—ã¦ã„ã¾ã›ã‚“ãŒã€Doctrine ORMã¨ã‚ã‚ã›ã¦ä½¿ã†ãŸã‚ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’ãƒ—ãƒªã‚»ãƒƒãƒˆã¨ã—ã¦æä¾›ã—ã¦ã„ã‚‹ã®ã§ã€ãã‚Œã‚’ä½¿ãˆã°ã¨ã¦ã‚‚å°‘ãªã„å¤‰æ›´ã§ç°¡å˜ã«ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’å°å…¥ã§ãã¾ã™ã€‚

ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚ˆãã‚ã‚‹ä¸€è¦§ç”»é¢ã®å ´åˆãªã‚‰ã€`ttskch/paginator-bundle` å°å…¥å‰å¾Œã®ã‚³ãƒ¼ãƒ‰ã¯ã“ã‚“ãªæ„Ÿã˜ã«ãªã‚Šã¾ã™ã€‚

**Before**

```php
// FooController.php

use Symfony\Component\HttpFoundation\Response;

public function index(FooRepository $fooRepository): Response
{
    return $this->render('index.html.twig', [
        'foos' => $fooRepository->findAll(),
    ]);
}
```

```twig
{# index.html.twig #}

<table>
  <thead>
  <tr>
    <th>Id</th>
    <th>Name</th>
    <th>Email</th>
  </tr>
  </thead>
  <tbody>
  {% for foo in foos %}
    <tr>
      <td>{{ foo.id }}</td>
      <td>{{ foo.name }}</td>
      <td>{{ foo.email }}</td>
    </tr>
  {% endfor %}
  </tbody>
</table>
```

**After**

```php
// FooController.php

use Symfony\Component\HttpFoundation\Response;
use Ttskch\PaginatorBundle\Counter\Doctrine\ORM\QueryBuilderCounter;
use Ttskch\PaginatorBundle\Criteria\Criteria;
use Ttskch\PaginatorBundle\Paginator;
use Ttskch\PaginatorBundle\Slicer\Doctrine\ORM\QueryBuilderSlicer;

/**
 * @param Paginator<\Traversable<array-key, Foo>, Criteria> $paginator
 */
public function index(FooRepository $fooRepository, Paginator $paginator): Response
{
    $qb = $fooRepository->createQueryBuilder('f');
    $paginator->initialize(new QueryBuilderSlicer($qb), new QueryBuilderCounter($qb), new Criteria('id'));

    return $this->render('index.html.twig', [
        'foos' => $paginator->getSlice(),
    ]);
}
```

```twig
{# index.html.twig #}

<table>
  <thead>
  <tr>
    <th>{{ ttskch_paginator_sortable('id', 'Id') }}</th>
    <th>{{ ttskch_paginator_sortable('name', 'Name') }}</th>
    <th>{{ ttskch_paginator_sortable('email', 'Email') }}</th>
  </tr>
  </thead>
  <tbody>
  {% for foo in foos %}
    <tr>
      <td>{{ foo.id }}</td>
      <td>{{ foo.name }}</td>
      <td>{{ foo.email }}</td>
    </tr>
  {% endfor %}
  </tbody>
</table>

{{ ttskch_paginator_pager() }}
```

ä»¥ä¸‹ã®éƒ¨åˆ†

```php
$paginator->initialize(new QueryBuilderSlicer($qb), new QueryBuilderCounter($qb), new Criteria('id'));
```

ã§ã€`$paginator` ãŒå†…éƒ¨çš„ã« `handleRequest()` ã‚’å®Ÿè¡Œã—ã¦ã€URLã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã‚‚ã¨ã«ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ãã‚Œã¾ã™ã€‚

`QueryBuilderSlicer` ã¨ `QueryBuilderCounter` ã¯ãã‚Œãã‚Œã€

* ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã® `Foo` ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹ãŸã‚ã®å‡¦ç†
* `Foo` ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ç·æ•°ã‚’ç®—å‡ºã™ã‚‹ãŸã‚ã®å‡¦ç†

ã‚’æ‹…ã£ã¦ã„ã¾ã™ã€‚

ã¾ãŸã€`Criteria` ã¯ã€URLã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦é€ä¿¡ã•ã‚ŒãŸãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã®æƒ…å ±ï¼ˆãƒšãƒ¼ã‚¸ç•ªå·ã‚„1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Šã®è¡¨ç¤ºä»¶æ•°ãªã©ï¼‰ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å½¢ã§ä¿æŒã—ã¦ãã‚Œã‚‹ã‚„ã¤ã§ã™ã€‚ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å¼•æ•°ã«æ¸¡ã—ã¦ã„ã‚‹ `'id'` ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚½ãƒ¼ãƒˆé …ç›®ã§ã™ã€‚

ã“ã‚Œã‚‰ãŒ `ttskch/paginator-bundle` ãŒç”¨æ„ã—ã¦ãã‚Œã¦ã„ã‚‹Doctrine ORMç”¨ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã§ã™ã€‚

ãƒ“ãƒ¥ãƒ¼å´ã§ã¯ã€

* `ttskch_paginator_sortable()` é–¢æ•°ã§ã‚½ãƒ¼ãƒˆã®ãŸã‚ã®ãƒªãƒ³ã‚¯ã‚’å‡ºåŠ›
* `ttskch_paginator_pager()` é–¢æ•°ã§ãƒšãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’å‡ºåŠ›

ã—ã¦ã„ã¾ã™ã€‚

# ãƒ“ãƒ¥ãƒ¼ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å¤‰æ›´ã™ã‚‹

ãƒ“ãƒ¥ãƒ¼ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯è¨­å®šã§è‡ªç”±ã«å¤‰æ›´ã§ãã¾ã™ã€‚

```yaml
# config/packages/ttskch_paginator.yaml

ttskch_paginator:
  template:
    pager: 'your/own/pager.html.twig'
    sortable: 'your/own/sortable.html.twig'
```

ãƒ—ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹Bootstrap 5ã‚¹ã‚¿ã‚¤ãƒ«ã®ãƒšãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’ä½¿ã„ãŸã„ã ã‘ãªã‚‰ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã™ã‚Œã°OKã§ã™ã€‚

```yaml
# config/packages/ttskch_paginator.yaml

ttskch_paginator:
  template:
    pager: '@TtskchPaginator/pager/bootstrap5.html.twig'
```

# æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚ã‚ã›ã¦ä½¿ã†

æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚ã‚ã›ã¦ä½¿ã†å ´åˆã¯ã€ãƒªãƒã‚¸ãƒˆãƒªã‚¯ãƒ©ã‚¹ãªã©ã« `QueryBuilder` ã®çµ„ã¿ç«‹ã¦ã‚’æ›¸ã„ã¦ã€ãã‚Œã‚’ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦æ¸¡ã—ã¾ã™ã€‚

ã“ã®ã¨ãã€URLã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦é€ä¿¡ã•ã‚ŒãŸæ¤œç´¢æ¡ä»¶ã‚„ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ã„ã¡ã„ã¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰å–ã‚Šå‡ºã—ãŸã‚Šã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã»ã©ç™»å ´ã—ãŸ `Criteria` ã¨ã„ã†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒãã‚Œã‚‰ã‚’ä¿æŒã™ã‚‹å½¹å‰²ã‚’æ‹…ã£ã¦ã„ã¦ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã§ `$paginator->initialize()` ã—ãŸã¨ãã«URLã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å€¤ãŒé©åˆ‡ã«ã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® `Criteria` ã¯ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ã ã‘ã—ã‹æŒãŸãªã„ãŸã‚ã€ã“ã‚Œã‚’ç¶™æ‰¿ã—ã¦æ¤œç´¢æ¡ä»¶ã®æƒ…å ±ã‚’æŒã¤ã‚ˆã†ã«ã—ãŸç‹¬è‡ªã® `FooCriteria` ã‚’ä½œã‚‹ã¨ã“ã‚ã‹ã‚‰å§‹ã‚ã¾ã™ã€‚

ä»Šå›ã¯ä¾‹ã¨ã—ã¦ã€æ–‡å­—åˆ—ã§æ¤œç´¢ã™ã‚‹ãŸã‚ã® `query` ã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¿½åŠ ã—ã¦ã¿ã¾ã™ã€‚

```php
// FooCriteria.php

use Ttskch\PaginatorBundle\Criteria\AbstractCriteria;

class FooCriteria extends AbstractCriteria
{
    public ?string $query = null;

    public function __construct(string $sort)
    {
        parent::__construct($sort);
    }

    public function getFormTypeClass(): string
    {
        return FooSearchType::class;
    }
}
```

ç¶šã„ã¦ã€ã“ã® `FooCriteria` ã«å¯¾å¿œã™ã‚‹ `FooFormType` ã‚’ä½œã‚Šã¾ã™ã€‚`ttskch/paginator-bundle` ãŒæä¾›ã—ã¦ã„ã‚‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® `CriteriaType` ã‚’ç¶™æ‰¿ã™ã‚‹ã“ã¨ã§ã€ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ã«é–¢ã™ã‚‹å‡¦ç†ã‚’æ°—ã«ã›ãšã€è‡ªåˆ†ãŒè¿½åŠ ã—ãŸæ¤œç´¢é …ç›®ã®ã“ã¨ã ã‘ã‚’è€ƒãˆã‚Œã°ã„ã„ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```php
// FooSearchType.php

use Symfony\Component\Form\AbstractType;
use Symfony\Component\Form\Extension\Core\Type\SearchType;
use Symfony\Component\Form\FormBuilderInterface;
use Symfony\Component\OptionsResolver\OptionsResolver;
use Ttskch\PaginatorBundle\Form\CriteriaType;

class FooSearchType extends AbstractType
{
    public function buildForm(FormBuilderInterface $builder, array $options): void
    {
        $builder
            ->add('query', SearchType::class)
        ;
    }

    public function configureOptions(OptionsResolver $resolver): void
    {
        $resolver->setDefaults([
            'data_class' => FooCriteria::class,
            // symfony/security-csrf ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ç’°å¢ƒã§ã¯ä»¥ä¸‹ãŒå¿…è¦
            // 'csrf_protection' => false,
        ]);
    }

    public function getParent(): string
    {
        return CriteriaType::class;
    }
}
```

æ¬¡ã«ã€ãƒªãƒã‚¸ãƒˆãƒªã‚¯ãƒ©ã‚¹ãªã©ã« `FooCriteria` ã‚’ã‚‚ã¨ã« `QueryBuilder` ã‚’çµ„ã¿ç«‹ã¦ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½œã‚Šã¾ã™ã€‚

```php
// FooRepository.php

use Doctrine\Bundle\DoctrineBundle\Repository\ServiceEntityRepository;
use Doctrine\ORM\QueryBuilder;

/**
 * @extends ServiceEntityRepository<Foo>
 */
class FooRepository extends ServiceEntityRepository
{
    // ...

    private function createQueryBuilderFromCriteria(FooCriteria $criteria): QueryBuilder
    {
        return $this->createQueryBuilder('f')
            ->orWhere('f.name like :query')
            ->orWhere('f.email like :query')
            ->setParameter('query', '%'.str_replace('%', '\%', $criteria->query).'%')
        ;
    }
}
```

`$criteria->query` ã‚’LIKEå¥ã«é£Ÿã‚ã›ã¦æ¤œç´¢ã—ã¦ã„ã‚‹ã ã‘ã§ã™ã­ã€‚

ã“ã® `QueryBuilder` ã‚’çµ„ã¿ç«‹ã¦ã‚‹å‡¦ç†ã ã‘ã¯ã‚¢ãƒ—ãƒªå›ºæœ‰ãªã®ã§è‡ªåˆ†ã§æ›¸ãå¿…è¦ãŒã©ã†ã—ã¦ã‚‚ã‚ã‚Šã¾ã™ãŒã€ã“ã‚Œã‚’ã‚‚ã¨ã« `Slicer` ãŠã‚ˆã³ `Counter` ã‚’ä½œã‚‹å‡¦ç†ã«ã¯ `ttskch/paginator-bundle` ãŒæä¾›ã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’æ´»ç”¨ã§ãã¾ã™ã€‚

```php
// FooRepository.php

use Doctrine\Bundle\DoctrineBundle\Repository\ServiceEntityRepository;
use Doctrine\ORM\QueryBuilder;
use Ttskch\PaginatorBundle\Counter\Doctrine\ORM\QueryBuilderCounter;
use Ttskch\PaginatorBundle\Slicer\Doctrine\ORM\QueryBuilderSlicer;

/**
 * @extends ServiceEntityRepository<Foo>
 */
class FooRepository extends ServiceEntityRepository
{
    // ...

    /**
     * @return \Traversable<array-key, Foo>
     */
    public function sliceByCriteria(FooCriteria $criteria): \Traversable
    {
        $qb = $this->createQueryBuilderFromCriteria($criteria);
        $slicer = new QueryBuilderSlicer($qb);
    
        return $slicer->slice($criteria);
    }
    
    public function countByCriteria(FooCriteria $criteria): int
    {
        $qb = $this->createQueryBuilderFromCriteria($criteria);
        $counter = new QueryBuilderCounter($qb);
    
        return $counter->count($criteria);
    }
    
    private function createQueryBuilderFromCriteria(FooCriteria $criteria): QueryBuilder
    {
        return $this->createQueryBuilder('f')
            ->orWhere('f.name like :query')
            ->orWhere('f.email like :query')
            ->setParameter('query', '%'.str_replace('%', '\%', $criteria->query).'%')
        ;
    }
}
```

ã“ã‚“ãªæ„Ÿã˜ã§ã€æ¤œç´¢æ¡ä»¶é©ç”¨æ¸ˆã¿ã® `QueryBuilderã‚’` æ¸¡ã—ã¦ `Slicer` ãŠã‚ˆã³ `Counter` ã‚’ä½œã‚Šã€ãã‚Œã‚‰ã®å‡¦ç†ã‚’ `FooCriteria` ã‚’æ¸¡ã—ã¦å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ã™ã‚Œã°OKã§ã™ã€‚

æœ€å¾Œã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã®å®Ÿè£…ã§ã™ã€‚

`$paginator->initialize()` ã«å…ˆã»ã©ä½œã£ãŸãƒªãƒã‚¸ãƒˆãƒªã‚¯ãƒ©ã‚¹ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ¸¡ã—ã¾ã™ã€‚

`Criteria` ãŒæŒã¤ `getFormTypeClass()`ãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚ˆã£ã¦å¯¾å¿œã™ã‚‹ `FormType` ã‚¯ãƒ©ã‚¹ãŒè‡ªå‹•ã§åˆ¤åˆ¥ã•ã‚Œã‚‹ï¼ˆã“ã“ã§ã¯ `FooFormType`ï¼‰ã®ã§ã€`$paginator->getForm()` ã«ã‚ˆã£ã¦ `handleRequest()` æ¸ˆã¿ã® `FooFormType` ã® `Form` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå–å¾—ã§ãã¾ã™ã€‚

```php
// FooController.php

use Symfony\Component\HttpFoundation\Response;
use Ttskch\PaginatorBundle\Paginator;

/**
 * @param Paginator<\Traversable<array-key, Foo>, FooCriteria> $paginator
 */
public function index(FooRepository $fooRepository, Paginator $paginator): Response
{
    $paginator->initialize(
        $fooRepository->sliceByCriteria(...),
        $fooRepository->countByCriteria(...),
        new FooCriteria('id'),
    );

    return $this->render('index.html.twig', [
        'foos' => $paginator->getSlice(),
        'form' => $paginator->getForm()->createView(),
    ]);
}
```

ã‚ã¨ã¯ãƒ“ãƒ¥ãƒ¼ã«ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¨­ç½®ã™ã‚Œã°å®Œäº†ã§ã™ã€‚

```diff
  {# index.html.twig #}

+ {{ form(form, {action: path('foo_index'), method: 'get'}) }}
+ 
  <table>
      <thead>
      <tr>
          <th>{{ ttskch_paginator_sortable('id', 'Id') }}</th>
          <th>{{ ttskch_paginator_sortable('name', 'Name') }}</th>
          <th>{{ ttskch_paginator_sortable('email', 'Email') }}</th>
      </tr>
      </thead>
      <tbody>
      {% for foo in foos %}
          <tr>
              <td>{{ foo.id }}</td>
              <td>{{ foo.name }}</td>
              <td>{{ foo.email }}</td>
          </tr>
      {% endfor %}
      </tbody>
  </table>
  
  {{ ttskch_paginator_pager() }}
```

# ãŠã‚ã‚Šã«

ã¨ã„ã†ã‚ã‘ã§ã€æ‹™ä½œã®ã‚·ãƒ³ãƒ—ãƒ«ã§ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã‚„ã™ã„æœ€å¼·ã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ³ãƒ‰ãƒ« `ttskch/paginator-bundle` ã‚’ç´¹ä»‹ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚

https://github.com/ttskch/TtskchPaginatorBundle

ç¹°ã‚Šè¿”ã—ã«ãªã‚Šã¾ã™ãŒã€ã‚‚ã—æ™®æ®µã‹ã‚‰ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’è‡ªåŠ›ã§æ›¸ã„ã¦ã„ã‚‹ã¨ã„ã†æ–¹ãŒã„ãŸã‚‰ã€è©¦ã—ã«ä½¿ã£ã¦ã¿ã¦ã„ãŸã ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™ï¼

æ„Ÿæƒ³ã‚„Issue/PRãªã©ã‚‚ãŠå¾…ã¡ã—ã¦ã¾ã™ï¼

[Symfony Advent Calendar 2023](https://qiita.com/advent-calendar/2023/symfony)ã€æ˜æ—¥ã¯ [@kuni__94](https://twitter.com/kuni__94) ã•ã‚“ã§ã™ï¼ãŠæ¥½ã—ã¿ã«ï¼
