---
title: "Laravel版のAPI PlatformでSystem ProviderやSystem Processorをデコレートするのが難しかった話"
emoji: "🕸️"
type: "tech"
topics: ["php", "apiplatform", "symfony"]
published: true
---

# 3行で

- Laravel版の [API Platofrm](https://api-platform.com/) でシステムプロセッサーをデコレートしようとしたら循環依存が発生した
- LLMや [@fuwasegu さんに相談](https://x.com/ttskch/status/1979104036734509510) しつつ調べたら、現状のAPI Platformの内部構造ではSystem ProviderやSystem Processorを適切な方法でデコレートすることができないということが分かった
- ので改善案を [PR](https://github.com/api-platform/core/pull/7467) してみた

# 詳細

Laravelのサービスコンテナでは、[`extend()` を使ってサービスをデコレートすることができます](https://laravel.com/docs/12.x/container#extending-bindings)。

この方法で、[API PlatformのSystem Processor](https://api-platform.com/docs/v4.1/core/extending/#system-providers-and-processors) である `WriteProcessor` をデコレートしようと以下のようなコードを書きました。

```php:app/Providers/AppServiceProvider.php
<?php

namespace App\Providers;

use ApiPlatform\State\Processor\WriteProcessor;
use App\State\AppWriteProcessor;
use Illuminate\Support\ServiceProvider;

class AppServiceProvider extends ServiceProvider
{
    public function register(): void
    {
    }

    public function boot(): void
    {
        $this->app->extend(WriteProcessor::class, function (WriteProcessor $inner) {
            return new AppWriteProcessor($inner);
        });
    }
}
```

```php
<?php

declare(strict_types=1);

namespace App\State;

use ApiPlatform\Metadata\Operation;
use ApiPlatform\State\Processor\WriteProcessor;
use ApiPlatform\State\ProcessorInterface;

final class AppWriteProcessor implements ProcessorInterface
{
    public function __construct(
        private readonly WriteProcessor $decorated,
    ) {
    }

    public function process(mixed $data, Operation $operation, array $uriVariables = [], array $context = []): mixed
    {
        return $this->decorated->process($data, $operation, $uriVariables, $context);
    }
}
```

すると、サービスコンテナにおいて循環依存が発生してしまい、

<img width="744" alt="image.png (45.8 kB)" src="https://img.esa.io/uploads/production/attachments/15064/2025/10/18/77821/4356ade6-9b1b-4cae-a5e0-9ee417aa2ff6.png">

こうなってしまいました。

原因を調べたところ、API Platformの

- https://github.com/api-platform/laravel/blob/v4.2.2/ApiPlatformDeferredProvider.php#L103
- https://github.com/api-platform/laravel/blob/v4.2.2/ApiPlatformDeferredProvider.php#L183
- https://github.com/api-platform/laravel/blob/v4.2.2/ApiPlatformDeferredProvider.php#L325-L337

この辺で `ProcessorInterface` の実装クラスすべてに `ProcessorInterface::class` タグが付けられ、

`ProcessorInterface::class` タグが付けられたクラスは

- https://github.com/api-platform/laravel/blob/v4.2.2/ApiPlatformDeferredProvider.php#L173

ここで `CallableProcessor`（アプリケーションが実装している各種プロセッサーを保持するChain of Responsibility）の依存に含まれるという実装になっていました。

そして、

- https://github.com/api-platform/laravel/blob/v4.2.2/ApiPlatformProvider.php#L432

ここにあるとおり `CallableProcessor` は `WriteProcessor` の依存であるため、

`CallebleProcessor` → `AppWriteProcessor` → `WriteProcessor` → `CallableProcessor` という循環依存になってしまっていたのです。

この循環を断ち切るには、

- `AppWriteProcessor` のコンストラクターの引数の型を `WriteProcessor` ではなく `mixed` などに変更する
- そもそも `AppWriteProcessor` が `CallableProcessor` の依存に含まれてしまうことが間違いなので[^1]、それを回避する

[^1]: `CallableProcessor` が `WriteProcessor` の依存になっていることから分かるように、`CallableProcessor` に含まれるべきは「アプリケーションレイヤーの [State Processor](https://api-platform.com/docs/v4.1/core/state-processors/)」のみであり、[System Processor](https://api-platform.com/docs/v4.1/core/extending/#system-providers-and-processors) である `AppWriteProcessor` が含まれてしまうのは間違いです。現状のLaravel版API Platformでは、アプリケーションのコードベースにSystem Processor（のデコレーター）がいることが想定されていなかったということですね。

のいずれかの方法しかありません。

そこで、`SkipAutoconfigure` というアトリビュートを作って、

```php
<?php

declare(strict_types=1);

namespace App\Attribute;

#[\Attribute(\Attribute::TARGET_CLASS)]
class SkipAutoconfigure
{
}
```

API Platformのコードの [この辺](https://github.com/api-platform/laravel/blob/v4.2.2/ApiPlatformDeferredProvider.php#L104) に

```php
foreach ($classes as $className => $refl) {
    foreach ($refl->getAttributes() as $attribute) {
        if ($attribute->getName() === SkipAutoconfigure::class) {
            unset($classes[$className]);
        }
    }
}
```

こんなコードを挿入することで、[循環しなくなることを確認しました](https://github.com/ttskch/api-platform-laravel-system-provider-decoration-example/commit/e995443c223553eff5f9dfe14295c2b32a477072)。

この対応を [本家にPRしてみました](https://github.com/api-platform/core/pull/7467) が、自分でもこれが（現状の実装に合わせた最小コストの対応ではあるかもしれないけど）理想的な対応だとは思ってないので、どうなるかは分かりません。

おわり

（ [@fuwasegu](https://x.com/fuwasegu) さん、相談乗ってくれてありがとうございました！）
