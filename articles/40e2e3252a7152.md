---
title: "Laravelç‰ˆã®API Platformã§System Providerã‚„System Processorã‚’ãƒ‡ã‚³ãƒ¬ãƒ¼ãƒˆã™ã‚‹ã®ãŒé›£ã—ã‹ã£ãŸè©±"
emoji: "ğŸ•¸ï¸"
type: "tech"
topics: ["php", "apiplatform", "symfony"]
published: true
---

# 3è¡Œã§

- Laravelç‰ˆã® [API Platofrm](https://api-platform.com/) ã§ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ã‚’ãƒ‡ã‚³ãƒ¬ãƒ¼ãƒˆã—ã‚ˆã†ã¨ã—ãŸã‚‰å¾ªç’°ä¾å­˜ãŒç™ºç”Ÿã—ãŸ
- LLMã‚„ [@fuwasegu ã•ã‚“ã«ç›¸è«‡](https://x.com/ttskch/status/1979104036734509510) ã—ã¤ã¤èª¿ã¹ãŸã‚‰ã€ç¾çŠ¶ã®API Platformã®å†…éƒ¨æ§‹é€ ã§ã¯System Providerã‚„System Processorã‚’é©åˆ‡ãªæ–¹æ³•ã§ãƒ‡ã‚³ãƒ¬ãƒ¼ãƒˆã™ã‚‹ã“ã¨ãŒã§ããªã„ã¨ã„ã†ã“ã¨ãŒåˆ†ã‹ã£ãŸ
- ã®ã§æ”¹å–„æ¡ˆã‚’ [PR](https://github.com/api-platform/core/pull/7467) ã—ã¦ã¿ãŸ

# è©³ç´°

Laravelã®ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ³ãƒ†ãƒŠã§ã¯ã€[`extend()` ã‚’ä½¿ã£ã¦ã‚µãƒ¼ãƒ“ã‚¹ã‚’ãƒ‡ã‚³ãƒ¬ãƒ¼ãƒˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™](https://laravel.com/docs/12.x/container#extending-bindings)ã€‚

ã“ã®æ–¹æ³•ã§ã€[API Platformã®System Processor](https://api-platform.com/docs/v4.1/core/extending/#system-providers-and-processors) ã§ã‚ã‚‹ `WriteProcessor` ã‚’ãƒ‡ã‚³ãƒ¬ãƒ¼ãƒˆã—ã‚ˆã†ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã¾ã—ãŸã€‚

```php:app/Providers/AppServiceProvider.php
<?php

namespace App\Providers;

use ApiPlatform\State\Processor\WriteProcessor;
use App\State\AppWriteProcessor;
use Illuminate\Support\ServiceProvider;

class AppServiceProvider extends ServiceProvider
{
    public function register(): void
    {
    }

    public function boot(): void
    {
        $this->app->extend(WriteProcessor::class, function (WriteProcessor $inner) {
            return new AppWriteProcessor($inner);
        });
    }
}
```

```php
<?php

declare(strict_types=1);

namespace App\State;

use ApiPlatform\Metadata\Operation;
use ApiPlatform\State\Processor\WriteProcessor;
use ApiPlatform\State\ProcessorInterface;

final class AppWriteProcessor implements ProcessorInterface
{
    public function __construct(
        private readonly WriteProcessor $decorated,
    ) {
    }

    public function process(mixed $data, Operation $operation, array $uriVariables = [], array $context = []): mixed
    {
        return $this->decorated->process($data, $operation, $uriVariables, $context);
    }
}
```

ã™ã‚‹ã¨ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ³ãƒ†ãƒŠã«ãŠã„ã¦å¾ªç’°ä¾å­˜ãŒç™ºç”Ÿã—ã¦ã—ã¾ã„ã€

![](https://img.esa.io/uploads/production/attachments/15064/2025/10/18/77821/4356ade6-9b1b-4cae-a5e0-9ee417aa2ff6.png)

ã“ã†ãªã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚

åŸå› ã‚’èª¿ã¹ãŸã¨ã“ã‚ã€API Platformã®

- https://github.com/api-platform/laravel/blob/v4.2.2/ApiPlatformDeferredProvider.php#L103
- https://github.com/api-platform/laravel/blob/v4.2.2/ApiPlatformDeferredProvider.php#L183
- https://github.com/api-platform/laravel/blob/v4.2.2/ApiPlatformDeferredProvider.php#L325-L337

ã“ã®è¾ºã§ `ProcessorInterface` ã®å®Ÿè£…ã‚¯ãƒ©ã‚¹ã™ã¹ã¦ã« `ProcessorInterface::class` ã‚¿ã‚°ãŒä»˜ã‘ã‚‰ã‚Œã€

`ProcessorInterface::class` ã‚¿ã‚°ãŒä»˜ã‘ã‚‰ã‚ŒãŸã‚¯ãƒ©ã‚¹ã¯

- https://github.com/api-platform/laravel/blob/v4.2.2/ApiPlatformDeferredProvider.php#L173

ã“ã“ã§ `CallableProcessor`ï¼ˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Ÿè£…ã—ã¦ã„ã‚‹å„ç¨®ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ã‚’ä¿æŒã™ã‚‹Chain of Responsibilityï¼‰ã®ä¾å­˜ã«å«ã¾ã‚Œã‚‹ã¨ã„ã†å®Ÿè£…ã«ãªã£ã¦ã„ã¾ã—ãŸã€‚

ãã—ã¦ã€

- https://github.com/api-platform/laravel/blob/v4.2.2/ApiPlatformProvider.php#L432

ã“ã“ã«ã‚ã‚‹ã¨ãŠã‚Š `CallableProcessor` ã¯ `WriteProcessor` ã®ä¾å­˜ã§ã‚ã‚‹ãŸã‚ã€

`CallebleProcessor` â†’ `AppWriteProcessor` â†’ `WriteProcessor` â†’ `CallableProcessor` ã¨ã„ã†å¾ªç’°ä¾å­˜ã«ãªã£ã¦ã—ã¾ã£ã¦ã„ãŸã®ã§ã™ã€‚

ã“ã®å¾ªç’°ã‚’æ–­ã¡åˆ‡ã‚‹ã«ã¯ã€

- `AppWriteProcessor` ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ã®å¼•æ•°ã®å‹ã‚’ `WriteProcessor` ã§ã¯ãªã `mixed` ãªã©ã«å¤‰æ›´ã™ã‚‹
- ãã‚‚ãã‚‚ `AppWriteProcessor` ãŒ `CallableProcessor` ã®ä¾å­˜ã«å«ã¾ã‚Œã¦ã—ã¾ã†ã“ã¨ãŒé–“é•ã„ãªã®ã§[^1]ã€ãã‚Œã‚’å›é¿ã™ã‚‹

[^1]: `CallableProcessor` ãŒ `WriteProcessor` ã®ä¾å­˜ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‹ã‚‰åˆ†ã‹ã‚‹ã‚ˆã†ã«ã€`CallableProcessor` ã«å«ã¾ã‚Œã‚‹ã¹ãã¯ã€Œã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ã‚¤ãƒ¤ãƒ¼ã® [State Processor](https://api-platform.com/docs/v4.1/core/state-processors/)ã€ã®ã¿ã§ã‚ã‚Šã€[System Processor](https://api-platform.com/docs/v4.1/core/extending/#system-providers-and-processors) ã§ã‚ã‚‹ `AppWriteProcessor` ãŒå«ã¾ã‚Œã¦ã—ã¾ã†ã®ã¯é–“é•ã„ã§ã™ã€‚ç¾çŠ¶ã®Laravelç‰ˆAPI Platformã§ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã«System Processorï¼ˆã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼‰ãŒã„ã‚‹ã“ã¨ãŒæƒ³å®šã•ã‚Œã¦ã„ãªã‹ã£ãŸã¨ã„ã†ã“ã¨ã§ã™ã­ã€‚

ã®ã„ãšã‚Œã‹ã®æ–¹æ³•ã—ã‹ã‚ã‚Šã¾ã›ã‚“ã€‚

ãã“ã§ã€`SkipAutoconfigure` ã¨ã„ã†ã‚¢ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ãƒˆã‚’ä½œã£ã¦ã€

```php
<?php

declare(strict_types=1);

namespace App\Attribute;

#[\Attribute(\Attribute::TARGET_CLASS)]
class SkipAutoconfigure
{
}
```

API Platformã®ã‚³ãƒ¼ãƒ‰ã® [ã“ã®è¾º](https://github.com/api-platform/laravel/blob/v4.2.2/ApiPlatformDeferredProvider.php#L104) ã«

```php
foreach ($classes as $className => $refl) {
    foreach ($refl->getAttributes() as $attribute) {
        if ($attribute->getName() === SkipAutoconfigure::class) {
            unset($classes[$className]);
        }
    }
}
```

ã“ã‚“ãªã‚³ãƒ¼ãƒ‰ã‚’æŒ¿å…¥ã™ã‚‹ã“ã¨ã§ã€[å¾ªç’°ã—ãªããªã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ãŸ](https://github.com/ttskch/api-platform-laravel-system-provider-decoration-example/commit/e995443c223553eff5f9dfe14295c2b32a477072)ã€‚

ã“ã®å¯¾å¿œã‚’ [æœ¬å®¶ã«PRã—ã¦ã¿ã¾ã—ãŸ](https://github.com/api-platform/core/pull/7467) ãŒã€è‡ªåˆ†ã§ã‚‚ã“ã‚ŒãŒï¼ˆç¾çŠ¶ã®å®Ÿè£…ã«åˆã‚ã›ãŸæœ€å°ã‚³ã‚¹ãƒˆã®å¯¾å¿œã§ã¯ã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã‘ã©ï¼‰ç†æƒ³çš„ãªå¯¾å¿œã ã¨ã¯æ€ã£ã¦ãªã„ã®ã§ã€ã©ã†ãªã‚‹ã‹ã¯åˆ†ã‹ã‚Šã¾ã›ã‚“ã€‚

ãŠã‚ã‚Š

ï¼ˆ [@fuwasegu](https://x.com/fuwasegu) ã•ã‚“ã€ç›¸è«‡ä¹—ã£ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼ï¼‰
