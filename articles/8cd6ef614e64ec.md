---
title: "[Flutter/Firestore] ORæ¤œç´¢ã—ã¤ã¤å¤‰æ›´æ¤œçŸ¥ã—ãŸã„"
emoji: "ğŸ’»"
type: "tech"
topics: ["flutter", "firestore"]
published: true
published_at: 2020-08-20
---

:::message
ã“ã®è¨˜äº‹ã¯ã€2020-08-20ã«åˆ¥ã®ãƒ–ãƒ­ã‚°åª’ä½“ã«æŠ•ç¨¿ã—ãŸè¨˜äº‹ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ã™ã€‚
:::

[cloud_firestore](https://pub.dev/packages/cloud_firestore) ã‚’ä½¿ã£ã¦Flutterã‚¢ãƒ—ãƒªã‹ã‚‰Cloud Firestoreã‚’ä½¿ã†éš›ã«ã€ORæ¤œç´¢ã—ã¤ã¤å¤‰æ›´æ¤œçŸ¥ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦è‰²ã€…æ¤œè¨ã—ãŸã®ã§å‚™å¿˜éŒ²ã¨ã—ã¦æ®‹ã—ã¾ã™ã€‚

# Firestoreã§ã¯ORæ¤œç´¢ã¯ã§ããªã„

é€šå¸¸ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã§ `where()` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦ã‚¯ã‚¨ãƒªã‚’çµ„ã¿ç«‹ã¦ã¦ã€ `QuerySnapshot` ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’listenã™ã‚‹ã“ã¨ã§å¤‰æ›´æ¤œçŸ¥ã‚’è¡Œã„ã¾ã™ã€‚

```dart
final Query query = Firestore.instance.collection('foo')
    .where('bar', isEqualTo: 'baz')
    .orderBy('createdAt');

query.snapshots().listen((qss) {
    final List<DocumentSnapshot> docs = qss.documents;
    final List<DocumentSnapshot> changedDocs = qss.documentChanges.map((docChange) => docChange.document).toList();
    
    // å¤‰æ›´ã‚’æ¤œçŸ¥ã—ãŸéš›ã«å®Ÿè¡Œã—ãŸã„å‡¦ç†
});
```

ã—ã‹ã—ã€ORæ¤œç´¢ã‚’å«ã‚€æ¡ä»¶ã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’çµã‚Šè¾¼ã¿ãŸã„å ´åˆã¯ã‚„ã£ã‹ã„ã§ã™ã€‚

[Firestoreã®ä»•æ§˜ã¨ã—ã¦ORæ¤œç´¢ã¯ã§ããš](https://firebase.google.com/docs/firestore/query-data/queries?hl=ja#query_limitations)ã€ORæ¡ä»¶ã”ã¨ã«ç‹¬ç«‹ã—ãŸã‚¯ã‚¨ãƒªã‚’ä½œæˆã—ã¦ã‚¢ãƒ—ãƒªå´ã§çµæœã‚’çµåˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã—ã‹ã—ã€ãã†ã™ã‚‹ã¨é€šå¸¸ã®ã‚ˆã†ã« `Query::snapshots()` ã‚’listenã™ã‚‹ã¨ã„ã†ã“ã¨ãŒã§ãã¾ã›ã‚“ğŸ¤”

# `whereIn` ã¨ã‹ `arrayContains` ã¨ã‹ `arrayContainsAny` ã¨ã‹ã‚ã‚‹ã‘ã©ï¼Ÿ

`where()` ãƒ¡ã‚½ãƒƒãƒ‰ã®æ¯”è¼ƒæ¼”ç®—å­ã¨ã—ã¦ `whereIn` `arrayContains` `arrayContainsAny` ã¨ã„ã£ãŸã‚‚ã®ã¯ç”¨æ„ã•ã‚Œã¦ã„ã¦ã€ã“ã‚Œã‚‰ã¯ã¾ã•ã«ORæ¤œç´¢ã®ç”¨é€”ãªã®ã§ã™ãŒã€æ®‹å¿µãªãŒã‚‰æ¡ä»¶ã¨ã—ã¦æ¸¡ã›ã‚‹é…åˆ—ã¯æœ€å¤§ã§è¦ç´ æ•°10ä»¶ã¾ã§ã—ã‹å¯¾å¿œã—ã¦ã„ãªã„ã‚ˆã†ã§ã™ã€‚

ã¾ãŸã€ç©ºã®é…åˆ—ã‚’æ¸¡ã™ã“ã¨ã‚‚ã§ãã¾ã›ã‚“ã€‚

```dart
// å‹•ã
final Query query = Firestore.instance.collection('foo')
    .where('number', whereIn: [1,2,3,4,5,6,7,8,9,10]);

// ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
// Invalid Query. 'arrayContainsAny' filters support a maximum of 10 elements in the value array.
final Query query = Firestore.instance.collection('foo')
    .where('number', whereIn: [1,2,3,4,5,6,7,8,9,10,11]);

// ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
// Invalid Query. A non-empty array is required for 'whereIn' filters.
final Query query = Firestore.instance.collection('foo')
    .where('number', whereIn: []);
```

ãªã®ã§ã€å‹•çš„ãªé…åˆ—ã‚’ä½¿ã£ãŸORæ¤œç´¢ã¨ã—ã¦ã¯å®Ÿè³ªä½¿ãˆã¾ã›ã‚“ğŸ˜“

> å‚è€ƒï¼š[Firestoreã®ArrayContainAnyã‚¯ã‚¨ãƒªã§ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’å®Ÿè£…ã—ã¦ã¿ãŸ - Qiita](https://qiita.com/yuto_nakano44/items/02631ea4a79e940cdf80#%E3%82%B3%E3%83%BC%E3%83%89)

# è§£æ±ºç­–ï¼šã‚¢ãƒ—ãƒªå´ã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’çµã‚Šè¾¼ã‚“ã§ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã”ã¨ã«listenã™ã‚‹

ã‚¯ã‚¨ãƒªã‚’listenã™ã‚‹ã“ã¨ãŒã§ããªã„ã®ã§ã‚ã‚Œã°ã€ã‚¢ãƒ—ãƒªå´ã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’çµã‚Šè¾¼ã‚“ã§ãŠã„ã¦ã€ãã‚Œã‚‰ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ãã‚Œãã‚Œå€‹åˆ¥ã«listenã™ã‚Œã°ä¸€å¿œã‚„ã‚ŠãŸã„ã“ã¨ãŒã§ãã¾ã™ã€‚

```dart
List<Foo> foos = (await Firestore.instance.collection('foo').getDocuments())
    .documents
    .map((doc) => _fromDoc(doc)) // DocumentSnapshotã‚’Fooãƒ¢ãƒ‡ãƒ«ã«å¤‰æ›ã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’ä½œã£ã¦ãŠãã‚¤ãƒ¡ãƒ¼ã‚¸
    .toList();

// ORæ¤œç´¢ã¯ã‚¢ãƒ—ãƒªå´ã§è¡Œã†
List<Foo> filteredFoos = foos.where((foo) => targetIds.contains(foo.id)).toList();

filteredFoos.forEach((foo) {
    Firestore.instance.collection('foo')
        .document(foo.id)
        .snapshots()
        .listen((DocumentSnapshot doc) {
            // å¤‰æ›´ã‚’æ¤œçŸ¥ã—ãŸéš›ã«å®Ÿè¡Œã—ãŸã„å‡¦ç†
        });
});
```

ãŸã ã€ã“ã‚Œã ã¨

* æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ–°ãŸã«è¿½åŠ ã•ã‚ŒãŸã¨ã
* æ¡ä»¶ã«ä¸€è‡´ã—ã¦ã„ãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚ŒãŸã¨ã
* æ¡ä»¶ã«ä¸€è‡´ã—ã¦ã„ãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ›´æ–°ã•ã‚ŒãŸã“ã¨ã«ã‚ˆã‚Šæ¡ä»¶ã«ä¸€è‡´ã—ãªããªã£ãŸã¨ã

ã«é©åˆ‡ã«æ¤œçŸ¥ã™ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ğŸ˜“

ã©ã†ã—ã¦ã‚‚ãã‚ŒãŒå¿…è¦ãªå ´åˆã¯ã€ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å…¨ä½“ã‚’listenã—ã¦ãŠã„ã¦ã€å¤‰æ›´ã•ã‚ŒãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å†…å®¹ã«å¿œã˜ã¦ä½•ã‹ã—ã‚‰ã®å‡¦ç†ã‚’å®Ÿæ–½ã—ãŸã‚Šç„¡è¦–ã—ãŸã‚Šã™ã‚‹ã‚ˆã†ãªå®Ÿè£…ã«ã™ã‚‹ã—ã‹ãªã„ã®ã‹ãªã¨æ€ã„ã¾ã™ã€‚

```dart
Firestore.instance.collection('foo').snapshots().listen((qss) async {
    qss.documentChanges.map((docChange) => docChange.document).forEach((DocumentSnapshot doc) {
        if (_isTarget(doc)) {
            // å¤‰æ›´ã‚’æ¤œçŸ¥ã—ãŸéš›ã«å®Ÿè¡Œã—ãŸã„å‡¦ç†
        }
    });
});

```

å…¨ç„¶è©³ã—ãç†è§£ã§ãã¦ãªã„ã®ã§ã€ã‚‚ã£ã¨ã„ã„æ–¹æ³•ã‚’ã”å­˜çŸ¥ã®æ–¹ã„ãŸã‚‰ãœã² [æ•™ãˆã¦ãã ã•ã„](https://twitter.com/ttskch) ğŸ™‡
