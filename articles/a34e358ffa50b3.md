---
title: "BEAR.Sunday/Ray.Di/Ray.Aopã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒ¢"
emoji: "ğŸ˜"
type: "tech"
topics: ["php", "bearsunday", "raydi", "rayaop"]
published: true
published_at: 2014-12-31
---

:::message
ã“ã®è¨˜äº‹ã¯ã€2014-12-31ã«åˆ¥ã®ãƒ–ãƒ­ã‚°åª’ä½“ã«æŠ•ç¨¿ã—ãŸè¨˜äº‹ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ã™ã€‚
:::

BEAR.Skeleton ~0.10 ã§ä½œæˆã—ãŸã‚¢ãƒ—ãƒªã‚’ ~1.0@dev ã«ä¸Šã’ã‚‹ä½œæ¥­ã‚’ã—ãªãŒã‚‰ã‚³ãƒ¼ãƒ‰ã„ã£ã±ã„èª­ã‚“ã ã®ã§ãƒ¡ãƒ¢ã‚’æ®‹ã—ã¦ãŠãã¾ã™ã€‚è‡ªåˆ†ç”¨ãªã®ã§èµ°ã‚Šæ›¸ãã§ã™ã€‚

# ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã® install ã¨ override

ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹æ–¹æ³•ã¯ intall ã¨ override ã® 2 é€šã‚Šã‚ã‚‹ã€‚
[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://github.com/koriym/Ray.Di/blob/develop-2/README.ja.md#install) ã«ã‚ˆã‚‹ã¨ install ã¯å…ˆã«æŸç¸›ã‚’å®šç¾©ã—ãŸã‚‚ã®ãŒå„ªå…ˆã•ã‚Œã‚‹ãŒã€override ãªã‚‰ä¸Šæ›¸ãã§ãã‚‹ã¨ã®ã“ã¨ã€‚

* [AbstractModule::install()](https://github.com/koriym/Ray.Di/blob/develop-2/src/AbstractModule.php#L60)
* [AbstractModule::override()](https://github.com/koriym/Ray.Di/blob/develop-2/src/AbstractModule.php#L68)

å®Ÿè£…ã‚’è¦‹ã‚‹ã¨ `Container` ã®ãƒãƒ¼ã‚¸ã®æ–¹æ³•ãŒç•°ãªã‚‹ã ã‘ã®ã‚ˆã†ã€‚

[Container](https://github.com/koriym/Ray.Di/blob/develop-2/src/Container.php) ã¯

* [ä¾å­˜ã«å¯¾ã™ã‚‹æŸç¸›ï¼ˆDIï¼‰ã®ãƒªã‚¹ãƒˆ](https://github.com/koriym/Ray.Di/blob/develop-2/src/Container.php#L20)
* [ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ã‚·ãƒ§ãƒ³å®šç¾©ï¼ˆAOPï¼‰ã®ãƒªã‚¹ãƒˆ](https://github.com/koriym/Ray.Di/blob/develop-2/src/Container.php#L25)

ã‚’æŒã£ã¦ã„ã¦ã€[Container::merge()](https://github.com/koriym/Ray.Di/blob/develop-2/src/Container.php#L123) ã‚’ä½¿ã£ã¦ãƒãƒ¼ã‚¸ã•ã‚Œã‚‹ã€‚

ãƒãƒ¼ã‚¸ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¦‹ã‚‹ã¨ã€ç¢ºã‹ã«

* install ãªã‚‰å…ˆå‹ã¡
* override ãªã‚‰å¾Œå‹ã¡

ã«ãªã£ã¦ã„ã‚‹ã€‚ï¼ˆé…åˆ—ã«å¯¾ã™ã‚‹ `+` ã§ã®åŠ ç®—ã¯ã€åŒã˜ã‚­ãƒ¼ã«å¯¾ã—ã¦å·¦é …ãŒæ®‹ã‚‹ã®ãŒ PHP ã®ä»•æ§˜ï¼‰

# DI (bind)

[AbstractModule::bind()](https://github.com/koriym/Ray.Di/blob/develop-2/src/AbstractModule.php#L50) ã®å‡¦ç†å†…å®¹ã‚’è¦‹ã‚‹ã¨ã€[Bind ã‚¯ãƒ©ã‚¹ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿](https://github.com/koriym/Ray.Di/blob/develop-2/src/Bind.php#L43) ã«å¯¾ã—ã€

* è‡ªåˆ†è‡ªèº«ï¼ˆAbstractModuleï¼‰ãŒæŒã£ã¦ã„ã‚‹ `Container`
* æŸç¸›ã—ãŸã„ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã®ã‚¯ãƒ©ã‚¹å

ã® 2 ã¤ã‚’æ¸¡ã—ã¦ã„ã‚‹ã€‚

ã•ã‚‰ã«ãã®å¾Œ [Bind::to()](https://github.com/koriym/Ray.Di/blob/develop-2/src/Bind.php#L87) ãŒå‘¼ã°ã‚Œã‚‹ã¨ã€é ã‹ã£ã¦ã„ãŸ `Container` ã«å¯¾ã—ã¦ [add($this)](https://github.com/koriym/Ray.Di/blob/develop-2/src/Bind.php#L91) ï¼ˆï¼ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã¨å®Ÿã‚¯ãƒ©ã‚¹ã®ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’ã‚³ãƒ³ãƒ†ãƒŠã«ç™»éŒ²ï¼‰ã‚’è¡Œã†ã€‚

[Container::add()](https://github.com/koriym/Ray.Di/blob/develop-2/src/Container.php#L30) ã®ä¸­èº«ã‚’è¦‹ã‚‹ã¨ã€`Bind->getBound()` ã§ä¾å­˜å®šç¾©ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—ã—ã€ãã‚Œã‚’ [ä¾å­˜ã«å¯¾ã™ã‚‹æŸç¸›ï¼ˆDIï¼‰ã®ãƒªã‚¹ãƒˆ](https://github.com/koriym/Ray.Di/blob/develop-2/src/Container.php#L20) ã«ç™»éŒ²ã—ã¦ã„ã‚‹ã€‚

ç™»éŒ²ã®å‡¦ç†ã¯ [Dependency::register()](https://github.com/koriym/Ray.Di/blob/develop-2/src/Dependency.php#L48) ã§è¡Œã‚ã‚Œã¦ã„ã‚‹ã€‚

é…åˆ—ã®ã‚­ãƒ¼ã¯ [ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã®ã‚¯ãƒ©ã‚¹åã¨ AnnotatedWith (@Named) ã§ä»˜ã‘ã‚‰ã‚ŒãŸåå‰ã‚’ãƒã‚¤ãƒ•ãƒ³ã§æ¥ç¶šã—ãŸæ–‡å­—åˆ—](https://github.com/koriym/Ray.Di/blob/develop-2/src/Bind.php#L158) ã«ãªã‚‹ã€‚

ã¤ã¾ã‚Šã€ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã®ã‚¯ãƒ©ã‚¹åã¨ @Named ã®åå‰ã®çµ„ãŒå…¨ãåŒã˜ãªã‚‰ã€åŒã˜æŸç¸›ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹ã€‚

# AOP (bindInterceptor)

[AbstractModule::bindInterceptor()](https://github.com/koriym/Ray.Di/blob/develop-2/src/AbstractModule.php#L90) ã®å‡¦ç†å†…å®¹ã‚’è¦‹ã‚‹ã¨ã€

* `Container` ã¸ã® [Pointcut](https://github.com/koriym/Ray.Aop/blob/develop-2/src/Pointcut.php) ã®è¿½åŠ 
* ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ã‚¿ã®ã‚¯ãƒ©ã‚¹åã«å¯¾ã—ã¦ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ã‚¿ã®ã‚¯ãƒ©ã‚¹ã‚’æŸç¸›ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ã‚¿ã®å®Ÿã‚¯ãƒ©ã‚¹ã‚’ã‚³ãƒ³ãƒ†ãƒŠã«ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆã•ã›ã‚‹ãŸã‚ï¼Ÿï¼‰

ã® 2 ã¤ã®ã“ã¨ã‚’è¡Œã£ã¦ã„ã‚‹ã€‚

`Container` ã¸ã® `Pointcut` ã®è¿½åŠ ã¯ [ã‚­ãƒ¼æŒ‡å®šãªã—ã§é…åˆ—ã« push ã—ã¦ã„ã‚‹ã ã‘](https://github.com/koriym/Ray.Di/blob/develop-2/src/Container.php#L41) ãªã®ã§ã€[åˆ¥ã®ã‚³ãƒ³ãƒ†ãƒŠã¨ãƒãƒ¼ã‚¸ã•ã‚Œã‚‹ã¨ã](https://github.com/koriym/Ray.Di/blob/develop-2/src/Container.php#L126) ã¯å®Œå…¨ãªå…ˆå‹ã¡ã«ãªã‚‹ã€‚ï¼ˆé…åˆ—ã«å¯¾ã™ã‚‹ + ã§ã®åŠ ç®—ã¯ã€åŒã˜ã‚­ãƒ¼ã«å¯¾ã—ã¦å·¦é …ãŒæ®‹ã‚‹ã®ãŒ PHP ã®ä»•æ§˜ãªã®ã§ã€ã‚­ãƒ¼æŒ‡å®šãªã—ã§ã‚‚ `0` ã¨ã‹ `1` ã¨ã‹ã®ã‚­ãƒ¼ã«å¯¾ã—ã¦å…ˆå‹ã¡ã«ãªã‚‹ï¼‰

ã—ãŸãŒã£ã¦ã€Ray.Di ~2.0@dev ã§ã¯ã€[~1.0 ã§ã‚„ã£ã¦ã„ãŸã‚ˆã†ã«](https://github.com/koriym/BEAR.Skeleton/blob/develop/src/Module/AppModule.php#L45) AOP ã®ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’ AppModule ä»¥å¤–ã«æ›¸ã„ã¦ãŠã„ã¦ install ã™ã‚‹ã¨ã„ã†ã“ã¯å‡ºæ¥ãªã„ã€‚ï¼ˆoverride ã™ã‚Œã°ã§ãã‚‹ã‘ã©ã€[PackageModule ã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°](https://github.com/koriym/BEAR.Skeleton/blob/develop-2/src/Module/AppModule.php#L16) ãŒæ¶ˆãˆã¦ã—ã¾ã†ï¼‰

# æŸç¸›ãŒå®Ÿéš›ã«ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆã•ã‚Œã‚‹ã®ã¯ã„ã¤ã‹ï¼Ÿ

BEAR.Sunday ã§å®Ÿéš›ã« Ray ã®æŸç¸›ãŒã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆã•ã‚Œã‚‹ä»•çµ„ã¿ã¯ã©ã†ãªã£ã¦ã„ã‚‹ã®ã‹ï¼Ÿ

## DI

1. bootstrap ã§ [BEAR.Sunday ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒä½œã‚‰ã‚Œã‚‹](https://github.com/koriym/BEAR.Skeleton/blob/develop-2/bootstrap/bootstrap.php#L23)
2. App ãŒä½œã‚‰ã‚Œã‚‹ã¨ãã«ã€[ä¸€ç•ªå¤–å´ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ](https://github.com/koriym/BEAR.Skeleton/blob/develop-2/bootstrap/api.php#L3) ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å…ƒã« [Injector ãŒä½œã‚‰ã‚Œã‚‹](https://github.com/koriym/BEAR.Package/blob/develop-2/src/Bootstrap.php#L39)
3. Injector ãŒä½œã‚‰ã‚Œã‚‹ã¨ãã«ã€[InjectorInterface ã«è‡ªåˆ†è‡ªèº«ã‚’æŸç¸›ã—ã¦ã„ã‚‹](https://github.com/koriym/Ray.Di/blob/develop-2/src/Injector.php#L35)
4. [Injector::getInstance](https://github.com/koriym/Ray.Di/blob/develop-2/src/Injector.php#L44) ã§å®Ÿéš›ã«ä¾å­˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–ã‚Šå‡ºã—ã¦ã„ã‚‹äººã¯ [BEAR\Resouce\AppAdapter](https://github.com/koriym/BEAR.Resource/blob/develop-2/src/AppAdapter.php#L48) ãã‚‰ã„ã—ã‹è¦‹ã¤ã‹ã‚‰ãšã€å®Ÿè¡Œæ™‚ã«èª°ãŒã©ã†ã‚„ã£ã¦ä¾å­˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¸¡ã—ã¦ã„ã‚‹ã®ã‹ã‚ˆãåˆ†ã‹ã‚‰ãšâ€¦

## AOP

1. bootstrap ã§ [BEAR.Sunday ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒä½œã‚‰ã‚Œã‚‹](https://github.com/koriym/BEAR.Skeleton/blob/develop-2/bootstrap/bootstrap.php#L23)
2. App ãŒä½œã‚‰ã‚Œã‚‹ã¨ãã«ã€[ä¸€ç•ªå¤–å´ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ](https://github.com/koriym/BEAR.Skeleton/blob/develop-2/bootstrap/api.php#L3) ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å…ƒã« [Injector ãŒä½œã‚‰ã‚Œã‚‹](https://github.com/koriym/BEAR.Package/blob/develop-2/src/Bootstrap.php#L39)
3. Injector ãŒä½œã‚‰ã‚Œã‚‹ã¨ãã«ã€[ã‚³ãƒ³ãƒ†ãƒŠã® weaveAspects() ãŒå®Ÿè¡Œã•ã‚Œã‚‹](https://github.com/koriym/Ray.Di/blob/develop-2/src/Injector.php#L32)
4. ã‚³ãƒ³ãƒ†ãƒŠã® weaveAspects ã§ã€[ã‚³ãƒ³ãƒ†ãƒŠãŒæŒã¤å„ä¾å­˜ã® weaveAspects() ãŒå®Ÿè¡Œã•ã‚Œã‚‹](https://github.com/koriym/Ray.Di/blob/develop-2/src/Container.php#L139)
5. [Dependency::weaveAspects()](https://github.com/koriym/Ray.Di/blob/develop-2/src/Dependency.php#L89) ã“ã“ã‹ã‚‰å…ˆã¯åŠ›å°½ãã¦ã‚ã‚“ã¾ã‚Šèª­ã‚ã¦ãªã„â€¦ã‘ã©ã€ä¸‹ä½ã® weaveAspects ã«ä¼æ’­ã—ã¦ã„ãæ„Ÿã˜ã‹ãªã¨æƒ³åƒã—ã¦ã‚‹

# æ®‹ã£ãŸç–‘å•

* AOP ã®åˆ¥ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰ã® install ãŒ v0 â†’ v1 ã§å‡ºæ¥ãªããªã£ãŸã®ã¯ãªãœã ã‚ã†ï¼Ÿï¼ˆ`Container::merge` ã‚’ã€€`+` ã˜ã‚ƒãªã `array_merge` ã«ã™ã‚‹ã ã‘ã§è§£æ±ºã—ãŸã‚Šã—ãªã„ã®ã‹ãªï¼Ÿï¼ˆã—ãªã„ã‚“ã ã‚ã†ã‘ã©ï¼‰ï¼‰
* DI ã‚„ AOP ã§å®Ÿéš›ã«æŸç¸›ãŒè¡Œã‚ã‚Œã‚‹ã¾ã§ã®ãƒ­ã‚¸ãƒƒã‚¯ãŒã¾ã ã‚ˆãåˆ†ã‹ã‚‰ãªã„
