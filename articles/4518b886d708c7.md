---
title: "[2022å¹´ç‰ˆ] Symfony5ã«Sentry4ç³»ã‚’å°å…¥ã™ã‚‹æ‰‹é †"
emoji: "ğŸ»"
type: "tech"
topics: ["php", "symfony", "sentry"]
published: true
published_at: 2022-02-10
---

:::message
ã“ã®è¨˜äº‹ã¯ã€2022-02-10ã«åˆ¥ã®ãƒ–ãƒ­ã‚°åª’ä½“ã«æŠ•ç¨¿ã—ãŸè¨˜äº‹ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ã™ã€‚
:::

éå»ã«

> [[è¶…ç°¡å˜] Symfonyãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«Sentryã‚’å°å…¥ã™ã‚‹](https://zenn.dev/ttskch/articles/73d8bdce973b0b)

ã¨ã„ã†è¨˜äº‹ã‚’æ›¸ãã¾ã—ãŸãŒã€SentryãŒãƒãƒ¼ã‚¸ãƒ§ãƒ³4ç³»ã«ãªã£ã¦è¨­å®šæ–¹æ³•ãªã©ãŒå¤šå°‘å¤‰ã‚ã£ã¦ã„ãŸã®ã§ã€æ”¹ã‚ã¦å°å…¥æ‰‹é †ã‚’ã¾ã¨ã‚ã¦ãŠããŸã„ã¨æ€ã„ã¾ã™ã€‚

# 1. SentryBundleã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```shell
$ composer require sentry/sentry-symfony
```

ãƒ¬ã‚·ãƒ”ã‚‚å®Ÿè¡Œã—ã¾ã™ã€‚

```shell
  -  WARNING  sentry/sentry-symfony (>=3.0): From github.com/symfony/recipes-contrib:master
    The recipe for this package comes from the "contrib" repository, which is open to community contributions.
    Review the recipe at https://github.com/symfony/recipes-contrib/tree/master/sentry/sentry-symfony/3.0

    Do you want to execute this recipe?
    [y] Yes
    [n] No
    [a] Yes for all packages, only for the current installation session
    [p] Yes permanently, never ask again for this project
    (defaults to n): y
```

ã“ã‚Œã§ã€

* `config/packages/sentry.yaml` ãŒä½œæˆã•ã‚Œã‚‹
* `.env` ã« `SENTRY_DSN=` ãŒè¿½è¨˜ã•ã‚Œã‚‹
* `config/bundles.php` ã«SentryBundleãŒè¿½è¨˜ã•ã‚Œã‚‹

ã¾ã§è‡ªå‹•ã§è¡Œã‚ã‚Œã¾ã™ã€‚

# 2. çµ„ã¿è¾¼ã¿ErrorListenerã®ä»£ã‚ã‚Šã«Monologã¨çµ±åˆã™ã‚‹

å¤šãã®Symfonyã‚¢ãƒ—ãƒªã§ã¯ [Monolog](https://symfony.com/doc/current/logging.html#monolog) ãŒå°å…¥ã•ã‚Œã¦ã„ã‚‹ã ã‚ã†ã¨ã„ã†å‹æ‰‹ãªæƒ³å®šã®ã‚‚ã¨ã€æœ¬è¨˜äº‹ã§ã¯çµ„ã¿è¾¼ã¿ã®ErrorListenerã®ä»£ã‚ã‚Šã«Monologã¨çµ±åˆã—ã¦Sentryã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã‚’è§£èª¬ã—ã¾ã™ğŸ™

> [Symfony | Sentry Documentation `#monolog-integration`](https://docs.sentry.io/platforms/php/guides/symfony/#monolog-integration)

ã‚’å‚è€ƒã«ã€ErrorListenerã‚’ç„¡åŠ¹ã«ã—ã¦ã€ä»£ã‚ã‚Šã«MonologçµŒç”±ã§Sentryã«ã‚¨ãƒ©ãƒ¼ã‚’é€ä¿¡ã§ãã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

ã¾ãšã€ `config/packages/sentry.yaml` ã«ä»¥ä¸‹ã‚’è¿½è¨˜ã—ã¦ErrorListenerã‚’ç„¡åŠ¹ã«ã—ã¾ã™ã€‚

```diff
  sentry:
      dsn: '%env(SENTRY_DSN)%'
+     register_error_listener: false
```

ã‚‚ã—ã€ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ä¸­ã« `E_NOTICE` `E_STRICT` `E_DEPRECATED` ç­‰ã®ãƒ¬ãƒ™ãƒ«ã®ã‚¨ãƒ©ãƒ¼ã‚’å‡ºã—ã¦ã„ã‚‹ã‚‚ã®ãŒã‚ã‚‹å ´åˆãªã©ã¯ã€ä»¥ä¸‹ã‚’è¿½è¨˜ã™ã‚‹ã“ã¨ã§ãã‚Œã‚‰ã®ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```diff
  sentry:
      dsn: '%env(SENTRY_DSN)%'
      register_error_listener: false
+     options:
+         error_types: E_ALL & ~(E_NOTICE|E_STRICT|E_DEPRECATED)
```

æ¬¡ã«ã€`config/packages/monolog.yaml` ã«ä»¥ä¸‹ã‚’è¿½è¨˜ã—ã¾ã™ã€‚

```yaml
monolog:
  handlers:

    # ...

    sentry:
      type: sentry
      level: !php/const Monolog\Logger::ERROR
      hub_id: Sentry\State\HubInterface
```

åŸºæœ¬çš„ã«ã¯ã“ã‚Œã ã‘ã§å°å…¥å®Œäº†ã§ã™âœ‹

# 3. 400ç³»ã®ã‚¨ãƒ©ãƒ¼ã‚’å ±å‘Šã—ãªã„ã‚ˆã†ã«ã™ã‚‹

404 Not Foundã‚„405 Method Not Allowedãªã©ã®ã‚¨ãƒ©ãƒ¼ã¯å ±å‘Šã—ãªã„ã‚ˆã†ã«è¨­å®šã—ã¦ãŠããŸã„ã“ã¨ã‚‚ã‚ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

Sentry3ç³»ã§ã¯ [`config/packages/sentry.yaml` ã« `excluded_exceptions` ã¨ã„ã†ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸ](https://zenn.dev/ttskch/articles/73d8bdce973b0b#%E7%89%B9%E5%AE%9A%E3%81%AE%E4%BE%8B%E5%A4%96%E3%82%92%E5%A0%B1%E5%91%8A%E3%81%97%E3%81%AA%E3%81%84%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B) ãŒã€4ç³»ã§ã¯ã“ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯å»ƒæ­¢ã•ã‚Œã¦ã„ã¾ã™ã€‚

ä»£ã‚ã‚Šã«Monologã® `excluded_http_codes` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦è¨­å®šã—ã¾ã™ã€‚

```diff
  monolog:
    handlers:
  
      # ...
  
-     sentry:
-       type: sentry
-       level: !php/const Monolog\Logger::ERROR
-       hub_id: Sentry\State\HubInterface
+     sentry:
+       type: fingers_crossed
+       action_level: error
+       handler: sentry_nested
+       excluded_http_codes: [404, 405]
+       buffer_size: 50
+     sentry_nested:
+       type: sentry
+       level: !php/const Monolog\Logger::ERROR
+       hub_id: Sentry\State\HubInterface
```

> å‚è€ƒï¼š
>
> * [How to Configure Monolog to Exclude Specific HTTP Codes from the Log (Symfony Docs)](https://symfony.com/doc/current/logging/monolog_exclude_http_codes.html)
> * [php - Sentry on Symfony: how to exclude `NotFoundHttpException` - Stack Overflow `#answer-67834078`](https://stackoverflow.com/questions/64098722/sentry-on-symfony-how-to-exclude-notfoundhttpexception#answer-67834078)

# 4. LiipTestFixturesBundleã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã¯testç’°å¢ƒã§DbalTracingã‚’ç„¡åŠ¹ã«ã™ã‚‹å¿…è¦ã‚ã‚Šï¼Ÿï¼ˆè©³ç´°æœªç¢ºèªï¼‰

ã“ã“ã¾ã§ã§ã»ã¼è¨­å®šå®Œäº†ãªã®ã§ã™ãŒã€åƒ•ã®ç’°å¢ƒã ã¨ã€ãƒ†ã‚¹ãƒˆæ™‚ã« [LiipTestFixturesBundle](https://github.com/liip/LiipTestFixturesBundle) ã® `loadAliceFixture()` ãŒ

```
Doctrine\DBAL\Exception: Operation 'Doctrine\DBAL\Platforms\AbstractPlatform::getListDatabasesSQL' is not supported by platform.
```

ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã—ãŸğŸ¤”

ã¡ã‚‡ã£ã¨è©³ç´°ãªåŸå› ã¯è¿½ãˆã¦ã„ãªã„ã®ã§ã™ãŒã€è©¦è¡ŒéŒ¯èª¤ã®çµæœ `config/bundles.php` ã§SentryBundleã‚’ç™»éŒ²ã™ã‚‹ã¨å†ç¾ã™ã‚‹ã“ã¨ãŒåˆ†ã‹ã£ãŸã®ã§ã€

* [sentry-symfony/src/SentryBundle.php](https://github.com/getsentry/sentry-symfony/blob/dd37786fc7ca81a4320e6d9812ff549104193043/src/SentryBundle.php)
* [sentry-symfony/src/DependencyInjection/Compiler/DbalTracingPass.php `#L34-L40`](https://github.com/getsentry/sentry-symfony/blob/master/src/DependencyInjection/Compiler/DbalTracingPass.php#L34-L40)

ã‚ãŸã‚Šã‚’è¦‹ã¦ã€`config/packages/test/sentry.yaml` ã‚’

```yaml
sentry:
  tracing:
    dbal:
      enabled: false
```

ã¨ã„ã†å†…å®¹ã§ä½œæˆã—ã¦ã¿ãŸã¨ã“ã‚è§£æ¶ˆã•ã‚Œã¾ã—ãŸã€‚

è©³ç´°åˆ†ã‹ã‚‹æ–¹ã„ã‚‰ã—ãŸã‚‰ãœã² [æƒ…å ±ã„ãŸã ã‘ã‚‹ã¨](https://twitter.com/ttskch) å¬‰ã—ã„ã§ã™ğŸ™
