---
title: "[Angular][RxJS] å…¥é–€è¨˜äº‹ã‚’èª­ã‚“ã§ã‚‚åˆ†ã‹ã‚‰ãªã‹ã£ãŸã€Web APIã‚’Observableã§æ‰±ã†ã¨ãã®å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰ä¾‹"
emoji: "ğŸ’»"
type: "tech"
topics: ["javascript", "typescript", "angular", "rxjs"]
published: true
published_at: 2020-12-03
---

:::message
ã“ã®è¨˜äº‹ã¯ã€2020-12-03ã«åˆ¥ã®ãƒ–ãƒ­ã‚°åª’ä½“ã«æŠ•ç¨¿ã—ãŸè¨˜äº‹ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ã™ã€‚
:::

# ã¯ã˜ã‚ã«

[Angular Advent Calendar 2020](https://qiita.com/advent-calendar/2020/angular) ã®3æ—¥ç›®ã®è¨˜äº‹ã§ã™ï¼ğŸ„ğŸŒ™

æ˜¨æ—¥ã¯ [@ringtail003](https://twitter.com/ringtail003) ã•ã‚“ã® [[Angular] ã¯ã˜ã‚ã¦ã® E2E ãƒ†ã‚¹ãƒˆ](https://tech.quartetcom.co.jp/2020/12/02/angular-advent-calendar/) ã§ã—ãŸâœ¨

ä»Šæ—¥ã¯Angularãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¬¼é–€ã¨ã‚‚å‘¼ã¹ã‚‹RxJSã«ã¤ã„ã¦æ›¸ããŸã„ã¨æ€ã„ã¾ã™ã€‚

åƒ•è‡ªèº«ã¾ã ã¾ã Angularå‹‰å¼·ä¸­ã®èº«ã§ã™ãŒã€ä»¥å‰ã€è‡ªåˆ†ãªã‚Šã«åˆå­¦æ™‚ã«ã¤ã¾ãšã„ãŸã¨ã“ã‚ã‚’ä¸å¯§ã«è§£èª¬ã—ãªãŒã‚‰ã€ãã‚Œãªã‚Šã«ãƒªãƒƒãƒãªï¼ˆUIãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯å°å…¥ï¼†Firebaseåˆ©ç”¨ï¼‰ã‚¢ãƒ—ãƒªã‚’ã‚¼ãƒ­ã‹ã‚‰ä½œã‚‹ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’æ›¸ãã¾ã—ãŸã€‚ãŠã‹ã’ã•ã¾ã§ãŸãã•ã‚“ã®æ–¹ã«èª­ã‚“ã§ã„ãŸã ã„ã¦ã„ã¾ã™ã€‚

* [Angularå®Ÿè·µå…¥é–€ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ« | blog.ttskch](https://blog.ttskch.com/angular-todo/)ï¼ˆãƒ–ãƒ­ã‚°ç‰ˆï¼‰
* [Angularå®Ÿè·µå…¥é–€ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«](https://zenn.dev/ttskch/books/84c7a272deb3845e8085)ï¼ˆZennç‰ˆï¼‰ï¼ˆå†…å®¹ã¯ã¾ã£ãŸãåŒã˜ã§ã™ï¼‰

ä»Šå›ã¯ã“ã®ä¸­ã§è§£èª¬ã§ãã¦ã„ãªã‹ã£ãŸRxJSã«é–¢ã™ã‚‹è©±ã‚’æ”¹ã‚ã¦ã¾ã¨ã‚ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ğŸ’ª

# RxJSã¨ã¯

[ReactiveX](http://reactivex.io/) ã¨ã„ã†ã€[Observerãƒ‘ã‚¿ãƒ¼ãƒ³](https://ja.wikipedia.org/wiki/Observer_%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3) ã‚’ä½¿ã£ãŸéåŒæœŸå‡¦ç†ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã®ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªç¾¤ãŒã‚ã‚Šã€ãã®JavaScriptï¼ˆTypeScriptï¼‰ç‰ˆãŒ [RxJS](https://rxjs-dev.firebaseapp.com/) ã§ã™ã€‚

ã‚¤ãƒ™ãƒ³ãƒˆã§æ¸¡ã£ã¦ããŸãƒ‡ãƒ¼ã‚¿ã‚’åŠ å·¥ã™ã‚‹ãŸã‚ã®æ§˜ã€…ãª [ã‚ªãƒšãƒ¬ãƒ¼ã‚¿](https://rxjs-dev.firebaseapp.com/guide/operators) ãŒæä¾›ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚‚ã‚ã‚Šã€[å…¬å¼ã‚µã‚¤ãƒˆ](https://rxjs-dev.firebaseapp.com/guide/overview)ã§ã¯ã€Œã‚¤ãƒ™ãƒ³ãƒˆç”¨ã®Lodashã€ã¨ç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™ã€‚

> *Think of RxJS as Lodash for events.*

# å…¥é–€è¨˜äº‹ã§ã‚ˆãè¦‹ã‚‹ã‚µãƒ³ãƒ—ãƒ«

å®Ÿéš›ã«RxJSã‚’ä½¿ã†ã‚³ãƒ¼ãƒ‰ã®å…·ä½“ä¾‹ã‚’ã„ãã¤ã‹è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ã©ã‚Œã‚‚å…¥é–€è¨˜äº‹ãªã©ã‚’èª­ã‚“ã§ã„ã‚‹ã¨ã‚ˆãç›®ã«ã™ã‚‹å†…å®¹ã ã¨æ€ã„ã¾ã™ã€‚

## 1. æœ€ã‚‚åŸå§‹çš„ãªä½¿ç”¨ä¾‹

æœ€ã‚‚åŸå§‹çš„ãªRxJSã®ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‚‚ã®ã§ã™ã€‚

```ts
import { of } from "rxjs";

const observable$ = of(1, 2, 3);
observable$.subscribe(v => console.log(v));

// å‡ºåŠ›çµæœï¼š
// 1
// 2
// 3
```

[ğŸ¤–ãƒ‡ãƒ¢ã¯ã“ã¡ã‚‰](https://stackblitz.com/edit/rxjs-rxjs-example-01?devtoolsheight=33&file=index.ts)

ã©ã†ã‚„ã‚‰ `of(1, 2, 3)` ã¨ã„ã†ã‚³ãƒ¼ãƒ‰ãŒ [Observable](https://rxjs-dev.firebaseapp.com/api/index/class/Observable) ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã—ã¦ãŠã‚Šã€ãã‚Œã‚’ `.subscribe()` ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã­ã€‚

[of](https://rxjs-dev.firebaseapp.com/api/index/function/of) ã¯ã€å¯å¤‰å€‹ã®å¼•æ•°ã‚’å—ã‘å–ã£ã¦ã€ãã‚Œã‚‰ã®å€¤ãŒé †ã«æµã‚Œã¦ãã‚‹ã‚ˆã†ãª `Observable` ã‚’ä½œã£ã¦ãã‚Œã‚‹é–¢æ•°ã§ã™ã€‚

ã“ã®ä¾‹ã§ã¯ã€`of(1, 2, 3)` ã®çµæœã‚’ `.subscribe()` ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€ `1` `2` `3` ã¨ã„ã†3ã¤ã®å€¤ã‚’é †ã«å—ã‘å–ã£ã¦å‡¦ç†ã™ã‚‹ã“ã¨ãŒã§ãã¦ã„ã‚‹ã‚ã‘ã§ã™ã€‚

> ã¡ãªã¿ã«ã€ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã® `observable$` ã®æœ«å°¾ã® `$` ã¯ã€Observableãªå¤‰æ•°ã«å¯¾ã™ã‚‹å‘½åè¦å‰‡ã¨ã—ã¦ [Angularã®æ–‡åŒ–åœã§å¤šãæ¡ç”¨ã•ã‚Œã¦ã„ã‚‹](https://angular.io/guide/rx-library#naming-conventions-for-observables) ã¨ã„ã†ã ã‘ã§ã€æ–‡æ³•ä¸Šã®ç‰¹åˆ¥ãªæ„å‘³ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

## 2. ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ã‚’ä½¿ã£ãŸä¾‹

æ¬¡ã«ã€RxJSã®ä¸€ç•ªã®ç›®ç‰æ©Ÿèƒ½ã§ã‚ã‚‹ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ã‚’ä½¿ã†ä¾‹ã‚’è¦‹ã¦ã¿ã¾ã™ã€‚

```ts
import { of } from "rxjs";
import { map } from "rxjs/operators";

const observable$ = of(1, 2, 3);
observable$.pipe(map(v => v * 10)).subscribe(v => console.log(v));

// å‡ºåŠ›çµæœï¼š
// 10
// 20
// 30
```

[ğŸ¤–ãƒ‡ãƒ¢ã¯ã“ã¡ã‚‰](https://stackblitz.com/edit/rxjs-rxjs-example-02?devtoolsheight=33&file=index.ts)

å…ˆã»ã©ã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å¤‰ã‚ã£ãŸã®ã¯ã€ `observable$` ã¨ `.subscribe(v => console.log(v));` ã®é–“ã« `.pipe(map(v => v * 10))` ãŒåŠ ãˆã‚‰ã‚Œã¦ã„ã‚‹ã¨ã„ã†ç‚¹ã ã‘ã§ã™ã€‚

ã“ã‚Œã«ã‚ˆã£ã¦ã€å‡ºåŠ›çµæœãŒãã‚Œãã‚Œ10å€ã•ã‚ŒãŸå€¤ã«å¤‰ã‚ã£ã¦ã„ã¾ã™ã­ã€‚

`.subscribe()` ã™ã‚‹å‰ã« `.pipe()` ã«ã‚ˆã£ã¦ [mapã‚ªãƒšãƒ¬ãƒ¼ã‚¿](https://rxjs-dev.firebaseapp.com/api/operators/map) ã‚’ç™»éŒ²ã—ã€ `map()` å†…ã§å…ƒã®å€¤ã‚’10å€ã™ã‚‹å‡¦ç†ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

ã“ã®ã‚ˆã†ã«ã€ `Observable` ã‚’å®Ÿéš›ã« `.subscribe()` ã™ã‚‹å‰ã«ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ãŸã‚ŠåŠ å·¥ã—ãŸã‚Šã™ã‚‹ã®ã«åˆ©ç”¨ã§ãã‚‹ã®ãŒ **ã‚ªãƒšãƒ¬ãƒ¼ã‚¿** ã§ã™ã€‚

RxJSã§ã¯ã€[éå¸¸ã«ãŸãã•ã‚“ã®ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãŒæ¨™æº–ã§æä¾›ã•ã‚Œã¦ã„ã¾ã™](https://rxjs-dev.firebaseapp.com/guide/operators)ã€‚

## 3. ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ã‚’è¤‡æ•°çµ„ã¿åˆã‚ã›ã¦ä½¿ã£ãŸä¾‹

ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ã¯è¤‡æ•°çµ„ã¿åˆã‚ã›ã¦ä½¿ã†ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```ts
import { of } from "rxjs";
import { filter, map } from "rxjs/operators";

const observable$ = of(1, 2, 3);
observable$
  .pipe(
    map(v => v * 10),
    filter(v => v < 25)
  )
  .subscribe(v => console.log(v));

// å‡ºåŠ›çµæœï¼š
// 10
// 20
```

[ğŸ¤–ãƒ‡ãƒ¢ã¯ã“ã¡ã‚‰](https://stackblitz.com/edit/rxjs-rxjs-example-03?devtoolsheight=33&file=index.ts)

å…ˆã»ã©ã¾ã§ã¯ `.pipe()` ã®å¼•æ•°ã« `map()` ã ã‘ã‚’æ¸¡ã—ã¦ã„ã¾ã—ãŸãŒã€ä»Šå›ã¯ `map()` ã¨ `filter()` ã®2ã¤ã‚’æ¸¡ã—ã¦ã„ã¾ã™ã€‚

ã“ã®ã‚ˆã†ã« `.pipe()` ã«è¤‡æ•°ã®ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ã‚’æ¸¡ã—ãŸå ´åˆã¯ã€ç¬¬ä¸€å¼•æ•°ã®ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ã‹ã‚‰é †ã«é©ç”¨ã•ã‚Œã¦ã„ãã¾ã™ã€‚

[filterã‚ªãƒšãƒ¬ãƒ¼ã‚¿](https://rxjs-dev.firebaseapp.com/api/operators/filter) ã¯ã€æµã‚Œã¦ããŸå€¤ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹ãŸã‚ã®ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ã§ã™ã€‚

ä»Šå›ã®ä¾‹ã§ã¯ã€ **å€¤ãŒ `25` ã‚ˆã‚Šå°ã•ã„å ´åˆã«ã—ã‹æ¬¡ã«æµã•ãªã„** ã¨ã„ã†ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

ãã®ãŸã‚ã€æœ€çµ‚çš„ã« `.subscribe()` ã—ãŸéš›ã«ã¯ `30` ã¨ã„ã†å€¤ãŒãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚Œã¦ã€ `10` ã¨ `20` ã®2ã¤ã ã‘ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã¾ã™ã­ã€‚

`filter()` ã‚ˆã‚Šã‚‚å…ˆã« `map()` ãŒé©ç”¨ã•ã‚Œã¦å„å€¤ãŒ10å€ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ã€Œ `1` `2` `3` ã®æ™‚ç‚¹ã§ã™ã¹ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚Œã¦ä½•ã‚‚æµã‚Œã¦ã„ã‹ãªã„ã€ã¨ã„ã†çµæœã«ã¯ **ãªã£ã¦ã„ãªã„** ç‚¹ã«ã‚‚æ³¨ç›®ã§ã™ã€‚

# ã‚‚ã†å°‘ã—å®Ÿè·µçš„ãªä¾‹ï¼šWeb APIã®å€¤ã‚’å—ã‘å–ã‚‹

ã•ã¦ã€ã€Œ `Observable` ã« `.pipe()` ã§ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ã‚’ä»•è¾¼ã‚“ã ä¸Šã§ã€æœ€çµ‚çš„ã« `.subscribe()` ã—ã¦æµã‚Œã¦ããŸå€¤ã‚’åˆ©ç”¨ã™ã‚‹ã€ã¨ã„ã†ã‚³ãƒ¼ãƒ‰ã®æµã‚Œã¯ãªã‚“ã¨ãªãã‚¤ãƒ¡ãƒ¼ã‚¸ã§ããŸã§ã—ã‚‡ã†ã‹ã€‚

ã“ã“ã¾ã§ã¯RxJSã®å…¥é–€è¨˜äº‹ã‚’èª­ã‚ã°ã ã„ãŸã„å…±é€šã—ã¦èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ã‚‚ã¨ã‚‚ã¨ä½•ã¨ãªãã¯ç†è§£ã§ãã¦ã„ãŸã¨ã„ã†äººãŒå¤šã„ã®ã§ã¯ãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚

ã“ã“ã‹ã‚‰ã¯ã‚‚ã†å°‘ã—å®Ÿè·µçš„ãªä¾‹ã‚’è¦‹ã¦ã„ãã“ã¨ã«ã—ã¾ã™ğŸ’ª

ã¾ãšã€ä¸Šè¨˜ã®ä¾‹ã§ã¯ `of(1, 2, 3)` ã‚’ä½¿ã£ã¦è‡ªåˆ†ã®æ‰‹ã§ `Observable` ã‚’ä½œã£ã¦ã„ã¾ã—ãŸãŒã€Angularã‚’ä½¿ã£ã¦å®Ÿéš›ã«Webã‚¢ãƒ—ãƒªã‚’ä½œã‚‹å ´åˆã«ã¯ã€åŸºæœ¬çš„ã«ã¯å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰ `Observable` ãŒæ¸¡ã£ã¦ãã¦ã€ãã‚Œã‚’è‡ªåˆ†ã®ã‚³ãƒ¼ãƒ‰ã§åŠ å·¥ã—ãŸã‚Šæ´»ç”¨ã—ãŸã‚Šã™ã‚‹ã¨ã„ã†ä½¿ã„æ–¹ãŒãƒ¡ã‚¤ãƒ³ã«ãªã‚Šã¾ã™ã€‚ï¼ˆåŠ å·¥ã®éç¨‹ã®ä¸­ã§ `of` ã‚’ä½¿ã†ã“ã¨ã¯æ„å¤–ã¨ã‚ˆãã‚ã‚Šã¾ã™ãŒï¼‰

ãã®æœ€ã‚‚ä»£è¡¨çš„ãªä¾‹ãŒ **Web APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ `Observable` ã¨ã—ã¦å—ã‘å–ã£ã¦æ´»ç”¨ã™ã‚‹** ã¨ã„ã†ã‚‚ã®ã§ã—ã‚‡ã†ã€‚

ã¨ã„ã†ã‚ã‘ã§ã€ã“ã“ã§ã¯å®Ÿéš›ã«Web APIã®å€¤ã‚’ `Observable` ã¨ã—ã¦å—ã‘å–ã£ã¦å‡¦ç†ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

## 1. Web APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãŸã å–å¾—ã™ã‚‹ã ã‘ã®ä¾‹

ã¾ãšã¯ã€Web APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãŸã å–å¾—ã™ã‚‹ã ã‘ã®ä¾‹ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ä»Šå›ã¯Web APIã¨ã—ã¦ [JSONPlaceholder](https://jsonplaceholder.typicode.com/) ã‚’ä½¿ã‚ã›ã¦ã„ãŸã ãã¾ã™ã€‚

ã¾ãšã€Angularã‚¢ãƒ—ãƒªã‹ã‚‰Web APIã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã«ã€[HttpClientModule](https://angular.io/api/common/http/HttpClientModule) ã‚’å°å…¥ã—ã¾ã™ã€‚

```diff
  import { NgModule } from "@angular/core";
  import { BrowserModule } from "@angular/platform-browser";
  import { FormsModule } from "@angular/forms";
+ import { HttpClientModule } from "@angular/common/http";
  
  import { AppComponent } from "./app.component";
  import { HelloComponent } from "./hello.component";
  
  @NgModule({
-   imports: [BrowserModule, FormsModule],
+   imports: [BrowserModule, FormsModule, HttpClientModule],
    declarations: [AppComponent, HelloComponent],
    bootstrap: [AppComponent]
  })
  export class AppModule {}
```

ãã®ä¸Šã§ã€ä¾‹ãˆã° `AppComponent` ãªã©ã«ä»¥ä¸‹ã®ã‚ˆã†ã« [HttpClientã‚µãƒ¼ãƒ“ã‚¹](https://angular.io/api/common/http/HttpClient) ã‚’ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆã—ã¦ã€[HttpClient#get()](https://angular.io/api/common/http/HttpClient#get) ã‚’ä½¿ã£ã¦Web APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Šã¾ã™ã€‚

```ts
import { Component, OnInit } from "@angular/core";
import { HttpClient } from "@angular/common/http";

@Component({
  selector: "my-app",
  templateUrl: "./app.component.html",
  styleUrls: ["./app.component.css"]
})
export class AppComponent implements OnInit {
  constructor(private http: HttpClient) {}

  ngOnInit() {
    this.http
      .get("https://jsonplaceholder.typicode.com/users/1")
      .subscribe(response => console.log(response));
  }
}
```

**`this.http.get()` ã®æˆ»ã‚Šå€¤ãŒ `Observable` ã«ãªã£ã¦ã„ã‚‹** ã®ã§ã€ãã‚Œã‚’ `.subscribe()` ã™ã‚‹ã“ã¨ã§ [ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å†…å®¹](https://jsonplaceholder.typicode.com/users/1) ã‚’å–å¾—ã§ãã¾ã™ã€‚

![](https://tva1.sinaimg.cn/large/0081Kckwgy1gl9qam0kpmj30tm0eiq6g.jpg)

ã“ã“ã¾ã§ã¯ç‰¹ã«é›£ã—ã„ã“ã¨ã¯ãªã•ãã†ã§ã™ã­ğŸ’ª

[ğŸ¤–ãƒ‡ãƒ¢ã¯ã“ã¡ã‚‰](https://stackblitz.com/edit/rxjs-rxjs-example-04?devtoolsheight=33&file=src/app/app.component.ts)

## 2. Web APIã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ã‚¢ãƒ—ãƒªå´ã®ãƒ¢ãƒ‡ãƒ«ã«å¤‰æ›ã—ã¦å–å¾—ã™ã‚‹ä¾‹

å®Ÿéš›ã®ã‚¢ãƒ—ãƒªé–‹ç™ºã§ã¯ã€Web APIã‹ã‚‰å–å¾—ã—ãŸJSONã‚’ãã®ã¾ã¾æ‰±ã†ã‚ˆã†ãªã“ã¨ã¯ã›ãšã€ãƒªã‚½ãƒ¼ã‚¹ã”ã¨ã«å¯¾å¿œã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚¯ãƒ©ã‚¹ãªã©ã‚’å®šç¾©ã—ã¦ãŠã„ã¦ã€ãã“ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã—ãŸä¸Šã§æ‰±ã†ã“ã¨ãŒå¤šã„ã§ã—ã‚‡ã†ã€‚ï¼ˆã¨ã„ã†ã‹ãã†ã—ãªã„ã¨ä½•ã®ãŸã‚ã«TypeScriptã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã‹åˆ†ã‹ã‚Šã¾ã›ã‚“ï¼‰

ãã“ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ãª `User` ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ç”¨æ„ã—ã¦ã€ã“ã‚Œã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‹ã¨ã—ã¦åˆ©ç”¨ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

```ts
// src/models/user.ts

export interface User {
  id: number;
  name: string;
  username: string;
  email: string;
  address: {
    street: string;
    suite: string;
    city: string;
    zipcode: string;
    geo: {
      lat: string;
      lng: string;
    };
  };
  phone: string;
  website: string;
  company: {
    name: string;
    catchPhrase: string;
    bs: string;
  };
}
```

Web APIã‹ã‚‰å–å¾—ã—ãŸJSONã¯å¸¸ã« `User` å‹ã«å¤‰æ›ã—ãŸä¸Šã§æ‰±ã„ãŸã„ã®ã§ã€ãã®ä»•äº‹ã‚’ä»»ã›ã‚‹ãŸã‚ã® `UserRepositoryService` ã¨ã„ã†ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹ã‚’ä½œã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

```ts
// src/repositories/user-repository.service.ts

import { Injectable } from "@angular/core";
import { HttpClient } from "@angular/common/http";
import { Observable } from "rxjs";
import { map } from "rxjs/operators";

import { User } from "../models/user";

@Injectable({
  providedIn: "root"
})
export class UserRepositoryService {
  constructor(private http: HttpClient) {}

  get(id: number): Observable<User> {
    return this.http
      .get(`https://jsonplaceholder.typicode.com/users/${id}`)
      .pipe(map(response => response as User));
  }
}
```

ãªã‚‹ã»ã©ã€`.pipe(map())` ã‚’ä½¿ã£ã¦ç”ŸJSONã‚’ `User` å‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ã—ã¦ã„ã‚‹ã‚ã‘ã§ã™ã­ã€‚

`Observable` ã‚’ `.pipe()` ã§åŠ å·¥ã—ãŸã‚‚ã®ã‚‚ `Observable` ã§ã‚ã‚Šã€æœ€çµ‚çš„ã« `.subscribe()` ã•ã‚ŒãŸã¨ãã«æ¸¡ã£ã¦ãã‚‹å€¤ãŒåŠ å·¥å¾Œã®å€¤ã«ãªã£ã¦ã„ã‚‹ã ã‘ã€ã¨ã„ã†ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒæŒã¦ã‚‹ã¨ç†è§£ã—ã‚„ã™ã„ã¨æ€ã„ã¾ã™ã€‚

ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆã—ã¦ `.get()` ãƒ¡ã‚½ãƒƒãƒ‰ã«å–å¾—ã—ãŸã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®IDã‚’ä¸ãˆã‚Œã°ã€**`User` ã‚’å‹å¼•æ•°ã¨ã™ã‚‹ `Observable`** ã®å½¢ã§çµæœãŒè¿”ã£ã¦ãã¾ã™ã€‚ï¼ˆã¤ã¾ã‚Šã€ãã‚Œã‚’ `.subscribe()` ã™ã‚Œã° `User` å‹ã®å€¤ãŒå–ã‚Šå‡ºã›ã‚‹ï¼‰

ã¨ã„ã†ã‚ã‘ã§ã€ã“ã®å ´åˆã® `AppComponent` ã®ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```ts
import { Component, OnInit } from "@angular/core";

import { User } from "../models/user";
import { UserRepositoryService } from "../repositories/user-repository.service";

@Component({
  selector: "my-app",
  templateUrl: "./app.component.html",
  styleUrls: ["./app.component.css"]
})
export class AppComponent implements OnInit {
  constructor(private userRepository: UserRepositoryService) {}

  ngOnInit() {
    this.userRepository.get(1).subscribe((user: User) => console.log(user));
  }
}

```

![](https://tva1.sinaimg.cn/large/0081Kckwgy1gl9qam0kpmj30tm0eiq6g.jpg)

[ğŸ¤–ãƒ‡ãƒ¢ã¯ã“ã¡ã‚‰](https://stackblitz.com/edit/rxjs-rxjs-example-05?devtoolsheight=33&file=src/app/app.component.ts)

# ãƒ¢ãƒ‡ãƒ«ã¸ã®å¤‰æ›ãŒå…¥ã‚Œå­ã«ãªã‚‹ï¼ˆãƒ¢ãƒ‡ãƒ«ãŒå­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«åˆ¥ã®ãƒ¢ãƒ‡ãƒ«ã‚’æŒã£ã¦ã„ã‚‹ï¼‰ä¾‹

ã„ã‚ˆã„ã‚ˆæœ€å¾Œã®ä¾‹ã§ã™ã€‚

å…ˆã»ã©ã®ç¶šãã§ã€ä»Šåº¦ã¯ [User](https://jsonplaceholder.typicode.com/users/1) ã ã‘ã§ãªã [Post](https://jsonplaceholder.typicode.com/posts/1) ã¨ [Comment](https://jsonplaceholder.typicode.com/comments/1) ã‚‚ãƒ¢ãƒ‡ãƒ«åŒ–ã—ã¦ãã‚Œãã‚Œãƒªãƒã‚¸ãƒˆãƒªã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ãƒ¢ãƒ‡ãƒ«ã®å½¢ã§å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

```ts
// src/modles/post.ts

import { User } from "./user";

export interface Post {
  id: number;
  user: User;
  title: string;
  body: string;
}
```

```ts
// src/models/comment.ts

import { Post } from "./post";

export interface Comment {
  id: number;
  post: Post;
  name: string;
  email: string;
  body: string;
}
```

ç‰¹ã«é›£ã—ã„ã“ã¨ã¯ã—ã¦ã„ã¾ã›ã‚“ãŒã€ `Post#user` ã®å‹ãŒ `User` ã ã£ãŸã‚Š `Comment#post` ã®å‹ãŒ `Post` ã ã£ãŸã‚Šã—ã¦ã„ã‚‹ã“ã¨ã«æ³¨ç›®ã—ã¦ãã ã•ã„ã€‚ï¼ˆã“ã‚Œã«ã‚ˆã£ã¦ä¸€æ°—ã«è©±ãŒã‚„ã‚„ã“ã—ããªã‚Šã¾ã™ğŸ˜…ï¼‰

## 1. `PostRepositoryService`

ã•ã¦ã€ãã‚Œã§ã¯å…ˆã»ã©ã¨åŒæ§˜ã«ã€ã¾ãšã¯ `PostRepositoryService` ã‹ã‚‰ä½œã£ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

```ts
import { Injectable } from "@angular/core";
import { HttpClient } from "@angular/common/http";
import { Observable } from "rxjs";
import { map, mergeMap } from "rxjs/operators";

import { Post } from "../models/post";
import { UserRepositoryService } from "./user-repository.service";

@Injectable({
  providedIn: "root"
})
export class PostRepositoryService {
  constructor(
    private http: HttpClient,
    private userRepository: UserRepositoryService
  ) {}

  get(id: number): Observable<Post> {
    return this.http
      .get(`https://jsonplaceholder.typicode.com/posts/${id}`)
      .pipe(
        mergeMap((response: any) =>
          this.userRepository
            .get(response.userId)
            .pipe(map(user => ({ response, user })))
        ),
        map(({ response, user }) => Object.assign(response, { user }) as Post)
      );
  }
}
```

ã‚¦ã‚®ãƒ£ãƒ¼ï¼æ€¥ã«ã‚ã£ã¡ã‚ƒé›£ã—ã„ï¼ğŸ˜µ

ã¡ã‚‡ã£ã¨1ã¤ãšã¤é †ç•ªã«è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

```ts
get(id: number): Observable<Post> {
  return this.http
    .get(`https://jsonplaceholder.typicode.com/posts/${id}`)
```

ã“ã“ã¾ã§ã¯ã„ã„ã§ã™ã­ã€‚ä»Šã¾ã§ã©ãŠã‚Šã€å—ã‘å–ã£ãŸIDã«å¯¾å¿œã™ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚

```ts
    .pipe(
      mergeMap((response: any) =>
        this.userRepository
          .get(response.userId)
          .pipe(map(user => ({ response, user })))
      ),
      map(({ response, user }) => Object.assign(response, { user }) as Post)
    );
```

ã“ã“ãŒæ€¥ã«é›£ã—ã„ã§ã™ã­ã€‚

ã©ã†ã‚‚ `.pipe()` ã®ä¸­ã« `mergeMap()` ã¨ `map()` ã¨ã„ã†2ã¤ã®ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ã‚’æ¸¡ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ãŒã€ `mergeMap()` ã¯åˆè¦‹ã§ã™ã­ã€‚

ä¸€æ—¦ã€å…ˆã«2ã¤ç›®ã® `map()` ã®ã»ã†ã‹ã‚‰è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```ts
map(({ response, user }) => Object.assign(response, { user }) as Post)
```

1. `{ resopnse, user }` ã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒ2ã¤ã‚ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæµã‚Œã¦ããŸã¨ãã«
2. [Object.assign](https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Object/assign) ã‚’ä½¿ã£ã¦ `response` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã« `{ user }` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆ `{ user: user }` ã®ç•¥è¨˜ï¼‰ã‚’ä¸Šæ›¸ãã‚³ãƒ”ãƒ¼ã—ã¦
    * ã¤ã¾ã‚Šã€ `response` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã« `user` ã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚Œã°ã€ãã®å†…å®¹ã‚’ `user` å¤‰æ•°ã®å€¤ã§ç½®ãæ›ãˆã‚‹
3.  ãã®çµæœã‚’ `Post` å‹ã®å€¤ã¨ã—ã¦è¿”ã™

ã¨ã„ã†ã“ã¨ã‚’ã—ã¦ã„ã¾ã™ã€‚ã“ã® `map()` ãŒ `Post` å‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã—ã¦ã„ã‚‹ãŸã‚ã€ãƒ¡ã‚½ãƒƒãƒ‰å…¨ä½“ã®æˆ»ã‚Šå€¤ã¯ `Observable<Post>` ã«ãªã£ã¦ã„ã¾ã™ã€‚

ã§ã¯ã€1ã¤ç›®ã®ã»ã†ã® `mergeMap()` ã¨ã„ã†ã‚„ã¤ã¯ä½•ã‚’ã—ã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã‹ã€‚

```ts
mergeMap((response: any) =>
  this.userRepository
    .get(response.userId)
    .pipe(map(user => ({ response, user })))
),
```

ã¾ãšã€ `HttpClient#get()` ã®æˆ»ã‚Šå€¤ã‹ã‚‰ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å†…å®¹ã‚’ `response` ã¨ã„ã†å¼•æ•°ã§å—ã‘å–ã‚Šã¾ã™ã€‚ï¼ˆ `response.userId` ã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ããŸã„ã®ã§ã‚ãˆã¦ `any` å‹ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ï¼‰

`response` ã‚’å—ã‘å–ã£ãŸã‚‰ã€ä»Šåº¦ã¯ã•ã‚‰ã« `this.userRepository.get(response.userId)` ã‚’å‘¼ã³å‡ºã—ã¦ `Observable<User>` ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã­ã€‚

ã“ã‚Œã¯ã€ä¸Šè¿°ã—ãŸã¨ãŠã‚Š `Post#user` ãŒ `User` å‹ãªã®ã§ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰å–å¾—ã—ãŸ `userId` ã‚’å…ƒã« `User` ã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã§ã™ã€‚

ãã—ã¦ã“ã‚Œã‚’ã•ã‚‰ã« `.pipe(map())` ã§å¤‰å½¢ã—ã¦ã„ã¾ã™ã­ã€‚

```ts
.pipe(map(user => ({ response, user })))
```

æµã‚Œã¦ããŸ `user` ã‚’ `{ response, user }` ã¨ã„ã†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰å½¢ã—ã¦ã€ `user` ã¨ `response` ã‚’ã‚»ãƒƒãƒˆã«ã—ã¦æ¬¡ã«æµã›ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

ã“ã‚ŒãŒå…ˆã»ã©è¦‹ãŸ1ã¤ç›®ã® `map()` ã«æ¸¡ã£ã¦ãã‚‹ã¨ã„ã†æ§‹é€ ã«ãªã£ã¦ã„ã‚‹ã‚ã‘ã§ã™ã­ã€‚

ãªãœ `map()` ã§ã¯ãªã `mergeMap()` ãªã‚“ã¦ã„ã†çŸ¥ã‚‰ãªã„ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦ã„ãŸã®ã‹ã¨ã„ã†å•é¡ŒãŒæ®‹ã£ã¦ã„ã¾ã™ãŒã€ã“ã‚Œã¯ã€**å€¤ã®å¤‰å½¢ã®éç¨‹ã«éåŒæœŸå‡¦ç†ãŒå…¥ã‚‹** ãŸã‚ã§ã™ã€‚

å…ˆã»ã©ã€ `response` ã‚’ `{ response, user }` ã«å¤‰å½¢ã™ã‚‹ãŸã‚ã«ã€ `this.userRepository.get()` ã‚’å®Ÿè¡Œã—ã¦ `Observable<User>` ã‚’å–å¾—ã—ã¾ã—ãŸã‚ˆã­ã€‚

**ä½•ã‚‚è€ƒãˆãšã« `map()` ã§å¤‰å½¢ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€ `User` ã‚’æµã—ãŸã„ã®ã« `Observable<User>` ã‚’æµã—ã¦ã—ã¾ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚**

ã“ã†ã„ã†å ´åˆã«æœ‰ç”¨ãªã®ãŒä»Šå›ä½¿ã£ãŸ [mergeMap](https://rxjs-dev.firebaseapp.com/api/operators/mergeMap) ã¨ã„ã†ã‚„ã¤ã§ã€ã“ã®ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ã¯ **éåŒæœŸã‚’è§£æ±ºã—ãŸä¸Šã§æ¬¡ã«æµã—ã¦ãã‚Œã‚‹** ã¨ã„ã†æ€§è³ªã‚’æŒã£ã¦ã„ã¾ã™ã€‚

åŒã˜ã‚ˆã†ã«éåŒæœŸã‚’è§£æ±ºã—ã¦ãã‚Œã‚‹ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ã« [concatMap](https://rxjs-dev.firebaseapp.com/api/operators/concatMap) ã‚„ [switchMap](https://rxjs-dev.firebaseapp.com/api/operators/switchMap) ã¨ã„ã†ã‚‚ã®ã‚‚ã‚ã‚Šã€ãã‚Œãã‚Œå¾®å¦™ã«æ©Ÿèƒ½ãŒç•°ãªã‚Šã¾ã™ãŒã€å®Ÿã¯ä»Šå›ã®ä¾‹ã§ã¯ã©ã‚Œã‚’ä½¿ã£ã¦ã‚‚åŒã˜ã‚ˆã†ã«å‹•ä½œã—ã¾ã™ã€‚

`mergeMap` `concatMap` `switchMap` ã®æ¯”è¼ƒã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®è¨˜äº‹ãŒå‚è€ƒã«ãªã‚Šã¾ã™ã€‚ï¼ˆãŸã ã—ã€å†…å®¹ãŒRxJS v5ä»¥å‰ã‚’å¯¾è±¡ã«ã—ãŸã‚‚ã®ã«ãªã£ã¦ã„ã¦ã€ã‚³ãƒ¼ãƒ‰ã®æ›¸ãæ–¹ãŒv6ä»¥é™ã¨ã¯è‹¥å¹²ç•°ãªã£ã¦ã„ã‚‹ã®ã§æ³¨æ„ã—ã¦ãã ã•ã„ï¼‰

> [RxJSã®concatMap, mergeMap, switchMapã®é•ã„ã‚’ç†è§£ã™ã‚‹(ä¸­ç´šè€…å‘ã‘) - Qiita](https://qiita.com/ovrmrw/items/b45d7bf29c8d29415bd7)

ã“ã“ã¾ã§ç†è§£ã—ãŸä¸Šã§ã€ã‚‚ã†ä¸€åº¦ã‚³ãƒ¼ãƒ‰å…¨ä½“ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```ts
get(id: number): Observable<Post> {
  return this.http
    .get(`https://jsonplaceholder.typicode.com/posts/${id}`)
    .pipe(

      // response ã‚’ { response, user } ã«å¤‰æ›
      // ãŸã ã—éåŒæœŸã§ã®å¤‰æ›ãªã®ã§ã€ãã®è§£æ±ºã‚’å¾…ã£ã¦ã‹ã‚‰æ¬¡ã«æµã™
      mergeMap((response: any) =>
        this.userRepository
          .get(response.userId)
          .pipe(map(user => ({ response, user })))
      ),
      
      // { response, user } ã‚’ Post ã«å¤‰æ›
      map(({ response, user }) => Object.assign(response, { user }) as Post)
    );
}
```

ã‚³ãƒ¼ãƒ‰ãŒèª­ã‚ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ãŸã‚‰å¤§æˆé•·ã§ã™ï¼ğŸ‰

> ã‚„ã£ã±ã‚Šã‚ˆãåˆ†ã‹ã‚‰ãªã„â€¦ã¨ã„ã†äººã¯ã€ä½•åº¦ã‚‚èª­ã¿è¿”ã—ãŸã‚Šã€å®Ÿéš›ã«æ‰‹å…ƒã§ã‚³ãƒ¼ãƒ‰ã‚’å‹•ã‹ã—ãŸã‚Šã—ã¦ã¿ãªãŒã‚‰ã˜ã£ãã‚Šç†è§£ã—ã¦ã¿ã¦ãã ã•ã„ğŸ™

## 2. `CommentRepositoryService`

åŒæ§˜ã« `CommentRepositoryService` ã‚‚ä½œã£ã¦ã„ãã¾ã™ã€‚

```ts
import { Injectable } from "@angular/core";
import { HttpClient } from "@angular/common/http";
import { Observable, zip } from "rxjs";
import { map, mergeMap } from "rxjs/operators";

import { Post } from "../models/post";
import { Comment } from "../models/comment";
import { PostRepositoryService } from "./post-repository.service";

@Injectable({
  providedIn: "root"
})
export class CommentRepositoryService {
  constructor(
    private http: HttpClient,
    private postRepository: PostRepositoryService
  ) {}

  get(id: number): Observable<Comment> {
    return this.http
      .get(`https://jsonplaceholder.typicode.com/comments/${id}`)
      .pipe(
        mergeMap((response: any) =>
          this.postRepository
            .get(response.postId)
            .pipe(map((post: Post) => ({ response, post })))
        ),
        map(
          ({ response, post }) => Object.assign(response, { post }) as Comment
        )
      );
  }

  list(postId: number): Observable<Comment[]> {
    return this.http
      .get(`https://jsonplaceholder.typicode.com/comments?postId=${postId}`)
      .pipe(
        mergeMap((responses: any[]) =>
          zip(
            ...responses.map(response =>
              this.postRepository.get(response.postId)
            )
          ).pipe(map((posts: Post[]) => ({ responses, posts })))
        ),
        map(({ responses, posts }) =>
          responses.map(
            (response, i) =>
              Object.assign(response, { post: posts[i] }) as Comment
          )
        )
      );
  }
}
```

ãŠã‚„ãŠã‚„â€¦ã“ã‚Œã¯ã¾ãŸé›£ã—ã„æ„Ÿã˜ã§ã™ã­â€¦

é †ã«è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ğŸ’ª

ã¾ãšã€ `get` ãƒ¡ã‚½ãƒƒãƒ‰ã«ã¤ã„ã¦ã¯ã€ã‚ˆãè¦‹ã‚‹ã¨å…ˆã»ã©ã® `PostRepositoryService#get()` ã¨ã¾ã£ãŸãåŒã˜æ§‹é€ ã ã¨ã„ã†ã“ã¨ãŒåˆ†ã‹ã‚‹ã¨æ€ã„ã¾ã™ã®ã§ã€ã“ã¡ã‚‰ã¯èª¬æ˜ã‚’å‰²æ„›ã—ã¾ã™ã€‚

å•é¡Œã¯ `list` ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã­ã€‚

```ts
list(postId: number): Observable<Comment[]> {
  return this.http
    .get(`https://jsonplaceholder.typicode.com/comments?postId=${postId}`)
    .pipe(
      mergeMap((responses: any[]) =>
        zip(
          ...responses.map(response =>
            this.postRepository.get(response.postId)
          )
        ).pipe(map((posts: Post[]) => ({ responses, posts })))
      ),
      map(({ responses, posts }) =>
        responses.map(
          (response, i) =>
            Object.assign(response, { post: posts[i] }) as Comment
        )
      )
    );
}
```

`postId` ã‚’æŒ‡å®šã—ã¦ [ã‚³ãƒ¡ãƒ³ãƒˆã®ä¸€è¦§](https://jsonplaceholder.typicode.com/comments?postId=1) ã‚’å–å¾—ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚ãªã®ã§æˆ»ã‚Šå€¤ã®å‹ã¯ `Observable<Comment[]>` ã¨ãªã£ã¦ã„ã¾ã™ã­ã€‚

ã¤ã¾ã‚Šã€ `.pipe()` å†…ã§å€¤ã®å¤‰å½¢ã‚’è¡Œã£ãŸçµæœã€**æœ€çµ‚çš„ã« `Comment` ã®é…åˆ—ã‚’ä½œæˆã§ãã‚Œã°ã‚ˆã„** ã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

ä»Šå›ã‚‚ã¾ãŸåˆè¦‹ã® `zip()` ãªã‚‹ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãŒç™»å ´ã—ã¦ã„ã¾ã™ãŒã€å…ˆã»ã©ã¨åŒæ§˜ã€ä¸€æ—¦å¾ŒåŠã‹ã‚‰å…ˆã«è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

```ts
map(({ responses, posts }) =>
  responses.map(
    (response, i) =>
      Object.assign(response, { post: posts[i] }) as Comment
  )
)
```

1. `{ resopnses, posts }` ã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒ2ã¤ï¼ˆã„ãšã‚Œã‚‚é…åˆ—ï¼‰ã‚ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæµã‚Œã¦ããŸã¨ãã«
2. `responses` é…åˆ—ã‚’ [Array.prototype.map()](https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Array/map) ã§å›ã—ã¦
3. 1ã¤1ã¤ã® `response` ã«ã¤ã„ã¦ã€[Object.assign](https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Object/assign) ã‚’ä½¿ã£ã¦ `response` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã« `{ post: posts[i] }` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆ `responses` ã®ãƒ«ãƒ¼ãƒ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«å¯¾å¿œã™ã‚‹ `posts` ã®ä¸­èº«ï¼‰ã‚’ä¸Šæ›¸ãã‚³ãƒ”ãƒ¼ã—ã¦
    * ã¤ã¾ã‚Šã€ `response` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã« `post` ã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚Œã°ã€ãã®å†…å®¹ã‚’ `posts[i]` ã®å€¤ã§ç½®ãæ›ãˆã‚‹
3.  ãã®çµæœã‚’ `Comment` å‹ã®å€¤ã¨ã—ã¦è¿”ã™ã“ã¨ã«ã‚ˆã‚Šã€æœ€çµ‚çš„ã« `Comment` ã®é…åˆ—ï¼ˆ `Comment[]` å‹ï¼‰ã‚’è¿”ã™

ã¨ã„ã†ã“ã¨ã‚’ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šãƒ¡ã‚½ãƒƒãƒ‰å…¨ä½“ã®æˆ»ã‚Šå€¤ã¯ `Observable<Comment[]>` ã«ãªã£ã¦ã„ã¾ã™ã€‚

ã“ã®éƒ¨åˆ†ã¯ã€æ¸¡ã£ã¦ãã‚‹å€¤ãŒé…åˆ—ã«ãªã£ã¦ã„ã‚‹ä»¥å¤–ã¯ `PostRepositoryService` ã®ã¨ãã¨ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯åŒã˜ã§ã™ã­ğŸ’ª

å•é¡Œã¯å‰åŠã§ã™ã€‚

```ts
mergeMap((responses: any[]) =>
  zip(
    ...responses.map(response =>
      this.postRepository.get(response.postId)
    )
  ).pipe(map((posts: Post[]) => ({ responses, posts })))
),
```

[zip](https://rxjs-dev.firebaseapp.com/api/operators/zip) ã¨ã„ã†åˆè¦‹ã®ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãŒç™»å ´ã—ã¦ã„ã¾ã™ã€‚

`zip()` ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ã¯ã€è¤‡æ•°ã® `Observable` ã‚’å—ã‘å–ã£ã¦ã€ãã‚Œã‚’çµ„ã¿åˆã‚ã›ãŸ `Observable` ã‚’è¿”ã—ã¾ã™ã€‚

ä»¥ä¸‹ã®ä¾‹ã‚’è¦‹ã‚‹ã¨ã‚¤ãƒ¡ãƒ¼ã‚¸ã—ã‚„ã™ã„ã¨æ€ã„ã¾ã™ã€‚

```ts
const zip$ = zip(of(1, 2, 3), of(4, 5, 6));
zip$.subscribe(v => console.log(v));

// å‡ºåŠ›çµæœï¼š
// [1, 4]
// [2, 5]
// [3, 6]
```

ã¤ã¾ã‚Šã€

```ts
zip(
  ...responses.map(response =>
    this.postRepository.get(response.postId)
  )
)
```

ã“ã®éƒ¨åˆ†ã¯ã€

1. `responses` 1ã¤1ã¤ã«ã¤ã„ã¦ `this.postRepository.get()` ã‚’ä½¿ã£ã¦ `Observable<Post>` ã‚’å–å¾—ã—
2. ãã‚Œã‚‰ã™ã¹ã¦ã® `Observable<Post>` ã‚’ `zip()` ã«å¼•æ•°ã¨ã—ã¦æ¸¡ã—
    * `...` ã¯JavaScriptã® [ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰æ§‹æ–‡](https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Operators/Spread_syntax) ã§ã™
3. çµæœã¨ã—ã¦ `Observable<Post[]>` ã‚’ä½œã‚‹

ã¨ã„ã†ã“ã¨ã‚’ã—ã¦ã„ã‚‹ã‚ã‘ã§ã™ã€‚

ãã—ã¦ã€ãã® `Observable<Post[]>` ã‚’ã•ã‚‰ã«

```ts
.pipe(map((posts: Post[]) => ({ responses, posts })))
```

ã«æ¸¡ã—ã¦ã€ `{ responses, posts }` ã«å¤‰å½¢ã—ã¦æ¬¡ã® `map()` ã«æ¸¡ã—ã¦ã„ã‚‹ã¨ã„ã†ã‚ã‘ã§ã™ã­ã€‚

ã§ã¯ã€ã“ã“ã¾ã§ç†è§£ã—ãŸä¸Šã§ã€ã‚‚ã†ä¸€åº¦ã‚³ãƒ¼ãƒ‰å…¨ä½“ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```ts
list(postId: number): Observable<Comment[]> {
  return this.http
    .get(`https://jsonplaceholder.typicode.com/comments?postId=${postId}`)
    .pipe(
      mergeMap((responses: any[]) =>
        zip(
          ...responses.map(response =>
            this.postRepository.get(response.postId)
          )
        ).pipe(map((posts: Post[]) => ({ responses, posts })))
      ),
      map(({ responses, posts }) =>
        responses.map(
          (response, i) =>
            Object.assign(response, { post: posts[i] }) as Comment
        )
      )
    );
}
```

ã‚³ãƒ¼ãƒ‰ãŒèª­ã‚ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ãŸã‚‰å¤§æˆé•·ã§ã™ï¼ğŸ‰

ä¾‹ã«ã‚ˆã£ã¦ã€ã‚„ã£ã±ã‚Šã¾ã ã‚ˆãåˆ†ã‹ã‚‰ãªã„ã¨ã„ã†äººã¯ãœã²ä½•åº¦ã‚‚èª­ã¿è¿”ã—ã¦ã¿ã¦ãã ã•ã„ğŸ’ª

## 3. `AppComponent`

æœ€å¾Œã«ã€å‘¼ã³å‡ºã—å…ƒã§ã‚ã‚‹ `AppComponent` ã®ã‚³ãƒ¼ãƒ‰ã¯ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```ts
import { Component, OnInit } from "@angular/core";

import { User } from "../models/user";
import { Post } from "../models/post";
import { Comment } from "../models/comment";
import { UserRepositoryService } from "../repositories/user-repository.service";
import { PostRepositoryService } from "../repositories/post-repository.service";
import { CommentRepositoryService } from "../repositories/comment-repository.service";

@Component({
  selector: "my-app",
  templateUrl: "./app.component.html",
  styleUrls: ["./app.component.css"]
})
export class AppComponent implements OnInit {
  constructor(
    private userRepository: UserRepositoryService,
    private postRepository: PostRepositoryService,
    private commentRepository: CommentRepositoryService
  ) {}

  ngOnInit() {
    this.userRepository.get(1).subscribe((user: User) => console.log(user));
    this.postRepository.get(1).subscribe((post: Post) => console.log(post));
    this.commentRepository.get(1).subscribe((comment: Comment) => console.log(comment));
    this.commentRepository.list(1).subscribe((comments: Comment[]) => console.log(comments));
  }
}
```

![](https://tva1.sinaimg.cn/large/0081Kckwgy1gl9rjnlvtbj31cy05k76h.jpg)

> 4ã¤ã® `.subscribe()` ãŒãã‚Œãã‚ŒéåŒæœŸã«å‡¦ç†ã•ã‚Œã‚‹ã®ã§ã€å¿…ãšã—ã‚‚ `user` `post` `comment` `comments` ã®é †ã«å‡ºåŠ›ã•ã‚Œãªã„ã€ã¨ã„ã†ã®ã‚‚åœ°å‘³ã«ãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚

[ğŸ¤–ãƒ‡ãƒ¢ã¯ã“ã¡ã‚‰](https://stackblitz.com/edit/rxjs-rxjs-example-06?devtoolsheight=33&file=src/app/app.component.ts)

## ä½™è«‡

ã¡ãªã¿ã«ã€ä»Šå›ã¯Web APIã®ãƒ‡ãƒ¼ã‚¿ãŒæ­£è¦åŒ–ã•ã‚Œã¦ã„ãŸã®ã§è¤‡æ•°å›ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ãªã„ã¨å®Œå…¨ãªãƒ¢ãƒ‡ãƒ«ã‚’ç²å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸãŒã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚‚è‡ªåˆ†ã§ä½œã£ã¦ã„ã‚‹å ´åˆã‚„ã€Firestoreãªã©ã®NoSQLã‚’ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ä½¿ã£ã¦ã„ã‚‹å ´åˆã«ã¯ã€ç„¡é§„ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ¸›ã‚‰ã™ãŸã‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’éæ­£è¦åŒ–ã™ã‚‹ã“ã¨ã‚‚æ¤œè¨ã—ã¦ã¿ã‚‹ã¨ã‚ˆã„ã¨æ€ã„ã¾ã™ã€‚

# ãŠã‚ã‚Šã«

ã¨ã„ã†ã‚ã‘ã§ã€Angularãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¬¼é–€ã§ã‚ã‚‹RxJSã«ã¤ã„ã¦è§£èª¬ã—ã¦ã¿ã¾ã—ãŸã€‚

> å…¨ç„¶ãã‚“ãªã¤ã‚‚ã‚Šã¯ãªã‹ã£ãŸã®ã«ã€æ°—ä»˜ã„ãŸã‚‰2ä¸‡æ–‡å­—è¶Šãˆã®å¤§ä½œã«ãªã£ã¦ã—ã¾ã„ã¾ã—ãŸğŸ’¨

å…¥é–€è¨˜äº‹ãªã©ã§é›°å›²æ°—ã¯åˆ†ã‹ã£ã¦ã„ãŸã‘ã©ã€å®Ÿéš›ã®ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚³ãƒ¼ãƒ‰ã§ã©ã‚“ãªé¢¨ã«ä½¿ã†ã®ã‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ãã¦ã„ãªã‹ã£ãŸã¨ã„ã†äººã®ãŠå½¹ã«ç«‹ã¦ã°å¬‰ã—ã„ã§ã™ğŸ’ª

å®Ÿéš›ã€åƒ•è‡ªèº«ã‚‚åˆå¿ƒè€…ã®é ƒã«ã“ã®è¨˜äº‹ã®æœ€å¾Œã®ä¾‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ãŒã¾ã£ãŸãæ›¸ã‘ãªãã¦ã€ã‚°ã‚°ã£ã¦ã‚‚å…·ä½“çš„ãªæƒ…å ±ãŒ1ãƒŸãƒªã‚‚è¦‹ã¤ã‘ã‚‰ã‚Œãšå¤§å¤‰è‹¦åŠ´ã—ã¾ã—ãŸğŸ˜­

ãªã®ã§ã€åŒã˜ã‚ˆã†ã«å›°ã£ã¦ã„ã‚‹åˆå¿ƒè€…ã®äººãŒå…·ä½“çš„ãªã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ç†è§£ã‚’æ·±ã‚ã‚‹åŠ©ã‘ã«ãªã‚Œã°ã¨ç­†ã‚’ã¨ã£ãŸæ¬¡ç¬¬ã§ã™ã€‚

ã“ã®è¨˜äº‹ã«æ›¸ã„ãŸå†…å®¹ã‚’ãƒ™ãƒ¼ã‚¹ã« [Angularå®Ÿè·µå…¥é–€ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«](https://zenn.dev/ttskch/books/84c7a272deb3845e8085) ã®ã»ã†ã«ã‚‚RxJSã«ã¤ã„ã¦ã®ã‚ˆã‚Šè©³ã—ã„è§£èª¬ã‚’åŠ ç­†ã—ãŸã„ã¨æ€ã£ã¦ã„ã‚‹ã®ã§ã€ãã¡ã‚‰ã‚‚ãœã²æ¥½ã—ã¿ã«ã—ã¦ã„ã¦ãã ã•ã„ï¼ğŸ˜‡

[Angular Advent Calendar 2020](https://qiita.com/advent-calendar/2020/angular)ã€æ˜æ—¥ã¯ [@FuwattoFlower](https://twitter.com/FuwattoFlower) ã•ã‚“ã§ã™ï¼ãŠæ¥½ã—ã¿ã«ï¼

# å‚è€ƒã‚µã‚¤ãƒˆ

* [RxJSã®åŸºç¤ä¸­ã®åŸºç¤ - Qiita](https://qiita.com/agajo/items/7942743a0130f7a0f30b)
* [RxJS ã® Observable / Observer ã®æ¦‚è¦ - Qiita](https://qiita.com/bouzuya/items/63a6dfca0e3ebb0f5268)
* [RxJSå…¥é–€#1åŸºæœ¬ã®æ¦‚å¿µã‚’ã²ã¨ã¤ãšã¤å­¦ã¶ - Qiita](https://qiita.com/katsunory/items/75651919f6786864c2b5)
* [RxJSã®concatMap, mergeMap, switchMapã®é•ã„ã‚’ç†è§£ã™ã‚‹(ä¸­ç´šè€…å‘ã‘) - Qiita](https://qiita.com/ovrmrw/items/b45d7bf29c8d29415bd7)
* [mergeMap / flatMap - Learn RxJS](https://www.learnrxjs.io/learn-rxjs/operators/transformation/mergemap)
