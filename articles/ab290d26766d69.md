---
title: "kreait/firebase-bundleã§åˆæœŸåŒ–ã—ãŸCloud Storageã‚’league/flysystem-bundleã§ä½¿ã†"
emoji: "ğŸ»"
type: "tech"
topics: ["php", "symfony", "firebase"]
published: true
published_at: 2022-05-26
---

:::message
ã“ã®è¨˜äº‹ã¯ã€2022-05-26ã«åˆ¥ã®ãƒ–ãƒ­ã‚°åª’ä½“ã«æŠ•ç¨¿ã—ãŸè¨˜äº‹ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ã™ã€‚
:::

kreait/firebase-bundleã§åˆæœŸåŒ–ã—ãŸCloud Storage for Firebaseã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’league/flysystem-bundleã‹ã‚‰ä½¿ã†æ–¹æ³•ã‚’è§£èª¬ã—ã¾ã™ã€‚

# kreait/firebase-bundleã¨ã¯

[kreait/firebase-php](https://github.com/kreait/firebase-php) ã¯ [Firebase Admin SDK](https://firebase.google.com/docs/admin/setup?hl=ja) ã®PHPå®Ÿè£…ã§ã€éå…¬å¼ã§ã¯ã‚ã‚Šã¾ã™ãŒPHPã®å®Ÿè£…ã¨ã—ã¦ã¯ãƒ‡ãƒ•ã‚¡ã‚¯ãƒˆã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ã¨ãªã£ã¦ã„ã¾ã™ã€‚

kreait/firebase-phpã‚’Symfonyã«ç°¡å˜ã«çµ±åˆã™ã‚‹ãŸã‚ã®ãƒãƒ³ãƒ‰ãƒ«ã¨ã—ã¦ [kreait/firebase-bundle](https://github.com/kreait/firebase-bundle) ãŒã‚ã‚Šã¾ã™ã€‚

# league/flysystem-bundleã¨ã¯

[league/flysystem](https://github.com/thephpleague/flysystem) ã¯ã€æ§˜ã€…ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚’é€éçš„ã«åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®PHPãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚Amazon S3ã‚„Google Cloud Storageãªã©ä¸»è¦ãªãƒãƒãƒ¼ã‚¸ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚‚å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚

league/flysystemã‚’Symfonyã«ç°¡å˜ã«çµ±åˆã™ã‚‹ãŸã‚ã®ãƒãƒ³ãƒ‰ãƒ«ã¨ã—ã¦ [league/flysystem-bundle](https://github.com/thephpleague/flysystem-bundle) ãŒã‚ã‚Šã¾ã™ã€‚

# kreait/firebase-bundleã®åˆæœŸåŒ–æ‰‹é †

[å…¬å¼ã®README](https://github.com/kreait/firebase-bundle#readme) ã®ã¨ãŠã‚Šã§ã™ãŒã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ‰‹é †ã«ãªã‚Šã¾ã™ã€‚

## 1. ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ç§˜å¯†éµã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

`https://console.firebase.google.com/project/{ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå}/settings/serviceaccounts/adminsdk?hl=ja`

ã«ã¦ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã€ç§˜å¯†éµã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚ä»Šå›ã¯ãã‚Œã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã« `firebase-credentials.json` ã¨ã—ã¦ä¿å­˜ã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

```
# .gitignore
/firebase-credentials.json
```

ç§˜åŒ¿æƒ…å ±ãªã®ã§å¿˜ã‚Œãšã«gitignoreã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

## 2. ãƒãƒ³ãƒ‰ãƒ«ã‚’è¨­å®š

```yaml
# config/packages/firebase.yaml

kreait_firebase:
  projects:
    {ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè­˜åˆ¥å­}:
      credentials: '%kernel.project_dir%/firebase-credentials.json'
```

ã“ã‚Œã§ã€`kreait_firebase.{ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè­˜åˆ¥å­}.storage` ã¨ã„ã†ã‚µãƒ¼ãƒ“ã‚¹IDã§ `Kreait\Firebase\Contract\Storage` ã®å®Ÿè£…ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

# league/flysystem-bundleã®åˆæœŸåŒ–æ‰‹é †

ã“ã¡ã‚‰ã‚‚ [å…¬å¼ã®README](https://github.com/thephpleague/flysystem-bundle#readme) ãŠã‚ˆã³ [Cloud Storage Providersã®åˆ©ç”¨æ–¹æ³•ã«ã¤ã„ã¦ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://github.com/thephpleague/flysystem-bundle/blob/2.2.0/docs/2-cloud-storage-providers.md#google-cloud-storage) ã«è©³ç´°ãŒè¼‰ã£ã¦ã„ã¾ã™ãŒã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ‰‹é †ã«ãªã‚Šã¾ã™ã€‚

## 1. Google Cloud Storageç”¨ã®ã‚¢ãƒ€ãƒ—ã‚¿ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```shell
$ composer require league/flysystem-google-cloud-storage
```

## 2. ãƒãƒ³ãƒ‰ãƒ«ã‚’è¨­å®š

```yaml
# config/packages/flysystem.yaml

flysystem:
  storages:
    default.storage:
      adapter: gcloud
      options:
        client: Google\Cloud\Storage\StorageClient # service id
        bucket: '%env(FIREBASE_STORAGE_BUCKET_NAME)%'
        # prefix: optional/path/prefix # å¿…è¦ãªã‚‰è¨­å®š
```

```
# .env(.local)

FIREBASE_STORAGE_BUCKET_NAME={ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå}.appspot.com
```

ãƒã‚±ãƒƒãƒˆåã¯ `{ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå}.appspot.com` ã«ãªã‚Šã¾ã™ï¼ˆ[å‚è€ƒ](https://firebase.google.com/docs/storage/admin/start?hl=ja#use_a_default_bucket)ï¼‰ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã¨æœ¬ç•ªãªã©ç’°å¢ƒã”ã¨ã«ç•°ãªã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ã„åˆ†ã‘ã‚‹ã“ã¨ã«ãªã‚‹ã‹ã¨æ€ã„ã¾ã™ã®ã§ã€å…·ä½“çš„ãªå€¤ã¯ `.env` ã«æ›¸ãã¾ã—ã‚‡ã†ã€‚

ã•ã¦ã€

```yaml
client: Google\Cloud\Storage\StorageClient # service id
```

ã„ããªã‚Šã“ã®ã‚ˆã†ã«æ›¸ã„ã¦ã¿ã¾ã—ãŸãŒã€ç¾çŠ¶ `Google\Cloud\Storage\StorageClient` ã¨ã„ã†IDã®ã‚µãƒ¼ãƒ“ã‚¹ã¯å®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

ãªã®ã§ã€å‰æã¨ã—ã¦è‡ªå‰ã§ `Google\Cloud\Storage\StorageClient` ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ï¼ˆ`Google\Cloud\Storage\StorageClient` ã¨ã„ã†ã‚µãƒ¼ãƒ“ã‚¹IDã§ï¼‰ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦å®šç¾©ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## 3. `Google\Cloud\Storage\StorageClient` ã‚µãƒ¼ãƒ“ã‚¹ã‚’å®šç¾©

kreait/firebase-bundleã«ã‚ˆã£ã¦ã™ã§ã« `kreait_firebase.{ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè­˜åˆ¥å­}.storage` ã¨ã„ã†ã‚µãƒ¼ãƒ“ã‚¹IDã§ `Kreait\Firebase\Contract\Storage` ã®å®Ÿè£…ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

`Kreait\Firebase\Contract\Storage` ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€[`getStorageClient()` ã¨ã„ã†publicãƒ¡ã‚½ãƒƒãƒ‰ã§ `Google\Cloud\Storage\StorageClient` ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å–å¾—ã§ãã‚‹](https://github.com/kreait/firebase-php/blob/6.x/src/Firebase/Contract/Storage.php#L12) ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

ã¨ã„ã†ã‚ã‘ã§ã€ã“ã‚Œã§å–å¾—ã—ãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦å®šç¾©ã—ã¦ã‚ã’ã‚Œã°ã‚ˆã•ãã†ã§ã™ã€‚

ã“ã®ã‚ˆã†ãªå ´åˆã«ã¯ã€Symfonyã®ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ³ãƒ†ãƒŠã® [`factory` æ©Ÿèƒ½](https://symfony.com/doc/current/service_container/factories.html#non-static-factories) ãŒæ´»ç”¨ã§ãã¾ã™ã€‚

```yaml
# config/services.yaml

services:
  Google\Cloud\Storage\StorageClient:
    factory: ['@kreait_firebase.{ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè­˜åˆ¥å­}.storage', getStorageClient]
```

ã“ã®ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã€`kreait_firebase.{ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè­˜åˆ¥å­}.storage` ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆã¤ã¾ã‚Š `Kreait\Firebase\Contract\Storage` ã®å®Ÿè£…ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼‰ã® `getStorageClient()` ãƒ¡ã‚½ãƒƒãƒ‰ã®æˆ»ã‚Šå€¤ã‚’ `Google\Cloud\Storage\StorageClient` ã¨ã„ã†IDã§ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã‚Œã§ç„¡äº‹ã«è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸğŸ‘

# ä½¿ã£ã¦ã¿ã‚‹

å®Ÿéš›ã«ä½¿ã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

é©å½“ãªã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã«ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã¿ã¾ã™ã€‚

```php
class SomeController extends AbstractController
{
    public function __construct(private FilesystemOperator $defaultStorage)
    {
    }

    public function someAction(): Response
    {
        $this->defaultStorage->write('test.txt', 'test');

        return new Response();
    }
}
```

`League\Flysystem\FilesystemOperator` å‹ã® `$defaultStorage` ã‚’ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆã—ã¦ã€ã“ã“ã§ã¯ `write()` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚

[league/flysystem-bundleã®READMEã«è¨˜è¼‰ãŒã‚ã‚‹ã¨ãŠã‚Š](https://github.com/thephpleague/flysystem-bundle#:~:text=class%20MyController%0A%7B-,//%20The%20variable%20name%20%24defaultStorage%20matters%3A%20it%20needs%20to%20be%20the%20camelized%20version%0A%20%20%20%20//%20of%20the%20name%20of%20your%20storage.,-public%20function%20index)ã€ã“ã® `$defaultStorage` ã¨ã„ã†å¼•æ•°åã«ã¯ãƒ«ãƒ¼ãƒ«ãŒã‚ã‚Šã€ä»»æ„ã®å¼•æ•°åã§å—ã‘å–ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚

ä»Šå›ã¯

```yaml
# config/packages/flysystem.yaml

flysystem:
  storages:
    default.storage:
      # ç•¥
```

ã“ã®ã‚ˆã†ã« `default.storage` ã¨ã„ã†ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸åã§å®šç¾©ã—ãŸã®ã§ã€ã“ã‚Œã‚’lowerCamelCaseã§è¡¨ç¾ã—ãŸ `$defaultStorage` ã¨ã„ã†å¼•æ•°åã«ãƒã‚¤ãƒ³ãƒ‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã“ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã‚’å®Ÿéš›ã«å®Ÿè¡Œã—ãŸã‚ã¨ã€Firebaseã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’è¦‹ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ğŸ‘

![](https://tva1.sinaimg.cn/large/e6c9d24egy1h2llcqp2gfj21g00asmy0.jpg)

# ãŠã¾ã‘ï¼škreait/firebase-bundleã§Firebase Authenticationã‚’ä½¿ã†ã¨ãã®Tips

Cloud Storage for Firebaseã¨é•ã£ã¦Firebase Authenticationã‚’ä½¿ã†ã¨ãã¯ç‰¹ã«ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’è¢«ã›ãŸã‚Šã›ãšç›´æ¥ä½¿ã†ã®ãŒæ™®é€šã ã¨æ€ã„ã¾ã™ã€‚

Cloud Storage for Firebaseã®å ´åˆã¨åŒæ§˜ã€ãƒãƒ³ãƒ‰ãƒ«ã«Firebaseã®ç§˜å¯†éµã‚’è¨­å®šã—ãŸæ™‚ç‚¹ã§ã€`kreait_firebase.{ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè­˜åˆ¥å­}.auth` ã¨ã„ã†ã‚µãƒ¼ãƒ“ã‚¹IDã§ `Kreait\Firebase\Contract\Auth` ã®å®Ÿè£…ã‚¯ãƒ©ã‚¹ã‚’åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

ãŒã€ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’è¤‡æ•°ç®‡æ‰€ã§ä½¿ã†å¿…è¦ãŒå‡ºã¦ããŸã¨ãã«ã€`Kreait\Firebase\Contract\Auth` å‹ã§autowireã—ã¦ã‚‚ã‚‰ãˆãªã„ã®ã¯éå¸¸ã«ä¸ä¾¿ã§ã™ã€‚

ãã“ã§ã€services.yamlã«ä»¥ä¸‹ã®2è¡Œã‚’è¿½è¨˜ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

```yaml
# config/services.yaml

services:
  Kreait\Firebase\Contract\Auth:
    alias: kreait_firebase.{ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè­˜åˆ¥å­}.auth
```

ã“ã‚Œã§ã€`Kreait\Firebase\Contract\Auth` å‹ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å¼•æ•°ï¼ˆç­‰ï¼‰ã«è‡ªå‹•ã§ `kreait_firebase.{ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè­˜åˆ¥å­}.auth` ã‚µãƒ¼ãƒ“ã‚¹ãŒã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆã•ã‚Œã¦ã¨ã¦ã‚‚å¹¸ã›ã«ãªã‚Œã¾ã™ã€‚
